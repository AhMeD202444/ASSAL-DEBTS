<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ASSAL • فواتير ديون يومية مكتب عسل</title>

 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  

  <style>
  
  /* فكّ حماية أيقونات Font Awesome من Cairo وتحديد الوزن الصحيح */
.fa-solid, .fas{
  font-family: "Font Awesome 6 Free" !important;
  font-weight: 900 !important;   /* مهم للـ solid */
}
.fa-regular, .far{
  font-family: "Font Awesome 6 Free" !important;
  font-weight: 400 !important;
}
.fa-brands, .fab{
  font-family: "Font Awesome 6 Brands" !important;
  font-weight: 400 !important;
}

  
  
  /* 1) خط Cairo على كل الواجهة (يشمل الأزرار والنوافذ والمدخلات) */
:root{ --ui-font: "Cairo", system-ui; }

/* غطّي كل العناصر المرئية في الصفحة */
:where(html, body, button, input, select, textarea, .btn, .field,
       .ribbon, .ribbon *, .layout, .rail, .rail *,
       .board, .board *, .masonry, .card, .card *,
       .insights, .insights *, .dock, .dock *,
       .footer, .footer *, .modal, .modal *){
  font-family: var(--ui-font) !important;
}

/* 2) حماية أيقونات Font Awesome حتى لا يتغيّر خطّها */
i.fa, i.fa-solid, i.fa-regular, i.fa-brands,
.fa, .fa-solid, .fa-regular, .fa-brands{
  font-family: var(--fa-style-family, "Font Awesome 6 Free") !important;
  font-weight: inherit;
}

  
  
  
  
    /* =================== لوحة ألوان عصرية =================== */
    :root{
      /* أساسيات */
      --bg:#0b1220;                /* خلفية داكنة أنيقة */
      --bg-2:#121a2b;              /* أغمق قليلاً لمناطق ثانوية */
      --paper:#0f172a;             /* لوحات وبطاقات داكنة ناعمة */
      --rail:#0f172a;              /* سايدبار */
      --ink:#e5e7eb;               /* نص رئيسي فاتح */
      --muted:#9aa4b2;             /* نص ثانوي */
      --stroke:#1f2a44;            /* حدود رفيعة */

      /* ألوان العلامة (تدرّج عصري) */
      --brand:#12d1b4;             /* فيروزي */
      --brand-2:#7c3aed;           /* بنفسجي */
      --brand-3:#0ea5e9;           /* أزرق سماوي للتفاصيل */

      /* دلالية */
      --good:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      /* مؤثرات */
      --radius:16px;
      --shadow:0 18px 50px rgba(0,0,0,.35);

      /* قياسات */
      --footer-h:44px;
      --dock-gap:68px;
      --hdr-h:54px;

      /* أسطح فاتحة داخل الداكن */
      --surface:#111a2f;
      --surface-2:#0e1630;
      --chip:#0f1a33;
    }

    /* خلفية بنمط شعاعي لطيف */
    body{
      margin:0;
      height:100%;
      color:var(--ink);
      font-family:"Cairo",system-ui;
      background:
        radial-gradient(1000px 600px at 80% -10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 500px at -10% 10%, rgba(18,209,180,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      overflow-x:hidden;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }

    /* =================== Header (عنوان بالمنتصف + زجاجي) =================== */
    .ribbon{
      position:sticky; top:0; z-index:70;
      background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(17,24,39,.5));
      border-bottom:1px solid rgba(124,58,237,.25);
      backdrop-filter:blur(10px);
    }
    .ribbon-wrap{
      height:var(--hdr-h);
      max-width:1480px;
      margin:auto;
      padding:0 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* يسار | مركز | يمين */
      align-items:center;
      gap:10px;
    }
    .r-left{display:flex;align-items:center;gap:8px}
    .r-center{justify-self:center}
    .r-right{justify-self:end;display:flex;gap:6px}

    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand .dot{
      width:26px;height:26px;border-radius:8px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;font-size:13px;font-weight:800;
      box-shadow:0 8px 22px rgba(124,58,237,.35);
    }
    .brand .name{
      font-size:15px;letter-spacing:.1px;color:#fff;
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    .pill{
      border:1px solid rgba(124,58,237,.25);
      border-radius:999px;
      padding:4px 10px;
      color:#cbd5e1;
      background:linear-gradient(180deg, #0b1220, #0d1527);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
      font-size:12px;
    }
    .icon{
      width:34px;height:34px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0c1426,#0e1830);
      border-radius:10px;display:grid;place-items:center;cursor:pointer;
      color:#e2e8f0;
    }
    .icon:hover{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 8px 24px rgba(124,58,237,.25);
      transform:translateY(-1px);
      transition:.18s ease;
    }

    /* =================== Layout =================== */
    .layout{
      max-width:1480px;margin:14px auto;padding:0 14px;
      display:grid;grid-template-columns: 280px 1fr 320px;gap:14px
    }
    @media (max-width:1280px){ .layout{grid-template-columns: 240px 1fr 280px} }
    @media (max-width:980px){ .layout{grid-template-columns: 1fr; grid-auto-rows:min-content} }

    /* =================== Rail =================== */
    .rail{
      background:var(--surface);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
      position:sticky;
      top:calc(var(--hdr-h) + 8px);
      height:calc(100vh - var(--hdr-h) - 24px);
      display:flex;flex-direction:column
    }
    .rail h3{margin:0 0 6px 0;font-size:14px;font-weight:900;color:#e2e8f0}
    .rail .search{margin:6px 0}
    .input{
      width:100%;height:34px;padding:8px 10px;
      border:1px solid var(--stroke);border-radius:10px;background:#0c1325;color:#e5e7eb;
      font-family:"Cairo",system-ui;
      outline:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .input:focus{
      border-color:rgba(18,209,180,.6);
      box-shadow:0 0 0 3px rgba(18,209,180,.14);
    }

    /* شهور + أيام */
    .month{
      margin:10px 0 8px 0;
      padding:8px;
      border:1px dashed rgba(124,58,237,.35);
      border-radius:12px;
      background:linear-gradient(180deg, #0e1730, #0c1427);
    }
    .month-title{
      font-weight:900;color:#e5e7eb;margin-bottom:6px;
      display:flex;align-items:center;gap:8px;
    }
    .month-title .mchip{
      font-size:11px;border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;
      background:#0a1020;color:#a0aec0
    }

    .day{
      position:relative;margin:8px 0;padding:8px 10px;border:1px solid var(--stroke);
      border-radius:10px;cursor:pointer;background:#0b1327;
      display:flex;align-items:center;justify-content:space-between
    }
    .day .title{font-weight:800;font-size:13px;color:#e2e8f0}
    .day .meta{font-size:11px;color:#9aa4b2}
    .day:hover{border-color:rgba(124,58,237,.45)}
    .day.active{outline:2px solid rgba(124,58,237,.35)}
    
    
   .day{ position: relative; border-radius: 12px; }
.day.active{
  outline: none;
  background: rgba(18,209,180,.08);   /* تظليل خفيف كلش */
  border: 1px solid rgba(18,209,180,.20);
}



    /* =================== Board =================== */
    .board{min-height:60vh;padding-bottom:calc(var(--dock-gap) + var(--footer-h) + 18px)}
 
 
   /* استبدل تعريف .board-head الحالي بهذا */
.board-head{
  position: sticky;
  top: calc(var(--hdr-h) + 10px);  /* تحت الشريط العلوي */
  z-index: 60;

  display: grid;
  grid-template-columns: auto 1fr auto; /* يسار | وسط (بحث) | يمين */
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;

  padding: 10px;
  background: linear-gradient(135deg, rgba(20,30,55,.85), rgba(17,25,45,.85));
  backdrop-filter: blur(10px);
  border: 1px solid rgba(124,58,237,.28);
  border-radius: 14px;
  box-shadow: 0 12px 28px rgba(0,0,0,.35);
}

/* تأكد حقل البحث ياخذ العرض كامل في الوسط */
.board-search .input{ width:100%; height:34px; }





.board-head .chip input[type="checkbox"]{
  transform: translateY(1px);
}


 
 
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;
      background:#0b1327;color:#cbd5e1;font-size:12px
    }

    .masonry{
  display: grid;
  grid-template-columns: 1fr; /* كولمن واحد */
  gap: 12px;                  /* المسافة بين الكروت */
}


    .card{
      background:linear-gradient(180deg, #0f1a33, #0d172d);
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:10px;display:flex;flex-direction:column;gap:10px
    }
    .card-head{display:flex;align-items:center;justify-content:space-between}
    .cust{font-weight:900;display:flex;align-items:center;gap:8px;color:#e7eef9}
    .bill-badge{
      font-size:11px;padding:2px 8px;border-radius:999px;
      background:linear-gradient(180deg,#0f5132,#0b3d25);
      color:#b7f7d6;border:1px solid rgba(34,197,94,.35)
    }
    .tag{
      font-size:11px;border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;
      color:#c6d0e1;background:#0a1020
    }


    /* =================== Rows =================== */
    .items{display:flex;flex-direction:column;gap:6px}
    .item{
       display:grid;
  grid-template-columns: auto auto 1fr 1fr 1fr 1fr auto auto; 
     gap:8px;align-items:center;border:1px solid var(--stroke);
  border-radius:12px;padding:10px;background:#0c1529;transition:background .2s ease, opacity .2s ease
    }
    .btn-mini{
      width:28px;height:28px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0d172d,#0b1426);
      border-radius:8px;display:grid;place-items:center;cursor:pointer;color:#e5e7eb
    }
    .btn-mini:hover{border-color:rgba(18,209,180,.5)}
    .btn-return:hover{box-shadow:0 0 0 3px rgba(245,158,11,.18)}
    .btn-pay:hover{box-shadow:0 0 0 3px rgba(18,209,180,.18)}
    .btn-del:hover{box-shadow:0 0 0 3px rgba(239,68,68,.18)}

    .iname{font-weight:800;font-size:13px;color:#e8eef8}
    .icat{font-size:11px;color:#9aa4b2}
    .iqty{font-weight:800;color:#e8eef8}

    
    
    .ichip{
  font-size:12px;color:#c7d2e1;
  padding:4px 10px;border-radius:999px;background:#0a1122;border:1px solid var(--stroke);
  max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  text-align:center;
}
.inote{
  font-size:12px;color:#c7d2e1;
  padding:2px 8px;  /* تقلل العرض بصريًا */
  border-radius:999px;background:#0a1122;border:1px solid var(--stroke);
  max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.iqty {font-weight:800;color:#e8eef8;text-align:center}

    
    
    .itime{font-size:11px;color:#97a3b8}
    .badge{
      font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--stroke);
      background:#0a1020;color:#a5b0c2;margin-inline-start:6px
    }
    .item.returned .iname,.item.returned .icat{ text-decoration: line-through; color:#e3b860 }
    .item.paid .iname,.item.paid .icat{ text-decoration: line-through; color:#4ade80 }
    .item.returned{background:#261a06}
    .item.paid{background:#0b2617}

    /* =================== Foot actions =================== */
    .card-foot{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .foot-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .i-btn{
      height:32px;min-width:32px;padding:0 10px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0c1426,#0e1830);
      border-radius:10px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#e2e8f0
    }
    .i-btn .fa-solid,.i-btn .fa-regular{font-size:13px}
    .i-btn.primary{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;border-color:transparent;box-shadow:0 10px 28px rgba(124,58,237,.35)
    }
    .i-btn.ghost{background:#0b1327;border:1px solid var(--stroke);color:#cbd5e1}
    .i-btn:hover{transform:translateY(-1px);transition:.18s ease}

    /* =================== Insights =================== */
    .insights{
      background:linear-gradient(180deg,#0f1a33,#0d172d);
      border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow);padding:12px;
      position:sticky;top:calc(var(--hdr-h) + 8px);height:calc(100vh - var(--hdr-h) - 24px);
      display:flex;flex-direction:column;gap:10px
    }
    .stat{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--stroke);border-radius:12px;padding:8px;background:#0c1529;color:#e5e7eb
    }

    /* =================== Dock =================== */
    .dock{
  position:fixed;
  inset-inline:50%;
  transform:translateX(50%); /* خليه مثل ما هو حتى يبقى بمحاذاة RTL */
  bottom:var(--dock-gap);
    bottom: calc(var(--footer-h) + 5px); /* 10px فوق الفوتر */
  z-index:80;

  /* كبّر العرض */
  max-width: 1380px;            /* كان 1020px */
  width: calc(100vw - 96px);    /* كان calc(100vw - 260px) */
}
@media (max-width:980px){
  .dock{ width: calc(100vw - 24px); } /* كانت -36px */
}

.dock-inner{
  display:grid;
  /*       cust   type   cat    item         price  qty   note              */
  grid-template-columns: 160px 120px 150px 3.4fr   110px 80px minmax(260px, 1fr);
  gap:8px;
  background:linear-gradient(135deg, rgba(20,30,55,.85), rgba(17,25,45,.85));
  backdrop-filter:blur(12px);
  border:1px solid rgba(124,58,237,.35);
  border-radius:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
  padding:8px;
  z-index:0; 
  position:relative;
}


/* 3) (اختياري بس مفيد) امنع أي عنصر يدفش الشبكة خارج الحاوية */
.dock-inner > *{
  min-width: 0;
}



/* تغليف الملاحظات مع زر الإضافة داخلها */
/* 1) صغّر الملاحظات وكبّر زر الإضافة داخل .note-wrap */
.note-wrap{
  display: grid;
  grid-template-columns: minmax(120px, .7fr) 130px; /* كان 160px */
  gap: 8px;
  min-width: 0;
}


.note-field{
  height: 36px;        /* نفس الارتفاع */
  min-width: 0;        /* يمنع التمدد الزايد */
}

.note-add{
  height: 36px;
  padding: 0 10px;   /* كان 16px */
  font-weight: 800;
  justify-content: center;
  white-space: nowrap;
  gap: 6px;          /* يقلّل المسافة بين الأيقونة والنص */
}




    
    .dock-inner::before{
  content:"";
  position:absolute;

  /* يمين في RTL + يغطي ارتفاع الدوك */
  inset-inline-start: 8px;
  inset-block: 8px;            /* أعلى وأسفل */

  width:5px;
  border-radius:999px;
  background:linear-gradient(180deg,var(--brand),var(--brand-2));
  box-shadow:0 0 18px rgba(124,58,237,.45);

  z-index:3;                   /* أهم سطر: فوق عناصر الـgrid */
  pointer-events:none;         /* لا يعطّل النقر على الحقول */
}
    
    
    .field, .btn{ font-family:"Cairo",system-ui }

.field{
  height:36px;
  padding:8px 10px;
  border:1px solid var(--stroke);
  border-radius:10px;
  background:#0b1327;
  color:#e8eef8;
  outline:none;
  width:100%;              /* <-- جديد: يخلي كل input/select يملأ العمود */
}




    .field:focus{
      border-color:rgba(14,165,233,.6);
      box-shadow:0 0 0 3px rgba(14,165,233,.16);
    }
  
  
  .btn{height:36px;padding:0 12px;border:none;border-radius:10px;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:8px}

  
  
    .primary{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;box-shadow:0 12px 28px rgba(124,58,237,.35)
    }
    .primary:hover{transform:translateY(-1px)}
    .ghost{background:#0b1327;border:1px solid var(--stroke);color:#e2e8f0}

    /* =================== Footer =================== */
    .footer{
      position:fixed;bottom:0;inset-inline:0;height:var(--footer-h);z-index:75;
      background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(17,24,39,.55));
      border-top:1px solid rgba(124,58,237,.25);
      display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:16px;
      backdrop-filter:blur(8px);
    }

    /* =================== Modal =================== */
    .modal-backdrop{
      position:fixed;inset:0;z-index:1000;
      background:rgba(2,6,23,.6);
      display:none;
      backdrop-filter:blur(2px);
    }
    .modal-backdrop.active{ display:block }
    .modal{
      position:fixed;inset:0;z-index:1001;
      display:none;align-items:center;justify-content:center;
    }
    .modal.active{ display:flex }
    
    
    .modal-card{
  width:min(480px, calc(100vw - 48px));
  background:linear-gradient(180deg,#0f1a33,#0d172d);
  border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);
  padding:16px;display:flex;flex-direction:column;gap:12px;color:#e7eef9;
  align-items:center;   /* توسيط أفقي */
  text-align:center;    /* توسيط النص */
}
.modal-actions{
  display:flex;
  gap:8px;
  justify-content:center;  /* توسيط الأزرار */
  width:100%;
}

    
    
    
    .modal-head{font-weight:900;font-size:16px}
    .modal-body{color:#cbd5e1;font-size:14px}
   
  
   
   
    .modal-btn{
      height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--stroke);
      background:#0b1327;cursor:pointer;color:#e5e7eb
    }
    .modal-btn.danger{
      background:linear-gradient(135deg,#ef4444,#f97316);
      color:#fff;border-color:transparent;box-shadow:0 10px 26px rgba(249,115,22,.3)
    }
    .modal-btn.ghost{background:#0b1327}
    
    
    
    /* بادج نوع الفاتورة جنب اسم الزبون */
.badge-type{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:#0a1020;
  margin-inline-start:6px;
}
.badge-type.sell{
  color:#a7f3d0;                 /* أخضر فاتح */
  background:linear-gradient(180deg,#064e3b,#052e2a);
  border-color:rgba(16,185,129,.35);
}
.badge-type.return{
  color:#fecaca;                 /* أحمر فاتح */
  background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
  border-color:rgba(239,68,68,.35);
}

/* خلي المواد الراجعة أوضح بالأحمر */
.item.returned{
  background:#2a0c12;            /* خلفية أحمر داكن */
  border-color:#7f1d1d;
}
.item.returned .iname,
.item.returned .icat{
  color:#fca5a5;                  /* نص أحمر وردي */
  text-decoration:line-through;   /* تبقيها مشطوب */
}

    
 
 
 /* بادج "جديد" لاسم غير موجود بالمصفوفة */
.badge-new{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(127,29,29,.55);
  background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
  color:#fecaca; /* وردي فاتح للنص */
  margin-inline-start:8px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}

 
 
    
    
    
   /* نفس الإلغاء للسعر والعدد سوا */
#qty, #price{
  -moz-appearance: textfield;   /* Firefox */
}
#qty::-webkit-outer-spin-button,
#qty::-webkit-inner-spin-button,
#price::-webkit-outer-spin-button,
#price::-webkit-inner-spin-button{
  -webkit-appearance: none;     /* Chrome/Edge/Safari */
  margin: 0;
}




/* ===== Toasts (أعلى الصفحة + توسيط الرسالة) ===== */


.toasts{
  position:fixed;
  inset-inline:50%;
  transform:translateX(50%);
  top:18px;
  z-index:30000;                /* أعلى من الـ splash/الطبقات */
  display:flex;flex-direction:column;gap:12px;
  pointer-events:none;
}

/* خط فاصل أنيق بين كل توست والتالي */
.toasts .toast + .toast{
  position: relative;
}
.toasts .toast + .toast::before{
  content:"";
  position:absolute;
  inset-inline: 12px;
  top:-6px;
  height:1px;
  background: linear-gradient(90deg,
    rgba(255,255,255,.08),
    rgba(124,58,237,.35),
    rgba(255,255,255,.08)
  );
  pointer-events:none;
}



.toast{
  min-width:280px;max-width:520px;padding:10px 12px;border-radius:12px;
  border:1px solid var(--stroke);
  background:linear-gradient(135deg, rgba(20,30,55,.95), rgba(17,25,45,.95));
  box-shadow:0 10px 28px rgba(0,0,0,.45);color:#e7eef9;
  display:flex;align-items:center;gap:10px;pointer-events:auto;
  animation:toast-in-top .25s ease-out both;

  /* المفتاح: خلّي توزيع العناصر يسمح بتوسيط النص */
  justify-content:space-between;
}
.toast__icon{
  width:28px;height:28px;border-radius:8px;
  display:grid;place-items:center;background:#0b1327;border:1px solid var(--stroke);
  flex:0 0 auto;                  /* حجم ثابت */
}

.toast__msg{
  font-size:14px;
  font-weight:800;
  letter-spacing:.2px;
  flex:1 1 auto;
  text-align:center;
  white-space: nowrap;          /* سطر واحد */
  overflow: hidden;             /* قصّ الزائد */
  text-overflow: ellipsis;      /* … */
}



.toast__close{
  margin-inline-start:8px;cursor:pointer;opacity:.9;
  display:grid;place-items:center;width:28px;height:28px;border-radius:8px;
  border:1px solid var(--stroke);background:#0b1327;
  flex:0 0 auto;                  /* حجم ثابت */
}

.toast.success .toast__icon{background:linear-gradient(180deg,#064e3b,#052e2a);border-color:rgba(16,185,129,.35)}
.toast.warn    .toast__icon{background:linear-gradient(180deg,#5b3b06,#3a2704);border-color:rgba(245,158,11,.4)}
.toast.error   .toast__icon{background:linear-gradient(180deg,#7f1d1d,#4c0b0b);border-color:rgba(239,68,68,.45)}
.toast.info    .toast__icon{background:linear-gradient(180deg,#0b3b5b,#07293f);border-color:rgba(14,165,233,.45)}

@keyframes toast-in-top{from{transform:translateX(50%) translateY(-10px);opacity:0}to{transform:translateX(50%) translateY(0);opacity:1}}
@keyframes toast-out-top{from{transform:translateX(50%) translateY(0);opacity:1}to{transform:translateX(50%) translateY(-8px);opacity:0}}

/* أخفِ زر الإغلاق نهائياً */
.toast__close{ display:none !important; }


/* ===== تعديلات أسطر البطاقة (داخل الكارت) =====
   [راجع] [تسديد] | اسم المادة | الصنف | العدد | الملاحظات | الوقت | حذف
   ملاحظة: استعملنا !important حتى نضمن التطبيق فوق القواعد القديمة
*/
.card .item{
  /* [راجع] [تسديد] | الاسم | الصنف | السعر | العدد | الملاحظات | الوقت | حذف */
  grid-template-columns: auto auto .9fr 2.2fr .8fr .6fr 1fr auto auto !important;
  column-gap: 6px !important;
}

/* مظهر أنيق للسعر */
.iprice{
  font-weight:900;
  text-align:center;
  padding:2px 8px;
  border-radius:999px;
  background:#0a1020;
  border:1px solid var(--stroke);
  font-size:12px;
  color:#c7d2e1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


/* وسّط ووسّع اسم المادة */
.card .item .iname{
  text-align: center !important;
  min-width: 0 !important;     /* يمنع التمدد */
}

/* صغّر الصنف والملاحظات بصرياً وامنعها تقصّر الصف */
.card .item .ichip,
.card .item .inote{
  padding-inline: 8px !important;
  min-width: 0 !important;
  max-width: 100% !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* العدد بمساحة أضيق ومحاذاة وسط */
.card .item .iqty{
  text-align: center !important;
}

/* (اختياري) صغّر خط الوقت شوي */
.card .item .itime{
  font-size: 10.5px !important;
}



/* لمعة مؤقتة للبطاقة الجديدة */
/* لمعة مؤقتة للبطاقة الجديدة */
.flash-card{
  outline: 2px solid rgba(124,58,237,.55);
  box-shadow: 0 0 0 3px rgba(124,58,237,.22), var(--shadow);
  transition: outline .2s ease, box-shadow .2s ease;
}

/* خلّي المتصفّح يحسب مسافة فوق الكارت مساوية لارتفاع الهيدر */
.card{
  scroll-margin-top: calc(var(--hdr-h) + 10px);
  
}



/* ===== Zebra قوية وواضحة بين البطاقات ===== */

/* ضمّن إن البطاقة نسبية للزخرفة */
.masonry > .card{ position:relative; }

/* الزوجية: أفتح شوي */
.masonry > .card:nth-child(even){
  background: linear-gradient(180deg, #122243, #0e1b36) !important;
  border-color: #2c3f66 !important;
}

/* الفردية: أغمق شوي */
.masonry > .card:nth-child(odd){
  background: linear-gradient(180deg, #0b162e, #091126) !important;
  border-color: #223556 !important;
}


.masonry > .card:nth-child(even)::before{
  background: linear-gradient(180deg, var(--brand-3), var(--brand-2));
  opacity:.85;
}

/* لمسة ظل مختلفة خفيفة */
.masonry > .card:nth-child(even){
  box-shadow: 0 16px 36px rgba(0,0,0,.42);
}
.masonry > .card:nth-child(odd){
  box-shadow: 0 14px 32px rgba(0,0,0,.38);
}



/* ========= إبراز اسم الزبون داخل البطاقة ========= */

/* أيقونة صغيرة قبل الاسم (من Font Awesome) */
.card .card-head .cust{
  position: relative;
  gap: 10px;
}
.card .card-head .cust::before{
  content: "\f007"; /* user icon */
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  display: grid; place-items: center;
  width: 26px; height: 26px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: #fff;
  box-shadow: 0 6px 16px rgba(124,58,237,.28);
  margin-inline-start: 0;
  margin-inline-end: 6px;
}

/* اسم الزبون نفسه (أول span داخل .cust) بتدرّج أنيق */
.card .card-head .cust > span:first-child{
  position: relative;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: .2px;
  line-height: 1.1;
  background: linear-gradient(90deg, #eef2ff, #cbd5ff);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;               /* يُظهر التدرّج كنص */
  text-shadow: 0 1px 0 rgba(255,255,255,.04);
}



/* مسافات أنظف بين الاسم والبادجات اللاحقة */
.card .card-head .cust .badge-type,
.card .card-head .cust .bill-badge{
  margin-inline-start: 8px;
}

/* تباين بسيط لبادج النوع قرب الاسم */
.card .card-head .cust .badge-type{
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}




/* خلي حاوية البحث صف واحد */
.board-search{
  display:flex;
  align-items:center;
  gap:8px;
}

/* الحقل يتمدّد، بدون ما يطيح للتالي */
.board-search .input{
  flex:1 1 auto;
  min-width:160px;
  height:34px;
}

/* (اختياري) استجابة للشاشات الصغيرة: خليه يلفّ بنعومة */
@media (max-width:700px){
  .board-search{
    flex-wrap:wrap;
  }
  .board-search .input{
    flex:1 1 100%;
  }
}




/* === توحيد المسافات داخل رأس البطاقة (الاسم + البادجات) === */
:root{ --cust-inline-gap: 6px; }  /* غيّرها لـ 4px أو 8px إذا تريد تضبط أكثر */

.card .card-head .cust{
  gap: var(--cust-inline-gap) !important;               /* مسافة موحّدة بين العناصر */
}

/* شيل أي هوامش إضافية قديمة حتى ما تتضاعف المسافات */
.card .card-head .cust .badge-new,
.card .card-head .cust .badge-type,
.card .card-head .cust .bill-badge{
  margin-inline-start: 0 !important;
}

/* خلي أيقونة المستخدم بنفس المسافة */
.card .card-head .cust::before{
  margin-inline-end: var(--cust-inline-gap) !important;
}







/* ===== Page breaks (html2pdf) ===== */
@media print{
  .card{ break-inside: avoid; page-break-inside: avoid; }
}
.html2pdf__page-break{ height: 0; break-after: page; page-break-after: always; }

/* ===== Loading Overlay (للـ reloader فقط) ===== */
.loading{
  position: fixed;
  inset: 0;
  z-index: 20000;
  background: rgba(2,6,23,.72);
  backdrop-filter: blur(2px);
  display: none;
  align-items: center;
  justify-content: center;
}
.loading.active{ display:flex; }

.loading-box{
  min-width: 220px;
  padding: 16px 18px;
  border-radius: 14px;
  border: 1px solid var(--stroke);
  background: linear-gradient(135deg, rgba(20,30,55,.95), rgba(17,25,45,.95));
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
  color: #e7eef9;
  display:flex; align-items:center; gap:10px;
  font-weight: 800;
}


.pct{
  margin-inline-start:8px;
  padding:2px 8px;
  border:1px solid var(--stroke);
  border-radius:999px;
  background:#0b1327;
  font-size:12px;
  font-weight:900;
  letter-spacing:.2px;
  min-width:48px;
  text-align:center;
}




.spinner{
  width: 22px; height: 22px; border-radius: 50%;
  border: 3px solid rgba(255,255,255,.18);
  border-top-color: #7c3aed;
  animation: spin 0.8s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }


/* سهم منسدل لحقل الأصناف */
.cat-wrap{
  position:relative;
}
.cat-wrap::after{
  content:"";
  position:absolute;
  inset-inline-end: 12px;
  top:50%;
  width: 8px; height: 8px;
  border-inline-start: 2px solid #9aa4b2;
  border-bottom:       2px solid #9aa4b2;
  transform: translateY(-50%) rotate(-45deg);
  pointer-events:none;
  opacity:.9;
  transition: transform .18s ease, opacity .18s ease;
}
/* لما القائمة تنفتح يدور السهم */
.cat-wrap.open::after{
  transform: translateY(-50%) rotate(135deg);
  opacity:1;
}


/* حاويات نطبّق عليها سكرول أنيق */
.nice-scroll{
  scrollbar-gutter: stable;
  overscroll-behavior: contain;
}

/* افتراضي: إخفاء في فايرفوكس */
.nice-scroll{
  scrollbar-width: none;          /* Firefox */
}
.nice-scroll:hover{
  scrollbar-width: thin;          /* يظهر عند التحويم */
}

/* WebKit (كروم/إيدج/سفاري) */
.nice-scroll::-webkit-scrollbar{
  width: 0; height: 0;            /* مخفي */
}
.nice-scroll:hover::-webkit-scrollbar{
  width: 10px; height:10px;       /* يظهر عند التحويم */
}
.nice-scroll::-webkit-scrollbar-track{
  background: linear-gradient(180deg, #0a1020, #0b1327);
  border-radius: 999px;
  border: 1px solid var(--stroke);
}
.nice-scroll::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, var(--brand-3), var(--brand-2));
  border-radius: 999px;
  border: 2px solid transparent;
  background-clip: padding-box;
}
.nice-scroll::-webkit-scrollbar-thumb:hover{
  filter: brightness(1.1);
}

/* توسيط اسم المادة والملاحظات داخل الكارد */
.card .item .iname{ text-align:center !important; }
.card .item .inote{ text-align:center !important; }



/* ===== لوحة الملاحظات (بدون سكرول أفقي + أناقة أعلى) ===== */
.notes-compact{
  position: relative;
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0b1327;
  padding:10px 10px 8px;
  margin-top:8px;
  overflow: hidden; /* يضمن ما يطلع شي برّه */
  display: grid;
  /* نستخدم صف واحد قابل للطي/الفتح (يفيدنا بالتوسيع لاحقًا) */
  grid-template-rows: 1fr auto;           /* القائمة ثم شريط الإدخال */
  align-content: center;                   /* يوسّط المحتوى عموديًا داخل الحاوية */
  padding-block: 12px 10px;   
}




/* خط زينة رأسي خفيف (Timeline) داخل الصندوق */
.notes-compact::before{
  content:"";
  position:absolute;
  inset-inline-start: 6px;    /* RTL */
  top:8px; bottom:8px;
  width:3px;
  border-radius:999px;
  background:linear-gradient(180deg,var(--brand-3),var(--brand-2));
  opacity:.65;
  pointer-events:none;
}

/* إلغاء الرأس/العدّاد */
.notes-compact__head,
.notes-compact__title,
.notes-compact__count{ display:none !important; }

/* قائمة الملاحظات — عمودي فقط، لا أفقي */
.notes-compact__list{
  display:flex; flex-direction:column; gap:8px;
  max-height:168px;
  overflow-y:auto;        /* عمودي فقط */
  overflow-x:hidden;      /* لا أفقي نهائيًا */
  padding-inline-start: 8px; /* يبتعد عن خط الزينة */
  padding-inline-end: 2px;   /* حتى ما يغطي سكرول عمودي على المحتوى*/
  
}
.notes-compact__empty{ display:none !important; }

/* صف الملاحظة: يضمن ما يصير تمدد بعرض زايد */
.note-row{
  position:relative;
  padding-inline-end: 38px;     /* مساحة لزر الحذف الخارجي */
  min-width: 0;                 /* مهم لمنع تمدد grid */
}

/* شكل الحبة — أنعم */
.note-pill{
  display:grid;
  grid-template-columns: auto 1fr auto; /* # | النص | الوقت */
  align-items:center;
  height:34px;
  padding:0 12px;
  background:linear-gradient(180deg,#0a1327,#0b1327);
  border:1px solid var(--stroke);
  border-radius:10px;
  gap:10px;
  min-width:0;                  /* يمنع الهروب عرضيًا */
  box-shadow: 0 6px 14px rgba(0,0,0,.18);
}
.note-pill:hover{
  border-color: rgba(124,58,237,.45);
  box-shadow: 0 8px 18px rgba(124,58,237,.18);
  transform: translateY(-1px);
  transition: .18s ease;
}

/* زيبرا خفيفة */
.notes-compact__list .note-row:nth-child(odd) .note-pill{
  background:linear-gradient(180deg,#0b1428,#0a1326);
  border-color:#223556;
}

/* رقم التسلسل — تدرّج ناعم */
.note-pill__idx{
  font-weight:900; font-size:12px; letter-spacing:.2px;
  color:#eef2ff;
  min-width:34px; height:22px;
  display:grid; place-items:center;
  border-radius:999px;
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  box-shadow:0 4px 12px rgba(124,58,237,.25);
}

/* نص الملاحظة — سطر واحد بدون أي سكرول أفقي */
.note-pill__text{
  font-size:13px; color:#e7eef9; min-width:0;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* الوقت + أيقونة صغيرة */
.note-pill__time{
  display:inline-flex; align-items:center; gap:6px;
  font-size:11px; color:#9aa4b2;
  padding:2px 8px; border-radius:999px;
  background:#0b1327; border:1px solid var(--stroke);
}
.note-pill__time i{ font-size:10px; opacity:.95; }

/* زر حذف خارج الحبة على الحافة */
.note-del-out{
  position:absolute;
  inset-inline-end: -2px; top:50%;
  transform: translateY(-50%);
  width:28px; height:28px;
  border-radius:8px;
  border:1px solid rgba(239,68,68,.45);
  background:linear-gradient(135deg,#7f1d1d,#4c0b0b);
  color:#fecaca; display:grid; place-items:center; cursor:pointer;
}
.note-del-out:hover{ filter:brightness(1.06); transform: translateY(-50%) scale(1.04); }

/* شريط الإدخال */
.notes-compact__bar{
  display:grid; grid-template-columns: 1fr auto; gap:6px; margin-top:8px;
}
.note-input-sm{
  height:34px; padding:6px 10px; font-size:13px;
  background:#0a1327; border:1px solid var(--stroke); border-radius:10px; color:#e7eef9;
}
.note-add-mini{
  height:34px; min-width:40px; padding:0 12px; font-weight:900;
  border-radius:10px; border:1px solid transparent;
  background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff;
  display:inline-flex; align-items:center; gap:6px;
}
.note-add-mini i{ font-size:12px; }



/* ===== Notes block (للطباعة) ===== */
.notes{ margin-top:8px; border:1px solid var(--stroke); border-radius:10px; }
.notes__head{
  display:flex; align-items:center; justify-content:space-between;
  background:#f5f5f5; padding:6px 10px; border-bottom:1px solid var(--stroke);
  font-weight:900;
}
.notes__list{ padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
.note{
  display:flex; align-items:center; gap:8px;
  border:1px solid var(--stroke); border-radius:10px; padding:6px 10px;
}
.note__idx{
  font-weight:900; font-size:12px; min-width:28px; text-align:center;
  border:1px solid var(--stroke); border-radius:999px; padding:2px 6px; background:#fff;
}
.note__text{ flex:1; }
.note__time{ font-size:11px; color:#6b7280; white-space:nowrap; }



/* قائمة اقتراحات الزبائن */
#custSuggestions{ padding:6px 0; }

/* العنصر */
#custSuggestions .sugg-item{
  position: relative;
  padding: 12px 12px;          /* مساحة علوية تكفي فوق الخط */
  line-height: 1.5;            /* ارتفاع سطر مريح */
  white-space: normal;          /* يسمح باللف */
  word-break: break-word;       /* يكسر الكلمات الطويلة */
  display: block;               /* يضمن امتداد العرض بالكامل */
  cursor: pointer;
}

/* الفاصل بين العناصر — صار pseudo-element حتى ما يلمس النص */
#custSuggestions .sugg-item + .sugg-item::before{
  content: "";
  position: absolute;
  inset-inline: 12px;           /* يبعد عن الحواف */
  top: 0;                       /* أعلى العنصر */
  height: 1px;
  background: linear-gradient(90deg,
    rgba(255,255,255,.06),
    rgba(255,255,255,.12),
    rgba(255,255,255,.06)
  );
  pointer-events: none;
}

/* لون التحويم */
#custSuggestions .sugg-item:hover{
  background:#0e1b36;
}




/* قائمة اقتراحات المواد */
#itemSuggestions { padding:6px 0; }

/* كل عنصر مادة نفس شكل الزبون */
#itemSuggestions .sugg-item{
  position: relative;
  padding: 12px 12px;
  line-height: 1.5;
  white-space: normal;
  word-break: break-word;
  display: block;
  cursor: pointer;
  border-radius:10px;
}

/* الفاصل بين العناصر داخل المواد */
#itemSuggestions .sugg-item + .sugg-item::before{
  content: "";
  position: absolute;
  inset-inline: 12px;
  top: 0;
  height: 1px;
  background: linear-gradient(90deg,
    rgba(255,255,255,.06),
    rgba(255,255,255,.12),
    rgba(255,255,255,.06)
  );
  pointer-events: none;
}





/* ===== توسيع لوحة الكروت بتصغير الأعمدة الجانبية (العرضين متطابقين – أَعْرَض) ===== */
.layout{
  /* كان: 280px 1fr 320px */
  grid-template-columns: 260px 1fr 260px !important; /* يسار = يمين (أعرض) */
}

/* على الشاشات المتوسطة */
@media (max-width:1280px){
  .layout{
    /* كان: 240px 1fr 280px */
    grid-template-columns: 240px 1fr 240px !important; /* يسار = يمين (أعرض) */
  }
}

/* توازن الحشوات */
.rail, .insights{
  padding: 12px !important;
}
.rail .search{ margin: 6px 0 !important; }
.stat{ padding: 8px !important; }

/* عناصر الأيام – رجّعناها شوي أوسع */
.day{ padding: 8px 12px !important; }
.day .title{ font-size: 13px !important; }
.day .meta{ font-size: 11.5px !important; }

/* الدوك: بقاء مع توسيع بسيط إذا تحتاج عرض إضافي */
.dock{
  max-width: 1480px !important;
  width: calc(100vw - 80px) !important;
}

.loading-box{
  min-width: 220px;
  padding: 16px 18px;
  border-radius: 14px;
  border: 1px solid var(--stroke);
  background: linear-gradient(135deg, rgba(20,30,55,.95), rgba(17,25,45,.95));
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
  color: #e7eef9;
  display:flex; align-items:center; gap:10px;
  font-weight: 800;
}



/* ===== Login Gate (animated) ===== */
.gate{
  position:fixed; inset:0; z-index:99999; display:grid; place-items:center;
  background:
    radial-gradient(1000px 600px at 80% -10%, rgba(124,58,237,.16), transparent 60%),
    radial-gradient(900px 500px at -10% 10%, rgba(18,209,180,.12), transparent 60%),
    linear-gradient(180deg, #0b1220, #0f172a);
  animation: gate-bg 12s ease-in-out infinite alternate;
}
@keyframes gate-bg{
  0%{ background-position: 0 0, 0 0, 0 0; }
  100%{ background-position: -40px -20px, 30px 10px, 0 0; }
}

.gate-card{
  width:min(420px, 92vw);
  border:1px solid var(--stroke);
  border-radius:16px;
  background:linear-gradient(180deg,#0f1a33,#0d172d);
  box-shadow:0 22px 56px rgba(0,0,0,.45);
  padding:16px;
  display:flex; flex-direction:column; gap:14px;
  transform: translateY(6px);
  animation: gate-float 3s ease-in-out infinite;
}
@keyframes gate-float{
  0%,100%{ transform: translateY(6px); }
  50%    { transform: translateY(0); }
}

.gate-head{ display:flex; flex-direction:column; gap:6px; text-align:center; }
.gate-logo{ display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900; }
.g-dot{
  width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
  background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff;
  box-shadow:0 8px 24px rgba(124,58,237,.35); font-size:13px;
}
.g-name{ color:#fff; letter-spacing:.2px }
.g-sub{ color:#9aa4b2; font-size:12.5px }

.gate-body{ display:flex; flex-direction:column; gap:10px }
.gate-input{
  height:40px;
  background:#0b1327;
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#e7eef9;
  outline:none;
  transition:border-color .18s ease, box-shadow .18s ease, transform .12s ease;
}
.gate-input:focus{
  border-color:rgba(124,58,237,.55);
  box-shadow:0 0 0 4px rgba(124,58,237,.16);
  transform: translateY(-1px);
}

.gate-btn{
  height:40px;
  font-weight:900;
  position:relative;
  overflow:hidden;
}
.gate-btn .btn-spin{
  width:18px; height:18px; border-radius:50%;
  border:3px solid rgba(255,255,255,.25);
  border-top-color:#fff; display:none; margin-inline-start:8px;
  animation: spin 0.85s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.gate-btn.loading .btn-txt{ opacity:.0 }
.gate-btn.loading .btn-spin{ display:inline-block }

.gate-msg{
  min-height:18px;
  color:#fca5a5;
  font-size:12px;
  text-align:center;
}

/* دخول/خروج أنيميشين */
.gate.fade-in{ animation: gate-in .25s ease-out both; }
.gate.fade-out{ animation: gate-out .22s ease-in both; }
@keyframes gate-in{ from{ opacity:0 } to{ opacity:1 } }
@keyframes gate-out{ from{ opacity:1 } to{ opacity:0 } }




/* توسيع حاوية التوست حتى لا يختفي النص الطويل */
.toasts .toast{
  max-width: 840px !important;   /* كان 520px */
  min-width: 320px;              /* كان 280px */
}

/* لو احتجنا أعرض لرسائل معيّنة */
.toasts .toast.wide{
  max-width: 1080px !important;  /* توست عريض جدًا */
}

/* على الشاشات الصغيرة خلّيه ياخذ تقريبًا كل العرض */
@media (max-width: 980px){
  .toasts .toast{
    max-width: calc(100vw - 32px) !important;
  }
}


/* ابعاد زر الدخول قليلاً عن حقل كلمة السر */
#lgBtn{
  margin-top: 6px !important;   /* جرّب 6–10px حسب ذوقك */
}

/* على الشاشات الصغيرة نزّل الزر أكثر شوية */
@media (max-width: 480px){
  #lgBtn{
    margin-top: 10px !important;
  }
}




/* ===== Reload Overlay (Pro) ===== */
.reloader{
  position:fixed; inset:0; z-index:40000;
  display:none; place-items:center;
  background: radial-gradient(1200px 700px at 100% -10%, rgba(124,58,237,.16), transparent 55%),
              radial-gradient(1000px 600px at -10% 10%, rgba(18,209,180,.12), transparent 55%),
              rgba(2,6,23,.68);
  backdrop-filter: blur(6px);
}
.reloader.active{ display:grid; animation:reloader-in .22s ease-out both; }
@keyframes reloader-in{ from{ opacity:0; transform:scale(.98) } to{ opacity:1; transform:scale(1) } }

/* زخارف خفيفة */
.reloader-bg{ position:absolute; inset:0; overflow:hidden; pointer-events:none; }
.orb{
  position:absolute; filter: blur(24px); opacity:.22; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, var(--brand, #12d1b4), transparent 60%);
  width:280px; height:280px; animation: orb-float 9s ease-in-out infinite;
}
.orb-a{ top:8%;  right:8%;  background: radial-gradient(circle, #7c3aed, transparent 60%); }
.orb-b{ bottom:10%; left:6%; background: radial-gradient(circle, #0ea5e9, transparent 60%); animation-delay: -2s;}
.orb-c{ top:40%; left:50%; transform:translateX(-50%); width:220px; height:220px; animation-delay:-4s;}
@keyframes orb-float{ 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(-14px)} }

/* بطاقة */
.reload-card{
  position:relative;
  width:min(520px, 92vw);
  padding:18px 18px 16px;
  border:1px solid rgba(124,58,237,.35);
  border-radius:16px;
  background:linear-gradient(135deg, rgba(20,30,55,.92), rgba(17,25,45,.92));
  box-shadow:0 24px 70px rgba(0,0,0,.55);
  display:flex; flex-direction:column; gap:14px; color:#e7eef9;
}

/* رأس */
.reload-head{ display:flex; align-items:center; gap:10px; }
.brand-dot{
  flex: 0 0 auto;
  width:30px; height:30px; border-radius:9px; display:grid; place-items:center;
  background:linear-gradient(135deg, var(--brand,#12d1b4), var(--brand-2,#7c3aed));
  color:#fff; font-weight:900; box-shadow:0 10px 26px rgba(124,58,237,.35);
}
.reload-title{ font-weight:900; font-size:16px; letter-spacing:.2px; }
.reload-sub{ color:#bfc7d6; font-size:12.5px; margin-inline-start:auto; }

/* حلقة */
.ring-wrap{
  position:relative; height:92px;
  display:grid; place-items:center; margin-top:4px;
}
.ring{
  position:absolute; width:88px; height:88px; border-radius:50%;
  border:3px solid rgba(255,255,255,.10);
  border-top-color:#7c3aed;
  animation: spin 1s linear infinite;
}
.ring-2{
  width:72px; height:72px; border-color:rgba(255,255,255,.08);
  border-top-color:#12d1b4; animation-duration: 1.4s; animation-direction: reverse;
}
.ring-pct{ position:relative; font-weight:900; letter-spacing:.3px; }

/* شريط التقدّم */
.progress{
  height:10px; border-radius:999px; overflow:hidden;
  background: linear-gradient(180deg,#0b1327,#0e1830);
  border:1px solid rgba(255,255,255,.08);
}
.progress .bar{
  height:100%; width:0%;
  background:linear-gradient(90deg, #12d1b4, #7c3aed, #0ea5e9);
  background-size:200% 100%;
  animation: slide 2.4s linear infinite;
  border-right:1px solid rgba(255,255,255,.25);
}
@keyframes slide{ 0%{background-position:0 0} 100%{background-position:200% 0} }
@keyframes spin{ to{ transform: rotate(360deg); } }

/* أسفل */
.reload-foot{ display:flex; gap:6px; justify-content:flex-end; }
.reload-foot .chip{
  font-size:11px; padding:2px 8px; border-radius:999px;
  border:1px solid rgba(255,255,255,.08);
  background:#0b1327; color:#cbd5e1;
}

/* تباين نص النسبة داخل الحلقة */
.ring-pct{ font-size:14px; text-shadow:0 1px 0 rgba(0,0,0,.35) }




/* ===== Auth Splash (Highly Polished) ===== */
.auth-splash{
  position: fixed; inset: 0; z-index: 30000;
  display: none; place-items: center;
  backdrop-filter: blur(6px);
  background:
    radial-gradient(1000px 600px at 80% -10%, rgba(124,58,237,.12), transparent 60%),
    radial-gradient(900px 500px at -10% 10%, rgba(18,209,180,.10), transparent 60%),
    linear-gradient(180deg, rgba(11,18,32,.92), rgba(15,23,42,.92));
}

.auth-shell{
  width: min(520px, 92vw);
  border-radius: 16px;
  padding: 18px 18px 16px;
  border: 1px solid rgba(124,58,237,.25);
  background:
    linear-gradient(180deg, rgba(17,24,39,.75), rgba(15,23,42,.85));
  box-shadow: 0 24px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.03);
  display:flex; flex-direction:column; gap:14px;
  animation: auth-pop .22s ease-out both;
}

@keyframes auth-pop{ from{ transform: translateY(8px); opacity:0 } to{ transform: translateY(0); opacity:1 } }

.auth-brand{ display:flex; align-items:center; gap:12px }
.auth-mark{
  width:36px; height:36px; border-radius:10px;
  display:grid; place-items:center; font-weight:900;
  color:#fff;
  background:linear-gradient(135deg,var(--brand,#12d1b4),var(--brand-2,#7c3aed));
  box-shadow:0 10px 26px rgba(124,58,237,.35);
}
.auth-texts .auth-title{
  font-weight:900; letter-spacing:.5px; color:#fff; line-height:1;
}
.auth-texts .auth-sub{
  font-size:12px; color:#cbd5e1; opacity:.9; margin-top:2px;
}

.auth-status{ display:flex; flex-direction:column; gap:10px }
.auth-tip{
  font-weight:800; letter-spacing:.2px; color:#e7eef9;
  text-align:center;
}
.auth-progress{
  height:12px; border-radius:999px; overflow:hidden;
  border:1px solid var(--stroke,#1f2a44);
  background:linear-gradient(180deg,#0b1327,#0d172d);
  position:relative;
}
.auth-bar{
  height:100%; width:0%;
  background:linear-gradient(90deg, var(--brand-3,#0ea5e9), var(--brand-2,#7c3aed));
  border-right:1px solid rgba(255,255,255,.28);
  box-shadow: inset 0 0 10px rgba(255,255,255,.14);
  position:relative;
}
.auth-bar::after{
  content:"";
  position:absolute; inset:0;
  background-size: 32px 12px;
  background-image: linear-gradient( -45deg, rgba(255,255,255,.14) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.14) 50%, rgba(255,255,255,.14) 75%, transparent 75%, transparent);
  animation: auth-stripes 1s linear infinite;
  mix-blend-mode: screen;
  opacity:.55;
}
@keyframes auth-stripes{ to{ background-position: 32px 0 } }

.auth-meta{
  display:flex; align-items:center; justify-content:center; gap:8px;
  font-size:12.5px; color:#9aa4b2;
}
.auth-pct{ font-weight:900; color:#e7eef9 }
.auth-sep{ opacity:.6 }
.auth-subtle{ color:#b5bfd0 }

.auth-bg{
  position:absolute; filter: blur(24px); opacity:.22; pointer-events:none;
  border-radius: 50%;
}
.auth-bg--1{ width:340px; height:340px; right:8%; top:8%; background: radial-gradient(circle at 30% 30%, #7c3aed, transparent 70%); }
.auth-bg--2{ width:420px; height:420px; left:6%; bottom:6%; background: radial-gradient(circle at 70% 70%, #0ea5e9, transparent 70%); }
.auth-bg--3{ width:260px; height:260px; left:40%; top:12%; background: radial-gradient(circle at 50% 50%, #12d1b4, transparent 70%); }

@media (prefers-reduced-motion: reduce){
  .auth-shell{ animation:none }
  .auth-bar::after{ animation: none }
}



/* صندوق المال المضغوط */
.money--compact{
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0c1529;
  padding:8px;                 /* صغير */
  display:flex;
  flex-direction:column;
  gap:6px;                     /* مسافة صغيرة بين السطور */
}

/* كل سطر عبارة عن شريحتين يمين/يسار */
.money--compact .mrow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:6px 8px;             /* خفيف */
  border:1px solid var(--stroke);
  border-radius:10px;
  background:#0b1327;
}

.money--compact .mlabel{
  font-size:12.5px;
  color:#cbd5e1;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.money--compact .mlabel i{ font-size:12px; opacity:.95; }

.money--compact .mval{
  font-weight:900;
  font-size:13px;
  letter-spacing:.2px;
  color:#e7eef9;
}

/* دلالات ألوان خفيفة ومقروءة */
.money--compact .mval--paid   { color:#86efac; }   /* أخضر فاتح */
.money--compact .mval--unpaid { color:#fbbf24; }   /* أصفر */
.money--compact .mval--ret    { color:#fca5a5; }   /* أحمر وردي */


/* مسافة أنيقة بين صندوقي الإحصائيات داخل العمود الأيمن (.insights) */
#insightsBody{
  display: flex;
  flex-direction: column;
  gap: 8px;        /* غيّرها 8–16px حسب ذوقك */
}

/* (اختياري) شدّ حواف الصناديق شوي حتى يبين الفراغ أحلى */
#quickStats, #moneyStats{
  border-radius: 12px;
}


/* باجات sums داخل ذيل البطاقة — أنيق ومو بارز */
.card-foot .sum-badge{
  font-size: 12.5px;
  padding: 4px 10px;
  border-radius: 10px;
  background: #0b1327;
  border: 1px solid var(--stroke);
  color: #dbe2ea;
  letter-spacing: .1px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
}

/* لمسات ألوان خفيفة لكل نوع */
.card-foot .sum--items{
  border-color: rgba(14,165,233,.28);
  background: linear-gradient(180deg,#0b1426,#0b1327);
}
.card-foot .sum--total{
  border-color: rgba(148,163,184,.22);
  background: linear-gradient(180deg,#0b1424,#0b1327);
}
.card-foot .sum--unpaid{
  border-color: rgba(245,158,11,.28);
  background: linear-gradient(180deg,#0b151f,#0b1327);
}

/* اخفاء كل شي يخص الملاحظات داخل البطاقة فقط */
.card .notes-compact,
.card .notes-compact__list,
.card .notes-compact__bar,
.card .note-add-mini {
  display: none !important;
}

/* ضمان المودال يبقى ظاهر (لا يتأثر) */
#notesModal .notes-compact__list { display: block !important; }
#notesModal .notes-compact__bar { display: grid !important; } /* إذا تستخدم Grid بالمودال */



/* إلغاء أي تأثير hover على كبسولة الملاحظة */
.note-pill{
  transition: none !important;
}
.note-pill:hover{
  border-color: var(--stroke) !important;
  box-shadow: 0 6px 14px rgba(0,0,0,.18) !important; /* نفس الأساس */
  transform: none !important;
}


/* عند فتح أي مودال نمنع تمرير الصفحة */
body.modal-open{
  overflow: hidden !important;
  overscroll-behavior: none !important;
  touch-action: none !important; /* مفيد للموبايل */
}


/* ===== أزرار أسفل بطاقة الزبون (PDF / تسديد / ملاحظات / حذف) — ألوان مطفّية أنيقة ===== */
.card-foot .foot-actions .i-btn{
  border: 1px solid var(--stroke);
  transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  border-radius: 12px;
  box-shadow: 0 6px 14px rgba(0,0,0,.08);
}

/* (1) PDF — تِيل مطفّي */
.card-foot .foot-actions .i-btn:nth-child(1){
  background: linear-gradient(135deg, #3a8d8e, #2e6e6f);
  color: #f3fbfb;
  border-color: rgba(58,141,142,.45);
}
.card-foot .foot-actions .i-btn:nth-child(1):hover{
  transform: translateY(-1px);
  filter: brightness(1.04);
}

/* (2) تسديد الكل — بدون تغيير */

/* (3) الملاحظات — بنفسجي مُعتّق (mauve) */
.card-foot .foot-actions .i-btn:nth-child(3){
  background: linear-gradient(135deg, #7a6aa6, #66558c);
  color: #f7f5ff;
  border-color: rgba(122,106,166,.45);
}
.card-foot .foot-actions .i-btn:nth-child(3):hover{
  transform: translateY(-1px);
  filter: brightness(1.04);
}

/* (4) حذف البطاقة — طوبي/آجري مطفّي */
.card-foot .foot-actions .i-btn:nth-child(4){
  background: linear-gradient(135deg, #b64a3b, #8c372d);
  color: #fff4f3;
  border-color: rgba(182,74,59,.50);
}
.card-foot .foot-actions .i-btn:nth-child(4):hover{
  transform: translateY(-1px);
  filter: brightness(1.05);
}

/* فوكس هادئ موحّد */
.card-foot .foot-actions .i-btn:focus-visible{
  outline: 0;
  box-shadow:
    0 0 0 3px rgba(255,255,255,.08),
    0 0 0 6px rgba(99,102,241,.22);
}

/* أيقونات */
.card-foot .foot-actions .i-btn i{
  opacity:.95; margin-inline-end:.35rem;
}



/* ===== تثبيت الهيدر بدون لمس بقية التنسيقات ===== */
:root{ --hdr-h: 54px; } /* نفس اللي عندك، نثبّته للاحتياط */

.ribbon{
  position: fixed;     /* كان sticky */
  top: 0;
  inset-inline: 0;     /* يمين/يسار = 0 (يدعم RTL) */
  z-index: 1000;       /* فوق كلشي */
}

/* فراغ بسيط تحت الهيدر حتى ما يغطي أول المحتوى */
body{ padding-top: var(--hdr-h); }


/* حتى لا يُقصّ البادج لو يطلع خارج حدود الزر */
.card-foot .foot-actions { overflow: visible; }

/* زر الملاحظات يحتاج مرجع تموضع */
.card-foot .foot-actions .i-btn{ position: relative; }

/* بادج عدّاد الملاحظات — أحمر غامق */
.i-btn .notes-count{
  position: absolute;
  top: -6px;
  inset-inline-end: -6px;          /* يدعم RTL */
  min-width: 18px;
  height: 18px;
  padding: 0 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  line-height: 18px;
  text-align: center;
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b); /* أحمر غامق */
  color: #fecaca;
  border: 1px solid rgba(239,68,68,.45);
  box-shadow: 0 2px 10px rgba(239,68,68,.25);
  pointer-events: none; /* ما يمنع النقر على الزر */
}

/* إخفاء تام عندما العدد = 0 */
.i-btn .notes-count[hidden]{ display: none; }



/* ===== زر حذف سطر المادة داخل البطاقة ===== */
/* نغطي الاحتمالات الشائعة: زر صغير داخل العناصر، وأي زر يحمل كلاس/داتا حذف */
.item .btn-del,
.btn-mini.btn-del,
.item [data-action="del-item"],
.item .btn[data-action="del-item"]{
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b); /* أحمر غامق */
  color: #fecaca;
  border: 1px solid rgba(239,68,68,.45);
  box-shadow: 0 8px 18px rgba(239,68,68,.24);
  transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
}

/* Hover/Focus */
.item .btn-del:hover,
.btn-mini.btn-del:hover,
.item [data-action="del-item"]:hover,
.item .btn[data-action="del-item"]:hover{
  transform: translateY(-1px);
  filter: brightness(1.06);
  box-shadow: 0 12px 24px rgba(239,68,68,.30);
}

.item .btn-del:focus-visible,
.btn-mini.btn-del:focus-visible,
.item [data-action="del-item"]:focus-visible,
.item .btn[data-action="del-item"]:focus-visible{
  outline: 0;
  box-shadow:
    0 0 0 2px rgba(255,255,255,.10),
    0 0 0 5px rgba(239,68,68,.35);
}

/* لو عندك ستايل يفرض "شفاف/ghost" يتغلب على الخلفية، نعالجه هنا */
.item .btn-del.ghost,
.btn-mini.btn-del.ghost,
.item [data-action="del-item"].ghost{
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b);
  color: #fecaca;
  border-color: rgba(239,68,68,.45);
}

/* لو الحاوية تقصّ البادج/الظل بسبب overflow */
.item .actions, .item .controls { overflow: visible; }

/* (اختياري كحل أخير فقط) لو بعده أكو قاعدة تغلب – فعّل !important للخلفية واللون فقط */
/*
.item .btn-del,
.btn-mini.btn-del{
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b) !important;
  color: #fecaca !important;
}
*/

/* لون مميّز لحواف البطاقات الزوجية فقط (2,4,6,...) */
:root{
  /* غيّر اللون من هنا حسب ما يلائم تطبيقك */
  --alt-card-border: #f59e0b; /* Amber واضح جداً */
}

.masonry > .card:nth-child(even){
  border-color: var(--alt-card-border) !important; /* بس اللون */
  border-style: solid; /* ما نغير العرض، بس نضمن ظهور الحد لو كان محدد مسبقاً */
  /* ملاحظة: ما لمسنا الخلفية، النص، الأزرار، الظلال… فقط لون الحافة */
}

/* ====== قائمة الأصناف المخصّصة ====== */
.cat-list{ list-style:none; margin:0; padding:0; }
.cat-item{
  height:36px;
  display:flex;
  align-items:center;
  gap:10px;
  padding:0 12px;
  cursor:pointer;
  color:#e7eef9;
  border-bottom:1px dashed rgba(255,255,255,.06);
}
.cat-item i{
  width:18px;
  text-align:center;
  opacity:.95;
}

/* <<< هاي أهم نقطة: نفس التدرّج للعنصر المفعّل بكل القوائم >>> */
#custSuggestions .sugg-item.is-active,
#itemSuggestions .sugg-item.is-active,
.cat-item.active{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: #fff;
  border-radius: 10px;
}

/* الهوفر للباقي يبقى كحلي */
#itemSuggestions .sugg-item:hover,
.cat-item:hover{
  background:#0e1b36;
}

/* ===== مودال نقل الديون (اختيار اليوم/الشهر/السنة) ===== */
.transfer-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  width:100%;
}

.transfer-actions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  width:100%;
  margin-top:10px;
}

.transfer-hint{
  
  font-size: 16px !important;
  font-weight: 600 !important;
  color: #ffffff !important;
  text-align: center;
  line-height: 1.6;
  max-width:360px;
  margin-inline:auto;
}



/* زر إغلاق أحمر غامق لكل المودالات */
.close-red{
  background: linear-gradient(180deg,#7f1d1d,#4c0b0b) !important;
  color:#fecaca !important;
  border:1px solid rgba(127,29,29,.6) !important;
  box-shadow:0 10px 26px rgba(127,29,29,.4);
  font-weight:800;
  cursor:pointer;
  border-radius:10px;
  height:36px;
  padding:0 12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.close-red:hover{
  filter:brightness(1.05);
  transform:translateY(-1px);
  box-shadow:0 12px 30px rgba(127,29,29,.5);
  transition:.18s ease;
}

/* ===== Payments Modal (الحسابات المالية) ===== */

/* تغليف المودال: ناخذ اغلب الشاشة مو مثل المودال الصغير */
.payments-shell{
  width: min(1100px, 96vw);
  max-height: min(90vh, 800px);

  display:flex;
  flex-direction:column;
  gap:12px;

  background:linear-gradient(135deg, rgba(20,30,55,.92), rgba(17,25,45,.92));
  border:1px solid rgba(124,58,237,.35);
  border-radius:16px;
  box-shadow:0 24px 70px rgba(0,0,0,.6);

  padding:16px;
  overflow:hidden;
  position:relative;
}

/* الرأس */
.payments-head{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:8px;

  border:1px solid var(--stroke);
  background:linear-gradient(180deg,#0f1a33,#0d172d);
  border-radius:12px;
  padding:10px 12px;
  box-shadow:0 12px 28px rgba(0,0,0,.45);
  color:#e7eef9;
}
.payments-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:900;
  font-size:15px;
  letter-spacing:.2px;
  color:#fff;
}
.payments-title i{
  width:28px;height:28px;border-radius:8px;
  display:grid;place-items:center;
  background:linear-gradient(135deg,var(--brand,#12d1b4),var(--brand-2,#7c3aed));
  color:#fff;
  box-shadow:0 8px 24px rgba(124,58,237,.35);
  font-size:13px;
  font-weight:900;
}
.payments-actions{
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:6px;
}
.payments-export{
  border:1px solid var(--stroke);
  background:linear-gradient(180deg,#0c1426,#0e1830);
  color:#e2e8f0;
  border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.4);
  font-size:13px;
  font-weight:800;
  min-width:90px;
  height:36px;
}
.payments-close{
  background:linear-gradient(135deg,var(--brand,#12d1b4),var(--brand-2,#7c3aed));
  color:#fff;
  border:0;
  border-radius:10px;
  box-shadow:0 12px 28px rgba(124,58,237,.35);
  font-size:13px;
  font-weight:800;
  min-width:90px;
  height:36px;
}

/* الفورم */
.payments-form{
  display:grid;
  grid-template-columns: repeat(5, 1fr) auto;
  gap:10px;
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0b1327;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
  padding:12px;
}
.pf-field{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.pf-label{
  font-size:12px;
  font-weight:800;
  color:#cbd5e1;
  display:flex;
  align-items:center;
  gap:6px;
}
.pf-add{
  display:flex;
  align-items:flex-end;
}
.pf-add-btn{
  width:100%;
  height:36px;
  border-radius:10px;
  justify-content:center;
  font-size:13px;
  font-weight:900;
  box-shadow:0 12px 28px rgba(124,58,237,.35);
}

/* اقتراحات الاسماء */
.pf-cust{
  position:relative;
}
.pf-suggestions{
  position:absolute;
  inset-inline-start:0;
  inset-inline-end:0;
  top:100%;
  z-index:20;
  max-height:160px;
  overflow-y:auto;
  border:1px solid var(--stroke);
  border-radius:10px;
  background:linear-gradient(180deg,#0f1a33,#0d172d);
  box-shadow:0 18px 40px rgba(0,0,0,.6);
  display:none;
}
.pf-suggestions .sugg-item{
  position:relative;
  cursor:pointer;
  padding:10px 12px;
  line-height:1.4;
  font-size:13px;
  color:#e7eef9;
}
.pf-suggestions .sugg-item + .sugg-item::before{
  content:"";
  position:absolute;
  top:0;
  inset-inline:12px;
  height:1px;
  background:linear-gradient(90deg,
    rgba(255,255,255,.06),
    rgba(255,255,255,.12),
    rgba(255,255,255,.06)
  );
  pointer-events:none;
}
.pf-suggestions .sugg-item:hover{
  background:#0e1b36;
}

/* اللستة/الجدول */
.payments-list-wrap{
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0c1529;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  min-height:180px;
  max-height:300px;
  overflow-y:auto;
  font-size:12.5px;
  color:#e7eef9;
}

/* الراس */
.payments-header-row{
  display:grid;
  grid-template-columns: 40px 1fr 80px 120px 1fr 100px 90px 40px;
  gap:6px;
  font-weight:900;
  color:#cbd5e1;
  border:1px solid var(--stroke);
  border-radius:10px;
  background:#0a1327;
  padding:6px 8px;
  font-size:12px;
}

/* السطور المدخولة */
.payments-rows{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.payment-row{
  display:grid;
  grid-template-columns: 40px 1fr 80px 120px 1fr 100px 90px 40px;
  align-items:center;
  gap:6px;
  border:1px solid var(--stroke);
  border-radius:10px;
  background:#0c1529;
  padding:8px;
  font-size:12px;
  line-height:1.3;
  color:#e7eef9;
}

.payment-row .pay-amt{
  font-weight:900;
  text-align:center;
  background:#0a1020;
  border:1px solid var(--stroke);
  border-radius:999px;
  padding:2px 8px;
  white-space:nowrap;
}
.payment-row .pay-type.pay-in{
  color:#a7f3d0;
  background:linear-gradient(180deg,#064e3b,#052e2a);
  border:1px solid rgba(16,185,129,.35);
  border-radius:999px;
  padding:2px 8px;
  text-align:center;
  font-weight:800;
  font-size:11px;
}
.payment-row .pay-type.pay-out{
  color:#fecaca;
  background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
  border:1px solid rgba(239,68,68,.35);
  border-radius:999px;
  padding:2px 8px;
  text-align:center;
  font-weight:800;
  font-size:11px;
}
.payment-del-btn{
  width:28px;
  height:28px;
  border-radius:8px;
  border:1px solid rgba(239,68,68,.45);
  background:linear-gradient(135deg,#7f1d1d,#4c0b0b);
  color:#fecaca;
  display:grid;
  place-items:center;
  cursor:pointer;
  font-size:12px;
  line-height:0;
}
.payment-del-btn:hover{
  filter:brightness(1.06);
  transform:scale(1.04);
  transition:.18s ease;
}

/* ريسبونسيف تلفونات */
@media (max-width:700px){
  .payments-form{
    grid-template-columns: 1fr 1fr;
  }
  .pf-add{
    grid-column: 1 / -1;
  }
  .payments-header-row,
  .payment-row{
    grid-template-columns: 28px 1fr 60px 100px 1fr 70px 32px;
    font-size:11px;
  }
}



/* تظليل العنصر المحدَّد بالكيبورد */
.pf-suggestions .sugg-item.active{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: #fff; /* نفس الدوك */
  border-inline-start: 3px solid var(--brand-3); /* نخليها مثل ما كانت */
}


/* خلي زر إغلاق نافذة الحسابات المالية أحمر غامق */
#paymentsModal .payments-close,
#closePaymentsBtn{
  background: linear-gradient(180deg,#7f1d1d,#4c0b0b) !important;
  color: #fecaca !important;
  border: 1px solid rgba(127,29,29,0.6) !important;
  box-shadow: 0 10px 26px rgba(127,29,29,0.4) !important;
}
#paymentsModal .payments-close:hover,
#closePaymentsBtn:hover{
  filter: brightness(1.05);
  transform: translateY(-1px);
  box-shadow: 0 12px 30px rgba(127,29,29,0.5);
  transition: .18s ease;
}

/* ترويسة جدول الحاسبات المالية: خطوط بين الأعمدة + توسيط كامل */
.payments-header-row{
  display: grid;
  grid-template-columns: 40px 1.2fr .9fr 1fr 1.2fr .9fr .8fr 60px; /* # | الاسم | النوع | المبلغ | ملاحظات | تاريخ | وقت | حذف */
  background: #0b1630;
  border: 1px solid var(--stroke, #253250);
  border-radius: 10px;
  overflow: hidden;     /* حتى الزوايا تنقص صح */
  gap: 0;               /* حتى نرسم حدود بدل الفراغ */
}






/* ترويسة جدول الحاسبات المالية: أقل ارتفاع + ألوان أجمل */
.payments-header-row{
  display: grid;
  grid-template-columns: 40px 1.2fr .9fr 1fr 1.2fr .9fr .8fr 60px;
  background: linear-gradient(135deg, #0e1b36, #0a1327); /* تدرّج كحلي أنيق */
  border: 1px solid rgba(80,110,160,.35);
  border-radius: 10px;
  overflow: hidden;
  gap: 0;
}

/* خلايا الترويسة: توسيط كامل + ارتفاع أقل */
.payments-header-row > div{
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px 8px;             /* كان 8px 10px → قلّلناه */
  min-height: 30px;             /* ارتفاع أنحف */
  font-weight: 800;
  font-size: 11.5px;            /* أصغر شوية */
  letter-spacing: .2px;
  color: #e6efff;               /* نص أفتح ومتباين */
  border-inline-start: 1px solid rgba(80,110,160,.35);
}

/* أول خانة بدون خط يسار */
.payments-header-row > div:first-child{
  border-inline-start: none;
}


/* نفس شبكة الأعمدة للترويسة وصفوف التسديد */
.payments-header-row,
.payment-row{
  display: grid;
  grid-template-columns: 40px 1fr 80px 120px 1fr 100px 90px 40px; 
  /* # | الاسم | النوع | المبلغ (د.ع) | ملاحظات | تاريخ | وقت | حذف */
  gap: 0;                     /* مهم: بدون فجوات */
}


/* --- خلايا الترويسة عندك جاهزة (تبقى مثل ما هي) --- */

/* خلايا صف التسديد: نفس حدود الترويسة وتوسيط كامل */
.payment-row > div{
  display: flex;
  align-items: center;
  justify-content: center;     /* يضمن الاسم بالنص */
  padding: 6px 8px;
  min-height: 34px;
  color: #e7eef9;
  font-size: 12px;
  border-inline-start: 1px solid rgba(80,110,160,.35); /* نفس خط الترويسة */
  box-sizing: border-box;
}

/* أول خلية بدون خط يسار (مثل الترويسة) */
.payment-row > div:first-child{
  border-inline-start: none;
}

/* (اختياري) قص الملاحظات لسطر واحد */
.payment-row > div:nth-child(5){
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* فاصل بسيط بين الصفوف */
.payment-row + .payment-row{
  border-top: 1px solid rgba(80,110,160,.35);
}








/* ===== 1) تطابق الصفوف مع الترويسة: خطوط عمودية بين كل عمود ===== */

/* خلي الترويسة بدون فجوات، والحشوة جوّا الخلايا */
.payments-header-row{
  gap: 0 !important;
  padding: 0 !important;
}
.payments-header-row > div{
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px 8px;
  min-height: 30px;
  font-weight: 800;
  font-size: 11.5px;
  letter-spacing: .2px;
  color: #e6efff;
  border-inline-start: 1px solid rgba(80,110,160,.35);
}
.payments-header-row > div:first-child{ border-inline-start: none; }

/* الصفوف بنفس الشبكة وبدون فجوات، والحدود داخل الخلايا */
.payment-row{
  display: grid;
  grid-template-columns: 40px 1fr 80px 120px 1fr 100px 90px 40px; /* # | الاسم | النوع | المبلغ | ملاحظات | تاريخ | وقت | حذف */
  gap: 0 !important;
  padding: 0 !important;
  background: #0a1327;          /* قريب من الترويسة */
  border: 1px solid var(--stroke);
  border-radius: 10px;
  overflow: hidden;
}
.payment-row > div{
  display: flex;
  align-items: center;
  justify-content: center;      /* يضمن الاسم بالنص */
  padding: 6px 8px;
  min-height: 34px;
  color: #e7eef9;
  font-size: 12px;
  border-inline-start: 1px solid rgba(80,110,160,.35);
  box-sizing: border-box;
}
.payment-row > div:first-child{ border-inline-start: none; }

/* ملاحظات كسطر واحد (اختياري) */
.payment-row > div:nth-child(5){
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ===== 2) إلغاء بادج النوع والمبلغ وتحويلهم نص عادي متوسّط ===== */

/* توسيط نص العمودين 3 و4 */
.payment-row > div:nth-child(3),
.payment-row > div:nth-child(4){
  text-align: center;
  justify-content: center;
}

/* شيل تنسيق البادجات/الأزرار داخل العمودين وخليها نص */
.payment-row > div:nth-child(3) *,
.payment-row > div:nth-child(4) *{
  all: unset !important;
  display: inline !important;
  color: inherit !important;
  font: inherit !important;
  pointer-events: none !important;  /* يتصرف كنص */
  text-align: center !important;
}

/* إلغاء ستايلات البادجات الأصلية (لو تأثّروا بمكان آخر) */
.payment-row .pay-amt,
.payment-row .pay-type{ 
  background: transparent !important;
  border: 0 !important;
  border-radius: 0 !important;
  padding: 0 !important;
  font-weight: inherit !important;
  font-size: inherit !important;
  color: inherit !important;
}

/* خط بين النوع والمبلغ داخل صف التسديد فقط */
.payment-row > div:nth-child(4){
  position: relative; /* حتى نرسم الفاصل فوق محتوى الخلية */
}
.payment-row > div:nth-child(4)::before{
  content: "";
  position: absolute;
  inset-block: 0;             /* top:0; bottom:0; بنسخة منطقية */
  inset-inline-start: 0;      /* بداية الخلية (RTL/LTR) */
  width: 1px;
  background: rgba(80,110,160,.35);  /* نفس لون خطوط الترويسة */
  pointer-events: none;
  z-index: 1;                 /* فوق أي بادج/خلفية داخل الخلية */
}



/* علّي ارتفاع ترويسة الجدول قليلاً */
.payments-header-row > div{
  padding: 6px 10px;   /* كان 4px 8px */
  min-height: 36px;    /* كان 30px */
}

/* قلّل ارتفاع صف التسديد قليلاً */
.payment-row > div{
  padding: 4px 8px;    /* كان 6px 8px */
  min-height: 28px;    /* كان 34px */
}


/* ترويسة الجدول: لون أوضح وبروز أعلى */
.payments-header-row{
  background: linear-gradient(135deg, #162b52, #0f2143); /* لون أوضح من قبل */
  border: 1px solid #35507e;                              /* إطار أقوى */
}
.payments-header-row > div{
  color: #f0f6ff;                                         /* نص أفتح */
  border-inline-start: 1px solid rgba(90,130,190,.55);    /* فواصل أوضح */
}

/* صف التسديد: حدّ أسمك وأغمق */
.payment-row{
  border: 2px solid #2a3b5f !important;                   /* كان 1px → صار 2px */
  border-radius: 10px;
}
.payment-row > div{
  /* نفس الفاصل الداخلي لكن أغمق شوي */
  border-inline-start: 1px solid rgba(90,130,190,.45);
}

/* فاصل بين الصفوف (لو عندك صفوف متتالية) */
.payment-row + .payment-row{
  margin-top: 6px;
  border-color: #243556;                                   /* أغمق شوية */
}

/* تقوية الكتابة بكل صف التسديد */
.payment-row > div{
  font-weight: 700;     /* أغمق */
  font-size: 13px;      /* أكبر شوي */
  color: #e9f1ff;       /* وضوح أعلى */
}

/* إبراز قوي لعمود "المبلغ (د.ع)" — هو العمود الرابع */
.payment-row.payment-row > div:nth-child(4),
.payment-row > div:nth-child(4),
.payment-row > div:nth-child(4) *{
  font-weight: 900 !important;
  font-size: 15px !important;
  line-height: 1.2 !important;
  color: #ffe8bf !important;            /* لون أوضح */
  font-variant-numeric: tabular-nums !important;
  font-feature-settings: "tnum" 1 !important;
}

/* شيل أي تزيين يغطي التنسيق داخل عمود المبلغ */
.payment-row > div:nth-child(4) .pay-amt,
.payment-row > div:nth-child(4) .amount-chip,
.payment-row > div:nth-child(4) .badge,
.payment-row > div:nth-child(4) button,
.payment-row > div:nth-child(4) .btn{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  color: inherit !important;
  font: inherit !important;
}

/* تقليل الفراغ بين الصفوف */
.payment-row{ margin: 0; }

.payment-row + .payment-row{
  margin-top: 2px;              /* كان 6px → صار 2px */
  /* (اختياري) خط فاصل خفيف بدل الفراغ الكبير */
  border-top: 1px solid rgba(80,110,160,.35);
}



/* ============ إعدادات ارتفاعات ثابتة ============ */
:root{
  --payments-header-h: 44px;   /* ارتفاع الترويسة ثابت */
  --payments-row-h:    42px;   /* ارتفاع صف واحد ثابت */
  --payments-row-gap:  0px;    /* بدون فراغات بين الصفوف حتى نحافظ على الحساب */
  --payments-max-rows: 5;      /* فقط 5 صفوف مرئية */
}

/* غلاف القائمة كله */
.payments-list-wrap{
  position: relative;
  border: 1px solid var(--stroke, #24304a);
  border-radius: 10px;
  overflow: hidden;            /* نخلي السكرول على جسم الصفوف فقط */
  background: #0b1327;
}

/* ترويسة الأعمدة — تبقى ثابتة */
.payments-header-row{
  display: grid;
  grid-template-columns: 40px 1fr 120px 140px 1.2fr 130px 100px 70px;
  align-items: center;
  height: var(--payments-header-h);
  min-height: var(--payments-header-h);
  max-height: var(--payments-header-h);
  padding: 0 8px;
  position: sticky;
  top: 0;
  z-index: 2;
  background: #0f1a36;        /* خلفية مميّزة للترويسة */
  border-bottom: 1px solid var(--stroke, #24304a);
  font-weight: 700;
}

/* جسم الصفوف — هنا يكون السكرول */
.payments-rows{
  display: flex;
  flex-direction: column;
  gap: var(--payments-row-gap);
  max-height: calc( var(--payments-row-h) * var(--payments-max-rows)
                    + max(0px, (var(--payments-max-rows) - 1) * var(--payments-row-gap)) );
  overflow-y: auto;           /* يظهر سكرول فقط للجسم */
  overflow-x: hidden;
}

/* صف واحد */
.payment-row{
  display: grid;
  grid-template-columns: 40px 1fr 120px 140px 1.2fr 130px 100px 70px;
  align-items: center;
  height: var(--payments-row-h);
  min-height: var(--payments-row-h);
  max-height: var(--payments-row-h);   /* يمنع التمدد */
  padding: 0 8px;
  border-bottom: 1px dashed rgba(255,255,255,0.06);
  background: #0b152e;
}

/* خلايا داخل الصف — تمنع تغيّر الارتفاع وتقصّ النص */
.payment-row > div{
  display: flex;
  align-items: center;
  height: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;         /* يمنع سطر ثاني */
}

/* عمود المبلغ لو عندك صندوق إدخال داخله */
.payment-row .pay-amt,
.payment-row .pay-amt input{
  height: 28px;
  line-height: 28px;
}

/* زر الحذف/الآيكونات */
.payment-row .payment-del-btn{
  height: 28px;
  min-width: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: 1px solid var(--stroke, #24304a);
  background: #0e1a34;
  cursor: pointer;
}

/* شريط سكرول أنيق لجسم الصفوف فقط (اختياري) */
.payments-rows{
  scrollbar-width: thin;       /* Firefox */
}
.payments-rows::-webkit-scrollbar{ width: 10px; }
.payments-rows::-webkit-scrollbar-track{
  background: #0a1020; border-radius: 999px; border: 1px solid var(--stroke,#24304a);
}
.payments-rows::-webkit-scrollbar-thumb{
  background: #243a73; border-radius: 999px;
}








/* ===== صف السحب بلون أحمر غامق مثل "الآيتم الراجع" ===== */
.payment-row.withdraw{
  /* خلفية أحمر داكنة ولمسة حدود مثل تنسيق السطر الراجع */
  background: #2a0c12 !important;
  border-bottom-color: rgba(127,29,29,0.45) !important;
}
.payment-row.withdraw > div{
  color: #fca5a5;              /* نص وردي فاتح حتى يبان */
}
.payment-row.withdraw .pay-amt{
  background: #200a0f;         /* حقل المبلغ يبان ضمن التظليل */
  border: 1px solid #7f1d1d;
  color: #fecaca;
  font-weight: 800;
}

/* ===== زر حذف التسديد يرجع أحمر غامق (التنسيق القديم) ===== */
.payments-list-wrap .payment-del-btn{
  background: #4c0e12;                 /* أحمر غامق */
  border: 1px solid #7f1d1d;
  color: #ffd7d7;
}
.payments-list-wrap .payment-del-btn:hover{
  background: #6b1217;                 /* أفتح شوي عند الهوفر */
  border-color: #9f2a2a;
  color: #fff0f0;
}
.payments-list-wrap .payment-del-btn:active{
  background: #3a0b0e;                 /* ضغطة */
  border-color: #7f1d1d;
}



/* فيروزي داكن هادئ ينسجم ويا الخلفية الداكنة */
:root{
  /* تقدر تغيّرها لاحقًا بس هذي درجة ناعمة مو فاقعة */
  --head-color: #0e7490; /* teal-700 */
  --head-text: #eaf6f8;  /* أبيض مائل لفيروزي حتى النص ما يصير حاد */
}

/* ترويسة الجدول في واجهة العرض فقط */
.payments-header-row{
  background: var(--head-color) !important;
  color: var(--head-text) !important;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

/* (اختياري) خفّف حواف خلايا الترويسة شوي حتى يكون أنعم */
.payments-header-row > div{
  border-color: rgba(255,255,255,0.10);
}




/* ====== Modal Bigger + Clearer Typography ====== */
/* طبّق هالكلاسات لما تمرّر { modalClass: 'modal-confirm-lg', bodyClass: 'text-base md:text-lg leading-7' } إلى showConfirm */

.modal-confirm-lg .modal-dialog {
  max-width: 720px;       /* أكبر من الافتراضي */
  width: 96vw;            /* يستغل العرض بالموبايل */
  margin: 1.25rem auto;   /* مسافة من الأعلى */
}

.modal-confirm-lg .modal-content {
  border-radius: 16px;
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
  overflow: hidden;
  background: #fff;
}

.modal-confirm-lg .modal-header {
  padding: 14px 18px;
  border-bottom: 1px solid rgba(0,0,0,.06);
}

.modal-confirm-lg .modal-title {
  font-weight: 700;
  font-size: 18px;
  line-height: 1.4;
}

.modal-confirm-lg .modal-body {
  padding: 18px;
  direction: rtl;          /* عربي */
  text-align: start;       /* احترم اتجاه RTL */
  color: #0f172a;          /* slate-900 */
}

.modal-confirm-lg .modal-footer {
  padding: 14px 18px;
  border-top: 1px solid rgba(0,0,0,.06);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* ====== Utility classes (تماثل اللي استخدمناها بالدالة) ====== */
.text-base { font-size: 16px; }
.leading-7 { line-height: 1.75; }

/* md:text-lg */
@media (min-width: 768px) {
  .md\:text-lg { font-size: 18px; }
}

/* ====== Buttons styling ====== */
.btn {
  appearance: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: .5rem;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 600;
  border: 1px solid transparent;
  cursor: pointer;
  user-select: none;
  transition: transform .05s ease, box-shadow .2s ease, background-color .2s ease, opacity .2s ease;
  text-decoration: none;
  white-space: nowrap;
}

.btn:active { transform: translateY(1px); }

/* موافقة = أخضر */
.btn-success {
  background: #16a34a;        /* green-600 */
  color: #fff;
  box-shadow: 0 4px 12px rgba(22,163,74,.25);
}
.btn-success:hover { background: #15803d; } /* green-700 */
.btn-success:focus { outline: 2px solid rgba(22,163,74,.35); outline-offset: 2px; }

/* إلغاء = رمادي غامق */
.btn-dark {
  background: #374151;        /* gray-700 */
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
}
.btn-dark:hover { background: #1f2937; }    /* gray-800 */
.btn-dark:focus { outline: 2px solid rgba(31,41,55,.35); outline-offset: 2px; }

/* Ghost = درجة أخف (مثل ظلّ خفيف) */
.btn-ghost {
  background: rgba(255,255,255,.08);
  border-color: rgba(0,0,0,.08);
}

/* ترتيب الأزرار إذا المودال ما يستعمل gap */
.modal-confirm-lg .modal-footer .btn + .btn { margin-inline-start: 8px; }

/* ====== Responsive tweaks ====== */
@media (max-width: 480px) {
  .modal-confirm-lg .modal-dialog { width: 98vw; }
  .modal-confirm-lg .modal-body { padding: 16px; }
  .text-base { font-size: 15px; }
  .md\:text-lg { font-size: 16px; } /* بالموبايل تقريباً نفس الـbase */
}

/* ====== دعم وضع الليل (اختياري) ====== */
@media (prefers-color-scheme: dark) {
  .modal-confirm-lg .modal-content { background: #0b1220; color: #e5e7eb; }
  .modal-confirm-lg .modal-body { color: #e5e7eb; }
  .modal-confirm-lg .modal-header, .modal-confirm-lg .modal-footer { border-color: rgba(255,255,255,.08); }
  .btn-dark { background: #111827; }         /* gray-900 */
  .btn-dark:hover { background: #0b1220; }
}

/* ——— نافذة التأكيد: خط أكبر شوية وموحّد مع الواجهة ——— */
.modal-card{
  width: min(620px, calc(100vw - 40px)) !important; /* تكبير واضح */
  border-radius: 16px !important;
  font-family: inherit !important;                   /* نفس خط الواجهة */
}
.modal-head{ font-size: 18.5px !important; font-weight: 900 !important; }
.modal-body{ font-size: 16.5px !important; line-height: 1.85 !important; }

/* زر "نعم" = أحمر غامق واضح (يشتغل لما danger=true) */
.modal-btn.danger{
  background: linear-gradient(180deg, #5f0b0b, #7a0e0e) !important;
  color: #fff !important;
  border-color: #7f1d1d !important;
  box-shadow: 0 12px 28px rgba(127,29,29,.35) !important;
}
.modal-btn.danger:hover{ filter: brightness(1.06) !important; transform: translateY(-1px) !important; }
.modal-btn.danger:focus{ outline: 2px solid rgba(127,29,29,.55) !important; outline-offset: 1px !important; }

/* إبراز "يوم سابق" داخل النص */
.prev-day{ color:#7f1d1d !important; font-weight:900 !important; }




/* تكبير أزرار التأكيد/الإلغاء */
.modal-actions{
  display:flex;
  gap:10px;
  justify-content:center;
  width:100%;
}

.modal-btn{
  height:44px;                 /* كان 36px */
  min-width:120px;             /* يخليها كبار شوي */
  padding:0 16px;
  border-radius:12px;          /* أنعم */
  font-size:16px;              /* خط أوضح */
  font-weight:900;
}


/* أخيرًا وبشكل حاسم: خلّي زر التأكيد أحمر غامق */
#modal-confirm.modal-btn.danger{
  background: linear-gradient(180deg, #5f0b0b, #7a0e0e) !important;
  color:#fff !important;
  border-color:#7f1d1d !important;
  box-shadow:0 12px 28px rgba(127,29,29,.35) !important;
}
#modal-confirm.modal-btn.danger:hover{
  filter:brightness(1.06) !important;
  transform:translateY(-1px) !important;
}



/* شريط البحث يم الأزرار */
.payments-actions { display:flex; align-items:center; flex-wrap:wrap; gap:6px; }

.payments-search{
  display:flex; align-items:center; gap:6px;
  border:1px solid var(--stroke);
  background:#0b1327;
  border-radius:10px;
  padding:4px 6px;
}

#paymentsSearchInput{
  height:32px; min-width:220px;
  background:#0c1426; color:#e7eef9; border:1px solid var(--stroke);
  border-radius:8px; padding:0 10px; outline:none;
}
#paymentsSearchInput:focus{
  border-color:rgba(18,209,180,.6);
  box-shadow:0 0 0 3px rgba(18,209,180,.14);
}


/* زر مسح البحث يخلي X أحمر */
#paymentsSearchClear{
  border:1px solid #7a1616;
  background:#2a0c0c;
  border-radius:8px;
  height:32px;
  padding:0 10px;
}
#paymentsSearchClear i{
  color:#ff4d4f;
}
#paymentsSearchClear:hover{
  background:#3a0f0f;
  border-color:#a61e1e;
  box-shadow:0 0 0 3px rgba(255,77,79,.18);
}


/* يخلي نافذة التأكيد فوق الكل مهما كان */
#modal-backdrop{
  position: fixed !important;
  inset: 0 !important;
  z-index: 2147483646 !important; /* أعلى من أي عنصر عندك */
}
#modal{
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  z-index: 2147483647 !important;
}




/* هيدر الكرت: مربع أحمر + نص التوافق على سطر واحد */
.compat-card__head{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:6px;
}

/* المربع الأحمر لاسم التوافق (من الكاجوري) */
.compat-cat-box{
  background:linear-gradient(135deg,#7f1d1d,#b91c1c);
  border-radius:10px;
  border:1px solid #ef4444;
  color:#fee2e2;
  font-weight:900;
  font-size:13px;
  padding:6px 10px;
  min-width:120px;
  text-align:center;
  white-space:nowrap;
}

/* النص اللي يم المربع الأحمر: حقل "التوافق" */
.compat-main-text{
  font-size:13px;
  color:#e5e7eb;
  font-weight:700;
  padding:6px 10px;
  border-radius:10px;
  background:#020617;
  border:1px solid rgba(148,163,184,.3);
  flex:1;
  text-align:center; /* بدل right */
}




/* شريط البحث */
.compat-search-row{
  display:flex;
  align-items:center;
  gap:6px;
}

/* خليه يتمدّد، والزر يبقى بحجمه الطبيعي */
#compatSearchInput{
  flex:1;
  min-width:0;
}

.compat-search-row .field{
  height:34px;
}

#compatSearchBtn{
  white-space:nowrap;
}


.compat-suggestions{
  display:none !important; /* خلاص ماكو اقتراحات */
}

/* صف البحث */
.compat-search-row{
  display: flex;
  gap: 8px;
  align-items: center;
}

/* غلاف حقل البحث + زر X */
.compat-search-input-wrap{
  position: relative;
  flex: 1;
}

/* حقل البحث نفسه */
#compatSearchInput{
  width: 100%;
  padding-left: 40px;  /* مساحة للزر من اليسار */
  box-sizing: border-box;
}

/* زر X داخل الشريد أقصى اليسار */
.compat-clear-btn{
  position: absolute;
  left: 8px;              /* أقصى اليسار جوّه الحقل */
  top: 50%;
  transform: translateY(-50%);
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid #7a1616;
  background: #2a0c0c;
  display: grid;
  place-items: center;
  padding: 0;
  cursor: pointer;
}

.compat-clear-btn i{
  font-size: 13px;
  color: #ff4d4f;
}

.compat-clear-btn:hover{
  background: #3a0f0f;
  border-color: #a61e1e;
  box-shadow: 0 0 0 3px rgba(255,77,79,.18);
}



.compat-results{
  flex:1;
  min-height:0;
  margin-top:14px;
  border-radius:12px;
  border:1px solid var(--stroke);
  background:#020617;
  padding:10px;
  overflow-y:auto;
  max-height:calc(100vh - 260px);
  display:flex;
  flex-direction:column;
  gap:4px;           /* 4 أو 6 بكسل تطلع أنيقة */
  text-align:center;
}


/* الكرت المحدد بالسهم ↑↓ */
.compat-card.is-active{
  
  
  outline: none !important;
  box-shadow: none !important;
  
}



/* عدّاد النتائج في نافذة توافقات قطع الغيار */
#compatCount{
  min-width:80px;
  text-align:center;
  font-size:11px;
  font-weight:600;
  padding:3px 10px;
  border-radius:10px;   /* نفس شكل close-red تقريبا */
  border:1px solid rgba(148,163,184,.5);
  background:#020617;
  color:#9ca3af;
  letter-spacing:0.5px;
}

/* لما تكون أكو نتائج */
#compatCount.has-results{
  border-color:rgba(34,197,94,.7);
  background:rgba(22,163,74,.12);
  color:#bbf7d0;
}

/* لما تكون 0 نتيجة */
#compatCount.has-zero{
  border-color:rgba(248,113,113,.55);
  background:rgba(127,29,29,.2);
  color:#fecaca;
}


/* زر اليوم التالي من يكون مفعّل يصير أحمر غامق */
.icon.nextday-active,
.icon.nextday-active:hover{
  background: linear-gradient(180deg,#7f1d1d,#450a0a); /* أحمر غامق */
  border-color: #450a0a;
  color: #fee2e2; /* لون الأيقونة أفتح حتى تبين */
  box-shadow: 0 0 0 2px rgba(127,29,29,.5);
  transform: translateY(-1px);
}



/* أزرار اختيار نوع البحث (توافقات / أسعار) في نافذة التوافقات */
.compat-mode-toggle{
  display:flex;
  gap:6px;
  margin-inline-end:8px;
}

.compat-mode-btn{
  height:28px;
  padding:0 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:#020617;
  color:#e5e7eb;
  font-size:11px;
  font-weight:700;
  cursor:pointer;
}

.compat-mode-btn.is-active{
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  border-color:transparent;
  color:#fff;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.06),
    0 10px 24px rgba(37,99,235,.35);
}

/* خط واحد للصنف - الايتم - السعر */
.compat-card--price .compat-card__grid{
  margin-top:8px;
}

.compat-price-line{
  display:grid;
  grid-template-columns: 1.1fr 2.4fr 1.1fr; /* صنف - ايتم - سعر */
  gap:6px;
}

.compat-price-line .ichip{
  text-align:center;
}


/* كارت الأسعار – سطر واحد فقط */
.compat-card--price{
  padding: 8px 10px;
}

.compat-price-line{
  display:grid;
  grid-template-columns: 0.9fr 2.4fr 0.9fr; /* صنف - ايتم - سعر */
  gap:6px;
}

/* الصنف داخل المستطيل الأحمر */
.compat-type-chip{
  background:#b91c1c;
  color:#fff;
  font-weight:700;
}

/* توحيد شكل الحقول */
.compat-price-line .ichip{
  text-align:center;
}

/* اختياري – بس يضمن أنه يضبط جوّا السطر */
.compat-type-chip{
  min-width: 0;      /* حتى ما يتوسّع زيادة داخل الـ grid */
  width: 100%;
}


/* خلي خط المادة والسعر غامق نفس التوافقات */
.compat-item-chip,
.compat-price-chip{
  font-weight: 700;        /* غامق */
  color: #e5e7eb;          /* نفس الدرجة الفاتحة مال النص */
  letter-spacing: 0.03em;  /* نفس الشعور بالتوافقات */
}

/* توسيط الصنف / المادة / السعر عموديًا داخل سطر الأسعار */
.compat-price-line .compat-cat-box,
.compat-price-line .ichip{
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1.2;
  height: 34px;       /* نفس تقريبًا ارتفاع تشيب التوافقات، عدّلها إذا تريد */
  padding-top: 0;
  padding-bottom: 0;
}






/* ===== Storage usage modal – نفس ألوان الواجهة الداكنة ===== */
.storage-modal-card{
  max-width: 520px;
  border-radius: var(--radius);
  background:
    radial-gradient(circle at 0% 0%, rgba(124,58,237,.18), transparent 55%),
    linear-gradient(145deg, var(--paper), var(--surface));
  border: 1px solid var(--stroke);
  box-shadow: var(--shadow);
  padding: 14px 16px 12px;
  color: var(--ink);
}

.storage-body{
  padding-top: 6px;
}

/* header */
.storage-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.storage-header-main{
  display: flex;
  align-items: center;
  gap: 10px;
}

.storage-icon-circle{
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: #f9fafb;
  box-shadow:
    0 9px 22px rgba(15, 23, 42, .65),
    0 0 0 1px rgba(15, 23, 42, .7);
  font-size: 18px;
}

.storage-title{
  font-size: 15px;
  font-weight: 800;
  color: var(--ink);
}

.storage-subtitle{
  font-size: 12px;
  color: var(--muted);
  margin-top: 1px;
}

.code-chip{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  padding: 1px 6px;
  border-radius: 999px;
  background: rgba(15, 23, 42, .7);
  border: 1px solid rgba(148, 163, 184, .5);
  font-size: 11px;
  color: #e5e7eb;
}

/* badge */
.storage-badge{
  padding: 4px 9px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}

.storage-badge::before{
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 999px;
}

.storage-badge-safe{
  background: rgba(22, 163, 74, .08);
  color: #bbf7d0;
  border: 1px solid rgba(22, 163, 74, .6);
}

.storage-badge-safe::before{
  background: var(--good);
}

.storage-badge-warn{
  background: rgba(245, 158, 11, .08);
  color: #fed7aa;
  border: 1px solid rgba(245, 158, 11, .6);
}

.storage-badge-warn::before{
  background: var(--warn);
}

.storage-badge-danger{
  background: rgba(239, 68, 68, .1);
  color: #fecaca;
  border: 1px solid rgba(239, 68, 68, .7);
}

.storage-badge-danger::before{
  background: var(--danger);
}

/* bar */
.storage-bar-outer{
  width: 100%;
  height: 10px;
  border-radius: 999px;
  background: #020617;
  border: 1px solid rgba(15, 23, 42, .9);
  overflow: hidden;
  position: relative;
  margin: 4px 0 12px;
}

.storage-bar-inner{
  height: 100%;
  width: 0;
  border-radius: inherit;
  background: linear-gradient(90deg, var(--good), var(--warn), #f97316, var(--danger));
  box-shadow: 0 0 0 1px rgba(15, 23, 42, .5);
  transition: width .45s cubic-bezier(.23,1,.32,1);
}

/* KPIs */
.storage-grid{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
  margin-bottom: 10px;
}

.storage-kpi{
  padding: 8px 9px;
  border-radius: 12px;
  background: var(--surface);
  border: 1px solid var(--stroke);
  box-shadow: 0 1px 2px rgba(15, 23, 42, .7);
}

.storage-kpi-label{
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 2px;
}

.storage-kpi-value{
  font-size: 13px;
  font-weight: 700;
  color: var(--ink);
}

/* text blocks */
.storage-stats{
  font-size: 12px;
  color: var(--ink);
  line-height: 1.7;
}

.storage-more{
  margin-top: 4px;
}

.storage-more-text{
  margin-bottom: 4px;
}

.storage-footer-note{
  margin-top: 8px;
  font-size: 11px;
  color: var(--muted);
}

/* actions + close button */
.storage-actions{
  margin-top: 10px;
  justify-content: flex-end;
}

.modal-btn.danger-solid{
  background: var(--danger);
  color: #f9fafb;
  border-radius: 999px;
  padding-inline: 18px;
  font-weight: 600;
  border: none;
  box-shadow:
    0 9px 22px rgba(15, 23, 42, .8),
    0 0 0 1px rgba(127, 29, 29, .9);
  transition: background .18s ease, transform .08s ease, box-shadow .18s ease;
}

.modal-btn.danger-solid:hover{
  background: #dc2626;
  transform: translateY(0.5px);
  box-shadow:
    0 11px 24px rgba(15, 23, 42, .9),
    0 0 0 1px rgba(127, 29, 29, 1);
}

.modal-btn.danger-solid:active{
  background: #991b1b;
  transform: translateY(1px);
  box-shadow:
    0 4px 10px rgba(15, 23, 42, .9),
    0 0 0 1px rgba(69, 10, 10, 1);
}




/* زر الإغلاق في وسط أسفل المودال */
.storage-actions{
  margin-top: 10px;
  justify-content: center;   /* بدل flex-end */
}

.storage-actions .modal-btn.danger-solid{
  min-width: 130px;
}





  
/* =================== إضافة عمود طباعة للحسابات المالية =================== */
.payments-header-row,
.payment-row{
  /* # | الاسم | النوع | المبلغ | ملاحظات | تاريخ | وقت | حذف | طباعة */
  grid-template-columns: 40px 1fr 80px 120px 1fr 100px 90px 40px 40px !important;
}

.payment-print-btn{
  width:28px;
  height:28px;
  border-radius:8px;
  border:1px solid rgba(14,165,233,45);
  background:linear-gradient(135deg,#0b3b5b,#07293f);
  color:#cfefff;
  display:grid;
  place-items:center;
  cursor:pointer;
  font-size:12px;
  line-height:0;
}
.payment-print-btn:hover{ filter:brightness(1.08); }
.payment-print-btn:active{ transform:translateY(1px); }

</style>
</head>

<body>
  <!-- Header -->
  <div class="ribbon">
    <div class="ribbon-wrap">
      <div class="r-left">
        <span id="dateBadge" class="pill">—</span>
      </div>

      <div class="r-center">
        <div class="brand">
          <div class="dot">A</div>
          <div class="name">فواتير ديون يومية مكتب عسل</div>
        </div>
      </div>

      
      <div class="r-right">
        
        
        <!-- [NEW] زر بحث توافقات قطع الغيار -->
<button class="icon" id="btnCompatSearch"
        title="توافقات قطع الغيار"
        aria-label="توافقات قطع الغيار">
  <i class="fa-solid fa-screwdriver-wrench"></i>
</button>
        
        
        
        <!-- [NEW] زر تحديد هوية الحاسبة -->
<button class="icon" id="btnDeviceRole" title="تحديد هوية الحاسبة" aria-label="تحديد هوية الحاسبة">
  <i class="fa-solid fa-id-badge"></i>
</button>

        
        <!-- زر الحسابات المالية الجديد -->
  <button id="openPaymentsBtn" class="icon" title="الحسابات المالية">
    <i class="fa-solid fa-money-bill-transfer"></i>
  </button>
        
        
        
       <!-- زر عرض آخر تاريخ نقل (معلّق)
<div id="btnTransferToast" class="icon" title="عرض آخر تاريخ نقل الديون">
  <i class="fa-solid fa-arrow-right-arrow-left"></i>
</div>
-->

<!-- زر فتح مودال تحديد التاريخ (معلّق)
<div id="btnTransferOpen" class="icon" title="إنجاز عمل (تحديد آخر تاريخ نقل الديون)">
  <i class="fa-solid fa-hand-holding-dollar"></i>
</div>
-->

  
        
        
  <button class="icon" id="btnRefresh" title="تحديث الصفحة" aria-label="تحديث الصفحة">
    <i class="fa-solid fa-rotate-right"></i>
  </button>

  <!-- تصدير محلي بدل زر البحث -->
  <button class="icon" id="btnExportLocal" title="تصدير محلي (JSON)" aria-label="تصدير محلي (JSON)">
    <i class="fa-solid fa-download"></i>
  </button>



  <!-- تصدير للسيرفر (رفع) -->
  <!-- تصدير للسيرفر (رفع)
<button class="icon" id="btnExportAll" title="رفع النسخة للسيرفر" aria-label="رفع النسخة للسيرفر">
  <i class="fa-solid fa-cloud-arrow-up"></i>
</button>
-->


  <!-- استيراد من السيرفر (سحب) -->
  <button class="icon" id="btnImportAll" title="سحب النسخة من السيرفر" aria-label="سحب النسخة من السيرفر">
    <i class="fa-solid fa-cloud-arrow-down"></i>
  </button>

  <button class="icon" id="btnNextDay" title="فتح فاتورة اليوم التالي" aria-label="فتح فاتورة اليوم التالي">
    <i class="fa-solid fa-calendar-plus"></i>
  </button>
  
  
  <!-- [NEW] زر حجم التخزين في المتصفح -->
        <button class="icon" id="btnStorageInfo"
                title="حجم تخزين المتصفح"
                aria-label="حجم تخزين المتصفح">
          <i class="fa-solid fa-database"></i>
        </button>
  
  

  <button class="icon" id="btnLogout" title="تسجيل خروج" style="display:none" aria-label="تسجيل خروج">
    <i class="fa-solid fa-right-from-bracket"></i>
  </button>
</div>

      
      
      
    </div>
  </div>

  <!-- Layout -->
  <main class="layout">
    <!-- Rail -->
    <aside class="rail">
      <h3><i class="fa-regular fa-calendar-days"></i> الفواتير السابقة</h3>
      <div class="search">

<input id="dayFilter" class="input" type="text" placeholder="فلترة (مثال: 02-10-2025 )"/>


      </div>
      <div id="rail" class="timeline"></div>
    </aside>

    <!-- Board -->
    <section class="board">
      
      
     <div class="board-head">
  <div class="chips">
    <span class="chip"><i class="fa-solid fa-layer-group"></i> بطاقات اليوم</span>
    <span id="cardsCount" class="chip">0 بطاقة</span>
  </div>

  <div class="board-search">
    <input id="cardSearch" class="input" type="text" placeholder="بحث بالاسم (مثال: حسين)"/>
    <label class="chip" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;flex:0 0 auto">
      <input id="globalSearch" type="checkbox" style="accent-color:#7c3aed;width:16px;height:16px;cursor:pointer">
      بحث كل الأيام
    </label>
  </div>

  <div class="chips">
    <button id="btnExportDay" class="btn ghost"><i class="fa-regular fa-file-pdf"></i> PDF اليوم</button>
    <button id="btnClearDay" class="btn ghost"><i class="fa-regular fa-trash-can"></i> تفريغ اليوم</button>
  </div>
</div>




      
      
      <div id="masonry" class="masonry"></div>
    </section>

    <!-- Insights -->
    <aside class="insights">
      <h3><i class="fa-solid fa-chart-simple"></i> ملخص اليوم</h3>
     
    </aside>
  </main>

  <!-- Dock -->
  
  
  <!-- ===== Dock (كامل بعد التعديل) ===== -->
<div class="dock">
  <div class="dock-inner">
    <!-- 1) اسم الزبون (اقتراحات فوق + 8 مرئية) -->
    <div class="cust-wrap" style="position:relative; min-width:0;">
      <input id="cust" class="field" type="text" placeholder="اسم الزبون"/>
      <ul id="custSuggestions" class="nice-scroll" style="
  display:none; position:absolute; inset-inline:0; bottom:calc(100% + 6px);
  z-index:1100; background:#0b1327; border:1px solid var(--stroke);
  border-radius:10px; max-height:288px; overflow:auto; margin:0; padding:6px 0; list-style:none;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
"></ul>
    </div>

    <!-- 2) نوع الفاتورة -->
    <select id="type" class="field">
      <option value="بيع" selected>بيع</option>
      <option value="راجع">راجع</option>
    </select>

    <!-- 3) الصنف (قائمة مخصّصة تطلع فوق + Scroll) -->
    <div class="cat-wrap" style="position:relative; min-width:0;">
      <input id="cat" class="field" type="text" placeholder="الصنف" readonly />
      <div id="catPanel" class="cat-panel nice-scroll" style="
  display:none; position:absolute; inset-inline:0; bottom:calc(100% + 6px);
  z-index:1100; background:#0b1327; border:1px solid var(--stroke);
  border-radius:10px; max-height:288px; overflow:auto; padding:6px 0;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
">
        <div class="cat-list" id="catList">
          <div class="cat-item" data-val="LCD"><i class="fa-solid fa-tv"></i> شاشات</div>
          <div class="cat-item" data-val="BATTERY"><i class="fa-solid fa-bolt"></i> بطاريات</div>
          <div class="cat-item" data-val="CAMERA"><i class="fa-solid fa-camera"></i> كاميرات</div>
          <div class="cat-item" data-val="CHARGING"><i class="fa-solid fa-plug"></i> شحن</div>
          <div class="cat-item" data-val="SPEAKER"><i class="fa-solid fa-headphones"></i> سماعة</div>
          <div class="cat-item" data-val="FLAT SPEAKER"><i class="fa-solid fa-volume-high"></i> فلات سماعة</div>
          <div class="cat-item" data-val="HOUSING"><i class="fa-solid fa-border-none"></i> شواصي</div>
          <div class="cat-item" data-val="BACK"><i class="fa-solid fa-mobile-screen"></i> أظهر</div>
          <div class="cat-item" data-val="BUZZER"><i class="fa-solid fa-bell"></i> جرس</div>
          <div class="cat-item" data-val="FINGER"><i class="fa-solid fa-fingerprint"></i> بصمة</div>
          <div class="cat-item" data-val="FLAT LCD"><i class="fa-solid fa-film"></i> فلات شاشة</div>
          <div class="cat-item" data-val="POWER"><i class="fa-solid fa-charging-station"></i> فلات بور</div>
          <div class="cat-item" data-val="VOLUME"><i class="fa-solid fa-sliders"></i> فلات صوت</div>
          <div class="cat-item" data-val="LENS"><i class="fa-solid fa-bullseye"></i> عدسة كاميرا</div>
          <div class="cat-item" data-val="HOLLDER"><i class="fa-solid fa-sim-card"></i> هولدر سيم</div>
          <div class="cat-item" data-val="NO-CATEGORY"><i class="fa-regular fa-square"></i> بدون صنف</div>
        </div>
      </div>
    </div>

    <!-- 4) اسم المادة (اقتراحات فوق + 8 مرئية) -->
    <div style="position:relative; min-width:0;">
      <input id="item" class="field" type="text" placeholder="اسم القطعة"/>
     <ul id="itemSuggestions" class="nice-scroll" style="
  display:none; position:absolute; inset-inline:0; bottom:calc(100% + 6px);
  z-index:1000; background:#0b1327; border:1px solid var(--stroke);
  border-radius:10px; max-height:288px; /* 8 عناصر × ~36px */
  overflow:auto; margin:0; padding:6px 0; list-style:none;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
"></ul>
    </div>

    <!-- 5) السعر -->
   <input id="price" class="field" type="text" inputmode="numeric" placeholder="السعر (دينار)"/>


    <!-- 6) العدد -->
    <input id="qty" class="field" type="number" min="1" step="1" placeholder="العدد"/>

    <!-- 7) الملاحظات + زر الإضافة -->
    <div class="note-wrap">
      <input id="note" class="field note-field" type="text" placeholder="ملاحظات (اختياري)"/>
      <button id="btnAdd" class="btn primary note-add">
        <i class="fa-solid fa-plus"></i> إضافة
      </button>
    </div>
  </div>
</div>





<!-- Auth Splash: نافذة احترافية للتحقق من الجلسة -->
<div id="authSplash" class="auth-splash" aria-live="polite" aria-atomic="true" style="display:none">
  <div class="auth-shell" role="dialog" aria-label="جاري التحقق من الجلسة">
    <div class="auth-brand">
      <div class="auth-mark">A</div>
      <div class="auth-texts">
        <div class="auth-title">ASSAL</div>
        <div class="auth-sub">مكتب عسل</div>
      </div>
    </div>

    <div class="auth-status">
      <div id="authTip" class="auth-tip">نحضّر كلشي…</div>

      <div class="auth-progress" aria-label="شريط التقدم">
        <div id="authBar" class="auth-bar"></div>
      </div>

      <div class="auth-meta">
        <span id="authPct" class="auth-pct">0%</span>
        <span class="auth-sep">•</span>
        <span id="authSub" class="auth-subtle">التحقق من الجلسة</span>
      </div>
    </div>
  </div>
  <!-- خلفية زخرفية -->
  <div class="auth-bg auth-bg--1"></div>
  <div class="auth-bg auth-bg--2"></div>
  <div class="auth-bg auth-bg--3"></div>
</div>


  

  <!-- Footer -->
 <div class="footer">© 2025 مكتب عسل — جميع الحقوق محفوظة</div>

  <!-- ===== Modal ===== -->
  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-card" role="document">
      <div class="modal-head" id="modal-title">تأكيد</div>
      <div class="modal-body" id="modal-body">هل أنت متأكد؟</div>
      <div class="modal-actions">
        <button id="modal-cancel" class="modal-btn ghost">إلغاء</button>
        <button id="modal-confirm" class="modal-btn danger">تأكيد</button>
      </div>
    </div>
  </div>
  
  
  <!-- Toasts -->
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>


<!-- Page Reload Overlay (احترافي) -->
<div id="reloader" class="reloader" aria-live="polite" aria-atomic="true" role="dialog" aria-modal="true">
  <!-- خلفية زخرفية خفيفة -->
  <div class="reloader-bg">
    <span class="orb orb-a"></span>
    <span class="orb orb-b"></span>
    <span class="orb orb-c"></span>
  </div>

  <!-- بطاقة اللودينگ -->
  <div class="reload-card">
    <div class="reload-head">
      <div class="brand-dot">A</div>
      <div class="reload-title">جاري تحديث الصفحة…</div>
      <div id="reloadTip" class="reload-sub">نحفظ شغلك أولاً ثم نحدّث</div>
    </div>

    <!-- حلقة متحركة + نسبة -->
    <div class="ring-wrap" aria-hidden="true">
      <div class="ring"></div>
      <div class="ring ring-2"></div>
      <div id="splashPct" class="ring-pct">0%</div>
    </div>

    <!-- شريط تقدّم -->
    <div class="progress">
      <div id="reloadBar" class="bar"></div>
    </div>

    <div class="reload-foot">
      <span class="chip">لا تغلق النافذة</span>
      <span class="chip">ثواني ونرجع لك</span>
    </div>
  </div>
</div>


<input type="file" id="importFile" accept="application/json" style="display:none">


<!-- Gate: شاشة تسجيل الدخول (جديدة بحركة ناعمة) -->
<div id="loginGate" class="gate" style="display:none">
  <div class="gate-card">
    <div class="gate-head">
      <div class="gate-logo">
        <span class="g-dot">A</span>
        <span class="g-name">ASSAL • دخول</span>
      </div>
      <div class="g-sub">سجّل دخولك للمتابعة</div>
    </div>

    <div class="gate-body">
      <input id="lgEmail" type="email" class="field gate-input" placeholder="الإيميل">
      <input id="lgPass"  type="password" class="field gate-input" placeholder="كلمة السر">
      <button id="lgBtn"  class="btn primary gate-btn">
        <span class="btn-txt">دخول</span>
        <span class="btn-spin" aria-hidden="true"></span>
      </button>
      <div id="lgMsg" class="gate-msg" role="status" aria-live="polite"></div>
    </div>
  </div>
</div>




<!-- مـودال الملاحظات -->
<div id="notesModalBackdrop" class="modal-backdrop"></div>
<div id="notesModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="notesModalTitle">
    <div class="modal-head" id="notesModalTitle">ملاحظات البطاقة</div>
    <div class="modal-body" style="width:100%;">
      <!-- قائمة ملاحظات داخل المودال -->
      <div id="notesModalList" class="notes-compact__list nice-scroll" style="max-height:200px;"></div>

      <!-- شريط إدخال داخل المودال -->
      <div class="notes-compact__bar" style="display:grid; grid-template-columns:1fr auto; gap:6px; margin-top:10px;">
        <input id="notesModalInput" class="field note-input-sm" placeholder="اكتب الملاحظة…"/>
        <button id="notesModalAdd" class="btn primary">
          <i class="fa-solid fa-plus"></i><span>إضافة</span>
        </button>
      </div>
    </div>

    <div class="modal-actions">
     <button id="notesModalClose" class="modal-btn close-red">إغلاق</button>
    </div>
  </div>
</div>



<!-- مودال تحديد تاريخ نقل الديون -->
<div id="transferModalBackdrop" class="modal-backdrop"></div>
<div id="transferModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="transferModalTitle">
    
    <div class="modal-head" id="transferModalTitle" style="display:flex;align-items:center;gap:8px;justify-content:center;">
      <i class="fa-solid fa-clipboard-check"></i>
      <span>تحديد آخر تاريخ نقل الديون</span>
    </div>

    <div class="modal-body" style="width:100%;display:flex;flex-direction:column;align-items:center;gap:12px;">
      
      <div class="transfer-hint">
  هذا هو تاريخ إقفال الديون السابقة. اختره ثم احفظ.
</div>


      <!-- القوائم المسندلة -->
      <div class="transfer-grid" style="text-align:start;">
        <select id="transferDay"   class="field" style="text-align:center;font-weight:800;" aria-label="اليوم"></select>
        <select id="transferMonth" class="field" style="text-align:center;font-weight:800;" aria-label="الشهر"></select>
        <select id="transferYear"  class="field" style="text-align:center;font-weight:800;" aria-label="السنة"></select>
      </div>

      <!-- أزرار حفظ/إغلاق -->
      <div class="transfer-actions">
        <button id="transferSaveBtn"  class="btn primary" style="min-width:120px;">
          <i class="fa-solid fa-floppy-disk"></i>
          <span>حفظ</span>
        </button>

        <button id="transferCloseBtn" class="btn close-red" style="min-width:80px;">
  <i class="fa-solid fa-xmark"></i>
  <span>إغلاق</span>
</button>

        
        
      </div>
    </div>
  </div>
</div>

<!-- خلفية تغطي الصفحة وتمنع لمس الخلفية -->
<div id="paymentsBackdrop" class="modal-backdrop"></div>

<!-- مودال الحسابات المالية -->
<div id="paymentsModal" class="modal">
  <div class="payments-shell nice-scroll">
    <!-- رأس النافذة -->
    <div class="payments-head">
      <div class="payments-title">
        <i class="fa-solid fa-wallet"></i>
        <span>الحسابات المالية</span>
      </div>

      <div class="payments-actions">
        
        
         <!-- زر البحث -->
<button id="searchPaymentsBtn" class="btn ghost payments-search-btn" title="بحث">
  <i class="fa-solid fa-magnifying-glass"></i>
  <span>بحث</span>
</button>

<!-- شريط البحث (مخفي افتراضياً) -->
<div id="paymentsSearchBar" class="payments-search" style="display:none;">
  <input id="paymentsSearchInput" class="field" type="text"
         placeholder="بحث بالتسديدات: اسم / ملاحظة / مبلغ…" autocomplete="off"/>
  <button id="paymentsSearchClear" class="btn ghost" title="مسح البحث">
    <i class="fa-solid fa-xmark"></i>
  </button>
</div>

        
        
        
        <!-- زر التصدير -->
        <button id="exportPaymentsBtn" class="btn ghost payments-export">
          <i class="fa-solid fa-file-export"></i>
          <span>تصدير</span>
        </button>

        <!-- زر اغلاق -->
        <button id="closePaymentsBtn" class="btn primary payments-close">
          <i class="fa-solid fa-xmark"></i>
          <span>إغلاق</span>
        </button>
        
        
       
        
        
      </div>
    </div>

   <form id="paymentsForm" class="payments-form">

  <!-- التاريخ -->
  <div class="pf-field pf-date">
    <input
      id="payDate"
      class="field"
      type="date"
    />
  </div>

  <!-- اسم الزبون + الاقتراحات -->
  <div class="pf-field pf-cust">
    <!-- هنشيل الـ label بعد شوي -->
    <input
      id="payCustomer"
      class="field"
      type="text"
      placeholder="اسم الزبون"
      autocomplete="off"
    />
    <div id="payCustSuggestions" class="pf-suggestions nice-scroll"></div>
  </div>

  <!-- النوع -->
  <div class="pf-field pf-type">
    <select id="payType" class="field">
      <option value="تسديد">تسديد</option>
      <option value="سحب">سحب</option>
    </select>
  </div>

  <!-- المبلغ -->
  <div class="pf-field pf-amount">
    <input
      id="payAmount"
      class="field"
      type="text"
      inputmode="numeric"
      placeholder="100,000"
    />
  </div>

  <!-- الملاحظات -->
  <div class="pf-field pf-notes">
    <input
      id="payNotes"
      class="field"
      type="text"
      placeholder="ملاحظة (اختياري)"
    />
  </div>

  <!-- زر إضافة -->
  <div class="pf-field pf-add">
    <button id="addPaymentBtn" type="submit" class="btn primary pf-add-btn">
      <i class="fa-solid fa-plus"></i>
      <span>إضافة</span>
    </button>
  </div>

</form>


 <!-- جدول المعاملات المدخولة (نفس فكرة العناصر اللي انت ترتبها بكارت/جدول داخل نفس النافذة بدون ما تطلع برا) :contentReference[oaicite:5]{index=5} -->
    <div class="payments-list-wrap nice-scroll">
     
     <div class="payments-list-wrap">
  <!-- ترويسة ثابتة -->
  <div class="payments-header-row">
    <div>#</div>
    <div>الاسم</div>
    <div>النوع</div>
    <div>المبلغ (د.ع)</div>
    <div>ملاحظات</div>
    <div>التاريخ</div>
    <div>الوقت</div>
    <div>حذف</div>
    <div>طباعة</div>
  </div>

  <!-- جسم الصفوف: هنا فقط يصير السكرول -->
  <div id="paymentsRows" class="payments-rows"></div>
</div>

    </div>
  </div>
</div>




<!-- نافذة توافقات قطع الغيار -->
<div id="compatBackdrop" class="modal-backdrop"></div>

<div id="compatModal" class="modal" aria-hidden="true">
  <div class="payments-shell compat-shell nice-scroll">
    <!-- رأس النافذة -->
    <div class="payments-head">
      <div class="payments-title">
        <i class="fa-solid fa-screwdriver-wrench"></i>
        <span>توافقات قطع الغيار</span>
      </div>

           <div class="payments-actions">

        <!-- أزرار وضع البحث: توافقات / أسعار -->
        <div class="compat-mode-toggle">
          <button
            id="compatModeCompat"
            type="button"
            class="btn ghost compat-mode-btn is-active">
            <i class="fa-solid fa-link"></i>
            <span>توافقات</span>
          </button>

          <button
            id="compatModePrice"
            type="button"
            class="btn ghost compat-mode-btn">
            <i class="fa-solid fa-tags"></i>
            <span>أسعار</span>
          </button>
        </div>

        <span id="compatCount" class="chip">—</span>

        <button id="closeCompatBtn" class="btn close-red">
          <i class="fa-solid fa-xmark"></i>
          <span>إغلاق</span>
        </button>
      </div>

    </div>

    <!-- جسم النافذة -->
    <div class="compat-body">
      <!-- شريط البحث -->
      <div class="compat-search-row">
  <!-- غلاف لحقل البحث + زر X داخله -->
  <div class="compat-search-input-wrap">
    <input
      id="compatSearchInput"
      class="field"
      type="text"
      placeholder="اكتب اسم الجهاز أو القطعة…"
      autocomplete="off"
    />

    <!-- زر مسح البحث X داخل الشريد -->
    <button id="compatSearchClear" class="compat-clear-btn" type="button" title="مسح البحث">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <!-- زر البحث يبقى مثل ما هو -->
  <button id="compatSearchBtn" class="btn primary">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span>بحث</span>
  </button>
</div>


      <!-- الاقتراحات -->
      <div id="compatSuggestions" class="compat-suggestions nice-scroll"></div>

      <!-- النتائج -->
      <div id="compatResults" class="compat-results nice-scroll">
        <div class="compat-empty">
          <i class="fa-regular fa-lightbulb"></i>
          <p>ابدأ بكتابة جزء من الاسم لعرض التوافقات.</p>
        </div>
      </div>
    </div>
  </div>
</div>





<!-- [NEW] نافذة اختيار هوية الحاسبة -->
<div id="roleBackdrop" class="modal-backdrop"></div>
<div id="roleModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-labelledby="roleTitle">
    <div class="modal-head" id="roleTitle">تحديد هوية الحاسبة</div>
    <div class="modal-body" id="roleMsg">اختر نوع هذه الحاسبة:</div>
    <div class="modal-actions">
      <button class="modal-btn" id="setRoleMain"  title="حاسبة رئيسية">حاسبة رئيسية</button>
      <button class="modal-btn danger" id="setRoleSub"  title="حاسبة فرعية (حفظ محلي فقط)">حاسبة فرعية (حفظ محلي فقط)</button>
      <button class="modal-btn ghost" id="closeRole">إغلاق</button>
    </div>
  </div>
</div>





  <!-- [NEW] مودال حجم تخزين المتصفح (تصميم احترافي) -->
  <div id="storageModalBackdrop" class="modal-backdrop"></div>
  <div id="storageModal" class="modal" aria-hidden="true">
    <div class="modal-card storage-modal-card"
         role="dialog"
         aria-modal="true"
         aria-labelledby="storageModalTitle">

      <div class="storage-header">
        <div class="storage-header-main">
          <div class="storage-icon-circle">
            <i class="fa-solid fa-database"></i>
          </div>
          <div>
            <div id="storageModalTitle" class="storage-title">
              حجم تخزين المتصفح
            </div>
            <div class="storage-subtitle">
              نظرة عامة على استخدام <span class="code-chip">localStorage</span> لهذا الجهاز.
            </div>
          </div>
        </div>

        <div id="storageBadge" class="storage-badge storage-badge-safe">
          حالة آمنة
        </div>
      </div>

      <div class="modal-body storage-body">
        <div class="storage-bar-outer">
          <div id="storageUsageBar" class="storage-bar-inner"></div>
        </div>

        <div class="storage-grid">
          <div class="storage-kpi">
            <div class="storage-kpi-label">المساحة المستخدمة</div>
            <div id="storageUsedKpi" class="storage-kpi-value">-</div>
          </div>
          <div class="storage-kpi">
            <div class="storage-kpi-label">المساحة المتبقية التقريبية</div>
            <div id="storageLeftKpi" class="storage-kpi-value">-</div>
          </div>
          <div class="storage-kpi">
            <div class="storage-kpi-label">نسبة الاستخدام</div>
            <div id="storagePctKpi" class="storage-kpi-value">-</div>
          </div>
        </div>

        <div id="storageUsageMain" class="storage-stats"></div>
        <div id="storageUsageMore" class="storage-stats storage-more"></div>

        <div class="storage-footer-note">
          القيم تقريبية وقد تختلف من متصفح لآخر. النسخ الاحتياطية على السيرفر تبقى آمنة دائماً حتى
          لو وصل المتصفح للحد الأقصى.
        </div>
      </div>

      <div class="modal-actions storage-actions">
        <button id="storageModalClose" class="modal-btn danger-solid">
          إغلاق
        </button>
      </div>
    </div>
  </div>





  <script>
    
    
    
    
  if(typeof window.IS_SIGNED_IN === 'undefined'){ window.IS_SIGNED_IN = false; }
  
  
  
  
  
  
    
    
    
    // ===== Excel DB (تحميل جوجل شيت) =====
let database = {};   // نخزّن بيه جداول الأصناف

// نفس رابطك (استخدم Google Sheets published XLSX)
const dropboxMainFile =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZww_ZDcqXnX6pUjlKccZdFUkRR9Z_JmfmdvNsnGVYT_rq_RTsSB1ydTy6QVrrS_o4s_ml1DNBTnaQ/pub?output=xlsx"
  + "&t=" + new Date().getTime();

async function loadExcelFiles(){
  try{
    const resp   = await fetch(dropboxMainFile, { cache: 'no-store' });
    const buffer = await resp.arrayBuffer();
    const wb     = XLSX.read(buffer, { type:"array" });

    database = {
      LCD       : XLSX.utils.sheet_to_json(wb.Sheets["LCD"]       || {}, {defval:null}),
      BATTERY   : XLSX.utils.sheet_to_json(wb.Sheets["BATTERY"]   || {}, {defval:null}),
      HOUSING   : XLSX.utils.sheet_to_json(wb.Sheets["HOUSING"]   || {}, {defval:null}),
      BACK      : XLSX.utils.sheet_to_json(wb.Sheets["BACK"]      || {}, {defval:null}),
      CAMERA    : XLSX.utils.sheet_to_json(wb.Sheets["CAMERA"]    || {}, {defval:null}),
      CHARGING  : XLSX.utils.sheet_to_json(wb.Sheets["CHARGING"]  || {}, {defval:null}),
      BUZZER    : XLSX.utils.sheet_to_json(wb.Sheets["BUZZER"]    || {}, {defval:null}),
      SPEAKER   : XLSX.utils.sheet_to_json(wb.Sheets["SPEAKER"]   || {}, {defval:null}),
      "FLAT SPEAKER": XLSX.utils.sheet_to_json(wb.Sheets["FLAT SPEAKER"] || {}, {defval:null}),
      FINGER    : XLSX.utils.sheet_to_json(wb.Sheets["FINGER"]    || {}, {defval:null}),
      "FLAT LCD": XLSX.utils.sheet_to_json(wb.Sheets["FLAT LCD"]  || {}, {defval:null}),
      POWER     : XLSX.utils.sheet_to_json(wb.Sheets["POWER"]     || {}, {defval:null}),
      VOLUME    : XLSX.utils.sheet_to_json(wb.Sheets["VOLUME"]    || {}, {defval:null}),
      LENS      : XLSX.utils.sheet_to_json(wb.Sheets["LENS"]      || {}, {defval:null}),
      HOLLDER      : XLSX.utils.sheet_to_json(wb.Sheets["HOLLDER"]      || {}, {defval:null})
      
    };

    // للتأكيد
    // console.log("DB loaded:", Object.keys(database));
  }catch(err){
    console.error("❌ خطأ تحميل:", err);
    showToast?.('error','تعذر تحميل بيانات الأصناف');
  }
}


// ===== فهرس بحث للأسعار (من الملف الرئيسي) =====
let priceIndex      = [];
let priceIndexBuilt = false;

function buildPriceIndexFromDatabase(){
  priceIndex      = [];
  priceIndexBuilt = false;

  if (!database || typeof database !== 'object') return;

  for (const [sheetName, rows] of Object.entries(database)){
    if (!Array.isArray(rows)) continue;

    rows.forEach(row => {
      const text = compatNormText(   // نفس تبسيط النص للتوافقات
        Object.values(row || {})
          .map(v => String(v ?? '').trim())
          .filter(Boolean)
          .join(' | ')
      );
      if (!text) return;
      priceIndex.push({ sheet: sheetName, row, text });
    });
  }

  priceIndexBuilt = true;
}

// بحث داخل كل الشيتات عن نص معيّن
function findPriceMatches(term){
  const q = compatNormText(term);
  if (!q || !priceIndex.length) return [];
  return priceIndex.filter(rec => rec.text.includes(q));
}










// ===== Compat Excel (توافقات قطع الغيار) =====

// صفوف التوافقات
let compatRows    = [];
let compatIndex   = [];
let compatLoaded  = false;
let compatLoading = null;

// رابط ملف التوافقات اللي انت عطيتني ياه
const compatFileUrl =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRZZFGe3dDXCCb9L5HtgpnXoj-H6kvqWeMS_tvYyWAL2VqpJh64rCMqRpoTaMw3v9fdazd5fWB5E2d/pub?output=xlsx"
  + "&t=" + new Date().getTime();

// تبسيط للنص (بحث أنظف)
function compatNormText(s){
  return String(s || '')
    .toLowerCase()
    // شيل كل أنواع المسافات
    .replace(/\s+/g, '')
    // لو تحب بعد تشيل شخوط / فواصل حتى يصير أذكى
    // .replace(/[-_/]+/g, '')
    .trim();
}



// تنسيق رقم كدينار عراقي (فوارز آلاف)
function formatIQD(value){
  if (value == null) return '';
  // نشيل أي شي مو رقم
  const cleaned = String(value).replace(/[^\d\-]/g, '');
  if (!cleaned) return '';

  const num = Number(cleaned);
  if (!Number.isFinite(num)) return String(value);

  // 14000 -> 14,000
  return num.toLocaleString('en-US'); // إذا تحب أرقام عربية سوّي 'ar-IQ'
}





// نبني نص البحث لكل سطر
function buildCompatIndex(){
  compatIndex = (Array.isArray(compatRows) ? compatRows : []).map(row => ({
    row,
    text: compatNormText(
      Object.values(row || {})
        .map(v => String(v ?? '').trim())
        .filter(Boolean)
        .join(' | ')
    )
  }));
}

// تحميل ملف التوافقات
async function loadCompatExcel(){
  if (compatLoaded && compatRows.length) return compatRows;
  if (compatLoading) return compatLoading;

  compatLoading = (async () => {
    try{
      const resp = await fetch(compatFileUrl, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      const buffer = await resp.arrayBuffer();
      const wb     = XLSX.read(buffer, { type:"array" });

      const sheetName = wb.SheetNames[0];
      if (!sheetName){
        compatRows   = [];
        compatLoaded = true;
        compatIndex  = [];
        return compatRows;
      }

      compatRows = XLSX.utils.sheet_to_json(
        wb.Sheets[sheetName] || {},
        { defval: '' }
      );

      compatLoaded = true;
      buildCompatIndex();
      // console.log('Compat DB loaded:', compatRows.length);
      return compatRows;

    }catch(err){
      console.error("❌ خطأ تحميل ملف التوافقات:", err);
      if (typeof showToast === 'function'){
        showToast('error','ما قدرنا نحمّل ملف توافقات قطع الغيار');
      }
      compatLoaded = false;
      compatRows   = [];
      compatIndex  = [];
      throw err;
    }finally{
      compatLoading = null;
    }
  })();

  return compatLoading;
}

// إرجاع كل الصفوف التي تحتوي نص البحث
function findCompatMatches(term){
  const q = compatNormText(term);
  if (!q || !compatIndex.length) return [];
  return compatIndex
    .filter(rec => rec.text.includes(q))
    .map(rec => rec.row);
}

// اقتراحات مبسّطة (نستخرج أول حقلين من كل سطر ونركب Label حلو)
function buildCompatSuggestions(term, limit = 12){
  const q = compatNormText(term);
  if (!q || !compatIndex.length) return [];

  const out  = [];
  const seen = new Set();

  for (const rec of compatIndex){
    if (!rec.text.includes(q)) continue;

    const values   = Object.values(rec.row || {});
    const primary  = values[0] != null ? String(values[0]).trim() : '';
    const secondary= values[1] != null ? String(values[1]).trim() : '';
    const label    = [primary, secondary].filter(Boolean).join(' — ') || primary || secondary || '';

    const key = label || rec.text;
    if (!key || seen.has(key)) continue;

    seen.add(key);
    out.push({ label, row: rec.row });

    if (out.length >= limit) break;
  }

  return out;
}




/* ================= PATCHED: Globals (new) ================= */
// هدنة منع السنك خلال عمليات معينة (زر السحب، بعد حفظ، ...)
let SYNC_BLOCK_UNTIL = 0;


// قائد تبويب لمنع سنكينج متزامن من جلسات متعددة
const SYNC_LEADER_KEY = 'ASSAL_SYNC_LEADER_V1';
const SYNC_LEADER_TTL = 30_000; // 30s
const TAB_ID = (Math.random().toString(36).slice(2) + Date.now().toString(36));


function isSyncLeader(){
try{
const raw = localStorage.getItem(SYNC_LEADER_KEY);
const obj = raw ? JSON.parse(raw) : null;
const now = Date.now();
if (!obj || (now - (obj.ts||0)) > SYNC_LEADER_TTL){
localStorage.setItem(SYNC_LEADER_KEY, JSON.stringify({ id:TAB_ID, ts: now }));
return true;
}
return obj.id === TAB_ID;
}catch{
return true; // في حال أي خطأ، اعتبر نفسك قائد
}
}


setInterval(()=>{
if (!window.IS_SIGNED_IN) return;
if (document.visibilityState !== 'visible') return;
const raw = localStorage.getItem(SYNC_LEADER_KEY);
const obj = raw ? JSON.parse(raw) : null;
if (!obj || obj.id === TAB_ID){
localStorage.setItem(SYNC_LEADER_KEY, JSON.stringify({ id:TAB_ID, ts: Date.now() }));
}
}, 5000);




// 👇 جديد
// آخر مرة المستخدم عدّل بيها شي (إضافة مادة, حذف سطر, تسديد, تغيير ملاحظة, ...)
// أول ما تفتح الصفحة نخليها 0
let LAST_EDIT_TS = 0;

// كم نطي "هدنة" قبل ما نسمح بالأوتو-مزامنة بعد أي تعديل محلي
// يعني خلال هالفترة، أي Sync خارجي ممنوع
const AUTO_SYNC_GRACE_MS = 10 * 1000; // 10 ثواني. تكدر تخليها 15000 = 15 ثانية.




/* ===== Auto Sync (every 15 min, no toast on load) ===== */

// مدة التزامن الدوري
const AUTO_SYNC_MS = 15 * 60 * 1000;

// أول مزامنة *بعد* تشغيل الصفحة (عدّلها مؤقتًا لـ 30s للفحص إذا تحب)
let firstAutoSyncAt = Date.now() + AUTO_SYNC_MS;

// ثروتل أمان حتى لو صار تعدد استدعاءات
const AUTO_SYNC_THROTTLE_MS = 15 * 60 * 1000;

// تتبع آخر مزامنة فعلية
let __lastAutoSyncAt = 0;
let __autoSyncTimer   = null;

// شروط جاهزية المزامنة التلقائية
function canAutoSyncNow(){
// ممنوع مزامنة تلقائية إذا الجهاز فرعي
if (typeof isSubDevice === 'function' && isSubDevice()) return false;


const now = Date.now();
if (now < firstAutoSyncAt) return false;
if (now - LAST_EDIT_TS < AUTO_SYNC_GRACE_MS) return false;
if (now < SYNC_BLOCK_UNTIL) return false; // الهدنة الجديدة
if (now - __lastAutoSyncAt < AUTO_SYNC_THROTTLE_MS) return false;
if (!window.IS_SIGNED_IN) return false;
if (!navigator.onLine) return false;
if (document.visibilityState !== 'visible') return false;
if (!isSyncLeader()) return false; // قائد التبويب فقط
return true;
}


let __syncAbortController = null;
function cancelInFlightSync(){ try{ __syncAbortController?.abort(); }catch{} __syncAbortController=null; }
function getSyncSignal(){ cancelInFlightSync(); __syncAbortController=new AbortController(); return __syncAbortController.signal; }


async function runAutoSync(){
if (typeof isSubDevice === 'function' && isSubDevice()) return;
if (!isSyncLeader()) return; // فقط القائد
if (!navigator.onLine) return;


const prevShowToast = window.showToast;
try{
window.showToast = function(){}; // ما نزعج المستخدم


// PUSH-ONLY: نرفع نسخة نظيفة بدون أي سحب
const payload = buildBackupPayload();
await serverPostBackup(payload, getSyncSignal());


__lastAutoSyncAt = Date.now();
}catch(e){
if (e.name !== 'AbortError') console.error('AutoSync failed:', e);
}finally{
window.showToast = prevShowToast;
}
prevShowToast && prevShowToast('info','تمت المزامنة التلقائية');
}




// حلقة تفقد خفيفة (كل 5 ثواني) لنشوف إذا حان وقت المزامنة
function startAutoSyncLoop(){
  if (__autoSyncTimer) clearInterval(__autoSyncTimer);
  __autoSyncTimer = setInterval(()=>{
    if (canAutoSyncNow()){
      runAutoSync();
    }
  }, 5000);
}

// حسّن السلوك عند العودة للتبويب
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible' && canAutoSyncNow()){
    runAutoSync();
  }
});

// ابدأ الحلقة بعد جاهزية الصفحة/تسجيل الدخول
startAutoSyncLoop();



/* ===== Dropdown الأصناف المخصّصة (8 مرئية + Scroll للأعلى) ===== */
let __catIdx = -1;



function showCatPanel(){
  const panel = document.getElementById('catPanel');
  if(!panel) return;
  panel.style.display = 'block';
  // دوران السهم
  document.querySelector('.cat-wrap')?.classList.add('open');
  __catIdx = -1;
  highlightCatItem();
}
function hideCatPanel(){
  const panel = document.getElementById('catPanel');
  if(panel) panel.style.display = 'none';
  // رجّع السهم لوضعه الطبيعي
  document.querySelector('.cat-wrap')?.classList.remove('open');
  __catIdx = -1;
  highlightCatItem();
}



function getCatItems(){ return Array.from(document.querySelectorAll('#catList .cat-item')); }
function highlightCatItem(){
  const items = getCatItems();
  items.forEach((li,i)=> li.classList.toggle('active', i===__catIdx));
  if(__catIdx >= 0 && items[__catIdx]){
    items[__catIdx].scrollIntoView({ block:'nearest' });
  }
}
function selectCatByIndex(i){
  const items = getCatItems();
  if(i < 0 || i >= items.length) return;
  const li = items[i];
  const val = li.getAttribute('data-val') || '';
  const input = document.getElementById('cat');
  if(input){
    input.value = val;                 // نخزن القيمة الإنجليزية
    hideCatPanel();
    // أشعل أحداثك الحالية المرتبطة بـ #cat (تعبئة اقتراحات/سعر...)
    input.dispatchEvent(new Event('change', { bubbles:true }));
    document.getElementById('item')?.focus();
  }
}

// فتح/إغلاق بالنقر على الحقل
document.getElementById('cat')?.addEventListener('click', (e)=>{
  e.stopPropagation();
  const panel = document.getElementById('catPanel');
  const visible = panel && panel.style.display === 'block';
  if(visible) hideCatPanel(); else showCatPanel();
});

// اختيار بالماوس
document.getElementById('catList')?.addEventListener('click', (e)=>{
  const li = e.target.closest('.cat-item');
  if(!li) return;
  const items = getCatItems();
  __catIdx = items.indexOf(li);
  selectCatByIndex(__catIdx);
});

// هايلايت مع حركة الماوس (اختياري)
document.getElementById('catList')?.addEventListener('mousemove', (e)=>{
  const li = e.target.closest('.cat-item');
  if(!li) return;
  const items = getCatItems();
  const idx = items.indexOf(li);
  if(idx !== -1 && idx !== __catIdx){
    __catIdx = idx;
    highlightCatItem();
  }
});

// تنقّل الكيبورد داخل قائمة الأصناف
// 2) تنقّل الكيبورد داخل قائمة الأصناف (ArrowUp/ArrowDown فقط)
// 2) تنقّل الكيبورد: ضفنا دعم ArrowLeft/ArrowRight كمكافئ لفوق/تحت
document.getElementById('cat')?.addEventListener('keydown', (e)=>{
  const panel = document.getElementById('catPanel');
  const visible = panel && panel.style.display === 'block';

  if(!visible){
    if(e.key === 'Enter' || e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'ArrowLeft' || e.key === 'ArrowRight'){
      e.preventDefault();
      showCatPanel();

      // عند الفتح من هنا، خليه يبدأ على LCD أيضًا
      const items = getCatItems();
      const lcdIndex = items.findIndex(li => (li.getAttribute('data-val')||'') === 'LCD');
      __catIdx = lcdIndex >= 0 ? lcdIndex : 0;
      highlightCatItem();
    }
    return;
  }

  const items = getCatItems();
  if(!items.length) return;

  // اعتبر Left مثل Up و Right مثل Down (مفيد مع RTL)
  const isDown = (e.key === 'ArrowDown' || e.key === 'ArrowRight');
  const isUp   = (e.key === 'ArrowUp'   || e.key === 'ArrowLeft');

  if(isDown){
    e.preventDefault();
    __catIdx = (__catIdx < 0) ? 0 : Math.min(items.length - 1, __catIdx + 1);
    highlightCatItem();
  }else if(isUp){
    e.preventDefault();
    __catIdx = (__catIdx < 0) ? items.length - 1 : Math.max(0, __catIdx - 1);
    highlightCatItem();
  }else if(e.key === 'Enter'){
    e.preventDefault();
    if(__catIdx >= 0) selectCatByIndex(__catIdx);
  }else if(e.key === 'Escape'){
    e.preventDefault();
    hideCatPanel();
  }
});

// إغلاق إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const panel = document.getElementById('catPanel');
  const field = document.getElementById('cat');
  if(!panel || !field) return;
  const inside = panel.contains(ev.target) || field.contains(ev.target);
  if(!inside) hideCatPanel();
});






// ===== أوتوكومبليت لاسم القطعة معتمد على الصنف المختار =====
let __autoIdx = -1;

function norm(s){ return String(s||'').replace(/\s+/g,'').toLowerCase(); }

function getSelectedCat(){
  const c = document.getElementById('cat')?.value || '';
  return c.trim();
}




function parseIQD(v){
  const s = String(v||'').replace(/[^\d.]/g,'');
  if(!s) return '';
  const n = Math.round(parseFloat(s));
  return isFinite(n) ? n : '';
}

function findPrice(cat, itemName){
  if(!cat || cat === 'NO-CATEGORY' || !itemName) return '';
  const list = database[cat] || [];
  const qn = norm(itemName);
  const row = list.find(r => norm(r["Item Name"] || r["Item"] || '') === qn);
  return row ? parseIQD(row["Discount Price"] ? row["Discount Price"] : row["Price"]) : '';
}


function tryFillPrice(){
  const cat  = getSelectedCat();
  const name = (document.getElementById('item')?.value || '').trim();
  const priceEl = document.getElementById('price');
  if(!priceEl) return;
  const p = findPrice(cat, name);
  if(p !== '') priceEl.value = formatIQD(p);  // 12,500
}






/* تحت دوال parseIQD / findPrice أضف: */
function formatIQD(v){
  const n = Number(String(v||'').replace(/[^\d.]/g,''));
  if(!isFinite(n)) return '';
  // نستخدم en-US حتى يطلع 12,500 (فوارز)
  return n.toLocaleString('en-US');
}


// ===== Price field one-time listeners =====
(function bindPriceField(){
  const priceInput = document.getElementById('price');
  if(!priceInput) return;
  priceInput.addEventListener('focus', ()=> priceInput.select?.());
  priceInput.addEventListener('input', ()=>{
    priceInput.value = priceInput.value.replace(/[^\d]/g,'');
  });
  priceInput.addEventListener('blur', ()=>{
    if(priceInput.value) priceInput.value = formatIQD(priceInput.value);
  });
})();



function activeCardsOfDay(dayKey){
  return (days[dayKey]||[]).filter(c=>{
    if (c?.deletedAt) return false;
    return (c.lines||[]).some(l=> !l.deletedAt);
  });
}
function activeLinesCountOfDay(dayKey){
  return (days[dayKey]||[]).reduce((sum,c)=>{
    if (c?.deletedAt) return sum;
    return sum + (c.lines||[]).filter(l=> !l.deletedAt).length;
  }, 0);
}




/* ===== IDs & Time helpers (أضِف) ===== */
function nowISO(){ return new Date().toISOString(); }
function genId(){ return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

/* اختصار مقارنة وقت: يرجّع true إذا tsB أحدث من tsA */
function isNewer(tsA, tsB){
  const a = tsA ? new Date(tsA).getTime() : 0;
  const b = tsB ? new Date(tsB).getTime() : 0;
  return b > a;
}












// دوال مساعدة جديدة (خليهم قبل/فوق renderItemSuggestions أو وياها نفس المنطقة)
function getItemLis(){
  const host = document.getElementById('itemSuggestions');
  return host ? Array.from(host.querySelectorAll('li.sugg-item')) : [];
}

function highlightAutoItem(){
  const lis = getItemLis();
  lis.forEach((li, i)=>{
    li.classList.toggle('is-active', i === __autoIdx);
  });
  if(__autoIdx >= 0 && lis[__autoIdx]){
    lis[__autoIdx].scrollIntoView({block:'nearest'});
  }
}

function renderItemSuggestions(){
  const host = document.getElementById('itemSuggestions');
  const qEl  = document.getElementById('item');
  if(!host || !qEl) return;

  const cat = getSelectedCat();
  const q   = norm(qEl.value.trim());

  host.innerHTML = '';
  host.style.display = 'none';
  __autoIdx = -1;

  // ماكو صنف أو هو NO-CATEGORY ؟ لا تعرض شي
  if(!cat || cat === 'NO-CATEGORY') return;

  const list = database[cat] || [];
  if(!q) return;

  const filtered = list.filter(row=>{
    const name = norm(row["Item Name"] || row["Item"] || '');
    return name.includes(q);
  });

  if(!filtered.length) return;

  filtered.forEach(row=>{
    const name = row["Item Name"] || row["Item"] || '';
    const li   = document.createElement('li');

    // بدال style.cssText و onmouseenter/onmouseleave
    // نخلي كلاس موحّد حتى الـ CSS يتحكم
    li.className = 'sugg-item';
    li.textContent = name;

    // كلك بالماوس يختار العنصر
    li.addEventListener('click', ()=>{
      qEl.value = name || '';
      host.style.display = 'none';

      // تعبئة السعر تلقائياً مثل قبل
      const priceEl = document.getElementById('price');
      if(priceEl){
        const p = findPrice(cat, name || '');
        if(p !== '') priceEl.value = formatIQD(p);
      }

      // روح مباشرة على الكمية
      const qtyEl = document.getElementById('qty');
      if(qtyEl){
        qtyEl.focus();
        if(qtyEl.select) qtyEl.select();
      }
    });

    host.appendChild(li);
  });

  host.style.display = 'block';

  // أول عنصر يكون مختار تلقائي
  __autoIdx = 0;
  highlightAutoItem();
}


function hideItemSuggestions(){
  const host = document.getElementById('itemSuggestions');
  if(host){ host.style.display = 'none'; __autoIdx = -1; }
}



// تحديث الاختيار حسب حركة الماوس (يطي تظليل مباشر)
document.getElementById('itemSuggestions')?.addEventListener('mousemove', (e)=>{
  const li = e.target.closest('.sugg-item');
  if(!li) return;

  const items = getItemLis();
  const idx = items.indexOf(li);

  if(idx !== -1 && idx !== __autoIdx){
    __autoIdx = idx;
    highlightAutoItem();
  }
});




// تريّغر العرض عند الكتابة وتغيير الصنف
document.getElementById('item')?.addEventListener('input', renderItemSuggestions);


document.getElementById('cat')?.addEventListener('change', ()=>{
  hideItemSuggestions();
  if((document.getElementById('item')?.value||'').trim()) renderItemSuggestions();
  // محاولة تعبية السعر حسب الاسم الحالي
  tryFillPrice();
});

// إذا المستخدم كتب/غيّر اسم المادة يدويًا ثم خرج من الحقل
document.getElementById('item')?.addEventListener('change', tryFillPrice);



// تنقّل الكيبورد داخل قائمة الاقتراحات
// تنقّل الكيبورد داخل قائمة اقتراح المواد
document.getElementById('item')?.addEventListener('keydown', (e)=>{
  const host = document.getElementById('itemSuggestions');
  const visible = host && host.style.display === 'block';

  // إذا القائمة ما مفتوحة
  if(!visible){
    if(e.key === 'Enter'){
      // إنتر بدون لست → روح للكمية
      e.preventDefault();
      const qtyEl = document.getElementById('qty');
      if(qtyEl){
        qtyEl.focus();
        if(qtyEl.select) qtyEl.select();
      }
    }
    return;
  }

  const items = getItemLis(); // بدل Array.from(... 'li')
  if(!items.length) return;

  // الأسهم: تغيير الاختيار
  if(e.key === 'ArrowDown' || e.key === 'ArrowUp'){
    e.preventDefault();
    const step = (e.key === 'ArrowDown') ? 1 : -1;

    if(__autoIdx < 0){
      __autoIdx = (e.key === 'ArrowDown') ? 0 : (items.length - 1);
    }else{
      __autoIdx = __autoIdx + step;
      if(__autoIdx < 0) __autoIdx = 0;
      if(__autoIdx > items.length - 1) __autoIdx = items.length - 1;
    }

    highlightAutoItem(); // يخلي is-active على العنصر المختار
  }

  // إنتر: اختار العنصر الحالي وعبّي كلشي
  if(e.key === 'Enter' && __autoIdx >= 0){
    e.preventDefault();

    const li = items[__autoIdx];
    const pickedName = li.textContent.trim();
    const qEl  = document.getElementById('item');
    const cat  = getSelectedCat();

    qEl.value = pickedName;
    hideItemSuggestions();

    // نفس منطق السعر الموجود بالـ click
    const priceEl = document.getElementById('price');
    if(priceEl){
      const p = findPrice(cat, pickedName);
      if(p !== '') priceEl.value = formatIQD(p);
    }

    // روح للكمية
    const qtyEl = document.getElementById('qty');
    if(qtyEl){
      qtyEl.focus();
      if(qtyEl.select) qtyEl.select();
    }
  }

  // Escape: غلق الليست
  if(e.key === 'Escape'){
    hideItemSuggestions();
  }
});


// إغلاق الاقتراحات إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const host = document.getElementById('itemSuggestions');
  const field= document.getElementById('item');
  if(!host || !field) return;
  const inside = host.contains(ev.target) || field.contains(ev.target);
  if(!inside) hideItemSuggestions();
});

    
    
    
    
    
    
    
    
    /* ============ بيانات محلية ============ */
    const STORAGE = 'assal:board:v3';
    const NAMES   = 'assal:names:v3';
    let globalLimit = 20;
    
    
    
    
    /* ================= [NEW] Device Role (Main/Sub) ================= */
const ROLE_KEY = 'assal:deviceRole'; // 'main' | 'sub'

// helpers
function getDeviceRole(){
  const r = (localStorage.getItem(ROLE_KEY) || '').trim();
  return (r === 'sub' ? 'sub' : (r === 'main' ? 'main' : '')); // فاضي = غير محدد
}
function isSubDevice(){ return getDeviceRole() === 'sub'; }
function setDeviceRole(role){
  localStorage.setItem(ROLE_KEY, role === 'sub' ? 'sub' : 'main');
  updateRoleUIState();
  showToast('success', role === 'sub' ? 'تم ضبط الهوية: حاسبة فرعية (حفظ محلي فقط)' : 'تم ضبط الهوية: حاسبة رئيسية');
}

// تحديث الواجهة (تعطيل زر الرفع عند الفرعية + توضيح التولتيب)
function updateRoleUIState(){
  const exportBtn = document.getElementById('btnExportAll');
  const importBtn = document.getElementById('btnImportAll');
  const roleBtn   = document.getElementById('btnDeviceRole');

  if(exportBtn){
    exportBtn.disabled = isSubDevice();          // منع رفع
    exportBtn.title = isSubDevice()
      ? 'غير متاح في الحاسبة الفرعية (حفظ محلي فقط)'
      : 'رفع النسخة للسيرفر';
  }
  if(importBtn){
    importBtn.disabled = false;                  // السحب دايمًا مسموح
    importBtn.title = isSubDevice()
      ? 'سحب نسخة السيرفر (سيتم استبدال المحلية)'
      : 'سحب النسخة من السيرفر (دمج ذكي)';
  }
  if(roleBtn){
    const r = getDeviceRole() || 'غير محددة';
    roleBtn.title = `تحديد هوية الحاسبة (الحالية: ${r === 'sub' ? 'فرعية' : (r === 'main' ? 'رئيسية' : 'غير محددة')})`;
  }
}

// نافذة الهوية (فتح/إغلاق + خيارات)
/* نافذة الهوية (فتح/إغلاق + خيارات) — [UPDATED: بدون أي confirm] */
(function initRoleModal(){
  const bd   = document.getElementById('roleBackdrop');
  const md   = document.getElementById('roleModal');
  const msg  = document.getElementById('roleMsg');
  const open = document.getElementById('btnDeviceRole');
  const close= document.getElementById('closeRole');
  const btnM = document.getElementById('setRoleMain');
  const btnS = document.getElementById('setRoleSub');

  function openModal(){
    // [CHANGED] نخلي الرسالة عامة دائمًا بدون تلميح للتحويل/تأكيد
    msg.textContent = 'اختر نوع هذه الحاسبة: رئيسية أو فرعية (الحفظ محلي فقط للفرعية).';
    bd.classList.add('active');
    md.classList.add('active');
    document.body.classList.add('modal-open');
  }
  function closeModal(){
    bd.classList.remove('active');
    md.classList.remove('active');
    document.body.classList.remove('modal-open');
  }

  open?.addEventListener('click', openModal);
  close?.addEventListener('click', closeModal);
  bd?.addEventListener('click', (e)=>{ if(e.target === bd) closeModal(); });

  // [CHANGED] بدون أي confirm — تغيير فوري
  btnM?.addEventListener('click', ()=>{
    setDeviceRole('main');   // يحدّث الواجهة ويعرض toast جاهز
    closeModal();
  });

  // [CHANGED] بدون أي confirm — تغيير فوري
  btnS?.addEventListener('click', ()=>{
    setDeviceRole('sub');    // يحدّث الواجهة ويعرض toast جاهز
    closeModal();
  });

  // تهيئة أولية لحالة الأزرار
  updateRoleUIState();
})();


    
    
    
    
    
    /* ====== SYNC CONFIG ====== */
const SYNC = {
  // بدّل <your-subdomain> إذا طالع لك دومين مخصص؛
  // إذا ما عندك دومين مخصص استعمل workers.dev مالك مثل الظاهر أدناه:
  BASE_URL: "https://assal-proxy.ahmed-al-bayatii-90.workers.dev/",
  TOKEN   : "Assal_1990"
};
    
    /* ====== قائمة أسماء الزبائن اليدوية (عدّلها على راحتك) ====== */
const CUSTOMERS = [
  "ابو همام - الكهربائي",
  "ابو مهند - بلدروز",
  "ابو يونس",
  "احمد الدليمي",
  "احمد الغزالي",
   "احمد طلال - وي رسول سابقا",
   "احمد 7 نيسان",
  "احمد تكسي - ابو مينا",
  "احمد سمير",
  "احمد كاسبر",
   "احمد عسل",
  "احمد الاشكر - تكسي",
   "اشرف غالبية",
   "مصطفى - نانا",
  "احمد عباس - تحرير",
  "احمد عسل - بلدروز",
  "احمد علي - كنعان",
  "احمد محسن - مندلي",
  "احمد محمد داودي",
  "ادم شروين",
  "ادم صيانة - 2",
  "انور دبي",
  "ايسر - سومر",
   "اثير حارث - سمعو عسل",
   "ابو احمد - سايق قزانية",
   "اسامة - حكم",
  "حارث - خان بني سعد",
  "حازم الغوالبة",
  "حسين ابل",
  "حسين بيروت - الكاطون",
  "حسين حنو",
  "حسين سعيد",
  "حسين علي - خان بني سعد",
  "حسين قزانية - ايسر بيروت",
  "حمزة كرايب ادم",
  "حيدر اركان",
   "حيدر عربية",
  "حيدر متعب - العظيم",
   "زياد الفضاء",
  "رسول كنعان",
  "رسول وي سامر",
  "رشيد مرسى سابقا",
  "زياد CBU - الاسود",
  "سامر العنبكي - صيانة",
  "سامر عبداللطيف",
  "سالم - مكتب المهندس",
  "ستار - المرسى 2",
  "سجاد - ماستر",
  "سعد غيلان",
  "سلوان - عمار جيزاني",
  "سمعو عسل",
  "ايوب - حديد",
  "مهند - خرنابات",
  "سيف سنتر - 2",
  "سامر عسل",
  "شاكر هبهب",
  "شعبان هبهب - حسين نانة",
  "صلاح المبرمج",
  "طالب جيزاني",
  "طيف المعموري - خان بني سعد",
  "عادل مندلي",
  "عباس حديد",
  "عبدالرحمن هبهب",
  "عبدالله سعد - خان",
   "عبد الباقي - صيانة",
  "عدنان هزاع - ابو مينا",
  "عزام ابراهيم - دورة",
  "عصام روتانا",
  "علي الحاتمية - وي نشوان",
  "علي الساحل - 2",
  "علي السادة",
  "علي هباوي - جامعة",
  "عماد هاتف خان - حبوب",
  "عمار سوفت",
  "عمار - مكتب ميوزك",
  "عواد - دوجمة",
  "عمر الباوي",
  "عمر سلفة - عسل",
  "غالب اكرم",
  "غسان هويدر",
  "فاضل - مكتب الساعة",
  "فراس - سايق اربيل",
  "كريم حديد",
  "كوري",
  "م. محمد - ابو مينا",
  "ماجد زيونة",
  "مازن العالمية",
  "محمد - مكتب بابل",
  "محمد ابو السلفة",
  "محمد الباقر - ايسر بيروت",
  "محمد خرنابات",
  "محمد سحاب",
  "محمد سمعو",
  "محمد صخرة",
  "محمد قحطان - ابو القسط",
  "محمد م. الموج",
  "محمد مجول",
  "محمد مؤيد دورة",
  "محمد هاشم السادة",
  "محمد هبهب",
  "محمد - تقاطع السادة",
   "محمد عسل",
  "محمد حميد - ياسر تحرير",
   "محمد - خانقين",
  "محي - قرة تبة",
  "مرتضى سراجق",
  "مركز التطور",
  "مصطفى - خان بني سعد",
  "مصطفى - وية همام",
  "مصطفى السادة",
  "مصطفى برج دبي",
  "مصطفى ثامر - الوثبة",
  "مصطفى طارق - كوكل",
  "مصطفى عسل",
  "مكتب القمة - راس الشارع",
  "مكتب الماسة",
  "مكتب الهرم - 2",
  "مهند سراجق",
  "نشوان - الحاتمية",
  "نظير مرهج - العظيم",
  "نور - مركز بيروت",
  "همام - اخو ادم",
  "همام ظاهر",
  "هيثم - فروسية",
  "وسام جمعة - اخو حيدر جمعة",
  "ياسر بهرز",
  "ياسر شفتة",
  "ياسر غالبية",
  "ياسر فون - مجاور عزت عشتار",
  "سيف سنتر - 1",
   "سيف علي - خان بني سعد",
  "ملك صيانة",
  "اجور رواتب موظفي عسل",
  "مصاريف نثرية",
  "مصاريف نقل وانتقال",
  "قتيبة - حديد",
  "عبدالملك - قزانية",
  "مصطفى زيونة",
  "صدام - عسل",
  "محمد - تقاطع السادة",
  "هيثم - ميديا تك",
   "هارون سلفة",
  "محمد كنعان",
  "محمود الميرديان",
  "ايسر سراجق",
  "مهندس حسام دور الزراعة",
  "حسين - اخو ابو هنادي",
  "نوري",
  "ياسين البدراني"
];



// مساعد: يرجّع ارتفاع شريط البورد اللاصق
    const boardHeadH = ()=> (document.querySelector('.board-head')?.offsetHeight || 0);

    const $  = (s)=> document.querySelector(s);
    const CE = (t, c)=>{ const e = document.createElement(t); if(c) e.className=c; return e; };

    const todayISO      = ()=> new Date().toISOString().slice(0,10);
    const TODAY         = todayISO();              // ← ثابت لليوم الحالي

    const arDateWithDay = (d)=> new Date(d).toLocaleDateString('ar-EG',{weekday:'long',year:'numeric',month:'2-digit',day:'2-digit'});
    const arMonthName   = (d)=> new Date(d).toLocaleDateString('ar-EG',{year:'numeric',month:'long'});
    const arTime        = (d)=> new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});

    let days        = load(STORAGE, {});
    let names       = load(NAMES, []);
    let selectedDay = todayISO();
    
    
    Object.defineProperty(window, 'days', { get(){ return days; } });
Object.defineProperty(window, 'selectedDay', { get(){ return selectedDay; } });
    
    

    function load(k, d){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); }catch{ return d; } }
    
function save(){
localStorage.setItem(STORAGE, JSON.stringify(days));
LAST_EDIT_TS = Date.now(); // حتى نمنع المزامنة مباشرة بعد أي تعديل
SYNC_BLOCK_UNTIL = Date.now() + 20_000; // هدنة 20 ثانية إضافية
}






/* ===================== تاريخ نقل الديون ===================== */

/* مفتاح التخزين المحلي للتاريخ */
const TRANSFER_DATE_KEY = 'ASSAL_TRANSFER_DATE';

/* helper: قراءة التاريخ من localStorage كـ 'YYYY-MM-DD' أو '' */
function getTransferDateIso(){
  return load(TRANSFER_DATE_KEY, '');
}

/* helper: حفظ التاريخ */
function setTransferDateIso(iso){
  localStorage.setItem(TRANSFER_DATE_KEY, JSON.stringify(iso || ''));
}

/* helper: صفرين */
function _pad2Local(n){
  n = Number(n)||0;
  return n < 10 ? ('0' + n) : String(n);
}

/* helper: رجع ستايل التوست مثل:
   تم النقل لغاية (الأحد | 26-10-2025)
*/
function formatTransferToastMsg(isoStr){
  if(!isoStr){
    return 'ما محدد تاريخ نقل ديون بعد';
  }
  // isoStr شكلها "YYYY-MM-DD"
  const [y,m,d] = isoStr.split('-');
  const dt = new Date(`${y}-${m}-${d}T00:00:00`);
  if(!Number.isFinite(dt.getTime())){
    return 'تاريخ غير صالح';
  }

  // اسم اليوم بالعربي من نفس المتصفح
  const weekdayAr = dt.toLocaleDateString('ar-EG',{ weekday:'long' });

  return `تم النقل لغاية (${weekdayAr} | ${d}-${m}-${y})`;
}

/* نملأ اللستات (اليوم/الشهر/السنة) كل مرة نفتح المودال */
function populateTransferSelects(){
  const selDay   = document.getElementById('transferDay');
  const selMonth = document.getElementById('transferMonth');
  const selYear  = document.getElementById('transferYear');

  if(!selDay || !selMonth || !selYear) return;

  // حضّر اليوم 1..31
  selDay.innerHTML = '';
  for(let dd=1; dd<=31; dd++){
    const opt = document.createElement('option');
    opt.value = String(dd);
    opt.textContent = dd; // نخليها رقم عربي عادي
    selDay.appendChild(opt);
  }

  // حضّر الشهر 1..12
  selMonth.innerHTML = '';
  for(let mm=1; mm<=12; mm++){
    const opt = document.createElement('option');
    opt.value = String(mm);
    opt.textContent = mm;
    selMonth.appendChild(opt);
  }

  // حضّر السنة (خلي نطاق محترم، تكدر توسعه براحتك)
  selYear.innerHTML = '';
  const currentY = (new Date()).getFullYear();
  for(let yy=currentY-5; yy<=currentY+5; yy++){
    const opt = document.createElement('option');
    opt.value = String(yy);
    opt.textContent = yy;
    selYear.appendChild(opt);
  }

  // حاول تهيئة القيم من آخر تاريخ مخزَّن، إذا موجود
  let iso = getTransferDateIso();
  let initY, initM, initD;
  if(iso){
    const parts = iso.split('-'); // [YYYY,MM,DD]
    initY = Number(parts[0]||0);
    initM = Number(parts[1]||0);
    initD = Number(parts[2]||0);
  }else{
    // إذا ماكو شي مخزون، خلّي اليوم الحالي
    const now = new Date();
    initY = now.getFullYear();
    initM = now.getMonth()+1; // 1..12
    initD = now.getDate();    // 1..31
  }

  selYear.value  = String(initY);
  selMonth.value = String(initM);
  selDay.value   = String(initD);
}

/* فتح المودال */
function openTransferModal(){
  populateTransferSelects();

  document.getElementById('transferModalBackdrop')?.classList.add('active');
  document.getElementById('transferModal')?.classList.add('active');

  // قفل السكرول على الخلفية (نفس نمط notesModal) :contentReference[oaicite:14]{index=14}
  document.body.classList.add('modal-open');

  // فوكس أول شي على اليوم
  const selDay = document.getElementById('transferDay');
  if(selDay){
    requestAnimationFrame(()=>{
      selDay.focus();
    });
  }
}

/* غلق المودال */
function closeTransferModal(){
  document.getElementById('transferModalBackdrop')?.classList.remove('active');
  document.getElementById('transferModal')?.classList.remove('active');
  document.body.classList.remove('modal-open');
}

/* حفظ التاريخ المختار */
/* حفظ التاريخ المختار + رفعه فوراً للسيرفر */
async function saveTransferDate(){
  const selDay   = document.getElementById('transferDay');
  const selMonth = document.getElementById('transferMonth');
  const selYear  = document.getElementById('transferYear');

  if(!selDay || !selMonth || !selYear) return;

  const d  = _pad2Local(selDay.value);
  const m  = _pad2Local(selMonth.value);
  const y  = String(selYear.value||'').trim();

  if(!d || !m || !y){
    showToast?.('warn','اختيار التاريخ غير كامل');
    return;
  }

  // نبني التاريخ بصيغة ISO: YYYY-MM-DD
  const iso = `${y}-${m}-${d}`;

  // خزّنه محلياً (localStorage)
  setTransferDateIso(iso);

  // سكّر المودال مباشرة حتى المستخدم يحس كلشي خلص
  closeTransferModal();

  // خبر المستخدم شنو آخر تاريخ نقل
  showToast('success', formatTransferToastMsg(iso));

  // جداً مهم:
  // فوراً نرفع النسخة (اليوم/الكروت/الأسماء + تاريخ النقل) إلى السيرفر
  // حتى الأجهزة الثانية من تستورد تشوف نفس التاريخ
  try{
    await smartExportToServer();
    // إذا تحب تبينله أنه التاريخ اتسنتر على السيرفر فعلاً، خليه هذا التوست:
    showToast('info','تم تحديث تاريخ نقل الديون على السيرفر');
  }catch(err){
    console.error('فشل رفع تاريخ النقل للسيرفر:', err);
    showToast('warn','انحفظ التاريخ هنا محلي بس فشل الرفع للسيرفر');
  }
}


/* عرض توست "آخر تاريخ نقل" بدون فتح المودال */
function showTransferToast(){
  const iso = getTransferDateIso();
  showToast('info', formatTransferToastMsg(iso));
}

/* ====== تحكم الكيبورد داخل المودال (Enter → التالي) ====== */
/*
  sequence:
    transferDay   + Enter   → transferMonth.focus()
    transferMonth + Enter   → transferYear.focus()
    transferYear  + Enter   → transferSaveBtn.focus()
    transferSaveBtn + Enter → saveTransferDate()
  Escape بأي مكان → closeTransferModal()
*/
function wireTransferModalKeyNav(){
  const d = document.getElementById('transferDay');
  const m = document.getElementById('transferMonth');
  const y = document.getElementById('transferYear');
  const s = document.getElementById('transferSaveBtn');
  const c = document.getElementById('transferCloseBtn');

  if(d){
    d.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        m?.focus();
      }else if(e.key==='Escape'){
        e.preventDefault();
        closeTransferModal();
      }
    });
  }

  if(m){
    m.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        y?.focus();
      }else if(e.key==='Escape'){
        e.preventDefault();
        closeTransferModal();
      }
    });
  }

  if(y){
    y.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        s?.focus();
      }else if(e.key==='Escape'){
        e.preventDefault();
        closeTransferModal();
      }
    });
  }

  if(s){
    s.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        saveTransferDate();
      }else if(e.key==='Escape'){
        e.preventDefault();
        closeTransferModal();
      }
    });
  }

  if(c){
    c.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key==='Escape'){
        e.preventDefault();
        closeTransferModal();
      }
    });
  }

  // كليك طبيعي للأزرار
  s?.addEventListener('click', saveTransferDate);
  c?.addEventListener('click', closeTransferModal);
}

/* ====== ربط الأزرار في الهيدر مع المودال/التوست ====== */
function wireTransferHeaderButtons() {
  const btnOpen  = document.getElementById('btnTransferOpen');
  const btnToast = document.getElementById('btnTransferToast');

  // نستخدم onclick بدل addEventListener
  // - إذا الدالة تنعاد أكثر من مرة ما راح يصير تكديس أحداث
  // - وإذا DOM انبنى من جديد، نثبت الهاندلر من جديد
  if (btnOpen) {
    btnOpen.onclick = openTransferModal;
  }

  if (btnToast) {
    btnToast.onclick = showTransferToast;
  }
}


/* استدعِ هذا بعد ما الـDOM يجهز (عندك اصلاً نهاية الملف تربط واي أزرار مثل btnImportAll.onclick = smartImportFromServer وغيره) :contentReference[oaicite:15]{index=15} */
function initTransferFeature(){
  wireTransferHeaderButtons();
  wireTransferModalKeyNav();
}

/* ناديناها */
initTransferFeature();




    
    
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  /* ====== Enter Navigation (جديد) ====== */
/* التسلسل المطلوب: cust -> type -> cat -> item -> qty -> note */
const order = ['cust','type','cat','item','price','qty','note'];


function openSelect(el){
  try{
    el.focus();
    if(typeof el.showPicker === 'function'){ el.showPicker(); }
    else{
      // fallback: ركّز وخلّي المستخدم ينزل بالسهم (ماكو API موحّد لكل المتصفحات)
      // نرسل ArrowDown كإشارة خفيفة (قد لا تعمل بكل المتصفحات)
      const ev = new KeyboardEvent('keydown', { key:'ArrowDown', bubbles:true });
      el.dispatchEvent(ev);
    }
  }catch(_){}
}

order.forEach((id, idx)=>{
  const el = document.getElementById(id);
  el.addEventListener('keydown', (e)=>{
    if(e.key !== 'Enter') return;
    e.preventDefault();

   if(id === 'cust'){
  // إذا قائمة الاقتراحات مفتوحة، خلّي مستمع الكيبورد أعلاه يتكفّل
  const vis = document.getElementById('custSuggestions')?.style.display === 'block';
  if(vis) return;

  // ماكو قائمة → تاليها نوع الفاتورة كالعادة
  const target = document.getElementById('type');
  openSelect(target);
  return;
}


  // 1) Enter على نوع الفاتورة: افتح القائمة وحدّد LCD مباشرة
if(id === 'type'){
  const catField = document.getElementById('cat');
  catField?.focus();

  // افتح القائمة
  showCatPanel();

  // ابحث عن فهرس "شاشات" (data-val="LCD") وخلّه محدّد
  const items = getCatItems();
  const lcdIndex = items.findIndex(li => (li.getAttribute('data-val')||'') === 'LCD');
  __catIdx = lcdIndex >= 0 ? lcdIndex : 0;   // إذا ما لقاها، خليه على أول عنصر
  highlightCatItem();

  // الآن إذا ضغطت Enter مرة ثانية فورًا يختارها
  return;
}


   if (id === 'note') {
  // أضف السطر
  document.getElementById('btnAdd').click();

  // رجّع الفوكس إلى "اسم الزبون"
  setTimeout(()=>{
    const target = document.getElementById('cust');
    target.focus();
    target.select?.();
  }, 0);

  return;
}

    // باقي الحقول تتنقل للتالي بشكل طبيعي
    const next = document.getElementById(order[idx+1]);
    if(next){
      next.focus();
      next.select?.();
      if(next.tagName === 'SELECT') openSelect(next);
    }
  });
});




/* ===== Toasts: صف واحد دائمًا + تباعد أنيق ===== */
const __toastQueue = [];
let __toastBusy = false;

function showToast(type='info', message='تم التنفيذ', timeout=2200){
  // ندفع دائمًا للصف — ما نعتمد على حالة السلاش
  __toastQueue.push({ type:type.toLowerCase(), message, timeout });
  if(!__toastBusy) processToastQueueUnified();
}

async function processToastQueueUnified(){
  __toastBusy = true;
  const host = document.getElementById('toasts');
  if(!host){ __toastBusy=false; return; }

  while(__toastQueue.length){
    const {type, message, timeout} = __toastQueue.shift();
    const t = document.createElement('div');
    t.className = `toast ${['success','warn','error','info'].includes(type)?type:'info'}`;
    t.setAttribute('role','status');

    const icon = document.createElement('div');
    icon.className='toast__icon';
    icon.innerHTML = ({
      success:'<i class="fa-solid fa-check"></i>',
      warn   :'<i class="fa-solid fa-triangle-exclamation"></i>',
      error  :'<i class="fa-solid fa-xmark"></i>',
      info   :'<i class="fa-solid fa-circle-info"></i>'
    })[type] || '<i class="fa-solid fa-circle-info"></i>';

    const msg = document.createElement('div');
    msg.className='toast__msg';
    msg.textContent = message || 'تم التنفيذ';

    // زر الإغلاق مخفي عندك أصلًا
    const btn = document.createElement('button');
    btn.className='toast__close';
    btn.title='إغلاق';
    btn.innerHTML='<i class="fa-solid fa-xmark"></i>';

    let closed = false;
    function dismiss(){
      if(closed) return;
      closed = true;
      t.style.animation='toast-out-top .22s ease-in both';
      setTimeout(()=> t.remove(), 180);
    }
    btn.onclick = dismiss;

    t.append(icon, msg, btn);
    // سقف 3 مرئيات (الطابور يضمن واحد بواحد، بس نخلي تنظيف احتياطي)
    while(host.children.length >= 3){ host.removeChild(host.firstElementChild); }
    host.appendChild(t);

    await new Promise(res=>{
      const timer = setTimeout(()=>{ dismiss(); res(); }, timeout);
    });

    // تباعد لطيف بين الرسالة واللي بعدها
    await new Promise(res=> setTimeout(res, 220));
  }
  __toastBusy = false;
}






    /* ====== Modal API ====== */
    const $modal  = $('#modal');
    const $back   = $('#modal-backdrop');
    const $mtitle = $('#modal-title');
    const $mbody  = $('#modal-body');
    const $mok    = $('#modal-confirm');
    const $mcancel= $('#modal-cancel');

    function showConfirm({title='تأكيد', message='هل أنت متأكد؟', okText='تأكيد', cancelText='إلغاء', danger=true}={}){
      return new Promise((resolve)=>{
        $mtitle.textContent = title;
        $mbody.innerHTML    = message;
        $mok.textContent    = okText;
        $mcancel.textContent= cancelText;
        $mok.classList.toggle('danger', !!danger);
        
        
        if (danger) {
  $mok.style.setProperty('background','linear-gradient(180deg,#5f0b0b,#7a0e0e)','important');
  $mok.style.setProperty('color','#fff','important');
  $mok.style.setProperty('border-color','#7f1d1d','important');
  $mok.style.setProperty('box-shadow','0 12px 28px rgba(127,29,29,.35)','important');
} else {
  $mok.style.removeProperty('background');
  $mok.style.removeProperty('color');
  $mok.style.removeProperty('border-color');
  $mok.style.removeProperty('box-shadow');
}

        
        

        $back.classList.add('active');
        $modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        const done = (val)=>{
          $back.classList.remove('active');
          $modal.classList.remove('active');
          document.body.style.overflow = '';
          $mok.onclick = null;
          $mcancel.onclick = null;
          resolve(val);
        };

        $mok.onclick     = ()=> done(true);
        $mcancel.onclick = ()=> done(false);
        document.onkeydown = (e)=>{ if(e.key === 'Escape'){ /* مقفلة */ } };
      });
    }

/* ====== إضافة سطر (ذكي لليوم السابق) ====== */
// ==== إضافة سطر مع تحذير عند الإضافة ليوم سابق (نسخة مُحدَّثة جاهزة للاستبدال) ====
document.getElementById('btnAdd').onclick = async () => {
  const customer = (document.getElementById('cust').value || '').trim();
  const item     = (document.getElementById('item').value || '').trim();
  const priceVal = Number(parseIQD(document.getElementById('price').value) || 0);
  let   qty  = String(document.getElementById('qty').value || '1').trim();
  const cat  = (document.getElementById('cat').value || '').trim();
  const type = (document.getElementById('type').value || 'بيع').trim(); // بيع / راجع
  const note = (document.getElementById('note').value || '').trim();

  if (!customer || !item) return;
  if (!/^\d+$/.test(qty)) qty = '1';
  if (!days[selectedDay]) days[selectedDay] = [];

  // ===== تحذير اليوم السابق (نفس رسائل الكود القديم) =====
  const warnedCreate = (window.__warnedPastCardCreate ||= new Set()); // key: day::customer
  const warnedAppend = (window.__warnedPastCardAppend ||= new Set()); // key: day::cardId
  const todayKey = (() => { const now=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`; })();
  const isPastDay = (selectedDay < todayKey);

  // ابحث عن البطاقة
  let cardIndex = days[selectedDay].findIndex(c => c.customer === customer && !c.deletedAt);
  let card = days[selectedDay][cardIndex];

  // ——— تحذير قبل إنشاء بطاقة جديدة في يوم سابق ———
  if (!card && isPastDay) {
    const createKey = `${selectedDay}::${customer}`;
    if (!warnedCreate.has(createKey)) {
      const ok = await (typeof showConfirm === 'function'
        ? showConfirm({
            title: 'تأكيد إضافة إلى يوم سابق',
            message: 'أنت حاليًا سوف تُضيف سطرًا إلى بطاقة في يوم سابق. هل تود المتابعة؟',
            okText: 'نعم',
            cancelText: 'لا',
            danger: true
          })
        : Promise.resolve(true));
      if (!ok) return; // إلغاء
      warnedCreate.add(createKey);
    }
  }

  const nowISOVal2 = (typeof nowISO === 'function') ? nowISO() : new Date().toISOString();
  const makeId     = (typeof genId  === 'function') ? genId  : (() => String(Date.now()));

  if (!card){
    // إنشاء بطاقة جديدة (سلوكك الآمن الحالي)
    card = { id: Date.now(), customer, lines: [], createdAt: nowISOVal2, updatedAt: nowISOVal2, paidAll:false, billType: type };
    days[selectedDay].unshift(card);
    cardIndex = 0;
  }else{
    // ——— تحذير قبل إضافة سطر لبطاقة موجودة في يوم سابق ———
    if (isPastDay) {
      const appendKey = `${selectedDay}::${card.id}`;
      if (!warnedAppend.has(appendKey)) {
        const ok = await (typeof showConfirm === 'function'
          ? showConfirm({
              title: 'تأكيد إضافة إلى يوم سابق',
              message: 'أنت حاليًا سوف تُضيف سطرًا إلى بطاقة في يوم سابق. هل تود المتابعة؟',
              okText: 'نعم، تابع',
              cancelText: 'لا',
              danger: true
            })
          : Promise.resolve(true));
        if (!ok) return; // إلغاء
        warnedAppend.add(appendKey);
      }
    }
    // توحيد نوع الفاتورة بحالة الخلط (مثل كودك)
    if (card.billType && card.billType !== type) card.billType = 'مختلط';
    if (!card.billType) card.billType = type;
  }

  // إذا البطاقة كانت فاضية قبل هالسطر، حدّث createdAt
  if (!Array.isArray(card.lines) || !card.lines.some(l => !l.deletedAt)) {
    card.createdAt = nowISOVal2;
  }

  // أضف السطر
  card.lines ||= [];
  card.lines.push({
    lineId   : makeId(),
    item, cat, price: priceVal, qty, note, type,
    paid: false, returned: (type==='راجع'),
    createdAt: nowISOVal2,
    updatedAt: nowISOVal2,
    at: nowISOVal2,
    deletedAt: null
  });

  // حدّث آخر نشاط وارفع البطاقة للأعلى (حذرًا)
  card.updatedAt = nowISOVal2;

  if (typeof cardIndex !== 'number') {
    cardIndex = (days[selectedDay]||[]).findIndex(c => c && c.id === card.id);
  }
  if (cardIndex > 0) {
    days[selectedDay].splice(cardIndex, 1);
    days[selectedDay].unshift(card);
  } else if (cardIndex === -1) {
    if (!days[selectedDay].includes(card)) days[selectedDay].unshift(card);
  }

  save();

  // تنظيف الحقول
  document.getElementById('item').value  = '';
  document.getElementById('price').value = '';
  document.getElementById('qty').value   = '';
  document.getElementById('note').value  = '';
  document.getElementById('item').focus();

  renderBoard?.();
  renderRail?.();
  refreshStats?.();
  focusNewCard?.(card);
  showToast?.('success','تمت الإضافة');
};











// استبدال كامل للدالة القديمة
function rebuildNames(){
  // لم نعد نستخدم <datalist> لاقتراحات الزبائن.
  // خَلّيناه no-op حتى ما ينهار الكود لو بقت مناداته بمكان.
}





// احسب عدد الملاحظات (يتجاهل المحذوفة)
function getNotesCount(card){
  const arr = (card && Array.isArray(card.notes)) ? card.notes : [];
  return arr.filter(n => !n.deletedAt).length;
}

// ضمن الزر: يظهر/يخفي البادج حسب العدد
function updateNotesBadge(btnNotes, card){
  if(!btnNotes) return;
  const badge = btnNotes.querySelector('.notes-count');
  if(!badge) return;
  const n = getNotesCount(card);
  if(n > 0){
    badge.textContent = n;
    badge.hidden = false;
  }else{
    badge.hidden = true;
  }
}



try{ window.__assalPayments = (function(){ 
  const raw = localStorage.getItem('assal.payments.v1') || '{}';
  return JSON.parse(raw) || {};
})(); }catch{}



    /* ====== رسم اللوح ====== */
    
function renderBoard() {
  const host = document.getElementById('masonry');
  if (!host) return;
  host.innerHTML = '';

  const q = (document.getElementById('cardSearch')?.value || '').trim().toLowerCase();
  const global = document.getElementById('globalSearch')?.checked;

  // نجمع البطاقات
  const collect = (d) => (days[d] || []).map(c => ({ ...c, __day: d }));
  let pool = [];

  if (global) {
    const allDaysKeys = Object.keys(days || {}).sort().reverse();
    allDaysKeys.forEach(d => { pool.push(...collect(d)); });
  } else {
    pool = collect(selectedDay);
  }

  // نختار بس البطاقات الفعّالة (مو محذوفة وبيها أقل شي سطر واحد مو محذوف)
  const isActiveCard = (c) => !c.deletedAt && (c.lines || []).some(l => !l.deletedAt);
  pool = pool.filter(isActiveCard);

  // فلترة حسب اسم الزبون
  let arr = q ? pool.filter(c => (c.customer || '').toLowerCase().includes(q)) : pool;

  // ترتيب بالبحث الشامل: الأحدث فوق
  if (global) {
    arr.sort(
      (a, b) =>
        new Date(b.updatedAt || b.createdAt) -
        new Date(a.updatedAt || a.createdAt)
    );
  }

  // عداد عدد البطاقات
  const totalCount = arr.length;
  if (global) {
    const sliced = arr.slice(0, globalLimit);
    document.getElementById('cardsCount').textContent =
      `${sliced.length} / ${totalCount} بطاقة`;
    arr = sliced;
  } else {
    document.getElementById('cardsCount').textContent = `${arr.length} بطاقة`;
  }

  // ماكو نتائج
  if (!arr.length) {
    host.innerHTML = `
      <div style="border:1px dashed var(--stroke);background:#0b1327;border-radius:14px;padding:16px;text-align:center;color:#9aa4b2">
        لا توجد بطاقات${global ? ' مطابقة في كل الأيام' : ' اليوم'}
      </div>
    `;
    // مهم حتى زر "آخر تاريخ نقل" يبقى مربوط
    wireTransferHeaderButtons();
    return;
  }

  // أرسم كل بطاقة
  arr.forEach((card) => {
    if (card.deletedAt) return;

    dedupeCardLines(card);

    const box = CE('div', 'card');
    box.id = 'card-' + card.id;

    /* ===== الهيدر مال البطاقة ===== */
    const head = CE('div', 'card-head');

    const custWrap = CE('div', 'cust');
    const custName = CE('span');
    custName.textContent = card.customer;
    custWrap.appendChild(custName);

    // بادج "زبون جديد" إذا مو ضمن القائمة المعروفة CUSTOMERS
    const isKnownCustomer = CUSTOMERS.includes(card.customer);
    if (!isKnownCustomer) {
      const newBadge = CE('span', 'badge-new');
      newBadge.textContent = 'زبون جديد';
      custWrap.appendChild(newBadge);
    }

    // نوع الفاتورة (بيع / راجع / مختلط). إذا مو مخزّن نحسبه من السطور
    let billType = card.billType;
    if (!billType) {
      const types = Array.from(new Set((card.lines || []).map(l => l.type)));
      billType = (types.length === 1) ? types[0] : 'مختلط';
      card.billType = billType;
    }

    const typeBadge = CE(
      'span',
      'badge-type ' + (
        billType === 'راجع'
          ? 'return'
          : billType === 'بيع'
            ? 'sell'
            : ''
      )
    );
    const typeLabel =
      billType === 'راجع'
        ? 'فاتورة راجع'
        : billType === 'بيع'
          ? 'فاتورة بيع'
          : 'فاتورة مختلطة';
    typeBadge.textContent = typeLabel;
    custWrap.appendChild(typeBadge);

    // بادج "تم تسديد مواد اليوم" إذا كله مدفوع
    if (card.paidAll || (card.lines.length && card.lines.every(l => l.paid))) {
      card.paidAll = true;
      const paidBadge = CE('span', 'bill-badge');
      paidBadge.textContent = 'تم تسديد مواد اليوم';
      custWrap.appendChild(paidBadge);
    }

    // جهة اليمين بالهيدر: تاريخ الفاتورة + الوقت
    const rightWrap = CE('div');
    rightWrap.style.display = 'flex';
    rightWrap.style.gap = '6px';

    const dateTag = CE('span', 'tag');
    dateTag.textContent = fmtDMY(card.__day || selectedDay); // dd-mm-yyyy

    const timeTag = CE('span', 'tag');
    timeTag.textContent = arTime(card.createdAt);

    rightWrap.append(dateTag, timeTag);
    head.append(custWrap, rightWrap);
    box.appendChild(head);

    /* ===== السطور (المواد) ===== */
    const itemsWrap = CE('div', 'items');

    (card.lines || [])
      .filter(ln => !ln.deletedAt) // لا تعرض السطور المعلمة محذوف
      .forEach((ln) => {
        const it = CE('div', 'item');
        if (ln.returned) it.classList.add('returned');
        if (ln.paid) it.classList.add('paid');

        const btnReturn = CE('button', 'btn-mini btn-return');
        btnReturn.innerHTML = '<i class="fa-solid fa-rotate-left"></i>';
        btnReturn.title = 'راجع';

        const btnPay = CE('button', 'btn-mini btn-pay');
        btnPay.innerHTML = '<i class="fa-solid fa-check"></i>';
        btnPay.title = 'تسديد';

        const name = CE('div', 'iname');
        name.textContent = ln.item;

        const cat = CE('div', 'ichip');
        cat.textContent = ln.cat || '—';

        const price = CE('div', 'iprice');
        price.textContent =
          (ln.price === 0 || ln.price) ? formatIQD(ln.price) : '—';

       const qty = CE('div', 'iqty');
       qty.textContent = `× ${ln.qty}`;


        const note = CE('div', 'inote');
        note.textContent =
          (ln.note && ln.note.trim()) ? ln.note : '—';

        const time = CE('div', 'itime');
        const ts = ln.at || ln.createdAt || ln.updatedAt;
        time.textContent = arTime(ts);

        const del = CE('button', 'btn-mini btn-del');
        del.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
        del.title = 'حذف';

        // بادج حالة (مدفوع / راجع) جنب اسم المادة
        const badge = CE('span', 'badge');
        setBadge(badge, ln);
        if (badge.textContent) name.appendChild(badge);

        it.append(
          btnReturn,
          btnPay,
          cat,
          name,
          price,
          qty,
          note,
          time,
          del
        );

        // ===== تبديل "راجع" للسطر =====
        btnReturn.onclick = () => {
          ln.returned = !ln.returned;
          if (ln.returned) ln.paid = false;

          ln.updatedAt = nowISO();

          // مهم: حدّث البطاقة الأصلية الحقيقة (مو بس نسخة العرض) حتى ما يصير تناقض بعدين
          const realCard = getMutableCard(card) || card;
          realCard.updatedAt = ln.updatedAt;

          save();
          renderBoard();
          renderRail();
          refreshStats();

          showToast(
            ln.returned ? 'warn' : 'info',
            ln.returned ? 'تم تعليمها راجع' : 'تم إلغاء الراجع'
          );
        };

        // ===== تبديل "مدفوع" للسطر =====
        btnPay.onclick = () => {
          ln.paid = !ln.paid;
          if (ln.paid) ln.returned = false;

          ln.updatedAt = nowISO();

          const realCard = getMutableCard(card) || card;
          realCard.updatedAt = ln.updatedAt;

          save(); // بنفس فكرتك، بعدين ممكن يصير export للسيرفر
          renderBoard();
          renderRail();
          refreshStats();

          showToast(
            ln.paid ? 'success' : 'info',
            ln.paid ? 'تم تسديد المادة' : 'تم إلغاء التسديد'
          );
        };

        // ===== حذف السطر (الإصلاح الحقيقي تبع مشكلتك الأولى) =====
        del.onclick = async () => {
          const ok = await showConfirm({
            title: 'تأكيد حذف السطر',
            message: `هل تريد حذف "${ln.item}"؟`,
            okText: 'حذف',
            cancelText: 'إلغاء',
            danger: true
          });
          if (!ok) return;

          // نجيب النسخة الحقيقية من البطاقة (حتى لو انت فاتح بحث شامل لكل الأيام)
          const realCard = getMutableCard(card) || card;

          // نحدد نفس السطر جوّا البطاقة الحقيقية
          let realLine = (realCard.lines || []).find(
            l => l === ln || l.lineId === ln.lineId
          );
          if (!realLine) {
            // احتياط إذا لأي سبب ما لقيناه
            realLine = ln;
          }

          const delTs = nowISO();
          realLine.deletedAt = delTs;
          realLine.updatedAt = delTs;

          // حدّث وقت البطاقة الحقيقية حتى الدمج/الفرز يحترم آخر تعديل
          realCard.updatedAt = delTs;

          save();
          renderBoard();
          renderRail();
          refreshStats();

          showToast('error', 'تم تعليم السطر كمحذوف');
        };

        itemsWrap.appendChild(it);
      });

    box.appendChild(itemsWrap);

    /* ===== ملاحظات البطاقة (mini timeline جوّا البطاقة) ===== */
    if (!Array.isArray(card.notes)) card.notes = [];

    const notesBox = CE('div', 'notes-compact');
    const notesList = CE('div', 'notes-compact__list');

    const notesBar = CE('div', 'notes-compact__bar');
    const noteInput = CE('input', 'field note-input-sm');
    noteInput.placeholder = 'اكتب الملاحظة…';
    const noteAddBtn = CE('button', 'btn primary note-add-mini');
    noteAddBtn.title = 'إضافة ملاحظة';
    noteAddBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';

    notesBar.append(noteInput, noteAddBtn);
    notesBox.append(notesList, notesBar);
    box.appendChild(notesBox);

    // دالة وقت عربي مختصر
    const tinyTime = (d) =>
      new Date(d).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

    function renderNotes() {
      notesList.innerHTML = '';

      const arrNotes = (card.notes || [])
        .filter(n => !n.deletedAt)
        .sort((a, b) => new Date(b.at) - new Date(a.at));

      arrNotes.forEach((n, i) => {
        const row = CE('div', 'note-row');
        row.style.minWidth = '0';

        const pill = CE('div', 'note-pill');
        pill.style.minWidth = '0';

        const idxEl = CE('div', 'note-pill__idx');
        idxEl.textContent = i + 1;

        const txtEl = CE('div', 'note-pill__text');
        txtEl.textContent = n.text || '';

        const tmEl = CE('div', 'note-pill__time');
        tmEl.innerHTML =
          '<i class="fa-regular fa-clock"></i>' +
          tinyTime(n.at || n.createdAt || new Date());

        pill.append(idxEl, txtEl, tmEl);

        const delNote = CE('button', 'note-del-out');
        delNote.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
        delNote.title = 'حذف الملاحظة';
        delNote.onclick = () => {
          n.deletedAt = nowISO();
          save();
          renderNotes();
          renderBoard(); // حتى البادج والعداد يتحدّث
          showToast('error', 'تم حذف الملاحظة');
        };

        row.append(pill, delNote);
        notesList.appendChild(row);
      });
    }

    function doAddNote() {
      const val = (noteInput.value || '').trim();
      if (!val) return;
      if (addCardNote(card, val)) {
        noteInput.value = '';
        renderNotes();
        showToast('success', 'تمت إضافة الملاحظة');
        setTimeout(() => noteInput.focus(), 0);
      }
    }

    noteAddBtn.onclick = doAddNote;
    noteInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doAddNote();
      }
    });

    // أول رسم للملاحظات
    renderNotes();

    /* ===== الفوتر (الإجماليات + الأزرار تحت) ===== */
    const foot = CE('div', 'card-foot');

    const left = CE('div');
    const sums = sumCardAmounts(card);
    left.innerHTML = `
      <span class="sum-badge sum--items">مواد: ${(card.lines || []).filter(l => !l.deletedAt).length}</span>
      <span class="sum-badge sum--total">المجموع: ${formatIQD(sums.total)}</span>
      <span class="sum-badge sum--unpaid">غير مدفوع: ${formatIQD(sums.unpaid)}</span>
    `;

    const right = CE('div', 'foot-actions');

    // زر PDF
    const btnPdf = CE('button', 'i-btn');
    btnPdf.innerHTML = '<i class="fa-regular fa-file-pdf"></i><span>PDF</span>';
    btnPdf.title = 'طباعة هاي البطاقة فقط';
    btnPdf.onclick = () => {
      exportCardPDF_Vector(card, card.__day || selectedDay);
    };

    // زر "تسديد الكل"
    const btnPayAll = CE('button', 'i-btn');
    card.paidAll = allActivePaid(card);
    stylePayAll(btnPayAll, card);

    btnPayAll.onclick = () => {
      if (!card.lines.length) return;
      const active = activeLines(card);
      if (active.length === 0) return;

      const allPaidBefore = active.every(l => l.paid);
      const makePaid = !allPaidBefore;

      active.forEach(l => { l.paid = makePaid; });
      card.paidAll = allActivePaid(card);

      card.updatedAt = new Date().toISOString();

      save();
      renderBoard();
      renderRail();
      refreshStats();

      showToast(
        makePaid ? 'success' : 'info',
        makePaid ? 'تم تسديد كل المواد' : 'تم إلغاء تسديد الكل'
      );
    };

    // زر حذف البطاقة كاملة
    const btnDelCard = CE('button', 'i-btn');
    btnDelCard.innerHTML = '<i class="fa-regular fa-trash-can"></i><span>حذف البطاقة</span>';
    btnDelCard.title = 'حذف البطاقة';
    btnDelCard.onclick = async () => {
      const ok = await showConfirm({
        title: 'تأكيد حذف البطاقة',
        message: `سيتم حذف بطاقة "${card.customer}" بكافة موادها.`,
        okText: 'حذف البطاقة',
        cancelText: 'إلغاء',
        danger: true
      });
      if (!ok) return;

      // إذا انت بوضع البحث الشامل، لازم نحذف من يومها الحقيقي
      const dayKey = card.__day || selectedDay;
      const arrRef = (days[dayKey] || []);
      const real = arrRef.find(c => c.id === card.id);
      if (real) {
        const tsDel = nowISO();
        real.deletedAt = tsDel;
        real.updatedAt = tsDel;
        save();
      }

      renderBoard();
      renderRail();
      refreshStats();

      showToast('error', 'تم حذف البطاقة');
    };

    // زر ملاحظات (المودال الرئيسي مالت الملاحظات)
    const btnNotes = CE('button', 'i-btn');
    btnNotes.innerHTML = `
      <i class="fa-regular fa-note-sticky"></i>
      <span>ملاحظات</span>
      <b class="badge notes-count" hidden>0</b>
    `;
    btnNotes.title = 'إضافة/استعراض ملاحظات البطاقة';
    btnNotes.onclick = () => openNotesModal(card);

    // حدّث عداد الملاحظات
    updateNotesBadge(btnNotes, card);

    right.append(btnPdf, btnPayAll, btnNotes, btnDelCard);
    foot.append(left, right);
    box.appendChild(foot);

    host.appendChild(box);
  });

  // زر "عرض المزيد" إذا جاي تستعرض كل الأيام
  if (global && totalCount > arr.length) {
    const more = CE('button', 'i-btn');
    more.style.margin = '8px auto 0';
    more.innerHTML = '<i class="fa-solid fa-angles-down"></i><span>عرض المزيد</span>';
    more.onclick = () => {
      globalLimit += 20;
      renderBoard();
    };
    host.appendChild(more);
  }

  // ✨ مهم لمشكلتك الثانية:
  // كل مرة نرسم البورد، نرجع نربط أزرار "آخر تاريخ نقل الديون"
  wireTransferHeaderButtons();
}




// حالة المودال الحالية
let __activeNotesCard = null;

// تنسيقات عنصر واحد (نفس ستايل الكبسولة داخل البطاقة)
function makeNoteRow(n, idx){
  const row  = CE('div','note-row');
  const pill = CE('div','note-pill');

  const idxEl = CE('div','note-pill__idx');  idxEl.textContent = idx;
  const txtEl = CE('div','note-pill__text'); txtEl.textContent = n.text || '';
  const tmEl  = CE('div','note-pill__time');
  tmEl.innerHTML = '<i class="fa-regular fa-clock"></i>' + tinyTime(n.at || n.createdAt || new Date());

  pill.append(idxEl, txtEl, tmEl);

  // زر حذف بسيط ضمن المودال
  const del = CE('button','note-del-out');
  del.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
  del.title = 'حذف الملاحظة';
  del.onclick = () => {
    n.deletedAt = nowISO();
    save();
    renderNotesModalList();
    renderBoard();   // حتى تنعكس داخل البطاقة أيضاً
    showToast('error','تم حذف الملاحظة');
  };

  row.append(pill, del);
  return row;
}

// وقت عربي قصير (موجود شبيه داخل ملفك)
function tinyTime(d){
  return new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
}

// افتح المودال على بطاقة معيّنة
function openNotesModal(card){
  // اربط على الأصل المخزّن داخل days (حتى لو اللي ظاهر نسخة بحث)
  const real = (typeof getMutableCard === 'function' ? getMutableCard(card) : null) || card;

  __activeNotesCard = real;
  if (!Array.isArray(__activeNotesCard.notes)) __activeNotesCard.notes = [];

  renderNotesModalList();

  document.getElementById('notesModalBackdrop').classList.add('active');
  document.getElementById('notesModal').classList.add('active');

  // فوكس مؤكد بعد عرض المودال
  requestAnimationFrame(() => {
    const inp = document.getElementById('notesModalInput');
    if (inp) { inp.focus(); inp.select(); }
  });

  // قفل تمرير الخلفية
  document.body.classList.add('modal-open');
}


// ارسم القائمة داخل المودال (أحدث وقت أولاً)
function renderNotesModalList(){
  const list = document.getElementById('notesModalList');
  const arr = (__activeNotesCard.notes || [])
    .filter(n => !n.deletedAt)
    .sort((a,b)=> new Date(b.at || b.createdAt) - new Date(a.at || a.createdAt)); // تأكيد الترتيب
  list.innerHTML = '';
  arr.forEach((n, i)=> list.appendChild(makeNoteRow(n, arr.length - i)));
}

// إغلاق المودال
function closeNotesModal(){
  document.getElementById('notesModalBackdrop').classList.remove('active');
  document.getElementById('notesModal').classList.remove('active');
  __activeNotesCard = null;

  // رجّع تمرير الخلفية طبيعي
  document.body.classList.remove('modal-open');
}

// إضافة من داخل المودال
function addNoteFromModal(){
  const inp  = document.getElementById('notesModalInput');
  const text = (inp && inp.value ? inp.value : '').trim();
  if (!text || !__activeNotesCard) return;

  // اشتغل على الأصل داخل days حتى تبقى الملاحظة بعد الإغلاق
  const real = (typeof getMutableCard === 'function' ? getMutableCard(__activeNotesCard) : null) || __activeNotesCard;
  if (!Array.isArray(real.notes)) real.notes = [];

  real.notes.push({
    id: (typeof crypto !== 'undefined' && crypto.randomUUID)
          ? crypto.randomUUID()
          : (Date.now() + '-' + Math.random().toString(16).slice(2)),
    text,
    at: (typeof nowISO === 'function') ? nowISO() : new Date().toISOString()
  });

  real.updatedAt = (typeof nowISO === 'function') ? nowISO() : new Date().toISOString();

  // خزّن وأعد الرسم حتى يبان كلشي مباشرة
  try { if (typeof save === 'function') save(); } catch(_){}
  try { if (typeof renderNotesModalList === 'function') renderNotesModalList(); } catch(_){}
  try { if (typeof renderBoard === 'function') renderBoard(); } catch(_){}

  if (inp) inp.value = '';
  try { if (typeof showToast === 'function') showToast('success','انضافت الملاحظة'); } catch(_){}
}



// ربط أزرار المودال
document.getElementById('notesModalClose').onclick = closeNotesModal;
document.getElementById('notesModalBackdrop').onclick = closeNotesModal; // اغلاق عند الضغط خارج
document.getElementById('notesModalAdd').onclick = addNoteFromModal;

// عناصر المودال
const _mi = document.getElementById('notesModalInput');
const _ma = document.getElementById('notesModalAdd');
const _mc = document.getElementById('notesModalClose');

// Enter بالحقل → يروح على زر الإضافة
_mi?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  _ma?.focus();
});

// Enter على زر الإضافة → يضيف + يحوّل الفوكس لزر الإغلاق
_ma?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  addNoteFromModal();
  setTimeout(()=> _mc?.focus(), 0);
});

// Enter على زر الإغلاق → يغلق
_mc?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  closeNotesModal();
});
    
  
  function activeLines(card){ return (card.lines||[]).filter(l => !l.deletedAt && !l.returned); }

  
  
function allActivePaid(card){
  const a = activeLines(card);
  return a.length>0 && a.every(l => l.paid);
}



/* سكرول مضمونة للكارت الجديد بعد الريندر */
/* سكرول مضمونة للكارت الجديد بعد الريندر */


/* سكرول مضمونة للكارت الجديد بعد الريندر (أسفل شريط البحث بمسافة صغيرة) */
function focusNewCard(card){
  const el = document.getElementById('card-' + card.id);
  if(!el) return;

  requestAnimationFrame(()=>{
    const header  = document.querySelector('.ribbon');
    const headerH = header ? header.offsetHeight : 0;
    const bh      = boardHeadH();   // ارتفاع .board-head اللاصق
    const gap     = 16;             // المسافة الأنيقة المطلوبة أسفل الشريط

    // خَلّي أعلى البطاقة يبتعد بمقدار gap تحت أسفل الشريط
    const absTop = el.getBoundingClientRect().top + window.pageYOffset;
    const y = Math.max(0, absTop - (headerH + bh + gap));

    window.scrollTo({ top: y, behavior: 'smooth' });

    el.classList.add('flash-card');
    setTimeout(()=> el.classList.remove('flash-card'), 1600);
  });
}



    
    
  
    
    
    

    /* ===== Helpers ===== */
    
  
    
    
   // (جديد) رجّع الكارت الأصلي المخزَّن داخل days اعتمادًا على __day + id
function getMutableCard(viewCard){
  if(!viewCard) return null;
  const dayKey = viewCard.__day || selectedDay;
  const arr = days[dayKey] || [];
  const idx = arr.findIndex(c => c.id === viewCard.id);
  return idx >= 0 ? arr[idx] : null;
}

function addCardNote(viewCard, text){
  if(!viewCard || !text) return false;

  // اشتغل على الأصل داخل days (حتى ينحفظ فعليًا)
  const real = getMutableCard(viewCard);
  if(!real) return false;

  real.notes ||= [];
  // وحّد المرجع مع الكارت المعروض حتى تتحدّث الواجهة فورًا
  viewCard.notes = real.notes;

 const t = nowISO();
real.notes.push({
  id: genId(),
  text,
  at: t,
  updatedAt: t,
  deletedAt: null
});
real.updatedAt = t;


  // حدّث آخر نشاط (يفيد بالفرز حسب updatedAt إن موجود)
  real.updatedAt = new Date().toISOString();

  save();
  return true;
}

function deleteCardNote(viewCard, noteId){
  if(!viewCard) return false;

  const real = getMutableCard(viewCard);
  if(!real || !Array.isArray(real.notes)) return false;

  const i = real.notes.findIndex(n => n.id === noteId);
  if(i === -1) return false;

 const n = real.notes[i];
if(n){
  n.deletedAt = nowISO();
  n.updatedAt = n.deletedAt;
}
real.updatedAt = nowISO();


  // وحّد المرجع مع الكارت المعروض
  viewCard.notes = real.notes;
  save();
  return true;
}


 
 
 
 function stylePayAll(btn, cardRef){
  const allPaidNow = allActivePaid(cardRef);
  if(allPaidNow || cardRef.paidAll){
    btn.classList.remove('primary'); btn.classList.add('ghost');
    btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i><span>إلغاء التسديد</span>';
    btn.title = 'إلغاء تسديد المواد غير الراجعة';
  }else{
    btn.classList.remove('ghost'); btn.classList.add('primary');
    btn.innerHTML = '<i class="fa-solid fa-check-double"></i><span>تسديد الكل</span>';
    btn.title = 'تسديد كل المواد غير الراجعة';
  }
}

 
 
 
    function wrapName(name, cat, badge){
      const box = CE('div');
      box.style.display='flex'; box.style.alignItems='center'; box.style.gap='6px';
      box.append(name, cat); if(badge.textContent) box.appendChild(badge);
      return box;
    }
    function setBadge(el, ln){
      el.textContent = ln.returned ? 'راجع' : (ln.paid ? 'تم التسديد' : '');
      el.style.display = el.textContent ? 'inline-flex' : 'none';
    }
    
    
    
    
    
    /* ===== تنسيقات مساعدة للفلترة ===== */
function pad2(n){ n = String(n); return n.length===1 ? '0'+n : n; }
function fmtDMY(iso){ // 'YYYY-MM-DD' -> 'DD-MM-YYYY'
  if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const [y,m,d] = iso.split('-'); return `${d}-${m}-${y}`;
}
function fmtMY(iso){ // 'YYYY-MM-DD' -> 'MM-YYYY'
  if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const [y,m] = iso.split('-'); return `${m}-${y}`;
}
function getYear(iso){ return /^\d{4}-\d{2}-\d{2}$/.test(iso) ? iso.slice(0,4) : iso; }

/* تحضير مُرشِّح حسب إدخال المستخدم */
function makeFilterPredicate(fraw){
  const f = (fraw||'').trim();
  if(!f) return ()=>true;

  // أنماط مدعومة:
  // 1) DD-MM-YYYY  2) MM-YYYY  3) YYYY
  const dmy = /^(\d{2})-(\d{2})-(\d{4})$/;
  const my  = /^(\d{2})-(\d{4})$/;
  const y   = /^(\d{4})$/;

  if(dmy.test(f)){
    const [_, dd, mm, yyyy] = f.match(dmy);
    const want = `${dd}-${mm}-${yyyy}`;
    return (iso)=> fmtDMY(iso) === want;
  }
  if(my.test(f)){
    const [_, mm, yyyy] = f.match(my);
    const want = `${mm}-${yyyy}`;
    return (iso)=> fmtMY(iso) === want;
  }
  if(y.test(f)){
    const [_, yyyy] = f.match(y);
    return (iso)=> getYear(iso) === yyyy;
  }

  // لو نص حر، نجرّب contains على صيغتنا
  const s = f.toLowerCase();
  return (iso)=> (fmtDMY(iso).toLowerCase().includes(s) ||
                  fmtMY(iso).toLowerCase().includes(s)  ||
                  getYear(iso).toLowerCase().includes(s));
}

    
    
    
    
// ===== Rail — شهر واحد فقط + منطق العبور (آخر يوم ↔ أول يوم) =====
function renderRail(){
  const host = document.getElementById('rail');
  host.innerHTML = '';

  // الافتراضي: نعرض يومين فقط (تقدر تخليها 5 إذا تريد)
  const DAYS_LIMIT = 2;

  // كل الأيام المتوفرة (بنزول)
  const allDays = Object.keys(days || {}).sort().reverse();

  // نضمن TODAY ضمن القائمة حتى لو مو موجود ببيانات days
  if (typeof TODAY === 'string' && !allDays.includes(TODAY)) {
    allDays.unshift(TODAY);
  }

  // فلترة البحث (إن وجدت)
  const fraw = (document.getElementById('dayFilter')?.value || '').trim();
  const match = (typeof makeFilterPredicate === 'function') ? makeFilterPredicate(fraw) : (() => true);
  const isFiltering = !!fraw;

  // أدوات تواريخ
  const pad2 = n => String(n).padStart(2,'0');
  const toStr = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  const parseYMD = (s) => {
    const y = +s.slice(0,4);
    const m = +s.slice(5,7);
    const d = +s.slice(8,10);
    return {y, m, d};
  };
  const firstOfMonthStr = (y,m) => `${y}-${pad2(m)}-01`;
  const lastOfPrevMonthStr = (y,m) => {
    const dt = new Date(`${y}-${pad2(m)}-01T00:00:00`);
    dt.setDate(0); // يوم 0 = آخر يوم من الشهر السابق
    return toStr(dt);
  };
  const firstOfNextMonthStr = (y,m) => {
    const dt = new Date(`${y}-${pad2(m)}-01T00:00:00`);
    dt.setMonth(dt.getMonth() + 1); // أول يوم للشهر القادم
    return toStr(dt);
  };
  const lastOfMonthStr = (y,m) => {
    const dt = new Date(`${y}-${pad2(m)}-01T00:00:00`);
    dt.setMonth(dt.getMonth() + 1);
    dt.setDate(0);
    return toStr(dt);
  };

  // نبني شجرة [سنة -> شهر -> أيام]
  const tree = {};
  allDays.forEach(k => {
    const yy = k.slice(0,4);
    const mm = k.slice(5,7);
    (tree[yy] ||= {});
    (tree[yy][mm] ||= []);
    tree[yy][mm].push(k);
  });

  // نحدد يوم الأساس: إذا عندك selectedDay نستعمله، وإلا TODAY
  const baseDay = (typeof selectedDay === 'string' && selectedDay) ? selectedDay : TODAY;
  const {y, m, d} = parseYMD(baseDay);

  // دوال فحص أول/آخر يوم
  const isFirstOfMonth = d === 1;
  const isLastOfMonth  = (baseDay === lastOfMonthStr(y,m));

  let daysToShow = [];

  if (isFiltering) {
    // إذا أكو فلترة، نعرض المطابق فقط (بدون تقييد)
    daysToShow = allDays.filter(k => match(k));
  } else {
    // —— منطق العبور —— 
    // إذا واقفين على أول يوم من الشهر -> اعرض [أول يوم من الشهر الحالي, آخر يوم من الشهر السابق]
    // إذا واقفين على آخر يوم من الشهر -> اعرض [أول يوم من الشهر القادم, آخر يوم من الشهر الحالي]
    if (isFirstOfMonth) {
      const pair = [
        firstOfMonthStr(y, m),
        lastOfPrevMonthStr(y, m)
      ];
      daysToShow = Array.from(new Set(pair)).sort().reverse();
    } else if (isLastOfMonth) {
      const pair = [
        firstOfNextMonthStr(y, m),
        lastOfMonthStr(y, m)
      ];
      daysToShow = Array.from(new Set(pair)).sort().reverse();
    } else {
      // الحالة الاعتيادية: شهر واحد فقط (شهر baseDay) وأعلى DAYS_LIMIT أيام من هذا الشهر
      const yy = baseDay.slice(0,4);
      const mm = baseDay.slice(5,7);
      const monthDays = ((tree[yy] && tree[yy][mm]) ? tree[yy][mm] : []).sort().reverse();

      // نضمن baseDay بالبداية لو مو موجود ضمن بيانات days
      if (!monthDays.includes(baseDay)) monthDays.unshift(baseDay);

      daysToShow = monthDays.slice(0, DAYS_LIMIT);
    }

    // ضمان عدم التكرار
    daysToShow = Array.from(new Set(daysToShow));
  }

  // لا يوجد شيء لعرضه
  if (!daysToShow.length) {
    host.innerHTML = '<div style="color:#9aa4b2">لا يوجد أيام لعرضها</div>';
    return;
  }

  // تجميع حسب الشهر (YYYY-MM)
  const groups = {};
  daysToShow.forEach(d => {
    const key = d.slice(0,7);
    (groups[key] ||= []).push(d);
  });

  // ترتيب الأشهر نزوليًا
  const monthKeys = Object.keys(groups).sort().reverse();
  const yearsSet  = new Set(monthKeys.map(mk => mk.slice(0,4)));
  const yearsOrdered = Array.from(yearsSet).sort().reverse();

  yearsOrdered.forEach(yyyy => {
    const monthsOfYear = monthKeys.filter(mk => mk.startsWith(yyyy + '-')).sort().reverse();

    monthsOfYear.forEach(monthKey => {
      const monthBox = CE('div','month');

      // عنوان الشهر + عدد البطاقات
      const mTitle    = CE('div','month-title');
      const niceMonth = arMonthName(monthKey + '-01');
      const mCount    = groups[monthKey].reduce((n, k) => n + activeCardsOfDay(k).length, 0);
      mTitle.innerHTML = `<span>${niceMonth}</span><span class="mchip">${mCount} بطاقة</span>`;
      monthBox.appendChild(mTitle);

      // الأيام داخل هذا الشهر (أحدث أولاً)
      const daysInMonth = groups[monthKey].sort().reverse();
      daysInMonth.forEach(k => {
        const row = CE('div','day' + (k === selectedDay ? ' active' : ''));
        row.innerHTML = `
          <div class="title">${arDateWithDay(k)}</div>
          <div class="meta">${activeCardsOfDay(k).length} بطاقة</div>
        `;
        row.onclick = () => {
          selectedDay = k;
          renderBoard();
          renderRail();
          refreshStats();
        };
        monthBox.appendChild(row);
      });

      host.appendChild(monthBox);
    });
  });
}



    document.getElementById('dayFilter').addEventListener('input', renderRail);
    document.getElementById('cardSearch').addEventListener('input', renderBoard);
    document.getElementById('btnExportLocal')?.addEventListener('click', exportInvoices);

  
  
   document.getElementById('globalSearch')?.addEventListener('change', ()=>{
  globalLimit = 20;     // رجّع الحد للبداية كل ما تبدّل وضع البحث الشامل
  renderBoard();
});



    /* ===== Stats ===== */
function refreshStats(){
  // بطاقات اليوم الفعّالة
  const cardsArr = activeCardsOfDay(selectedDay);

  // عدد المواد الفعّالة
  const itemsCount = cardsArr.reduce((n, c) =>
    n + (c.lines || []).filter(l => !l.deletedAt).length, 0
  );

  // مجاميع مالية
  const totals = cardsArr.reduce((acc, c) => {
    const s = sumCardAmounts(c); // { total, unpaid, paid, returned }
    acc.total    += s.total;
    acc.unpaid   += s.unpaid;
    acc.paid     += s.paid;
    acc.returned += s.returned;
    return acc;
  }, { total:0, unpaid:0, paid:0, returned:0 });

  // تحديث العدادين الأساسيين
  const setTxt = (id, v)=>{ const el = document.getElementById(id); if(el) el.textContent = v; };
  setTxt('statCards', String(cardsArr.length));
  setTxt('statItems', String(itemsCount));
  setTxt('statTime',  new Date().toLocaleTimeString('ar-EG'));

  // الحاوية الرئيسية
  const insights = document.querySelector('.insights');
  if(!insights) return;

  // --- نحدد العنوان كنقطة ارتكاز ثم ننشئ جسمًا بعده ---
  const titleEl = insights.querySelector('.insights__title, .section-title, h3, h2, h1');
  let body = document.getElementById('insightsBody');
  if(!body){
    body = document.createElement('div');
    body.id = 'insightsBody';
    if(titleEl && titleEl.after) titleEl.after(body);
    else insights.prepend(body); // احتياط
  }

  // ===== صندوق الإحصائيات السريعة (عدد البطاقات/المواد/آخر تحديث) =====
  let quick = document.getElementById('quickStats');
  if(!quick){
    quick = document.createElement('div');
    quick.id = 'quickStats';
    quick.className = 'money--compact';
    body.appendChild(quick);
  }
  quick.innerHTML = `
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-layer-group"></i> عدد البطاقات</span>
      <span class="mval">${cardsArr.length}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-boxes-stacked"></i> عدد المواد</span>
      <span class="mval">${itemsCount}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-regular fa-clock"></i> آخر تحديث</span>
      <span class="mval">${new Date().toLocaleTimeString('ar-EG')}</span>
    </div>
  `;

  // ===== صندوق المال المضغوط =====
  let box = document.getElementById('moneyStats');
  if(!box){
    box = document.createElement('div');
    box.id = 'moneyStats';
    box.className = 'money--compact';
    body.appendChild(box);
    
    
    
    // ===== صندوق ملخّصات إضافية (تحت إجمالي اليوم) =====
let extra = document.getElementById('extraStats');
if (!extra) {
  extra = document.createElement('div');
  extra.id = 'extraStats';
  extra.className = 'money--compact';
  body.appendChild(extra); // body هو insightsBody نفسه (موجود فوق)
}

// مساعدات آمنة
const F = (v)=> (typeof formatIQD === 'function' ? formatIQD(v || 0) : (v||0).toLocaleString('ar-IQ'));
const N = (v)=> (v||0).toLocaleString('ar-EG');

// حسابات سريعة (موجودة عندك أصلاً فوق)
const cardsCount  = Array.isArray(cardsArr) ? cardsArr.length : 0;
const avgPerCard  = cardsCount ? (totals.total / cardsCount) : 0;
const avgPerItem  = (itemsCount ? (totals.total / itemsCount) : 0);

// بطاقات فيها دين (غير مدفوعة كليًا)
const withUnpaidCount = (Array.isArray(cardsArr) ? cardsArr.filter(c => {
  const s = typeof sumCardAmounts==='function' ? sumCardAmounts(c) : {unpaid:0};
  return (s.unpaid||0) > 0;
}).length : 0);

// أول/آخر وقت عملية (تقريبي من خطوط الكروت)
function getFirstLastTime(arr){
  try{
    const all = arr.flatMap(c => (c.lines||[]))
                   .filter(l => !l.deletedAt && l.at)
                   .map(l => new Date(l.at).getTime())
                   .sort((a,b)=>a-b);
    if(!all.length) return {first:'—', last:'—'};
    const fmt = (ts)=> new Date(ts).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
    return { first: fmt(all[0]), last: fmt(all[all.length-1]) };
  }catch{ return {first:'—', last:'—'} }
}
const span = getFirstLastTime(Array.isArray(cardsArr)?cardsArr:[]);

extra.innerHTML = `
  <div class="mrow">
    <span class="mlabel"><i class="fa-solid fa-receipt"></i> متوسّط الفاتورة</span>
    <span class="mval">${F(avgPerCard)}</span>
  </div>
  
  <div class="mrow">
    <span class="mlabel"><i class="fa-regular fa-rectangle-list"></i> فواتير فيها دين</span>
    <span class="mval mval--unpaid">${N(withUnpaidCount)}</span>
  </div>
  
`;

    
    
    
  }

  const F = (v)=> formatIQD(v || 0);

  box.innerHTML = `
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-sack-dollar"></i> إجمالي اليوم</span>
      <span class="mval">${F(totals.total)}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-regular fa-circle-check"></i> مدفوع</span>
      <span class="mval mval--paid">${F(totals.paid)}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-regular fa-clock"></i> غير مدفوع</span>
      <span class="mval mval--unpaid">${F(totals.unpaid)}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-rotate-left"></i> راجع</span>
      <span class="mval mval--ret">${F(totals.returned)}</span>
    </div>
  `;
  
}







    /* ===== Actions ===== */
   
  document.getElementById('btnClearDay').onclick  = async ()=>{
  const ok = await showConfirm({
    title:'تفريغ اليوم',
    message:`سيتم حذف جميع بطاقات يوم ${arDateWithDay(selectedDay)}.`,
    okText:'تفريغ اليوم',
    cancelText:'إلغاء',
    danger:true
  });
  if(!ok) return;

  const now = nowISO();
  const arr = days[selectedDay] || [];

  arr.forEach(card=>{
    if(card){
      card.deletedAt = now;
      card.updatedAt = now;

      (card.lines || []).forEach(l=>{
        l.deletedAt = now;
        l.updatedAt = now;
      });
      (card.notes || []).forEach(n=>{
        n.deletedAt = now;
        n.updatedAt = now;
      });
    }
  });

  // لا تصفّر المصفوفة — خلّ التومبستونات تنسجّم مع الدمج
  save(); renderBoard(); renderRail(); refreshStats();
  showToast('error', 'تم تعليم كل بطاقات اليوم كمحذوفة');
};


   
   
   
// كسر الكاش + عرض شاشة التحديث قبل الرِيلود
function hardReload(){
  const url = new URL(location.href);
  url.searchParams.set('_ts', Date.now());
  location.replace(url.toString());
}

// نصائح بسيطة تتبدّل أثناء التحديث
const RELOAD_TIPS = [
  'نرتّب لك البيانات…',
  'نحفظ آخر التغييرات…',
  'نحدّث الواجهة…',
  'ثواني ونرجع لك…'
];

// فتح نافذة التحديث وبدء الأنيميشن
function showReloadOverlay(){
  const el = document.getElementById('reloader');
  if(!el) return;
  el.classList.add('active');

  // صفر الشريط والنسبة
  const bar = document.getElementById('reloadBar');
  const pct = document.getElementById('splashPct');
  const tip = document.getElementById('reloadTip');
  if(bar) bar.style.width = '0%';
  if(pct) pct.textContent = '0%';
  if(tip) tip.textContent = RELOAD_TIPS[0] || 'جارٍ التحديث…';
}

// إخفاء النافذة (في حال احتجت)
function hideReloadOverlay(){
  const el = document.getElementById('reloader');
  if(!el) return;
  el.classList.remove('active');
}

// أنيميشن نسبة + شريط، بعدها نعمل Reload
function animateReloadAndGo(totalMs = 1400){
  const bar = document.getElementById('reloadBar');
  const pct = document.getElementById('splashPct');
  const tip = document.getElementById('reloadTip');

  const start = performance.now();
  let tipIdx = 0;

  function step(now){
    const t = Math.min(1, (now - start) / totalMs);
    const eased = 1 - Math.pow(1 - t, 2); // ease-out
    const val = Math.floor(eased * 100);

    if(bar) bar.style.width = val + '%';
    if(pct) pct.textContent = val + '%';

    // بدّل النص كل ~450ms
    const newTipIdx = Math.min(RELOAD_TIPS.length - 1, Math.floor((now - start) / 450));
    if(tip && newTipIdx !== tipIdx){
      tipIdx = newTipIdx;
      tip.textContent = RELOAD_TIPS[tipIdx];
    }

    if(t < 1){
      requestAnimationFrame(step);
    }else{
      // بعد الاكتمال: ريفرش قاسي مع كسر كاش
      hardReload();
    }
  }
  requestAnimationFrame(step);
}



// استدعاء من زر التحديث
function refreshWithOverlay(){
  showReloadOverlay();
  animateReloadAndGo(1600, 300); // تقدر تغيّر المدة (ms)
}

// ربط الزر
document.getElementById('btnRefresh')?.addEventListener('click', refreshWithOverlay);



/* ===== [NEW] LocalStorage usage helper ===== */

// نفترض الحد تقريباً 5MB لـ localStorage (يختلف من متصفح لمتصفح)
const APPROX_LOCALSTORAGE_LIMIT_BYTES = 5 * 1024 * 1024;

function getLocalStorageUsageBytes(){
  let totalBytes = 0;

  try {
    const enc = new TextEncoder();

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i) || "";
      const val = localStorage.getItem(key) || "";

      // الحجم الحقيقي للـ key + value بالبايت (UTF-8)
      totalBytes += enc.encode(key).length;
      totalBytes += enc.encode(val).length;
    }
  } catch (e) {
    // لو المتصفح قديم جداً وما يدعم TextEncoder
    return 0;
  }

  return totalBytes;
}


function formatBytesNice(bytes){
  if(!bytes || bytes <= 0) return '0 بايت';
  const kb = bytes / 1024;
  if(kb < 1024) return kb.toFixed(1) + ' KB';
  const mb = kb / 1024;
  return mb.toFixed(2) + ' MB';
}

function openStorageUsageModal(){
  const backdrop = document.getElementById('storageModalBackdrop');
  const modal    = document.getElementById('storageModal');
  if(!backdrop || !modal) return;

  const usedBytes  = getLocalStorageUsageBytes();
  const limitBytes = APPROX_LOCALSTORAGE_LIMIT_BYTES;
  const pctRaw     = (usedBytes / limitBytes) * 100;
  const pct        = Math.max(0, Math.min(100, Math.round(pctRaw)));
  const leftBytes  = Math.max(0, limitBytes - usedBytes);

  const bar        = document.getElementById('storageUsageBar');
  const txtMain    = document.getElementById('storageUsageMain');
  const txtMore    = document.getElementById('storageUsageMore');

  const usedKpi    = document.getElementById('storageUsedKpi');
  const leftKpi    = document.getElementById('storageLeftKpi');
  const pctKpi     = document.getElementById('storagePctKpi');
  const badge      = document.getElementById('storageBadge');

  // شريط النسبة
  if(bar){
    bar.style.width = pct + '%';
  }

  // KPIs رقمية
  if(usedKpi) usedKpi.textContent = formatBytesNice(usedBytes);
  if(leftKpi) leftKpi.textContent = formatBytesNice(leftBytes);
  if(pctKpi)  pctKpi.textContent  = pct + '٪';

  // نص مختصر
  if(txtMain){
    txtMain.textContent =
      `مستعمل تقريباً ${formatBytesNice(usedBytes)} من ${formatBytesNice(limitBytes)} (${pct}٪ من السعة التقريبية).`;
  }

  // حالة + تفاصيل + ألوان البادج
  if(badge){
    badge.classList.remove('storage-badge-safe','storage-badge-warn','storage-badge-danger');

    let statusLabel = 'حالة آمنة';
    let statusClass = 'storage-badge-safe';
    let statusText  = 'الوضع ممتاز، ماكو أي خطر حاليًا من امتلاء تخزين المتصفح.';

    if(pct >= 75 && pct < 90){
      statusLabel = 'قريب من الحد';
      statusClass = 'storage-badge-warn';
      statusText  = 'الاستخدام بدأ يقترب من الحد التقريبي. يُفضّل بين فترة وفترة تصدّر نسخة احتياطية وتمسح بيانات قديمة إذا ممكن.';
    }else if(pct >= 90){
      statusLabel = 'على وشك الامتلاء';
      statusClass = 'storage-badge-danger';
      statusText  = 'التخزين قرّب يمتلئ. أنصحك فورًا تتأكد من النسخة الاحتياطية على السيرفر، وتمسح أو تضغط البيانات القديمة قبل ما يوقف الحفظ.';
    }

    badge.textContent = statusLabel;
    badge.classList.add(statusClass);

    if(txtMore){
      txtMore.innerHTML =
        `<div class="storage-more-text">${statusText}</div>
         <ul class="storage-list">
           <li>المتبقي التقريبي قبل الوصول للحد: <strong>${formatBytesNice(leftBytes)}</strong>.</li>
           <li>الحد المستخدم هنا تقريبي (حوالي 5MB لـ localStorage) ويختلف من متصفح لآخر.</li>
           <li>ينصح دائماً بالاعتماد على النسخ الاحتياطية على السيرفر وعدم الاعتماد على هذا المتصفح فقط.</li>
         </ul>`;
    }
  }

  // عرض المودال
  backdrop.classList.add('active');
  modal.classList.add('active');
  document.body.classList.add('modal-open');
}


function closeStorageUsageModal(){
  const backdrop = document.getElementById('storageModalBackdrop');
  const modal    = document.getElementById('storageModal');
  if(backdrop) backdrop.classList.remove('active');
  if(modal)    modal.classList.remove('active');
  document.body.classList.remove('modal-open');
}

// ربط أزرار المودال
document.getElementById('btnStorageInfo')?.addEventListener('click', openStorageUsageModal);
document.getElementById('storageModalClose')?.addEventListener('click', closeStorageUsageModal);
document.getElementById('storageModalBackdrop')?.addEventListener('click', closeStorageUsageModal);








/* ===== اقتراحات اسم الزبون (تطلع فوق + 8 مرئية + Scroll) ===== */
let __custIdx = -1;

function getAllCustomers(){
  return Array.isArray(CUSTOMERS) ? [...CUSTOMERS] : [];
}


function renderCustSuggestions(){
  const host = document.getElementById('custSuggestions');
  const inp  = document.getElementById('cust');
  if(!host || !inp) return;

  const q = String(inp.value||'').trim().toLowerCase();
  const all = getAllCustomers();

  // ماكو كتابة → لا تعرض شي
  if(!q){
    host.innerHTML = '';
    host.style.display = 'none';
    __custIdx = -1;
    return;
  }

  // فلترة بسيطة
  const data = all.filter(n => n.toLowerCase().includes(q));

  host.innerHTML = '';
  __custIdx = -1;

  data.forEach(name=>{
    const li = document.createElement('li');
    li.className = 'sugg-item';
    li.textContent = name;
    li.onclick = ()=>{
      inp.value = name;
      hideCustSuggestions();
      // بعد الاختيار: روّح على نوع الفاتورة
      const target = document.getElementById('type');
      target && (target.focus(), typeof target.showPicker==='function' && target.showPicker());
    };
    host.appendChild(li);
  });

  host.style.display = data.length ? 'block' : 'none';
}


function hideCustSuggestions(){
  const host = document.getElementById('custSuggestions');
  if(host){ host.style.display = 'none'; __custIdx = -1; }
}

function getCustLis(){
  const host = document.getElementById('custSuggestions');
  return host ? Array.from(host.querySelectorAll('li')) : [];
}

function highlightCustItem(){
  const items = getCustLis();
 items.forEach((li,i)=> li.classList.toggle('is-active', i === __custIdx));
  if(__custIdx >= 0 && items[__custIdx]){
    items[__custIdx].scrollIntoView({ block:'nearest' });
  }
}

// فتح أثناء الكتابة/الفوكس/الضغط
document.getElementById('cust')?.addEventListener('input',  renderCustSuggestions);
document.getElementById('btnExportDay').onclick = exportDayPDF_Vector;



// تنقّل الكيبورد داخل قائمة الزبائن
document.getElementById('cust')?.addEventListener('keydown', (e)=>{
  const host = document.getElementById('custSuggestions');
  const inp  = document.getElementById('cust');
  const visible = host && host.style.display === 'block';
  const hasQuery = !!String(inp.value||'').trim();

  // إذا الاقتراحات مو ظاهرة:
  if(!visible){
    // إذا ضغط Enter بدون كتابة → امشِ على "نوع الفاتورة" مباشرة
    if(e.key === 'Enter' && !hasQuery){
      e.preventDefault();
      const target = document.getElementById('type');
      if(target){
        target.focus();
        if(typeof target.showPicker==='function') target.showPicker();
      }
      return;
    }

    // إذا Down/Up/Enter ومعك كتابة → افتح الاقتراحات
    if((e.key==='ArrowDown' || e.key==='ArrowUp' || e.key==='Enter') && hasQuery){
      e.preventDefault();
      renderCustSuggestions();
    }
    return;
  }

  // الاقتراحات ظاهرة: تنقل واختيار
  const items = getCustLis();
  if(!items.length) return;

  if(e.key === 'ArrowDown'){
    e.preventDefault();
    __custIdx = (__custIdx < 0) ? 0 : Math.min(items.length - 1, __custIdx + 1);
    highlightCustItem();
  }else if(e.key === 'ArrowUp'){
    e.preventDefault();
    __custIdx = (__custIdx < 0) ? items.length - 1 : Math.max(0, __custIdx - 1);
    highlightCustItem();
  }else if(e.key === 'Enter'){
    e.preventDefault();
    if(__custIdx >= 0) items[__custIdx].click();
  }else if(e.key === 'Escape'){
    e.preventDefault();
    hideCustSuggestions();
  }
});


// إغلاق إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const host = document.getElementById('custSuggestions');
  const field= document.getElementById('cust');
  if(!host || !field) return;
  const inside = host.contains(ev.target) || field.contains(ev.target);
  if(!inside) hideCustSuggestions();
});




document.addEventListener('DOMContentLoaded', () => {
  const m  = document.getElementById('modal');
  const mb = document.getElementById('modal-backdrop');
  if (mb && mb.parentNode !== document.body) document.body.appendChild(mb);
  if (m  && m.parentNode  !== document.body) document.body.appendChild(m);
});





/* ==== Helper: HTML Escaper (للاحتياط لو احتجت نص داخل template) ==== */
function escHtml(s){
  return String(s||'')
   .replace(/&/g,'&amp;').replace(/</g,'&lt;')
   .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ===== تصدير كل بطاقات اليوم إلى PDF (محدّثة) =====
function exportDayPDF_Vector(){
  // نضمن آخر رسم
  renderBoard();

  // ✅ استبعاد البطاقات المحذوفة فقط
  const source = (days[selectedDay] || []);
 
 const cards  = source
  .filter(c => !c?.deletedAt)
  .filter(c =>
    Array.isArray(c.lines) &&
    c.lines.some(ln =>
      !ln?.deletedAt &&
      !ln?.paid              // يستبعد المدفوعة فقط
      // ما نتحقق من returned نهائياً حتى نسمح بطباعة المواد الراجعة
    )
  );
 

  if(!cards.length){ showToast('warn','ماكو بطاقات اليوم للتصدير'); return; }

 const dateStr = new Date(selectedDay)
  .toLocaleDateString('ar-EG', { weekday:'long', year:'numeric', month:'2-digit', day:'2-digit' });

  // نحضر بايلود + نمرر قائمة الزبائن المعروفة
  const payload = { dateStr, cards, known: CUSTOMERS || [] };

  const w = window.open('', '_blank');
  if(!w){ showToast('error','المتصفح منع فتح نافذة الطباعة'); return; }

  const title = 'فواتير ديون — مكتب عسل';
  const payloadJSON = JSON.stringify(payload).replace(/</g,'\\u003C'); // أمان بسيط

  w.document.write(`
    <!DOCTYPE html><html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title>${title}</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
      <style>
        :root{ --ink:#111827; --muted:#6b7280; --stroke:#e5e7eb; }
        html,body{ margin:0; padding:0; font-family:"Cairo",system-ui; color:var(--ink); }
        .wrap{ padding:18px; }
        .head{
          display:flex; align-items:center; justify-content:space-between;
          border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; margin-bottom:14px;
          background:#fafafa;
        }
        .title{ font-weight:900; }
        .date{ font-size:12px; color:var(--muted); }
        .card{
          border:1px solid var(--stroke); border-radius:12px; padding:10px; margin-bottom:10px;
          page-break-inside: avoid;
        }
        .card-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .cust{ font-weight:900; font-size:16px; display:flex; align-items:center; gap:8px; }
        .tag{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--stroke); color:#374151; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border:1px solid var(--stroke); padding:6px 8px; font-size:12.5px; }
        th{ background:#f5f5f5; text-align:center; }
        td{ vertical-align:top; }
        .center{ text-align:center; }
        .right{ text-align:right; }

        /* ===== خط على اسم المادة حسب الحالة ===== */
        .nm.return{ text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color:#b91c1c; }
        .nm.paid  { text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color:#065f46; }

        /* ===== بادج زبون جديد ===== */
        .badge-new{
          font-size:11px;
          padding:2px 8px;
          border-radius:999px;
          border:1px solid rgba(127,29,29,.55);
          background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
          color:#fecaca;
          box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
        }

        /* ===== مجاميع البطاقة (جديد) ===== */
        .totals{
          margin:8px 0 10px;
          display:flex;
          flex-wrap:wrap;
          gap:6px;
          font-size:12px;
          font-weight:900;
          color:#111827;
        }
        .totals__pill{
          border:1px solid var(--stroke);
          border-radius:8px;
          background:#f5f5f5;
          padding:4px 8px;
          line-height:1.3;
        }

        /* ===== Notes block (للطباعة) ===== */
        .notes{ margin-top:8px; border:1px solid var(--stroke); border-radius:10px; }
        .notes__head{
          display:flex; align-items:center; justify-content:space-between;
          background:#f5f5f5; padding:6px 10px; border-bottom:1px solid var(--stroke);
          font-weight:900;
        }
        .notes__list{ padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
        .note{
          display:flex; align-items:center; gap:8px;
          border:1px solid var(--stroke); border-radius:10px; padding:6px 10px;
        }
        .note__idx{
          font-weight:900; font-size:12px; min-width:28px; text-align:center;
          border:1px solid var(--stroke); border-radius:999px; padding:2px 6px; background:#fff;
        }
        .note__text{ flex:1; }
        .note__time{ font-size:11px; color:#6b7280; white-space:nowrap; }

        @media print{ .card{ break-inside: avoid; } }
      </style>
      
      <style>
        /* حواف البطاقة رمادي داكن خفيف مو أسود صِرف */
        .wrap .card{
          border-style: solid !important;
          border-width: 1.5px !important;     /* سماكة مناسبة */
          border-color: rgba(0,0,0,.60) !important; /* افتح من الأسود (60%) */
        }

        @media print{
          .wrap .card{
            border-width: 1.5px !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }
        }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="head">
          <div class="title">${title}</div>
          <div id="dateHolder" class="date"></div>
        </div>
        <div id="printCards"></div>
      </div>
      <script>
        // نفس مُنسّق السعر المُستخدم بالكروت
        function formatIQD(v){
          const n = Number(String(v||'').replace(/[^\\d.]/g,''));
          if(!Number.isFinite(n)) return '';
          return n.toLocaleString('en-US');
        }

        // ✅ حساب مجموع البطاقة / غير مدفوع
      // ✅ حساب مجموع البطاقة / غير مدفوع
// ملاحظة: القطع الراجعة تنطرح من المجموع (تروح سالب)
function sumCard(card){
  let total  = 0; // مجموع الباقي الحقيقي
  let unpaid = 0; // نفس الشي (إنت تريد نفس المنطق)

  (card.lines || []).forEach(ln => {
    if (ln.deletedAt) return;

    // نهمل الراجع نهائياً
    if (ln.returned) return;

    // نهمل المدفوع نهائياً
    if (ln.paid) return;

    // إذا وصلنا لهنا: هذا سطر فعّال فعلاً (مو راجع ومو مدفوع)
    const price = Number(ln.price || 0);
    const qty   = parseInt(String(ln.qty || '1'), 10) || 1;
    const sub   = price * qty;

    total  += sub;
    unpaid += sub;
  });

  return { total, unpaid };
}





        // البيانات المحقونة
        const PAYLOAD = ${payloadJSON};

        (function(){
          const host = document.getElementById('printCards');
          document.getElementById('dateHolder').textContent = PAYLOAD.dateStr || '';
          const KNOWN = Array.isArray(PAYLOAD.known) ? PAYLOAD.known : [];

          const cards = PAYLOAD.cards || [];
          if(!cards.length){ host.innerHTML = '<div>لا توجد بطاقات اليوم</div>'; return; }

          function arTime(d){ return new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}); }

          cards.forEach(card=>{
            const box = document.createElement('div');
            box.className = 'card';

            const head = document.createElement('div');
            head.className = 'card-head';

            const left = document.createElement('div');
            left.className = 'cust';

            // اسم الزبون
            const nm = document.createElement('span');
            nm.textContent = card.customer || '';
            left.appendChild(nm);

            // بادج زبون جديد إذا مو موجود بالمصفوفة
            if(card.customer && !KNOWN.includes(card.customer)){
              const nb = document.createElement('span');
              nb.className = 'badge-new';
              nb.textContent = 'زبون جديد';
              left.appendChild(nb);
            }

            const right = document.createElement('div');
            const type = card.billType || (()=>{
              const ts = Array.from(new Set((card.lines||[]).map(l=>l.type)));
              return (ts.length===1) ? ts[0] : 'مختلط';
            })();
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = (type==='راجع') ? 'فاتورة راجع' : (type==='بيع') ? 'فاتورة بيع' : 'فاتورة مختلطة';
            right.appendChild(tag);

            // NEW: التاريخ يمّ نوع الفاتورة
            const dateTag = document.createElement('span');   // NEW
            dateTag.className = 'tag';                        // NEW
            dateTag.textContent = PAYLOAD.dateStr || '';      // NEW
            right.appendChild(dateTag);                       // NEW

            head.append(left,right);
            box.appendChild(head);

            const tbl = document.createElement('table');
            tbl.innerHTML = \`
              <thead>
                <tr>
                  <th>الصنف</th>
                  <th>اسم المادة</th>
                  <th>العدد</th>
                  <th>السعر</th>
                  <th>ملاحظات</th>
                  <th>الوقت</th>
                  <th>الحالة</th>
                </tr>
              </thead>
              <tbody></tbody>\`;
            const tbody = tbl.querySelector('tbody');

            (card.lines||[]).filter(ln=>!ln.deletedAt).forEach(ln=>{
              const tr = document.createElement('tr');
              const isReturned = !!ln.returned;
              const isPaid     = !!ln.paid;
              const state = isReturned ? 'راجع' : (isPaid ? 'مدفوع' : '');
              const price = (ln.price === 0 || ln.price) ? (formatIQD(ln.price) || '—') : '—';

              const nmClass = isReturned ? 'return' : (isPaid ? 'paid' : '');
              const nameHTML = \`<span class="nm \${nmClass}">\${ln.item || ''}</span>\`;

              tr.innerHTML = \`
                <td class="center">\${ln.cat || '—'}</td>
                <td class="center">\${nameHTML}</td>
                <td class="center">× \${ln.qty || '1'}</td>
                <td class="center">\${price}</td>
                <td class="center">\${(ln.note && ln.note.trim()) ? ln.note : '—'}</td>
                <td class="center">\${arTime(ln.at || ln.createdAt || ln.updatedAt)}</td>
                <td class="center">\${state}</td>\`;
              tbody.appendChild(tr);
            });

            box.appendChild(tbl);

            // ✅ مجاميع البطاقة (المجموع / غير مدفوع / عدد المواد)
            (function(){
              const sums = sumCard(card);
              const totalsDiv = document.createElement('div');
              totalsDiv.className = 'totals';
              totalsDiv.innerHTML = \`
                <span class="totals__pill">مواد: \${(card.lines||[]).filter(l=>!l.deletedAt).length}</span>
                <span class="totals__pill">المجموع: \${formatIQD(sums.total)}</span>
                <span class="totals__pill">غير مدفوع: \${formatIQD(sums.unpaid)}</span>
              \`;
              box.appendChild(totalsDiv);
            })();

            // ===== Notes (إن وُجدت) =====
            (function(){
              const arr = Array.isArray(card.notes)
                ? card.notes
                    .filter(n => !n.deletedAt)
                    .slice()
                    .sort((a,b)=> new Date(b.at || b.updatedAt || 0) - new Date(a.at || a.updatedAt || 0))
                : [];
              if(!arr.length) return;

              const notes = document.createElement('div');
              notes.className = 'notes';

              const head = document.createElement('div');
              head.className = 'notes__head';
              head.innerHTML = \`<span>الملاحظات</span><span>\${arr.length}</span>\`;

              const list = document.createElement('div');
              list.className = 'notes__list';

              const tinyTime = (d)=> new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});

              arr.forEach((n, i)=>{
                const row = document.createElement('div');
                row.className = 'note';

                const idx = document.createElement('div');
                idx.className = 'note__idx';
                idx.textContent = \`#\${i+1}\`;

                const text = document.createElement('div');
                text.className = 'note__text';
                text.textContent = n.text || '';

                const when = document.createElement('div');
                when.className = 'note__time';
                when.textContent = tinyTime(n.at || Date.now());

                row.append(idx, text, when);
                list.appendChild(row);
              });

              notes.append(head, list);
              box.appendChild(notes);
            })();

            host.appendChild(box);
          });

          setTimeout(function(){ window.focus(); window.print(); }, 200);
        })();
      <\/script>
    </body></html>
  `);

  w.document.close();
  showToast('success','جاهز للطباعة — اختر "حفظ كـ PDF"');
}






// ===== تصدير بطاقة واحدة إلى PDF (محدّثة) =====
function exportCardPDF_Vector(card, dayKey){
  if (!card || !card.lines || !card.lines.length) {
    showToast('warn','هاي البطاقة فارغة');
    return;
  }

  const theDayISO = dayKey || card.__day || selectedDay;
  const dateStr = (function(iso){
    try{
      return new Date(iso).toLocaleDateString('ar-EG',{
        weekday:'long',
        year:'numeric',
        month:'2-digit',
        day:'2-digit'
      });
    }catch{
      return document.getElementById('dateBadge')?.textContent || '';
    }
  })(theDayISO);

  const payload = { dateStr, card, known: CUSTOMERS || [] };

  const w = window.open('', '_blank');
  if (!w){
    showToast('error','المتصفح منع فتح نافذة الطباعة');
    return;
  }

  const title = 'فاتورة ديون — مكتب عسل';
  const payloadJSON = JSON.stringify(payload).replace(/</g,'\\u003C');

  w.document.write(`
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title>${title}</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;900&display=swap" rel="stylesheet" />
      <style>
        :root{
          --ink:#020617;
          --muted:#6b7280;
          --stroke:#d4d4d8;
          --stroke-soft:#e5e7eb;
          --accent:#111827;
          --accent-soft:#f9fafb;
          --danger:#b91c1c;
          --danger-soft:#fef2f2;
          --paid:#166534;
          --paid-soft:#ecfdf3;
        }
        *{ box-sizing:border-box; }
        html,body{
          margin:0;
          padding:0;
          font-family:"Cairo",system-ui;
          color:var(--ink);
          background:#ffffff; /* ✅ كله أبيض حتى ما يطلع لون غامق تحت الفاتورة */
        }
        .page{
          padding:18px;
        }
        .invoice{
          max-width:900px;
          margin:0 auto;
          background:#ffffff;
          border-radius:12px;
          border:1px solid #111827; /* ✅ حد نظيف بدون لون إضافي تحت */
          padding:18px 20px 20px;
        }

        /* هيدر رئيسي */
        .inv-header{
          display:flex;
          justify-content:space-between;
          gap:16px;
          padding-bottom:10px;
          border-bottom:2px solid #0f172a;
          margin-bottom:14px;
        }
        .inv-head-left{
          display:flex;
          align-items:flex-start;
          gap:12px;
        }
        .logo-box{
          width:52px;
          height:52px;
          border-radius:8px;
          border:1.5px solid #0f172a;
          display:flex;
          align-items:center;
          justify-content:center;
          font-weight:900;
          font-size:18px;
          letter-spacing:1px;
        }
        .brand-block{
          display:flex;
          flex-direction:column;
          gap:2px;
        }
        .brand-name{
          font-weight:900;
          font-size:18px;
        }
        .brand-sub{
          font-size:11px;
          color:var(--muted);
        }
        .brand-line{
          font-size:11px;
          color:var(--muted);
        }

        .inv-head-right{
          min-width:230px;
          font-size:11px;
        }
        .meta-table{
          width:100%;
          border-collapse:collapse;
        }
        .meta-table td{
          padding:2px 4px;
          vertical-align:top;
        }
        .meta-label{
          color:var(--muted);
          white-space:nowrap;
        }
        .meta-value{
          font-weight:700;
          text-align:left;
        }
        .invoice-title{
          text-align:center;
          margin-top:6px;
          font-size:14px;
          font-weight:900;
          letter-spacing:.5px;
        }
        .invoice-title span{
          padding:2px 10px;
          border-radius:999px;
          border:1px solid var(--stroke);
          background:#f9fafb;
        }

        /* سطر الزبون / ملخص أعلى */
        .inv-row{
          display:flex;
          gap:18px;
          margin:12px 0;
        }
        .inv-card{
          flex:1;
          border-radius:10px;
          border:1px solid var(--stroke-soft);
          background:var(--accent-soft);
          padding:6px 8px; /* ✅ صغّرنا البادينك */
          font-size:12px;
        }
        .inv-card-header{
          font-weight:800;
          font-size:12px;
          margin-bottom:4px;
        }
        .cust-name-line{
          display:flex;
          align-items:center;
          gap:6px;
          margin-bottom:3px;
          font-size:15px;
          font-weight:900;
        }
        .badge{
          display:inline-flex;
          align-items:center;
          justify-content:center;
          padding:2px 8px;
          border-radius:999px;
          font-size:10px;
          border:1px solid var(--stroke);
        }
        .badge-type-sell{
          background:#ecfdf5;
          border-color:rgba(22,163,74,.45);
          color:#166534;
        }
        .badge-type-return{
          background:#fef2f2;
          border-color:rgba(239,68,68,.45);
          color:#b91c1c;
        }
        .badge-type-mixed{
          background:#eff6ff;
          border-color:#bfdbfe;
          color:#1e3a8a;
        }
        .badge-new{
          border-color:rgba(239,68,68,.6);
          background:#fef2f2;
          color:#991b1b;
        }
        .inv-card-text{
          color:var(--muted);
          font-size:11px;
        }

        /* جدول المواد */
        .table-wrap{
          border-radius:10px;
          border:1px solid var(--stroke-soft);
          overflow:hidden;
        }
        table{
          width:100%;
          border-collapse:collapse;
        }
        thead{
          background:#f9fafb;
          border-bottom:1px solid var(--stroke-soft);
        }
        th,td{
          padding:6px 6px;
          font-size:11.5px;
          border-bottom:1px solid var(--stroke-soft);
          text-align:center;
        }
        th{
          font-weight:800;
          color:#0f172a;
        }
        th:nth-child(2),
        th:nth-child(3),
        td:nth-child(2),
        td:nth-child(3){
          text-align:right;
        }
        .col-idx{ width:32px; }
        .col-qty{ width:50px; }
        .col-price{ width:90px; }
        .col-total{ width:100px; }
        .col-state{ width:70px; }

        .row-returned{
          background:var(--danger-soft);
          color:var(--danger);
        }
        .row-paid{
          background:var(--paid-soft);
          color:var(--paid);
        }
        .item-name{
          font-weight:700;
        }
        .item-name.returned{
          text-decoration:line-through;
          text-decoration-thickness:1.5px;
          text-decoration-color:var(--danger);
        }
        .item-name.paid{
          text-decoration:line-through;
          text-decoration-thickness:1.5px;
          text-decoration-color:var(--paid);
        }
        .money{
          font-weight:800;
          white-space:nowrap;
        }

        /* أسفل الفاتورة: الملاحظات + المجاميع (مخفّفة) */
        .bottom-row{
          margin-top:10px;
          display:flex;
          gap:12px;
        }
        .notes-box{
          flex:2;
          border-radius:8px;
          border:1px solid var(--stroke-soft);
          padding:6px 8px;      /* ✅ أصغر */
          font-size:11px;       /* ✅ أصغر */
          min-height:40px;      /* ✅ مو مربع كبير */
        }
        .notes-header{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:4px;
        }
        .notes-header-title{
          font-weight:800;
          font-size:12px;
        }
        .notes-count{
          font-size:10px;
          border-radius:999px;
          padding:1px 6px;
          border:1px solid var(--stroke-soft);
        }
        .main-note{
          font-size:11px;
          margin-bottom:4px;
        }
        .note-row{
          display:flex;
          align-items:flex-start;
          gap:4px;
          margin-bottom:2px;
        }
        .note-idx{
          min-width:18px;
          text-align:center;
          font-size:10px;
          border-radius:999px;
          border:1px solid var(--stroke-soft);
          padding:0 4px;
          background:#fff;
        }
        .note-text{
          flex:1;
          font-size:10.5px;
        }
        .note-time{
          font-size:10px;
          color:var(--muted);
          white-space:nowrap;
        }

        .totals-card{
          flex:1.1;
          border-radius:8px;
          border:1px solid var(--stroke-soft); /* ✅ مو حد غامق */
          padding:6px 8px;                     /* ✅ أصغر */
          font-size:11px;
        }
        .totals-title{
          font-weight:800;
          margin-bottom:4px;
          font-size:12px;
        }
        .totals-row{
          display:flex;
          justify-content:space-between;
          margin-bottom:3px;
        }
        .totals-label{
          color:var(--muted);
        }
        .totals-value{
          font-weight:800;
        }
        .totals-main{
          border-top:1px dashed var(--stroke);
          margin-top:2px;
          padding-top:4px;
        }
        .totals-main .totals-label{
          font-weight:800;
          color:#0f172a;
        }
        .totals-main .totals-value{
          font-size:13px;
        }
        /* ✅ قيمة بالسالب باللون الأحمر */
        .totals-value-minus{
          color:var(--danger);
        }

        /* فوتر */
        .inv-footer{
          margin-top:10px;
          padding-top:6px;
          border-top:1px solid var(--stroke-soft);
          display:flex;
          justify-content:space-between;
          align-items:flex-end;
          font-size:10px;
          color:var(--muted);
        }
        .sign-block{
          min-width:170px;
          text-align:center;
        }
        .sign-line{
          margin-top:14px;
          border-top:1px solid var(--stroke);
          padding-top:3px;
        }

        @page{
          margin:12mm;
        }
        @media print{
          body{
            background:#ffffff;
          }
          .page{
            padding:0;
          }
          .invoice{
            box-shadow:none;
          }
        }
      </style>
    </head>
    <body>
      <div class="page">
        <div class="invoice">
          <div id="invoiceRoot"></div>
        </div>
      </div>
      <script>
        function formatIQD(v){
          const n = Number(String(v||'').replace(/[^\\d.]/g,''));
          if(!Number.isFinite(n)) return '';
          return n.toLocaleString('en-US');
        }

        // ✅ عدّلناها: نحسب إجمالي المواد الراجعة returned
        function sumCard(card){
          let total = 0;
          let unpaid = 0;
          let returned = 0;

          (card.lines || []).forEach(function(ln){
            if(!ln || ln.deletedAt) return;

            const price = Number(String(ln.price ?? '').replace(/[^\\d.]/g,'')) || 0;
            const qty   = parseInt(String(ln.qty || '1'),10) || 1;
            const sub   = price * qty;

            if(ln.returned){
              returned += sub;   // المواد المسترجعة تنحسب هنا فقط
              return;           // وما تدخل على الدين
            }

            if(ln.paid) return; // المدفوع ما يدخل ضمن الدين

            total  += sub;
            unpaid += sub;
          });

          return { total, unpaid, returned };
        }

        function escHtmlLocal(s){
          return String(s||'')
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
        }

        function tinyTime(d){
          try{
            return new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
          }catch{
            return '';
          }
        }

        const PAYLOAD = ${payloadJSON};

        (function(){
          const root  = document.getElementById('invoiceRoot');
          const card  = PAYLOAD.card || {};
          const KNOWN = Array.isArray(PAYLOAD.known) ? PAYLOAD.known : [];
          const dateStr = PAYLOAD.dateStr || '';

          if(!card || !Array.isArray(card.lines) || !card.lines.length){
            root.textContent = 'لا توجد بيانات للبطاقة';
            return;
          }

          var billType = card.billType;
          if(!billType){
            const types = Array.from(new Set((card.lines || []).map(function(l){ return l && l.type; }))).filter(Boolean);
            billType = (types.length === 1) ? types[0] : 'مختلط';
          }
          var billLabel =
            billType === 'راجع' ? 'فاتورة راجع' :
            billType === 'بيع'  ? 'فاتورة بيع'  : 'فاتورة ديون';

          const isKnownCustomer = card.customer && KNOWN.indexOf(card.customer) !== -1;
          const totals = sumCard(card); // فيها unpaid + returned
          const createdAt = card.createdAt || card.at || null;
          const timeStr   = createdAt ? tinyTime(createdAt) : '';
          const invoiceId = card.id ? String(card.id) : '';

          // نجهز أسطر الجدول
          var idx = 0;
          var effectiveCount = 0;
          var rowsHtml = '';
          (card.lines || [])
            .filter(function(ln){ return ln && !ln.deletedAt; })
            .forEach(function(ln){
              idx++;
              const priceNum = Number(String(ln.price ?? '').replace(/[^\\d.]/g,'')) || 0;
              const qtyNum   = parseInt(String(ln.qty || '1'),10) || 1;
              const sub      = priceNum * qtyNum;

              const isReturned = !!ln.returned;
              const isPaid     = !!ln.paid;
              if(!isReturned && !isPaid){
                effectiveCount++;
              }

              const rowClass = isReturned ? 'row-returned' : (isPaid ? 'row-paid' : '');
              const state = isReturned ? 'راجع' : (isPaid ? 'مدفوع' : '');

              const catName  = escHtmlLocal(ln.cat || ln.category || '');
              const itemName = escHtmlLocal(ln.item || ln.name || '');
              const note     = escHtmlLocal(ln.note || ln.notes || '');
              const tm       = escHtmlLocal(tinyTime(ln.at || ln.createdAt || card.createdAt || new Date()));

              var itemClass = 'item-name';
              if(isReturned) itemClass += ' returned';
              if(isPaid)     itemClass += ' paid';

              rowsHtml +=
                '<tr class="'+rowClass+'">' +
                  '<td class="col-idx">'+ idx +'</td>' +
                  '<td>'+ (catName || '-') +'</td>' +
                  '<td><span class="'+itemClass+'">'+ (itemName || '-') +'</span></td>' +
                  '<td class="col-qty">'+ qtyNum +'</td>' +
                  '<td class="money col-price">'+ (priceNum ? formatIQD(priceNum) : '-') +'</td>' +
                  '<td class="money col-total">'+ (sub ? formatIQD(sub) : '-') +'</td>' +
                  '<td>'+ (note || '-') +'</td>' +
                  '<td>'+ tm +'</td>' +
                  '<td class="col-state">'+ (state || '') +'</td>' +
                '</tr>';
            });

          // الملاحظات (نفسها مع التوضيح)
          var notesHtml = '';
          const notesArr = Array.isArray(card.notes)
            ? card.notes
                .filter(function(n){ return n && !n.deletedAt; })
                .slice()
                .sort(function(a,b){
                  return new Date(b.at || b.updatedAt || 0) - new Date(a.at || a.updatedAt || 0);
                })
            : [];

          notesHtml +=
            '<div class="notes-header">' +
              '<div class="notes-header-title">الملاحظات</div>' +
              '<div class="notes-count">'+ notesArr.length +'</div>' +
            '</div>' +
            '<div class="main-note">المواد المسترجعة لا تُحتسب ضمن إجمالي الفاتورة بل ترجع من حساب الزبون السابق.</div>';

          if(notesArr.length){
            notesArr.forEach(function(n, i){
              const text = escHtmlLocal(n.text || '');
              const when = tinyTime(n.at || n.updatedAt || new Date());
              notesHtml +=
                '<div class="note-row">' +
                  '<div class="note-idx">#'+ (i+1) +'</div>' +
                  '<div class="note-text">'+ text +'</div>' +
                  '<div class="note-time">'+ when +'</div>' +
                '</div>';
            });
          }

          // نوع الفاتورة بادجات
          var typeClass = 'badge-type-mixed';
          if(billType === 'بيع') typeClass = 'badge-type-sell';
          if(billType === 'راجع') typeClass = 'badge-type-return';

          var newBadge = (!isKnownCustomer && card.customer)
            ? '<span class="badge badge-new">زبون جديد</span>'
            : '';

          root.innerHTML =
            '<div class="inv-header">' +
              '<div class="inv-head-left">' +
                '<div class="logo-box">AS</div>' +
                '<div class="brand-block">' +
                  '<div class="brand-name">مكتب عسل</div>' +
                  '<div class="brand-sub">نظام إدارة ديون وفواتير الزبائن</div>' +
                  '<div class="brand-line">بعقوبة - شارع الأوقاف، قرب البيت الكوري | 07728640560</div>' +
                '</div>' +
              '</div>' +
              '<div class="inv-head-right">' +
                '<table class="meta-table">' +
                  '<tr>' +
                    '<td class="meta-label">رقم الفاتورة</td>' +
                    '<td class="meta-value">'+ (invoiceId ? 'INV-' + invoiceId : '-') +'</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<td class="meta-label">التاريخ</td>' +
                    '<td class="meta-value">'+ escHtmlLocal(dateStr || '-') +'</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<td class="meta-label">الوقت</td>' +
                    '<td class="meta-value">'+ escHtmlLocal(timeStr || '-') +'</td>' +
                  '</tr>' +
                '</table>' +
                '<div class="invoice-title"><span>'+ billLabel +'</span></div>' +
              '</div>' +
            '</div>' +

            '<div class="inv-row">' +
              '<div class="inv-card">' +
                '<div class="inv-card-header">السيد</div>' +  /* ✅ بس "السيد" مثل ما طلبت */
                '<div class="cust-name-line">' +
                  '<span>'+ escHtmlLocal(card.customer || '') +'</span>' +
                  newBadge +
                '</div>' +
                '<div class="inv-card-text">هذه الفاتورة تمثل حركة الديون الخاصة بالزبون في هذا اليوم.</div>' +
              '</div>' +
              '<div class="inv-card">' +
                '<div class="inv-card-header">بيانات الفاتورة</div>' +
                '<div class="inv-card-text" style="margin-bottom:4px;">' +
                  '<span class="badge '+ typeClass +'">'+ billLabel +'</span>' +
                '</div>' +
                '<div class="inv-card-text">' +
                  ' عدد سطور الفاتورة (دين فقط) : ' +
                  '<strong>'+ effectiveCount +'</strong>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div class="table-wrap">' +
              '<table>' +
                '<thead>' +
                  '<tr>' +
                    '<th class="col-idx">#</th>' +
                    '<th>الصنف</th>' +
                    '<th>اسم المادة</th>' +
                    '<th class="col-qty">العدد</th>' +
                    '<th class="col-price">السعر</th>' +
                    '<th class="col-total">الإجمالي</th>' +
                    '<th>ملاحظات</th>' +
                    '<th>الوقت</th>' +
                    '<th class="col-state">الحالة</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody>'+ rowsHtml +'</tbody>' +
              '</table>' +
            '</div>' +

            '<div class="bottom-row">' +
              '<div class="notes-box">'+
                notesHtml +
              '</div>' +
              '<div class="totals-card">' +
                '<div class="totals-title">مجموع الفاتورة</div>' +
                '<div class="totals-row totals-main">' +
                  '<div class="totals-label">اجمالي الفاتورة (دين فقط)</div>' +
                  '<div class="totals-value">'+ formatIQD(totals.unpaid) +'</div>' +
                '</div>' +
                '<div class="totals-row">' +
                  '<div class="totals-label">إجمالي المواد المسترجعة</div>' +
                  '<div class="totals-value totals-value-minus">'+ (totals.returned ? ('-' + formatIQD(totals.returned)) : '0') +'</div>' +
                '</div>' +
              '</div>' +
            '</div>' +

            '<div class="inv-footer">' +
              '<div>تم إنشاء هذه الفاتورة من خلال نظام "ASSAL" لإدارة الديون والفواتير.</div>' +
              '<div class="sign-block">' +
                '<div>توقيع المسؤول</div>' +
                '<div class="sign-line">التوقيع / الختم</div>' +
              '</div>' +
            '</div>';

          setTimeout(function(){
            window.focus();
            window.print();
          }, 250);
        })();
      <\/script>
    </body>
    </html>
  `);

  w.document.close();
  showToast('success','جاهز لطباعة البطاقة — اختر "حفظ كـ PDF"');
}
















// خريطة أرقام الكاجوري → اسم التوافق
const COMPAT_CATEGORY_MAP = {
  '1':  'شاشات',
  '2':  'بطاريات',
  '3':  'جرس النغمات',
  '4':  'سماعة الاتصال',
  '5':  'كاميرات',
  '6':  'عدسة الكاميرا',
  '7':  'بورد الشحن',
  '8':  'قواعد الشحن',
  '9':  'كونكتر الشاشة',
  '10': 'بصمات',
  '11': 'شريط الهيتفون',
  '12': 'شريط البور والصوت',
  '13': 'گلاسات',
  '14': 'شريط الهوم',
  '15': 'آيسيات',
  '16': 'فلاتات الشاشة',
  '17': 'هولدر السيم كارت',
  '18': 'بصمات تحت الشاشة',
  '19': 'كيبلات الإشارة'
};




/* ===== توافقات قطع الغيار: واجهة المودال ===== */

function initCompatModal(){
  const bd        = document.getElementById('compatBackdrop');
  const md        = document.getElementById('compatModal');
  const btnOpen   = document.getElementById('btnCompatSearch');
  const btnClose  = document.getElementById('closeCompatBtn');
  const inp       = document.getElementById('compatSearchInput');
  const btnSearch = document.getElementById('compatSearchBtn');
  const btnClear  = document.getElementById('compatSearchClear'); // زر X الجديد
  const suggBox   = document.getElementById('compatSuggestions');
  const resultsBox= document.getElementById('compatResults');
  const countChip = document.getElementById('compatCount');
  
   // الأزرار الجديدة لوضع البحث
   const btnModeCompat = document.getElementById('compatModeCompat');
  const btnModePrice  = document.getElementById('compatModePrice');

  if (!bd || !md || !btnOpen || !inp || !resultsBox) return;

  // 'compat' = توافقات، 'price' = أسعار
  let compatMode = 'compat';

 function setCount(n){
  if (!countChip) return;

  // نشيل الكلاسات كل مرة قبل التحديث
  countChip.classList.remove('has-results', 'has-zero');

  if (!Number.isFinite(n) || n < 0){
    countChip.textContent = '—';
  }else{
    countChip.textContent =
      (n === 0)
        ? '0 نتيجة'
        : `${n.toLocaleString('ar-IQ')} نتيجة`;

    // نضيف الكلاس حسب عدد النتائج
    if (n === 0){
      countChip.classList.add('has-zero');
    }else{
      countChip.classList.add('has-results');
    }
  }
}


  function renderEmpty(messageHtml){
    resultsBox.innerHTML = `
      <div class="compat-empty">
        <i class="fa-regular fa-face-frown"></i>
        <p>${messageHtml}</p>
      </div>
    `;
  }

  function renderInitial(){
    resultsBox.innerHTML = `
      <div class="compat-empty">
        <i class="fa-regular fa-lightbulb"></i>
        <p>ابدأ بكتابة جزء من الاسم لعرض التوافقات.</p>
      </div>
    `;
    if (suggBox){
      suggBox.innerHTML = '';
      suggBox.style.display = 'none';
    }
    setCount(null);
  }
  
  
    function setMode(mode){
    compatMode = (mode === 'price') ? 'price' : 'compat';

    if (btnModeCompat){
      btnModeCompat.classList.toggle('is-active', compatMode === 'compat');
    }
    if (btnModePrice){
      btnModePrice.classList.toggle('is-active', compatMode === 'price');
    }

    if (compatMode === 'compat'){
      inp.placeholder = 'اكتب اسم الجهاز أو القطعة…';
      if (!inp.value.trim()){
        renderInitial();
      }
    }else{
      inp.placeholder = 'اكتب اسم الجهاز أو القطعة للبحث في الأسعار…';
      if (!inp.value.trim()){
        resultsBox.innerHTML = `
          <div class="compat-empty">
            <i class="fa-regular fa-lightbulb"></i>
            <p>اكتب جزء من الاسم للبحث عن <strong>أسعار المواد</strong> من الملف الرئيسي.</p>
          </div>
        `;
        setCount(null);
      }
    }
  }

  // ربط الأزرار
  btnModeCompat && btnModeCompat.addEventListener('click', () => {
    setMode('compat');
    inp.focus();
  });

  btnModePrice && btnModePrice.addEventListener('click', () => {
    setMode('price');
    inp.focus();
  });

  

  function openModal(){
    bd.classList.add('active');
    md.classList.add('active');
    document.body.classList.add('modal-open');

    renderInitial();
    inp.value = '';

    // نحمل ملف التوافقات بالخلفية
    loadCompatExcel().catch(()=>{ /* الخطأ ينعرض بتوست */ });

    setTimeout(() => inp.focus(), 40);
  }

  function closeModal(){
    bd.classList.remove('active');
    md.classList.remove('active');
    document.body.classList.remove('modal-open');
  }


  // Helper: نحاول نجيب قيمة حقل حسب مجموعة مفاتيح محتملة
  function getCompatField(row, keys){
    if (!row) return '';
    for (const k of keys){
      if (k in row && row[k] != null && String(row[k]).trim() !== ''){
        return row[k];
      }
    }
    return '';
  }




  let compatCards = [];
  let activeCardIndex = -1;

  function setActiveCard(idx){
    compatCards.forEach((el, i) => {
      el.classList.toggle('is-active', i === idx);
    });
    if (idx >= 0 && compatCards[idx]){
      compatCards[idx].scrollIntoView({
        block: 'nearest',
        inline: 'nearest',
        behavior: 'smooth'
      });
    }
  }




function renderCompatResults(rows, term){
  resultsBox.innerHTML = '';

  if (!rows || !rows.length){
    renderEmpty(
      `ماكو توافقات مطابقة لـ "<strong>${escHtml(term)}</strong>".`
    );
    setCount(0);
    return;
  }

  const frag = document.createDocumentFragment();

  // الحقول اللي ما نريد لا تنعرض بالـ grid ولا تنستخدم كـ fallback
  const HIDDEN_KEYS = new Set([
    'Item',                 // التوافق المفصّل (إحنا طالعينه فوق بالمستطيل)
    'New', 'الحالة',        // نخفي حقل New
    'Category','الكاجوري','CAT','cat','category', // نستخدمه للكاجوري بس نخفيه من العرض
    'التوافق','توافق',
    'Compat','compat','Compatibility','COMPAT',
    'match'
  ]);

  rows.forEach((row) => {
    const card = document.createElement('div');
    card.className = 'compat-card';

    // ===== الهيدر: مربع أحمر + مستطيل التوافق =====
    const head = document.createElement('div');
    head.className = 'compat-card__head';

    // رقم الكاجوري
    const rawCatCode = getCompatField(row, [
      'الكاجوري','Category','CAT','cat','category'
    ]);
    const catCodeStr = String(rawCatCode ?? '').trim();

    // اسم التوافق من الماب
    const catName = COMPAT_CATEGORY_MAP[catCodeStr] ||
      (catCodeStr ? `كود ${catCodeStr}` : 'غير مصنّف');

    const catBox = document.createElement('div');
    catBox.className = 'compat-cat-box';
    catBox.textContent = catName;

    // نحاول نجيب حقل "التوافق"
    let rawCompat = getCompatField(row, [
      'التوافق','توافق',
      'Compat','compat','Compatibility','COMPAT','match',
      'الوصف','Description','Desc',
      'Item' // احتياط لأن هواية ملفات تخلي التوافق جوّا الـ Item
    ]);

    // لو ماكو أي من الأسماء فوق، نطيح على أول قيمة نصية من الحقول غير المخفية
    if (!rawCompat){
      for (const [k, v] of Object.entries(row || {})){
        if (HIDDEN_KEYS.has(k)) continue;
        const txt = String(v ?? '').trim();
        if (!txt) continue;
        rawCompat = txt;
        break;
      }
    }

    const compatText = String(rawCompat ?? '').trim() || '—';

    const compatEl = document.createElement('div');
    compatEl.className = 'compat-main-text';
    compatEl.textContent = compatText;

    head.append(catBox, compatEl);

    // ===== باقي الحقول بنفس الـ grid، بدون الكاجوري/التوافق/New/Category/Item =====
    const grid = document.createElement('div');
    grid.className = 'compat-card__grid';

    Object.entries(row || {}).forEach(([key, val]) => {
      if (HIDDEN_KEYS.has(key)) return;

      const txt = String(val ?? '').trim();
      if (!txt) return;

      const item = document.createElement('div');
      item.className = 'compat-attr';

      const kEl = document.createElement('div');
      kEl.className = 'compat-attr__label';
      kEl.textContent = key;

      const vEl = document.createElement('div');
      vEl.className = 'compat-attr__value';
      vEl.textContent = txt;

      item.append(kEl, vEl);
      grid.append(item);
    });

    card.append(head, grid);
    frag.append(card);
  });

  resultsBox.append(frag);

  // خزن الكروت للتحكم بيها من الكيبورد
  compatCards = Array.from(resultsBox.querySelectorAll('.compat-card'));
  activeCardIndex = compatCards.length ? 0 : -1;
  if (activeCardIndex >= 0){
    setActiveCard(activeCardIndex);
  }

  setCount(rows.length);
}


  // مساعد لجلب حقل من صف الأسعار
// مساعد عام: يرجع أول حقل موجود من مجموعة مفاتيح
function getPriceField(row, keys){
  if (!row) return '';
  for (const k of keys){
    if (k in row && row[k] != null && String(row[k]).trim() !== ''){
      return row[k];
    }
  }
  return '';
}



// خريطة أسماء الشيتات → اسم الصنف
const PRICE_SHEET_LABELS = {
  LCD       : 'شاشات',
  BATTERY   : 'بطاريات',
  HOUSING   : 'شواصي',
  BACK      : 'أظهر',
  CAMERA    : 'كاميرات',
  CHARGING  : 'بورد الشحن',
  BUZZER    : 'جرس',
  SPEAKER   : 'سماعات',
  'FLAT SPEAKER': 'فلات سماعة',
  FINGER    : 'بصمات',
  'FLAT LCD': 'فلاتات الشاشة',
  POWER     : 'فلات البور',
  VOLUME    : 'فلات الصوت',
  LENS      : 'عدسات'
};

// مساعد يرجّع أول حقل موجود من مجموعة مفاتيح
function getPriceField(row, keys){
  if (!row) return '';
  for (const k of keys){
    if (k in row && row[k] != null && String(row[k]).trim() !== ''){
      return row[k];
    }
  }
  return '';
}

// ==== عرض نتائج الأسعار: سطر واحد (الصنف - الايتم - السعر) ====
function renderPriceResults(records, term){
  resultsBox.innerHTML = '';

  if (!records || !records.length){
    renderEmpty(
      `ماكو مواد مطابقة لـ "<strong>${escHtml(term)}</strong>" في ملف الأسعار.`
    );
    setCount(0);
    return;
  }

  const frag = document.createDocumentFragment();

  records.forEach((rec) => {
    const row   = rec.row   || {};
    const sheet = rec.sheet || '';

    // الصنف من اسم الشيت حصراً
    const typeText = PRICE_SHEET_LABELS[sheet] || sheet || '—';

    // اسم الايتم
    const itemText =
      getPriceField(row, [
        'Item Name','Item','ITEM',
        'اسم المادة','اسم القطعة','اسم',
        'الوصف','Description','Desc'
      ]) || '—';

    // السعر (Discount Price إذا موجود، وإلا Price)
    const discountRaw =
      getPriceField(row, ['Discount Price','DISCOUNT PRICE','discount price','DiscountPrice','سعر الخصم','سعر_الخصم']);

    const priceRaw =
      (discountRaw != null && String(discountRaw).trim() !== '')
        ? discountRaw
        : getPriceField(row, ['Price','PRICE','price','السعر']);

    const priceText =
      priceRaw != null && String(priceRaw).trim() !== ''
        ? formatIQD(priceRaw)
        : '—';

    // الكارت نفسه
    const card = document.createElement('div');
    card.className = 'compat-card compat-card--price';

    // سطر واحد فقط داخل الكارت
    const line = document.createElement('div');
    line.className = 'compat-price-line';

    const typeChip = document.createElement('div');
    // نستعمل نفس الكلاس مال التوافقات
    typeChip.className = 'compat-cat-box compat-type-chip';
    typeChip.textContent = typeText;

    const itemChip = document.createElement('div');
    itemChip.className = 'ichip compat-item-chip';
    itemChip.textContent = itemText;   // 👈 الايتم (SAMSUNG A107 ...)

    const priceChip = document.createElement('div');
    priceChip.className = 'ichip compat-price-chip';
    priceChip.textContent = priceText; // 👈 السعر (14000)

    line.append(typeChip, itemChip, priceChip);
    card.append(line);
    frag.append(card);
  });

  resultsBox.append(frag);

  // تفعيل الكروت للكيبورد إذا محتاج
  compatCards = Array.from(resultsBox.querySelectorAll('.compat-card'));
  activeCardIndex = compatCards.length ? 0 : -1;
  if (activeCardIndex >= 0){
    setActiveCard(activeCardIndex);
  }

  setCount(records.length);
}





  async function runSearch(){
    const term = inp.value.trim();
    if (!term){
      if (typeof showToast === 'function'){
        showToast('warn','اكتب كلمة بحث أولاً');
      }
      inp.focus();
      return;
    }

    if (compatMode === 'compat'){
      // نفس السلوك القديم: ملف التوافقات
      if (!compatLoaded){
        try{
          await loadCompatExcel();
        }catch{
          return; // الخطأ انعرض بالتوست
        }
      }

      const matches = findCompatMatches(term);
      renderCompatResults(matches, term);

    }else{
      // وضع "أسعار" → نبحث في الملف الرئيسي لكل الشيتات
      try{
        if (!database || !Object.keys(database).length){
          await loadExcelFiles();
        }
        if (!priceIndexBuilt){
          buildPriceIndexFromDatabase();
        }
      }catch(err){
        console.error('❌ خطأ تحميل ملف الأسعار الرئيسي:', err);
        if (typeof showToast === 'function'){
          showToast('error','تعذر تحميل ملف الأسعار الرئيسي');
        }
        return;
      }

      const matches = findPriceMatches(term);
      renderPriceResults(matches, term);
    }

    if (suggBox){
      suggBox.style.display = 'none';
      suggBox.innerHTML = '';
    }
  }


  function updateSuggestions(){
    // ما نستخدم الاقتراحات بعد
    if (suggBox){
      suggBox.style.display = 'none';
      suggBox.innerHTML = '';
    }
  }


  // ربط الأزرار والأحداث
  btnOpen.onclick  = openModal;
  btnClose && (btnClose.onclick = closeModal);

  bd.addEventListener('click', (e) => {
    if (e.target === bd) closeModal();
  });

  btnSearch && btnSearch.addEventListener('click', (e) => {
    e.preventDefault();
    runSearch();
  });
  
    // زر مسح البحث (X) — يصفر الحقل ويرجع الشاشة الابتدائية
  btnClear && btnClear.addEventListener('click', (e) => {
    e.preventDefault();
    inp.value = '';
    renderInitial();   // يرجع رسالة "ابدأ بكتابة جزء من الاسم…" + يصفر العداد
    inp.focus();
  });


  inp.addEventListener('input', () => {
    // نحاول نحمّل الملف أول مرة بصمت
    if (!compatLoaded && !compatLoading){
      loadCompatExcel().catch(()=>{});
    }
    // ماكو اقتراحات بعد
  });


  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){
      e.preventDefault();
      runSearch();

    } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp'){
      if (!compatCards.length) return;
      e.preventDefault();

      if (e.key === 'ArrowDown'){
        activeCardIndex = Math.min(
          activeCardIndex + 1,
          compatCards.length - 1
        );
      }else{
        activeCardIndex = Math.max(
          activeCardIndex - 1,
          0
        );
      }
      setActiveCard(activeCardIndex);

    } else if (e.key === 'Escape'){
      if (suggBox && suggBox.style.display === 'block'){
        suggBox.style.display = 'none';
        suggBox.innerHTML = '';
      }else{
        closeModal();
      }
    }
  });



  // كليك على الاقتراح
  suggBox && suggBox.addEventListener('click', (e) => {
    const item = e.target.closest('.sugg-item');
    if (!item) return;
    const label = item.getAttribute('data-label') || '';
    inp.value = label;
    runSearch();
  });

  // إخفاء الاقتراحات لو نقرنا برّه
  document.addEventListener('click', (e) => {
    if (!md.classList.contains('active') || !suggBox) return;
    const inside = suggBox.contains(e.target) || inp.contains(e.target);
    if (!inside){
      suggBox.style.display = 'none';
    }
  });

  // Esc يغلق المودال لو مفتوح
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && md.classList.contains('active')){
      e.preventDefault();
      closeModal();
    }
  });
    // الوضع الافتراضي عند فتح الصفحة
  setMode('compat');

}








// ربط الأزرار والملف
const btnExportAll = document.getElementById('btnExportAll');
const btnImportAll = document.getElementById('btnImportAll');
const importInput  = document.getElementById('importFile');



// بعد ربط الأزرار مباشرةً:
updateRoleUIState();
initCompatModal();


document.getElementById('btnNextDay')?.addEventListener('click', toggleNextDayFromToday);


// التصدير الآن يرفع إلى السيرفر (ويب آب)
btnExportAll && (btnExportAll.onclick = smartExportToServer);

btnImportAll && (btnImportAll.onclick = async () => {
if (document.visibilityState !== 'visible'){
return showToast?.('warn','افتح التبويب قدّامك قبل السحب');
}
if (!navigator.onLine){
return showToast?.('error','ماكو إنترنت للسحب');
}


// قفل الأوتو-سنك مؤقت
const unlockAt = Date.now() + 20_000;
SYNC_BLOCK_UNTIL = Math.max(SYNC_BLOCK_UNTIL, unlockAt);


cancelInFlightSync();


try{
// === سلوك الفرعية: سحب فقط بدون أي رفع ===
if (typeof isSubDevice === 'function' && isSubDevice()){
showToast?.('info','جهاز فرعي: نسحب فقط بدون رفع…');
const server = await serverGetBackup(getSyncSignal());
await smartImportFromServer?.(server);
showToast?.('success','تم السحب (بدون رفع)');
return;
}


// === سلوك الرئيسية: نرفع أولاً ثم نسحب ===
showToast?.('info','نرفع التعديلات المحلية أولًا…');
const payload = buildBackupPayload();
await serverPostBackup(payload, getSyncSignal());


showToast?.('info','حسنًا، هسّه نسحب آخر نسخة من السيرفر…');
const server = await serverGetBackup(getSyncSignal());


// دمج/استبدال بحسب منطقك الحالي في smartImportFromServer
await smartImportFromServer?.(server);


showToast?.('success','تم الرفع ثم السحب بنجاح');
}catch(e){
if (e.name === 'AbortError') return; // تم إلغاء العملية
console.error(e);
showToast?.('error','فشل إجراء السحب: '+ (e?.message||e));
}
});


importInput && (importInput.onchange = (e) => {
  const file = e.target.files?.[0];
  if(file) importInvoicesFromFile(file);
  e.target.value = ''; // حتى تقدر تختار نفس الملف مرة ثانية
});





// --- ضعها قبل exportInvoices() ---
function prepareCleanPayload(daysObj, namesArr){
  const cleanDays = {};
  for (const [dayKey, cards] of Object.entries(daysObj || {})) {
    const activeCards = (cards || [])
      .filter(c => !c?.deletedAt)
      .map(c => ({
        ...c,
        lines: (c.lines || []).filter(l => !l?.deletedAt),
        notes: (c.notes || []).filter(n => !n?.deletedAt)
      }))
      .sort((a,b)=> new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0));
    if (activeCards.length) cleanDays[dayKey] = activeCards;
  }

  // الأسماء الفعّالة فقط (الموجودة فعلاً ببطاقات فعّالة)
  const allowedNames = new Set();
  for (const cards of Object.values(cleanDays)) {
    for (const c of cards) if (c.customer) allowedNames.add(String(c.customer).trim());
  }
  const cleanNames = (namesArr || []).filter(n => allowedNames.has(String(n).trim()));

  return {
    version: 3,
    exportedAt: new Date().toISOString(),
    days: cleanDays,
    names: cleanNames
  };
}









function isActiveCard(card){
  if (!card || card.deletedAt) return false;
  const lines = Array.isArray(card.lines) ? card.lines.filter(l => !l.deletedAt) : [];
  return lines.length > 0; // لازم بيه مواد فعلية
}


// ===== تصدير/استيراد كل الفواتير (JSON) =====

// يبقي بس البيانات الفعّالة (غير محذوفة)
// يبقي بس البطاقات التي تحتوي أسطر فعّالة (الملاحظات لا تكفي لوحدها)
function compactDaysForExport(srcDays){
  const out = {};
  for (const [day, cards] of Object.entries(srcDays || {})) {
    const kept = [];
    for (const c of (cards || [])) {
      if (c?.deletedAt) continue;

      const lines = (c.lines || []).filter(l => !l?.deletedAt);
      if (lines.length === 0) continue; // <-- هنا التغيير: تجاهل أي بطاقة بلا أسطر

      // الملاحظات نضمّنها فقط كمعلومات إضافية، لكنها ما تأثر على قرار الإبقاء
      const notes = (c.notes || []).filter(n => !n?.deletedAt);

      const copy = {
        id       : c.id,
        customer : c.customer,
        createdAt: c.createdAt,
        updatedAt: c.updatedAt,
        paidAll  : !!c.paidAll,
        billType : c.billType,
        lines,
        notes
      };
      delete copy.deletedAt;
      kept.push(copy);
    }
    if (kept.length) out[day] = kept;
  }
  return out;
}






// ===== (اختياري) تنظيف محلي مرّة واحدة =====
// يشيل أي بطاقة ما بيها ولا سطر فعّال، حتى لو عدها ملاحظات
function cleanupLocalOnce(){
  if (!days || typeof days !== 'object') return 0;

  let changes = 0;
  const hasActiveLine = (card)=> (card.lines||[]).some(l => !l.deletedAt);

  Object.keys(days).forEach(dayKey=>{
    const arr = Array.isArray(days[dayKey]) ? days[dayKey] : [];
    const kept = arr.filter(hasActiveLine);
    changes += (arr.length - kept.length);
    if (kept.length) days[dayKey] = kept;
    else { delete days[dayKey]; changes++; }
  });

  save?.(); renderBoard?.(); renderRail?.(); refreshStats?.();
  showToast?.('success', changes ? `تم تنظيف ${changes} عنصر قديم` : 'لا يوجد شيء للتنظيف');
  return changes;
}






function cleanupEmptyCardsOnce(){
  let changed = 0;
  for(const [day, cards] of Object.entries(days || {})){
    const before = (cards || []).length;
    const afterArr = (cards || []).filter(isActiveCard);
    if (afterArr.length !== before){
      days[day] = afterArr;
      changed++;
    }
  }
  if (changed){
    save();
    renderBoard(); renderRail(); refreshStats();
    showToast('success', `تنظيف تم: ${changed} يوم تغيّر`);
  }else{
    showToast('info','ماكو شي يحتاج تنظيف');
  }
}
// نادِها يدويًا من الكونسول إذا تريد: cleanupEmptyCardsOnce()




// تصدير محلي نظيف: بدون تومبستونات + أسماء من CUSTOMERS فقط
function exportInvoices(){
  try{
    const payload = {
      version   : 3,
      mode      : "clean", // علم يفيد بالاستيراد
      exportedAt: new Date().toISOString(),
      days      : compactDaysForExport(days || {}),
      names     : Array.from(CUSTOMERS) // أو [] إذا ما تريدها
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const d = new Date().toISOString().slice(0,10);
    a.download = `assal-bills-backup-${d}.json`;
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
    showToast?.('success','تم تصدير الفواتير كـ JSON (نظيف)');
  }catch(err){
    console.error(err);
    showToast?.('error','تعذّر التصدير');
  }
}







async function importInvoicesFromFile(file){
  if(!file) return;
  try{
    const text = await file.text();
    let data = JSON.parse(text);

    // هيّئ بيانات الملف بنمط موحّد
    let fileDays  = {};
    let fileNames = [];
    if(data && typeof data === 'object'){
      if(data.days){            // فورمات جديد {version, days, names, ...}
        fileDays  = data.days || {};
        fileNames = data.names || [];
      }else{                    // فورمات قديم: كائن أيام مباشرة
        fileDays  = data;
      }
    }else{
      showToast?.('error','ملف غير صالح');
      return;
    }

    // دمج قوي: المحلي × الملف
    const localDays = days || {};
    const { days: mergedDays, report } = mergeAllDays(localDays, fileDays);


    // خزّن النتيجة المدموجة
    localStorage.setItem(STORAGE, JSON.stringify(mergedDays));

    // الأسماء: دمج بسيط (مجموعة)
    const curNames = Array.isArray(names) ? names : [];
    const newNames = Array.isArray(fileNames) ? fileNames : [];
    const namesSet = new Set([ ...curNames, ...newNames ]);
    const mergedNames = Array.from(namesSet);
    localStorage.setItem(NAMES, JSON.stringify(mergedNames));

    // حدّث الذاكرة والواجهة
    days  = load(STORAGE, {});
    names = load(NAMES,   []);
    renderBoard(); renderRail(); refreshStats();

    const changes = report.length;
    showToast?.('success', changes ? `تم الدمج من الملف (${changes} تغيير)` : 'لا تغييرات من الملف');

    // (اختياري) تقرير للكونسول
    console.groupCollapsed('ASSAL MERGE REPORT (FILE)');
    report.forEach(r=> console.log(r));
    console.groupEnd();

  }catch(err){
    console.error(err);
    showToast?.('error','تعذّر قراءة/دمج الملف');
  }
}




// يرجّع 'YYYY-MM-DD' بعد n أيام من ISO معيّن
function addDaysISO(iso, n=1){
  try{
    const d = new Date(iso);
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0,10);
  }catch{ 
    const t = new Date(); t.setDate(t.getDate()+n);
    return t.toISOString().slice(0,10);
  }
}

// افتح يوم "باجر" بالنسبة لتاريخ اليوم الحقيقي (TODAY)
function openNextDayFromToday(){
  const nextISO = addDaysISO(TODAY, 1);      // باجر
  selectedDay = nextISO;

  // إذا اليوم ما موجود بالقائمة، سوّي مصفوفة فارغة
  if(!days[selectedDay]) days[selectedDay] = [];

  // خزّن التغيير (حتى إذا أضفت مواد فورًا تبقى على نفس المفتاح)
  save();

  // حدّث شارة التاريخ بالهيدر حتى توضح إنّه على اليوم التالي
  const badge = document.getElementById('dateBadge');
  if(badge){
    badge.textContent = arDateWithDay(selectedDay) + ' — (اليوم التالي)';
  }

  renderBoard();
  renderRail();
  refreshStats();

  showToast('info','تم فتح فاتورة اليوم التالي');
}



// زر "اليوم التالي" يشتغل كتبديل (أول كلك يفتح، ثاني كلك يلغي إذا فارغ)
function toggleNextDayFromToday(){
  const nextISO = addDaysISO(TODAY, 1);   // باجر
  const btn     = document.getElementById('btnNextDay');

  // إذا إحنا واقفين أصلاً على اليوم التالي → هذي تعتبر "الضغطة الثانية"
  if (selectedDay === nextISO){
    // نتأكد إذا بيه بطائق فعّالة
    let hasCards = false;
    try{
      if (typeof activeCardsOfDay === 'function'){
        hasCards = activeCardsOfDay(nextISO).length > 0;
      }else{
        hasCards = Array.isArray(days[nextISO]) && days[nextISO].length > 0;
      }
    }catch(e){
      hasCards = Array.isArray(days[nextISO]) && days[nextISO].length > 0;
    }

    // إذا بيه بطائق → لا نسمح نحذفه
    if (hasCards){
      showToast?.('error','لا يمكن مسح اليوم التالي لوجود بطائق فيه');
      return;
    }

    // ماكو بطائق → نحذف اليوم ونرجّع لليوم الحقيقي
    if (days[nextISO]){
      delete days[nextISO];
      save();
    }

    // رجع لليوم الحالي (TODAY)
    selectedDay = TODAY;

    const badge = document.getElementById('dateBadge');
    if (badge){
      badge.textContent = arDateWithDay(selectedDay);
    }

    if (btn) btn.classList.remove('nextday-active');

    renderBoard();
    renderRail();
    refreshStats();

    showToast?.('info','تم إلغاء فتح اليوم التالي (ما بيه بطائق)');
  }else{
    // أول ضغطة → نفس سلوكك القديم: يفتح يوم باچر
    openNextDayFromToday();
    if (btn) btn.classList.add('nextday-active');
  }
}





/* ====== Sync Helpers (Server <-> Local) ====== */

// احسب أحدث وقت تعديل داخل كل البيانات (بطاقات/سطور/ملاحظات)
function getUpdatedAtMax(daysObj){
  let maxTs = 0;
  const asTs = (d)=> (d ? new Date(d).getTime() : 0);

  Object.values(daysObj||{}).forEach(cards=>{
    (cards||[]).forEach(card=>{
      maxTs = Math.max(maxTs, asTs(card.updatedAt), asTs(card.createdAt));
      
      
      (card.lines||[]).forEach(l=>{
  maxTs = Math.max(maxTs, asTs(l.updatedAt), asTs(l.createdAt), asTs(l.at));
});
(card.notes||[]).forEach(n=>{
  maxTs = Math.max(maxTs, asTs(n.updatedAt), asTs(n.at));
});

      
      
    });
  });
  return maxTs || 0;
}



// [NEW] مفتاح تطبيع موحد لكل عنصر تسديد (يدعم وجود id أو بدونه)
function __paymentKey__(p){
  try{
    // إذا عندك id ثابت استعمله
    if (p && (p.id || p._id)) return String(p.id || p._id);
    // إذا ماكو id: سوّي مفتاح مركّب من الحقول الاعتيادية (عدّل الأسماء إذا عندك غيرها)
    const obj = {
      cust      : (p.cust ?? p.customer ?? "").trim(),
      date      : p.date      ?? p.day      ?? "",
      time      : p.time      ?? "",
      amount    : p.amount    ?? p.value    ?? p.qty ?? "",
      type      : p.type      ?? p.kind     ?? "",
      note      : (p.notes    ?? p.note     ?? p.desc ?? p.text ?? "").trim()
    };
    // تطبيع بسيط حتى ما تختلف المسافات/الأحرف
    return JSON.stringify(obj);
  }catch{
    return JSON.stringify(p ?? {});
  }
}


// [NEW] إزالة التكرار لكل يوم
function __dedupePaymentList__(list){
  const seen = new Set();
  const out  = [];
  (Array.isArray(list) ? list : []).forEach(p=>{
    const k = __paymentKey__(p);
    if(!seen.has(k)){
      seen.add(k);
      out.push(p);
    }
  });
  return out;
}

// [NEW] إزالة التكرار لكائن كل الأيام { 'YYYY-MM-DD': [ ... ] }
function __dedupePaymentsObject__(payObj){
  const src = (payObj && typeof payObj === 'object') ? payObj : {};
  const out = {};
  Object.keys(src).forEach(day=>{
    out[day] = __dedupePaymentList__(src[day]);
  });
  return out;
}



// حضّر بايلود النسخة الاحتياطية (نفس فورماتك + updatedAtMax + transferDate)
// (REPLACED) حضّر بايلود النسخة الاحتياطية (نفس فورماتك + updatedAtMax + transferDate + payments)
function buildBackupPayload(){
  const payload = {
    version      : 3,
    exportedAt   : new Date().toISOString(),
    updatedAtMax : getUpdatedAtMax(days || {}),
    days         : days  || {},
    names        : names || [],
    transferDate : getTransferDateIso() || "",
    payments     : (function(){ // [NEW]
      try{
        const raw = localStorage.getItem('assal.payments.v1') || '{}';
        const obj = JSON.parse(raw);
        return (obj && typeof obj === 'object') ? obj : {};
      }catch{ return {}; }
    })()
  };
  return payload;
}



// [NEW] حمل مخزن الحسابات المالية (بدون الاعتماد على سكوب الـ IIFE)
function loadPaymentsStore(){
  try{
    const raw = localStorage.getItem('assal.payments.v1') || '{}';
    const obj = JSON.parse(raw);
    return (obj && typeof obj === 'object') ? obj : {};
  }catch{
    return {};
  }
}


// [NEW] دمج payments per-day: نلمّ بيانات السيرفر والمحلي
function mergePaymentsStores(localStore, remoteStore){
  const out = { ...(remoteStore || {}) };
  const loc = (localStore  && typeof localStore  === 'object') ? localStore  : {};
  const rem = (remoteStore && typeof remoteStore === 'object') ? remoteStore : {};

  Object.keys(loc).forEach(dayKey=>{
    const L = Array.isArray(loc[dayKey]) ? loc[dayKey] : [];
    const R = Array.isArray(rem[dayKey]) ? rem[dayKey] : [];
    // نستسهل: نخلي (سيرفر ثم محلي) حتى ما نخسر أي سجل
    // out[dayKey] = [...R, ...L];

    // ✅ تعديل: دمج ذكي حسب الهوية، والأحدث بين updatedAt/deletedAt يغلب
    const map = new Map();

    const keyOf = (row)=>{
      try {
        return String(
          row?.id || row?._id ||
          (typeof __paymentKey__ === 'function' ? __paymentKey__(row) :
            JSON.stringify([row?.cust, row?.date, row?.time, row?.amount, row?.kind]))
        );
      } catch {
        return String(Math.random());
      }
    };

    const stamp = (row)=>{
      const t = new Date(row?.updatedAt || row?.deletedAt || 0).getTime();
      return isNaN(t) ? 0 : t;
    };

    const put = (row)=>{
      const k = keyOf(row);
      if (!map.has(k)){
        map.set(k, { ...row });
      } else {
        const cur = map.get(k);
        // الأحدث يربح (يأخذ بالاعتبار deletedAt أيضاً)
        map.set(k, stamp(row) > stamp(cur) ? { ...row } : cur);
      }
    };

    // نحافظ على أسبقية السيرفر ثم ندمج المحلي مع فضّ النزاع
    R.forEach(put);
    L.forEach(put);

    out[dayKey] = Array.from(map.values());
  });

  return out;
}






async function serverGetBackup(signal){
const base = SYNC.BASE_URL; // لازم يكون رابط الويب آب وينتهي بـ /exec
const sep = base.includes('?') ? '&' : '?';
const url = `${base}${sep}token=${encodeURIComponent(SYNC.TOKEN)}&_=${Date.now()}`;


const resp = await fetch(url, {
method: 'GET',
cache : 'no-store',
signal
});
if(!resp.ok) throw new Error('GET failed');
return await resp.json();
}


// نفس الاسم ونفس المتغيرات SYNC.BASE_URL و SYNC.TOKEN
async function serverPostBackup(payload, signal){
const body = JSON.stringify(payload);
const size = new TextEncoder().encode(body).length;
const hash = await sha256(body);


const base = SYNC.BASE_URL; // لازم يكون رابط الويب آب (…/exec)
const sep = base.includes('?') ? '&' : '?';
const url = `${base}${sep}token=${encodeURIComponent(SYNC.TOKEN)}&size=${encodeURIComponent(size)}&hash=${encodeURIComponent(hash)}`;


const resp = await fetch(url, {
method : 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${SYNC.TOKEN}`
},
body,
signal
});
if(!resp.ok) throw new Error('POST failed');
return await resp.json();
}

async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2, '0')).join('');
}




function safeStr(s){ return String(s||'').trim().replace(/\s+/g,' '); }

// --- جديد: تجميع الطابع الزمني على مستوى الدقيقة فقط ---
function minuteBucket(ts){
  try{
    const d = new Date(ts);
    if(!Number.isFinite(d.getTime())) return '';
    d.setSeconds(0, 0);          // نلغي الثواني والميلي ثانية
    return d.toISOString();
  }catch{ return ''; }
}

// --- تعريف lineKey الوحيد المعتمد في النظام (لا تنسخه مرتين) ---
// يستخدم lineId حصراً. إذا ناقص، يولّد واحد ويثبّته على السطر.
function lineKey(l){
  try{
    if(!l) return '';
    if(l.lineId && String(l.lineId).trim() !== '') return l.lineId;
    // توليد وتثبيت هوية دائمة للسطر
    const id = (typeof genId === 'function') ? genId() : ('id-' + Math.random().toString(36).slice(2) + Date.now().toString(36));
    l.lineId = id;
    return id;
  }catch{
    // fallback آمن
    const id = (typeof genId === 'function') ? genId() : ('id-' + Math.random().toString(36).slice(2) + Date.now().toString(36));
    if(l) l.lineId = id;
    return id;
  }
}







// نفس الفكرة للملاحظة
// يستخدم id للملاحظة حصراً. إذا ناقص، يولّد واحد ويثبّته على الملاحظة.
function noteKey(n){
  try{
    if(!n) return '';
    if(n.id && String(n.id).trim() !== '') return n.id;
    const id = (typeof genId === 'function') ? genId() : ('id-' + Math.random().toString(36).slice(2) + Date.now().toString(36));
    n.id = id;
    return id;
  }catch{
    const id = (typeof genId === 'function') ? genId() : ('id-' + Math.random().toString(36).slice(2) + Date.now().toString(36));
    if(n) n.id = id;
    return id;
  }
}







// اجمع مبالغ البطاقة (يرجع كائن)
function sumCardAmounts(card){
  const out = { total:0, unpaid:0, paid:0, returned:0 };

  (card.lines || []).forEach(l => {
    if (l?.deletedAt) return;

    // نهمل أي سطر راجع بالكامل
    if (l.returned) return;

    // نهمل أي سطر مدفوع بالكامل
    if (l.paid) return;

    // إذا وصلنا لهنا: هذا بند فعلي بعده محسوب دين
    const price = Number(String(l.price ?? '').replace(/[^\d.]/g,'')) || 0;
    const qty   = Number(l.qty || 1);
    const amt   = price * qty;

    out.total  += amt;
    out.unpaid += amt;
    // out.paid يبقى 0
    // out.returned يبقى 0
  });

  return out;
}







/* ====== Smart Export / Import ====== */


// تصدير ذكي: يدمج المحلي مع السيرفر ويرفع نسخة موحّدة
// ويضمن أيضاً رفع transferDate (آخر تاريخ نقل ديون)


/* ===== Idempotency Helpers (جديد) ===== */
const IDEM_LOG_KEY   = 'ASSAL_IDEM_LOG';       // آخر طلبات ناجحة: { [requestId]: ts }
const IDEM_PENDING_K = 'ASSAL_IDEM_PENDING';   // طلب جارٍ: { requestId, payload }

function loadJSON(k, d){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(d)); }catch{ return d; } }
function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

function makeRequestId(){
  // يستعمل genId إذا موجود (نفس مشروعك)، وإلا يولّد واحد قوي
  try{ if (typeof genId === 'function') return 'req_'+genId(); }catch{}
  return 'req_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function markPending(requestId, payload){
  saveJSON(IDEM_PENDING_K, { requestId, payload, ts: Date.now() });
}

function clearPending(){
  localStorage.removeItem(IDEM_PENDING_K);
}

function getPending(){
  const obj = loadJSON(IDEM_PENDING_K, null);
  if (!obj || !obj.requestId) return null;
  return obj;
}

function markProcessed(requestId){
  const log = loadJSON(IDEM_LOG_KEY, {});
  log[requestId] = Date.now();
  // أبقِ السجل صغير (نمسح الأقدم بعد 200 إدخال)
  const ids = Object.keys(log);
  if (ids.length > 200){
    ids.sort((a,b)=> log[a]-log[b]);
    ids.slice(0, ids.length-200).forEach(id => delete log[id]);
  }
  saveJSON(IDEM_LOG_KEY, log);
}

function isProcessed(requestId){
  const log = loadJSON(IDEM_LOG_KEY, {});
  return !!log[requestId];
}




function cleanupAllTombstones(ttlDays = 14){
  const stats = {
    removed: { payments: 0, cards: 0, lines: 0, notes: 0, daysEmptied: 0 },
    kept:    { payments: 0, cards: 0, lines: 0, notes: 0 },
    errors:  []
  };
  const now = Date.now();
  const cutoff = now - (ttlDays * 24 * 60 * 60 * 1000);
  const isOldDeleted = (obj) => {
    if (!obj || !obj.deletedAt) return false;
    const t = new Date(obj.deletedAt).getTime();
    return !isNaN(t) && t <= cutoff;
  };

  // 1) assal.payments.v1
  try{
    const raw = localStorage.getItem('assal.payments.v1') || '{}';
    const store = JSON.parse(raw) || {};
    const out = {};
    Object.keys(store).forEach(day=>{
      const arr = Array.isArray(store[day]) ? store[day] : [];
      const keptArr = [];
      arr.forEach(row=>{
        if (isOldDeleted(row)) {
          stats.removed.payments += 1;
        } else {
          keptArr.push(row);
          if (row && row.deletedAt) stats.kept.payments += 1;
        }
      });
      if (keptArr.length > 0) out[day] = keptArr;
      else stats.removed.daysEmptied += 1;
    });
    localStorage.setItem('assal.payments.v1', JSON.stringify(out));
  }catch(e){ stats.errors.push('payments: ' + (e?.message || String(e))); }

  // 2) STORAGE (الأيام/البطاقات/الخطوط/الملاحظات)
  try{
    const rawDays = localStorage.getItem(STORAGE) || '{}';
    const daysObj = JSON.parse(rawDays) || {};
    const outDays = {};
    Object.keys(daysObj).forEach(dayKey=>{
      const dayVal = daysObj[dayKey];
      const cards = Array.isArray(dayVal?.cards) ? dayVal.cards : [];
      let removedAnyInDay = false;

      const keptCards = [];
      cards.forEach(card=>{
        if (isOldDeleted(card)) {
          stats.removed.cards += 1;
          removedAnyInDay = true;
          return;
        }
        const lines = Array.isArray(card?.lines) ? card.lines : [];
        const notes = Array.isArray(card?.notes) ? card.notes : [];
        const keptLines = [];
        const keptNotes = [];

        lines.forEach(line=>{
          if (isOldDeleted(line)) { stats.removed.lines += 1; removedAnyInDay = true; }
          else { keptLines.push(line); if (line?.deletedAt) stats.kept.lines += 1; }
        });
        notes.forEach(note=>{
          if (isOldDeleted(note)) { stats.removed.notes += 1; removedAnyInDay = true; }
          else { keptNotes.push(note); if (note?.deletedAt) stats.kept.notes += 1; }
        });

        const newCard = { ...card };
        if (Array.isArray(card.lines)) newCard.lines = keptLines;
        if (Array.isArray(card.notes)) newCard.notes = keptNotes;
        if (card?.deletedAt && !isOldDeleted(card)) stats.kept.cards += 1;

        keptCards.push(newCard);
      });

      if (keptCards.length > 0) outDays[dayKey] = { ...dayVal, cards: keptCards };
      else if (removedAnyInDay) stats.removed.daysEmptied += 1;
    });
    localStorage.setItem(STORAGE, JSON.stringify(outDays));
  }catch(e){ stats.errors.push('days/cards: ' + (e?.message || String(e))); }

  return stats;
}


// تصدير ذكي: يدمج المحلي مع السيرفر ويرفع نسخة موحّدة + (Idempotency)
async function smartExportToServer(){
  // ممنوع على الحاسبة الفرعية (نفس كودك)
  if (typeof isSubDevice === 'function' && isSubDevice()){
    showToast('warn','هذه حاسبة فرعية: الرفع للسيرفر غير مسموح. كل التخزين محلي فقط.');
    return;
  }
  if(!window.IS_SIGNED_IN){
    showToast('warn','سجّل دخول أولاً');
    return;
  }

  try{
    showToast('info','جاري مزامنة النسخة مع السيرفر.', 1800);

    // 0) حمل pending سابق إذا موجود (نفس requestId)
    let pending = getPending();
    let requestId = pending?.requestId || makeRequestId();

    // 1) جيب نسخة السيرفر
    const server = await serverGetBackup();

    // خذ لقطة طازة من الستورج (نفس أسلوبك)
    const latestDays  = load(STORAGE, {});
    const latestNames = load(NAMES,   []);
    const latestPays  = (function(){                  // [NEW] حمل مخزن الحسابات المالية
      try{
        const raw = localStorage.getItem('assal.payments.v1') || '{}';
        const obj = JSON.parse(raw);
        return (obj && typeof obj === 'object') ? obj : {};
      }catch{ return {}; }
    })();

    // [NEW] أدوات إزالة التكرار لتسديدات قائمة الحسابات المالية
    const __paymentKey__ = function(p){
      try{
        if (p && (p.id || p._id)) return String(p.id || p._id);
        const obj = {
          date   : p?.date ?? p?.day ?? "",
          time   : p?.time ?? "",
          amount : p?.amount ?? p?.value ?? p?.qty ?? "",
          type   : p?.type ?? p?.kind ?? "",
          note   : p?.note ?? p?.desc ?? p?.text ?? ""
        };
        return JSON.stringify(obj);
      }catch{
        return JSON.stringify(p ?? {});
      }
    };
    const __dedupePaymentList__ = function(list){
      const seen = new Set(); const out = [];
      (Array.isArray(list) ? list : []).forEach(p=>{
        const k = __paymentKey__(p);
        if(!seen.has(k)){ seen.add(k); out.push(p); }
      });
      return out;
    };
    const __dedupePaymentsObject__ = function(payObj){
      const src = (payObj && typeof payObj === 'object') ? payObj : {};
      const out = {};
      Object.keys(src).forEach(day=>{
        out[day] = __dedupePaymentList__(src[day]);
      });
      return out;
    };
    // [END NEW]

    // 2) حضّر نسخة نظيفة (تجاهل المحذوف)
    const { days: cleanDays, names: cleanNames } = prepareCleanPayload(latestDays, latestNames);

    // أساس البايـلود
    let payload = pending?.payload || {
      days: cleanDays,
      names: cleanNames,
      updatedAt: Date.now(),
      transferDate: getTransferDateIso() || '',
      payments: latestPays                              // [NEW] أضفنا الحسابات المالية للبايلود
    };

    let report = [];

    // 2.5) دمج آمن إذا السيرفر مو فاضي (نفس منطقك)
    if(server && server.days){
      const merged = mergeAllDays(latestDays || {}, server.days || {});
      const mergedDays  = merged.days;
      const mergeReport = merged.report || [];

      // نظّف الـIDs وديدوب (نفس دوالك)
      normalizeIdsInAllDays(mergedDays);
      dedupeAllDays(mergedDays);

      payload.days   = mergedDays;
      const curNames = Array.isArray(latestNames) ? latestNames : [];
      const srvNames = Array.isArray(server.names) ? server.names : [];
      payload.names  = Array.from(new Set([...curNames, ...srvNames]));
      if(!payload.transferDate && server.transferDate){
        payload.transferDate = server.transferDate;
      }

      // [NEW] دمج الحسابات المالية (per-day arrays) + إزالة التكرار
      const srvPays = (server && server.payments && typeof server.payments === 'object') ? server.payments : {};
      const locPays = latestPays && typeof latestPays === 'object' ? latestPays : {};
      const mergedPays = (function mergePaymentsStores(localStore, remoteStore){
        const out = { ...(remoteStore || {}) };
        const loc = localStore  && typeof localStore  === 'object' ? localStore  : {};
        const rem = remoteStore && typeof remoteStore === 'object' ? remoteStore : {};

        // ✅ تعديل: فضّ نزاع ذكي حسب الهوية، والأحدث بين updatedAt/deletedAt يغلب
        const keyOf = (row)=>{
          try {
            return String(
              row?.id || row?._id ||
              (typeof __paymentKey__ === 'function' ? __paymentKey__(row) :
                JSON.stringify([row?.cust, row?.date, row?.time, row?.amount, row?.kind]))
            );
          } catch {
            return String(Math.random());
          }
        };
        const stamp = (row)=>{
          const t = new Date(row?.updatedAt || row?.deletedAt || 0).getTime();
          return isNaN(t) ? 0 : t;
        };

        // ادمج يوم-بيوم
        const allDays = new Set([...Object.keys(rem), ...Object.keys(loc)]);
        allDays.forEach(dayKey=>{
          const L = Array.isArray(loc[dayKey]) ? loc[dayKey] : [];
          const R = Array.isArray(rem[dayKey]) ? rem[dayKey] : [];

          const map = new Map();
          const put = (row)=>{
            const k = keyOf(row);
            if (!map.has(k)){
              map.set(k, { ...row });
            } else {
              const cur = map.get(k);
              map.set(k, stamp(row) > stamp(cur) ? { ...row } : cur);
            }
          };

          // نحافظ على أسبقية السيرفر بالمرور أولاً، وبعدين المحلي مع فضّ النزاع
          R.forEach(put);
          L.forEach(put);

          out[dayKey] = Array.from(map.values());
        });

        return out;
      })(locPays, srvPays);
      payload.payments = __dedupePaymentsObject__(mergedPays); // [NEW] تنظيف نهائي على كل الأيام
      // [END NEW]

      report = mergeReport;
    }

    // لو صفرية لا ترفع (نفس سلوكك)
    if (!payload.days || Object.keys(payload.days).length === 0) {
      showToast('warn','ماكو بيانات فعّالة للتصدير.');
      return;
    }

    // 3) ————— Idempotency —————
    // لو كان requestId متعلّم "Processed" نوقف؛ هذا يعني سيرفر قبله سابقاً
    if (isProcessed(requestId)){
      clearPending();
      showToast('info','تمت مزامنة سابقة بنفس العملية (تجاهل التكرار).');
      return;
    }

    // خزّن pending قبل الإرسال (حتى لو انفصل النت بعد الحفظ) 
    payload.requestId = requestId;
    markPending(requestId, payload);

    // 3.1) إرسال مع إعادة محاولة بسيطة بنفس requestId
    const MAX_ATTEMPTS = 3;
    let attempt = 0, sentOk = false, lastErr = null;

    while(attempt < MAX_ATTEMPTS && !sentOk){
      attempt++;
      try{
        // ملاحظة: نمرر payload كما هو إلى دالتك الأصلية serverPostBackup
        await serverPostBackup(payload);
        sentOk = true;
      }catch(e){
        lastErr = e;
        // باك-أوف بسيط
        await new Promise(r => setTimeout(r, attempt * 700));
      }
    }

    if(!sentOk){
      // لا تمسح ال-pending حتى إعادة المحاولة الجاية تستخدم نفس requestId
      console.error('Export failed (kept pending for idempotent retry):', lastErr);
      showToast('warn','تعذّر رفع النسخة، سيتم استخدام نفس العملية بالمحاولة القادمة.');
      return;
    }

    // 4) علامة "تمت" لنفس requestId + إزالة pending
    markProcessed(requestId);
    clearPending();

    // 5) خزّن محلي آخر نسخة رفعت (نفس سلوكك)
    localStorage.setItem(STORAGE, JSON.stringify(payload.days || {}));
    localStorage.setItem(NAMES,   JSON.stringify(payload.names || []));
    if(payload.transferDate){
      setTransferDateIso(payload.transferDate);
    }
    localStorage.setItem('assal.payments.v1', JSON.stringify(payload.payments || {})); // [NEW] خزّن الحسابات المالية بعد الرفع

    // [NEW] حذف التومبستونات القديمة بعد الرفع مباشرةً (إن وُجدت الدالة)
    if (typeof cleanupAllTombstones === 'function') cleanupAllTombstones(14);

    // 6) حدّث الواجهة (نفسك)
    days  = load(STORAGE, {});
    names = load(NAMES,   []);
    renderBoard();
    renderRail();
    refreshStats();

    showToast(
      'success',
      report.length
        ? `تمت المزامنة (دمج ${report.length} تغيير)`
        : 'تم رفع النسخة إلى السيرفر'
    );

    console.groupCollapsed?.('ASSAL MERGE REPORT (EXPORT)');
    (report||[]).forEach(r => console.log(r));
    console.groupEnd?.();

  }catch(err){
    console.error(err);
    showToast('error','تعذّر رفع النسخة إلى السيرفر');
    // نبقي الـpending كما هو (لو موجود) حتى المحاولة القادمة تستعمل نفس requestId
  }
}







function normalizeIdsInAllDays(daysObj){
  Object.values(daysObj||{}).forEach(cards=>{
    (cards||[]).forEach(card=>{
      (card.lines||[]).forEach(l => { if(!l.lineId) l.lineId = lineKey(l); });
      (card.notes||[]).forEach(n => { if(!n.id)     n.id     = noteKey(n); });
    });
  });
}






/* =========================================================
   STRONG MERGE: يوم-بيوم، بطاقة-ببطاقة، سطر-بسطر، ملاحظة-بملاحظة
   ========================================================= */

/* اجلب حقل بالأحدث (حسب updatedAt خاصّ بالحقل إن وُجد، وإلا السطر/الملاحظة) */
function pickNewerField(aVal, aTs, bVal, bTs){
  return isNewer(aTs, bTs) ? {val:bVal, ts:bTs} : {val:aVal, ts:aTs};
}

/* دمج سطرين بنفس lineId */
function mergeLine(a, b, report, path){
  // a, b قد يكون أحدهما undefined
  const x = a || {};
  const y = b || {};

  // إذا أحدهما غير موجود → رجّع الموجود (لكن سجّل)
  if(!a && b){
    report.push({ path, type:'line-add', before:null, after:y });
    return {...y};
  }
  if(a && !b){
    report.push({ path, type:'line-keep', before:null, after:x });
    return {...x};
  }

  // كلاهما موجود: قارن deletedAt vs updatedAt (حذف مقابل تعديل)
  const delA = x.deletedAt || null;
  const delB = y.deletedAt || null;

  // إذا أحدهما محذوف والآخر عدّل بعد الحذف → الإلغاء/الإبقاء حسب الأحدث
  const base = {...x};

  // الحقول التي ندمجها حقل-بحقل
  const fields = ['item','cat','price','qty','note','paid','returned'];
  const merged = {...base};

  // timestamps لكل حقل (إذا ما عندك لكل حقل، نستعمل line.updatedAt كله)
  fields.forEach(f=>{
    const aVal = x[f];
    const bVal = y[f];
    const aTs  = x.updatedAt || x.at || null;
    const bTs  = y.updatedAt || y.at || null;
    const {val} = pickNewerField(aVal, aTs, bVal, bTs);
    merged[f] = val;
  });

  // قرارات الحذف:
  // إن كان delA أو delB موجودين، نحسم بحسب من الأحدث مقارنةً مع آخر updatedAt
  const lineUpdatedA = x.updatedAt || x.at || null;
  const lineUpdatedB = y.updatedAt || y.at || null;
  const newestEditTs = isNewer(lineUpdatedA, lineUpdatedB) ? lineUpdatedB : lineUpdatedA;
  const newestDelTs  = isNewer(delA, delB) ? delB : delA;

  if(newestDelTs && !isNewer(newestEditTs, newestDelTs)){
    // الحذف أحدث أو مساوي → إبقاء التومبستون
    merged.deletedAt = newestDelTs;
  }else{
    // التعديل أحدث → إلغاء الحذف
    merged.deletedAt = null;
  }

  // updatedAt = أحدث من الاثنين
  merged.updatedAt = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  merged.createdAt = x.createdAt || y.createdAt || merged.updatedAt || nowISO();
  merged.lineId    = x.lineId || y.lineId || genId();

  // سجّل before/after إذا تغيّر شيء مهم
  const before = JSON.stringify(x);
  const after  = JSON.stringify(merged);
  if(before !== after){
    report.push({ path, type:'line-merge', before:x, after:merged });
  }
  return merged;
}

/* دمج ملاحظة noteId */
function mergeNote(a, b, report, path){
  const x = a || {};
  const y = b || {};
  if(!a && b){ report.push({ path, type:'note-add', before:null, after:y }); return {...y}; }
  if(a && !b){ report.push({ path, type:'note-keep', before:null, after:x }); return {...x}; }

  const merged = {...x};
  const aTs = x.updatedAt || x.at || null;
  const bTs = y.updatedAt || y.at || null;

  // text
  merged.text = pickNewerField(x.text, aTs, y.text, bTs).val;

  // حذف مقابل تعديل
  const delA = x.deletedAt || null, delB = y.deletedAt || null;
  const newestEditTs = isNewer(aTs, bTs) ? bTs : aTs;
  const newestDelTs  = isNewer(delA, delB) ? delB : delA;
  merged.deletedAt = (newestDelTs && !isNewer(newestEditTs, newestDelTs)) ? newestDelTs : null;

  merged.updatedAt = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  merged.at        = x.at || y.at || merged.updatedAt || nowISO();
  merged.id        = x.id || y.id || genId();

  const before = JSON.stringify(x);
  const after  = JSON.stringify(merged);
  if(before !== after){
    report.push({ path, type:'note-merge', before:x, after:merged });
  }
  return merged;
}

/* دمج بطاقة cardId */
/* دمج بطاقة cardId — مطابق لكودك لكن الدمج داخله على lineId/id فقط */
function mergeCard(a, b, report, path){
  const x = a || {};
  const y = b || {};

  if (!a && b) { report.push({ path, type:'card-add',  before:null, after:y }); return { ...y }; }
  if ( a && !b) { report.push({ path, type:'card-keep', before:null, after:x }); return { ...x }; }

  const merged = { ...x };

  // اسم الزبون بالأحدث
  const custPick = pickNewerField(x.customer, x.updatedAt, y.customer, y.updatedAt);
  merged.customer = custPick.val;

  // حذف مقابل تعديل (تومبستون آمن)
  const delA = x.deletedAt || null, delB = y.deletedAt || null;
  const newestEditTs = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  const newestDelTs  = isNewer(delA,       delB)         ? delB       : delA;
  merged.deletedAt   = (newestDelTs && !isNewer(newestEditTs, newestDelTs)) ? newestDelTs : null;

  /* ===== دمج السطور: بالـ lineId حصراً ===== */
  const linesById = {};

  (x.lines || []).forEach(l => {
    const id = (l.lineId && String(l.lineId).trim()) ? l.lineId : (l.lineId = genId());
    linesById[id] = l;
  });

  (y.lines || []).forEach(l => {
    const id = (l.lineId && String(l.lineId).trim()) ? l.lineId : (l.lineId = genId());
    linesById[id] = mergeLine(linesById[id], l, report, `${path}.line:${id}`);
  });

  merged.lines = Object.values(linesById).map(l => {
    if (!l.lineId) l.lineId = genId();
    return l;
  });

  /* ===== دمج الملاحظات: بالـ id حصراً ===== */
  const notesById = {};

  (x.notes || []).forEach(n => {
    const nid = (n.id && String(n.id).trim()) ? n.id : (n.id = genId());
    notesById[nid] = n;
  });

  (y.notes || []).forEach(n => {
    const nid = (n.id && String(n.id).trim()) ? n.id : (n.id = genId());
    notesById[nid] = mergeNote(notesById[nid], n, report, `${path}.note:${nid}`);
  });

  merged.notes = Object.values(notesById).map(n => {
    if (!n.id) n.id = genId();
    return n;
  });

  // أزمنة ومشتقات
  merged.updatedAt = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  merged.createdAt = x.createdAt || y.createdAt || merged.updatedAt || nowISO();

  // billType يُعاد احتسابه من السطور الفعّالة
  const types = Array.from(
    new Set((merged.lines || []).filter(l => !l.deletedAt).map(l => (l.returned ? 'راجع' : 'بيع')))
  );
  merged.billType = (types.length === 1)
    ? types[0]
    : (types.length === 0 ? (x.billType || y.billType || 'بيع') : 'مختلط');

  // paidAll يُعاد احتسابه (مطابق لنمطك)
  merged.paidAll = (function(){
    const active = (merged.lines || []).filter(l => !l.deletedAt && !l.returned);
    return active.length > 0 && active.every(l => !!l.paid);
  })();

  // تقرير تغيّر
  const before = JSON.stringify(x);
  const after  = JSON.stringify(merged);
  if (before !== after) {
    report.push({ path, type:'card-merge', before:x, after:merged });
  }
  return merged;
}



/* دمج أيام: local مقابل remote (سيرفر) — يرجّع {days: merged, report:[] } */
/* دمج أيام: local مقابل remote (سيرفر) — يرجّع {days: merged, report:[] } */
function mergeAllDays(localDays, remoteDays){
  const out = {};
  const report = [];

  const allKeys = new Set([
    ...Object.keys(localDays || {}),
    ...Object.keys(remoteDays || {})
  ]);
  const keysSorted = Array.from(allKeys).sort(); // ترتيب ثابت

  keysSorted.forEach(dayKey => {
    const a = localDays?.[dayKey] || [];
    const b = remoteDays?.[dayKey] || [];

    // بطاقات حسب card.id (نفس أسلوبك)
    const byId = {};
    a.forEach(c => { byId[c.id] = c; });
    b.forEach(c => {
      byId[c.id] = mergeCard(byId[c.id], c, report, `day:${dayKey}.card:${c.id}`);
    });

    // بطاقات موجودة محلّيًا فقط
    a.forEach(c => {
      if (!b.find(x => x.id === c.id)) {
        byId[c.id] = mergeCard(c, null, report, `day:${dayKey}.card:${c.id}`);
      }
    });

    // لا نحذف التومبستون—نحتفظ بيه
    const mergedCards = Object.values(byId)
      .map(c => c)
      .sort((x, y) =>
        new Date(y.updatedAt || y.createdAt || 0) - new Date(x.updatedAt || x.createdAt || 0)
      );

    out[dayKey] = mergedCards;
  });

  return { days: out, report };
}






// استيراد ذكي: يسحب من السيرفر إذا هو أحدث (أو إذا المحلي فارغ)
async function smartImportFromServer(){
  if(!window.IS_SIGNED_IN){
    showToast('warn','سجّل دخول أولاً');
    return;
  }

  try{
    // فرق برسالة التوست حسب الهوية
    const subMode = (typeof isSubDevice === 'function' && isSubDevice());
    showToast('info', subMode
      ? 'جاري سحب نسخة السيرفر (سيتم استبدال المحلية بالكامل)...'
      : 'جاري جلب آخر نسخة من السيرفر…', 1800);

    const server = await serverGetBackup();
    if(!server || !server.days){
      showToast('warn','ماكو نسخة على السيرفر بعد');
      return;
    }

    // [NEW] أدوات إزالة التكرار لتسديدات قائمة الحسابات المالية
    const __paymentKey__ = function(p){
      try{
        if (p && (p.id || p._id)) return String(p.id || p._id);
        const obj = {
          date   : p?.date ?? p?.day ?? "",
          time   : p?.time ?? "",
          amount : p?.amount ?? p?.value ?? p?.qty ?? "",
          type   : p?.type ?? p?.kind ?? "",
          note   : p?.note ?? p?.desc ?? p?.text ?? ""
        };
        return JSON.stringify(obj);
      }catch{
        return JSON.stringify(p ?? {});
      }
    };
    const __dedupePaymentList__ = function(list){
      const seen = new Set(); const out = [];
      (Array.isArray(list) ? list : []).forEach(p=>{
        const k = __paymentKey__(p);
        if(!seen.has(k)){ seen.add(k); out.push(p); }
      });
      return out;
    };
    const __dedupePaymentsObject__ = function(payObj){
      const src = (payObj && typeof payObj === 'object') ? payObj : {};
      const out = {};
      Object.keys(src).forEach(day=>{
        out[day] = __dedupePaymentList__(src[day]);
      });
      return out;
    };
    // [END NEW]

    if(subMode){
      // ========= وضع "حاسبة فرعية": استبدال كامل =========
      localStorage.setItem(STORAGE, JSON.stringify(server.days || {}));
      localStorage.setItem(NAMES,   JSON.stringify(Array.isArray(server.names) ? server.names : []));
      if(server.transferDate){ setTransferDateIso(server.transferDate); }
      // [NEW] استبدال كامل للحسابات المالية + تنظيف تكرارات
      (function(){
        const srvPaysRaw = (server && server.payments && typeof server.payments === 'object') ? server.payments : {};
        const cleanSrvPays = __dedupePaymentsObject__(srvPaysRaw);
        localStorage.setItem('assal.payments.v1', JSON.stringify(cleanSrvPays));
        window.refreshPaymentsUI?.();   // <<< أضف هذا السطر
      })();
      // [END NEW]

      // حدّث الذاكرة والواجهة
      days  = load(STORAGE, {});
      names = load(NAMES,   []);   // ← تصليح: نحمل كـ Array
      renderBoard();
      renderRail();
      refreshStats();

      showToast('success','تم الاستبدال الكامل من السيرفر (الحفظ محلي فقط).');

      // خبرنا آخر تاريخ نقل ديون إذا موجود
      const iso = getTransferDateIso();
      if(iso){
        showToast('info', formatTransferToastMsg(iso));
      }
      return; // خلصنا بالفرعية
    }

    // ========= وضع "حاسبة رئيسية": دمج ذكي مثل طريقتك =========
    const localDays  = days || {};
    const remoteDays = server.days || {};

    const { days: mergedDays, report } = mergeAllDays(localDays, remoteDays);
    normalizeIdsInAllDays(mergedDays);
    dedupeAllDays(mergedDays);

    // خزن الفواتير/الأيام محلي
    localStorage.setItem(STORAGE, JSON.stringify(mergedDays));

    // وحّد أسماء الزبائن
    const curNames = Array.isArray(names) ? names : [];
    const srvNames = Array.isArray(server.names) ? server.names : [];
    const mergedNames = Array.from(new Set([...curNames, ...srvNames]));
    localStorage.setItem(NAMES, JSON.stringify(mergedNames));

    // خزن تاريخ نقل الديون إذا السيرفر عنده واحد
    if(server.transferDate){
      setTransferDateIso(server.transferDate);
    }

    // [NEW] دمج مخزن الحسابات المالية (محلي + سيرفر) مع إزالة التكرار
    (function(){
      try{
        const rawLocal  = localStorage.getItem('assal.payments.v1') || '{}';
        const localPays = JSON.parse(rawLocal) || {};
        const srvPays   = (server && server.payments && typeof server.payments === 'object') ? server.payments : {};
        const mergedPays = (function mergePaymentsStores(localStore, remoteStore){
          const out = { ...(remoteStore || {}) };
          const loc = localStore  && typeof localStore  === 'object' ? localStore  : {};
          const rem = remoteStore && typeof remoteStore === 'object' ? remoteStore : {};
          Object.keys(loc).forEach(dayKey=>{
            const L = Array.isArray(loc[dayKey]) ? loc[dayKey] : [];
            const R = Array.isArray(rem[dayKey]) ? rem[dayKey] : [];
            out[dayKey] = __dedupePaymentList__([ ...R, ...L ]); // دمج + ديدوب لكل يوم
          });
          return out;
        })(localPays, srvPays);
        const cleanMergedPays = __dedupePaymentsObject__(mergedPays);
        localStorage.setItem('assal.payments.v1', JSON.stringify(cleanMergedPays));
        window.refreshPaymentsUI?.();   // <<< أضف هذا السطر
      }catch{
        // إذا صار خطأ بالتحويل JSON نخليها فارغة بدون ما نكسر التدفق
        localStorage.setItem('assal.payments.v1', JSON.stringify({}));
      }
    })();
    // [END NEW]

    // حدّث الذاكرة والواجهة
    days  = load(STORAGE, {});
    names = load(NAMES,   []);   // ← تصليح: نحمل كـ Array
    renderBoard();
    renderRail();
    refreshStats();

    const changes = (report && report.length) ? report.length : 0;
    showToast(
      'success',
      changes
        ? `تم الدمج الآمن (${changes} تغيير)`
        : 'لا تغييرات — البيانات متطابقة'
    );

    // بعدين خبرنا آخر تاريخ نقل ديون اللي جبناه
    const iso = getTransferDateIso();
    if(iso){
      showToast('info', formatTransferToastMsg(iso));
    }

    console.groupCollapsed?.('ASSAL MERGE REPORT (IMPORT)');
    (report||[]).forEach(r => console.log(r));
    console.groupEnd?.();
  }catch(err){
    console.error(err);
    showToast('error','تعذّر جلب/دمج النسخة من السيرفر');
  }
}









/* ===== Dedupe Helpers (Lines/Notes) ===== */
function dedupeCardLines(card){
  if(!card || !Array.isArray(card.lines)) return;

  // نجمع حسب lineId فقط
  const byId = new Map();

  for(const ln of card.lines){
    // ثبّت lineId إن ناقص
    const k = lineKey(ln);
    const cur = byId.get(k);

    if(!cur){
      byId.set(k, ln);
      continue;
    }

    // فض نزاع النسخ المكررة لنفس الـlineId (منطقيًا يشبه mergeLine)
    const curEditTs = new Date(cur.updatedAt || cur.at || 0).getTime();
    const newEditTs = new Date(ln.updatedAt  || ln.at  || 0).getTime();
    const curDelTs  = cur.deletedAt ? new Date(cur.deletedAt).getTime() : null;
    const newDelTs  = ln.deletedAt  ? new Date(ln.deletedAt ).getTime() : null;

    // إذا عندنا حذف مقابل تعديل لنفس الهوية
    const newestEdit = Math.max(curEditTs || 0, newEditTs || 0);
    const newestDel  = Math.max(curDelTs  || 0, newDelTs  || 0);

    let winner = ln;

    if(newestDel && newestDel >= newestEdit){
      // الأحدث "حذف" ⇒ خزن نسخة محذوفة (تومبستون)
      winner = (curDelTs && curDelTs >= newDelTs) ? cur : ln;
    }else{
      // الأحدث "تعديل" ⇒ خزن الأحدث عدلًا
      winner = (curEditTs >= newEditTs) ? cur : ln;
      winner.deletedAt = null;
    }

    byId.set(k, winner);
  }

  card.lines = Array.from(byId.values());
  // ترتيب حديث نزولياً
  card.lines.sort((a,b)=> new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0));
}



function dedupeCardNotes(card){
  if(!card || !Array.isArray(card.notes)) return;

  const byId = new Map();

  for(const n of card.notes){
    const k = noteKey(n);
    const cur = byId.get(k);
    if(!cur){
      byId.set(k, n);
      continue;
    }
    const curTs = new Date(cur.updatedAt || cur.at || 0).getTime();
    const newTs = new Date(n.updatedAt   || n.at  || 0).getTime();
    byId.set(k, (newTs > curTs) ? n : cur);
  }

  card.notes = Array.from(byId.values());
  card.notes.sort((a,b)=> new Date(b.at||b.updatedAt||0) - new Date(a.at||a.updatedAt||0));
}


/* طبّق الديدوب على كل الأيام/البطاقات */
function dedupeAllDays(daysObj){
  Object.values(daysObj||{}).forEach(cards=>{
    (cards||[]).forEach(c=>{
      // ثبّت الهويات لو ناقصة
      (c.lines||[]).forEach(l => { if(!l.lineId) l.lineId = lineKey(l); });
      (c.notes||[]).forEach(n => { if(!n.id)     n.id     = noteKey(n); });

      // ديدوب آمن (حسب الهوية فقط)
      dedupeCardLines(c);
      dedupeCardNotes(c);
    });
  });
}





    /* ===== Init ===== */
    
    
   


(function init(){
  document.getElementById('dateBadge').textContent = arDateWithDay(TODAY);
  // --- سطر جديد: حمّل قاعدة الأصناف من الشيت ---
  loadExcelFiles();
  // ----------------------------------------------
  rebuildNames(); renderBoard(); renderRail(); refreshStats();
})();







(function(){
  // شيل أي وسوم قديمة من العنوان وخلي أساس ثابت
  const clean = s => String(s||"").replace(/\s*\[(cust|item|note|filter|c-note)\]\s*/gi, "").trim();
  const baseTitle = clean(document.title);

  function markTag(tag){
    document.title = `${baseTitle} ${tag}`;
  }
  function clearTag(){
    document.title = baseTitle;
  }

  // ===== حقول الـ Dock (ثابتة) =====
  const cust = document.getElementById('cust');   // اسم الزبون → عربي
  const item = document.getElementById('item');   // اسم المادة → إنكليزي
  const note = document.getElementById('note');   // الملاحظات (Dock) → عربي
  const cardSearch = document.getElementById('cardSearch'); // فلترة الكروت → عربي

  // ===== نافذة الحسابات المالية =====
  const payCustomer = document.getElementById('payCustomer');  // اسم الزبون (الحسابات المالية) → عربي
  const payNotes    = document.getElementById('payNotes');     // الملاحظات (الحسابات المالية) → عربي

  // ===== نافذة توافقات قطع الغيار =====
  const compatSearchInput = document.getElementById('compatSearchInput'); // بحث التوافقات → إنكليزي

  cust && cust.addEventListener('focus', ()=> markTag('[cust]'));
  cust && cust.addEventListener('blur',  ()=> clearTag());

  item && item.addEventListener('focus', ()=> markTag('[item]'));
  item && item.addEventListener('blur',  ()=> clearTag());

  note && note.addEventListener('focus', ()=> markTag('[note]'));
  note && note.addEventListener('blur',  ()=> clearTag());

  cardSearch && cardSearch.addEventListener('focus', ()=> markTag('[filter]'));
  cardSearch && cardSearch.addEventListener('blur',  ()=> clearTag());

  // --- الحسابات المالية (دائماً عربي) ---
  payCustomer && payCustomer.addEventListener('focus', ()=> markTag('[cust]'));
  payCustomer && payCustomer.addEventListener('blur',  ()=> clearTag());

  payNotes && payNotes.addEventListener('focus', ()=> markTag('[note]'));
  payNotes && payNotes.addEventListener('blur',  ()=> clearTag());

  // --- بحث توافقات قطع الغيار (دائماً إنكليزي) ---
  compatSearchInput && compatSearchInput.addEventListener('focus', ()=> markTag('[item]'));
  compatSearchInput && compatSearchInput.addEventListener('blur',  ()=> clearTag());

  // ===== ملاحظات داخل الكروت (تنشأ ديناميكياً) =====
  // عنصر الإدخال داخل البطاقة: input.note-input-sm
  document.addEventListener('focusin', (e)=>{
    if(e.target?.classList?.contains('note-input-sm')){
      markTag('[c-note]');
    }
  });
  document.addEventListener('focusout', (e)=>{
    if(e.target?.classList?.contains('note-input-sm')){
      clearTag();
    }
  });

  // حماية: لو تغيّر العنوان لسبب آخر، نظّفه كل 3 ثواني
  setInterval(()=>{
    const t = document.title;
    const cleaned = clean(t);
    if (t !== cleaned && !/\[(cust|item|note|filter|c-note)\]/i.test(t)) {
      document.title = cleaned;
    }
  }, 3000);
})();



  </script>
  
  
  
<script type="module">
  // ===== Firebase (ES Modules) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc }
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // كونفِغ مشروعك (نفس اللي أعطيتني)
  const firebaseConfig = {
    apiKey: "AIzaSyACIkf1KHXOiM_hAoNHT1CnxFAr-joo7oM",
    authDomain: "assal-debts.firebaseapp.com",
    projectId: "assal-debts",
    storageBucket: "assal-debts.firebasestorage.app",
    messagingSenderId: "329153281725",
    appId: "1:329153281725:web:1b69678fde727f3efa01d4"
  };

  // Init
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ===== حالة الجلسة كمتغيّر عالمي =====
window.IS_SIGNED_IN = false;     // خليها عالمية لأن كود خارج المودول يستعملها

// عناصر البوابة (تعريف مرّة وحدة فقط)
const gate     = document.getElementById('loginGate');
const emailEl  = document.getElementById('lgEmail');
const passEl   = document.getElementById('lgPass');
const btnEl    = document.getElementById('lgBtn');
const msgEl    = document.getElementById('lgMsg');
const btnLogout= document.getElementById('btnLogout');

// أزرار لازم تتعطّل لحد الدخول
const ctrlButtons = [
  document.getElementById('btnExportAll'),
  document.getElementById('btnImportAll'),
  document.getElementById('btnExportDay'),
  document.getElementById('btnClearDay'),
  document.getElementById('btnNextDay')
];
function toggleControls(disabled){
  ctrlButtons.forEach(b=> b && (b.disabled = !!disabled));
}
// ✅ فعّل القفل من البداية (تنفيذ ملاحظتك السابقة)
toggleControls(true);

  
  
  
  
  
  // عناصر السلاش

// ===== Auth Splash (منطق التقدّم الاحترافي) =====
const authSplash = document.getElementById('authSplash');
const authBar    = document.getElementById('authBar');
const authTip    = document.getElementById('authTip');
const authPct    = document.getElementById('authPct');
const authSubEl  = document.getElementById('authSub');

let authRAF = null, authStart = 0, authHold = false;

const AUTH_TIPS = [
  'نحضّر كلشي…',
  'نحدّث حالة الجلسة…',
  'نتأكد من صلاحيات الدخول…',
  'نربط بياناتك بأمان…'
];

// easeOutQuad
function easeOut(t){ return 1 - (1 - t) * (1 - t); }

// شغّل التقدم إلى 95% (الباقي عند الإخفاء)
function startAuthProgress(totalMs = 2200){
  cancelAnimationFrame(authRAF);
  authStart = performance.now();
  authHold  = false;

  function step(now){
    const t = Math.min(1, (now - authStart) / totalMs);
    const eased = easeOut(t);
    const val = Math.min(95, Math.floor(eased * 100)); // نمسك عند 95%

    if(authBar) authBar.style.width = val + '%';
    if(authPct) authPct.textContent = val + '%';

    // بدّل التلميح كل 500ms تقريبًا
    const tipIdx = Math.min(AUTH_TIPS.length - 1, Math.floor((now - authStart) / 500));
    if(authTip) authTip.textContent = AUTH_TIPS[tipIdx];

    if(t < 1 && !authHold){
      authRAF = requestAnimationFrame(step);
    }
  }
  authRAF = requestAnimationFrame(step);
}

// نكمل لـ 100% بسرعة لطيفة ثم نخفي
function completeAuthProgress(holdAfterMs = 120){
  authHold = true;
  cancelAnimationFrame(authRAF);

  const start = performance.now();
  const from  = parseInt((authPct?.textContent || '0').replace(/\D/g,''), 10) || 0;

  function step(now){
    const t = Math.min(1, (now - start) / 260); // اندفاع قصير
    const val = Math.floor(from + (100 - from) * easeOut(t));

    if(authBar) authBar.style.width = val + '%';
    if(authPct) authPct.textContent = val + '%';

    if(t < 1){
      requestAnimationFrame(step);
    }else{
      setTimeout(hideSplash, holdAfterMs);
    }
  }
  requestAnimationFrame(step);
}

// واجهات العرض/الإخفاء (استبدل الموجودة بكودك القديم)
function showSplash(subtitle = 'التحقق من الجلسة'){
  if(authSubEl) authSubEl.textContent = subtitle;
  if(authTip)   authTip.textContent   = AUTH_TIPS[0];
  if(authBar)   authBar.style.width   = '0%';
  if(authPct)   authPct.textContent   = '0%';

  authSplash.style.display = 'grid';
  startAuthProgress();
}
function hideSplash(){
  // أنيميشن خروج خفيف
  authSplash.style.animation = 'auth-pop .22s reverse ease-in both';
  setTimeout(()=>{
    authSplash.style.display   = 'none';
    authSplash.style.animation = '';
  }, 180);
}




function setBtnLoading(btn, on){
  if(!btn) return;
  btn.disabled = !!on;
  btn.classList.toggle('loading', !!on);
}




function showGate(message=''){
  gate.classList.remove('fade-out');
  gate.classList.add('fade-in');
  gate.style.display = 'grid';
  if(msgEl) msgEl.textContent = message || '';
  if(btnLogout) btnLogout.style.display = 'none';
}
function hideGate(){
  gate.classList.remove('fade-in');
  gate.classList.add('fade-out');
  // اخفِ بعد الأنيميشن
  setTimeout(()=>{ gate.style.display = 'none'; }, 200);
  if(msgEl) msgEl.textContent = '';
  if(btnLogout) btnLogout.style.display = '';
}

// UI عند الدخول/الخروج
function setSignedInUI(user){
  IS_SIGNED_IN = true;
  const badge = document.getElementById('userBadge');
  if(badge){ badge.textContent = user?.email || ''; badge.style.display = ''; }
  if(btnLogout){ btnLogout.style.display = ''; btnLogout.title = `تسجيل خروج (${user?.email||''})`; }
  toggleControls(false);   // فعّل الأزرار
  showToast?.('success','تم تسجيل الدخول بنجاح');
}


function setSignedOutUI(){
  IS_SIGNED_IN = false;
  const badge = document.getElementById('userBadge');
  if(badge){ badge.textContent = ''; badge.style.display = 'none'; }
  if(btnLogout){ btnLogout.style.display = 'none'; btnLogout.title = 'تسجيل خروج'; }
  toggleControls(true);    // عطّل الأزرار
  showToast?.('info','تم تسجيل الخروج');
}

// allowlist من Firestore
async function isAllowed(email){
  try{
    const snap = await getDoc(doc(db, "allowlist", "assal"));
    const emails = (snap.exists() && Array.isArray(snap.data().emails)) ? snap.data().emails : [];
    return emails.includes(email);
  }catch{ return false; }
}

// ابدأ والسلاش ظاهر والبوابة مخفية
showSplash();
gate.style.display = 'none';

// دخول يدوي
// تنقّل بالـ Enter داخل بوابة الدخول
emailEl?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); passEl?.focus(); }
});
passEl?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); btnEl?.focus(); }
});
btnEl?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); btnEl.click(); }
});

// دخول يدوي
btnEl?.addEventListener('click', async ()=>{
  msgEl.textContent = '';
  const email = (emailEl.value||'').trim();
  const pass  = passEl.value;
  if(!email || !pass){ msgEl.textContent = 'أدخل الإيميل وكلمة السر'; return; }

  // حركة زر + انتقال لطيف: gate يخفّ، بعدها يظهر Splash
  setBtnLoading(btnEl, true);
  try{
    hideGate();                 // أنيميشين خفيف
    setTimeout(()=> showSplash(), 180);  // بعد خفوت البوابة

    const { user } = await signInWithEmailAndPassword(auth, email, pass);
    if(!(await isAllowed(user.email))){
      await signOut(auth);
      hideSplash();
      showGate('هذا الإيميل غير مخوّل بالدخول');
      return;
    }

    setSignedInUI(user);
    // هنا لا نعرض توستين مع بعض؛ نظام الطابور يضمن واحد ورا الثاني تلقائيًا
  }catch(e){
    hideSplash();
    showGate('فشل تسجيل الدخول');
  }finally{
    setBtnLoading(btnEl, false);
  }
});




// خروج
btnLogout?.addEventListener('click', async ()=>{
  showSplash();
  try{
    await signOut(auth);
    setSignedOutUI();
    showGate('');
  }finally{
    hideSplash();
  }
});

// مراقبة حالة المصادقة (واحد فقط)
onAuthStateChanged(auth, async (user)=>{
  showSplash();
  try{
    if(!user){
      setSignedOutUI();
      showGate('');
      return;
    }
    const ok = await isAllowed(user.email);
    if(ok){
      hideGate();
      setSignedInUI(user);

      // ← هنا فقط: أول استيراد ذكي بعد تسجيل الدخول
      
      if(getDeviceRole() !== 'sub'){
  await smartImportFromServer();
} else {
  showToast('info','هذه الحاسبة فرعية: لا مزامنة تلقائية. استعمل زر "سحب النسخة" عند الحاجة.');
}

      
      
      
    }else{
      await signOut(auth);
      setSignedOutUI();
      showGate('الإيميل غير مخوّل');
    }
  }finally{
    hideSplash();
  }
});



</script>

<script>
(function(){
  // عناصر DOM
  const body = document.body;
  const paymentsBackdrop = document.getElementById('paymentsBackdrop');
  const paymentsModal    = document.getElementById('paymentsModal');
  const openBtn          = document.getElementById('openPaymentsBtn');
  const closeBtn         = document.getElementById('closePaymentsBtn');
  const exportBtn        = document.getElementById('exportPaymentsBtn');

  const inpDate     = document.getElementById('payDate');
  const form             = document.getElementById('paymentsForm');
  const inpCustomer      = document.getElementById('payCustomer');
  const inpType          = document.getElementById('payType');
  const inpAmount        = document.getElementById('payAmount');
  const inpNotes         = document.getElementById('payNotes');
  const addBtn           = document.getElementById('addPaymentBtn');

  const suggBox          = document.getElementById('payCustSuggestions');
  const rowsWrap         = document.getElementById('paymentsRows');
  
  
  
  
  // عناصر البحث
const searchBtn   = document.getElementById('searchPaymentsBtn');
const searchWrap  = document.getElementById('paymentsSearchBar');
const searchInput = document.getElementById('paymentsSearchInput');
const searchClear = document.getElementById('paymentsSearchClear');

// حالة نص البحث
let paymentsSearchQuery = '';

// إظهار/إخفاء شريط البحث
searchBtn?.addEventListener('click', ()=>{
  const nowOpen = !(searchWrap && searchWrap.style.display === 'flex');
  if (searchWrap) {
    searchWrap.style.display = nowOpen ? 'flex' : 'none';
    // بدّل الأيقونة حسب الحالة
    searchBtn.innerHTML = nowOpen
      ? '<i class="fa-solid fa-arrow-left"></i><span>بحث</span>'
      : '<i class="fa-solid fa-magnifying-glass"></i><span>بحث</span>';
    if (nowOpen) searchInput?.focus();
  }
});


// كتابة البحث → فلترة فورية
searchInput?.addEventListener('input', (e)=>{
  paymentsSearchQuery = String(e.target.value || '').trim();
  renderPaymentsRows();
});

// مسح البحث
searchClear?.addEventListener('click', ()=>{
  paymentsSearchQuery = '';
  if (searchInput) searchInput.value = '';
  renderPaymentsRows();
});

  
  

  // البيانات بالذاكرة
  let paymentsData = [];
 // لا تنسَ تصلّح getAllCustomers فوق بالمشروع كله
function getAllCustomers(){
  return Array.isArray(CUSTOMERS) ? [...CUSTOMERS] : [];
}



// [A] ===== تخزين محلي + إدارة أيام =====
const PAYMENTS_KEY = 'assal.payments.v1';      // مفتاح التخزين
let   paymentsStore = JSON.parse(localStorage.getItem(PAYMENTS_KEY) || '{}');

// ترجيع مفاتيح أيام بصيغة YYYY-MM-DD
function getDayKey(d){
  return (d ? String(d) : new Date().toISOString().slice(0,10));
}

// قائمة التسديدات ليوم معيّن
function listPayments(day){
  const k = getDayKey(day);
  return Array.isArray(paymentsStore[k]) ? paymentsStore[k] : [];
}

// حفظ يوم معيّن
function savePayments(day, arr){
  const k = getDayKey(day);
  paymentsStore[k] = arr;
  localStorage.setItem(PAYMENTS_KEY, JSON.stringify(paymentsStore));
}

// اليوم الحالي المعروض داخل النافذة
let currentDay = null;

// ضبط اليوم الحالي + تحميل بياناته
function setCurrentDay(day){
  currentDay   = getDayKey(day);
  paymentsData = listPayments(currentDay);
  renderPaymentsRows(); // عندك موجودة، تبقى تعرض فقط تسديدات اليوم الحالي
}

// بعد تعريف setCurrentDay() مباشرةً
window.refreshPaymentsUI = function(){
  try {
    // اقرأ المخزن من localStorage من جديد
    paymentsStore = (function loadPaymentsStore(){
      try {
        const raw = localStorage.getItem('assal.payments.v1') || '{}';
        const obj = JSON.parse(raw);
        return (obj && typeof obj === 'object') ? obj : {};
      } catch { return {}; }
    })();

    // حدّد اليوم المعروض وأعد تحميل البيانات + الرسم
    const day = (typeof todayStr === 'function' ? (document.getElementById('payDate')?.value || todayStr())
                                                : new Date().toISOString().slice(0,10));
    setCurrentDay(day);
  } catch (e) {
    console.warn('refreshPaymentsUI failed', e);
  }
};

// (اختياري مفيد لو عندك تبويبات): حدّث تلقائيًا إذا تغيّر التخزين
window.addEventListener('storage', (e)=>{
  if (e.key === 'assal.payments.v1') window.refreshPaymentsUI?.();
});





// [B] ===== تهيئة تاريخ الافتراضي + تحميل اليوم المختار =====
function todayStr(){ return new Date().toISOString().slice(0,10); }

// عند فتح نافذة الحسابات المالية: ثبّت تاريخ اليوم إذا فارغ، وحمّل بياناته

openBtn?.addEventListener('click', ()=>{
  // رجّع الحقل دائماً إلى تاريخ اليوم
  inpDate.value = todayStr();
  setCurrentDay(inpDate.value); // يحمل بيانات يوم اليوم ويعرضها
});

closeBtn?.addEventListener('click', ()=>{
  // حضّر الحالة للفتح القادم: رجّع التاريخ والداتا لليوم
  inpDate.value = todayStr();
  setCurrentDay(inpDate.value);
  // إذا عندك كود يغلق المودال هنا، يبقى كما هو (مثلاً إخفاء الـ modal)
});


// لما يغيّر التاريخ من داخل النافذة: بدّل اليوم المعروض
inpDate?.addEventListener('change', ()=>{
  setCurrentDay(inpDate.value || todayStr());
});






// ===== تنقّل بأسهم الكيبورد داخل اقتراحات "اسم الزبون" في نافذة الحسابات المالية =====

// مؤشر العنصر المتظلّل حاليًا
let __payCustIdx = -1;

// إرجاع عناصر <li> للّستة
function getPayCustLis(){
  const host = document.getElementById('payCustSuggestions');
  return host ? Array.from(host.querySelectorAll('.sugg-item')) : [];
}

// إبراز العنصر المحدَّد والتمرير له
function highlightPayCustItem(){
  const items = getPayCustLis();
  items.forEach(li => li.classList.remove('active'));
  if (__payCustIdx >= 0 && items[__payCustIdx]) {
    items[__payCustIdx].classList.add('active');
    items[__payCustIdx].scrollIntoView({ block: 'nearest' });
  }
}

// إخفاء اللستة
function hidePayCustSuggestions(){
  const host = document.getElementById('payCustSuggestions');
  if (host){
    host.style.display = 'none';
    host.innerHTML = '';
    __payCustIdx = -1;
  }
}

// رسم/تحديث الاقتراحات حسب النص المكتوب
function renderPayCustSuggestions(){
  const host = document.getElementById('payCustSuggestions');
  const inp  = document.getElementById('payCustomer');
  if(!host || !inp) return;

  const q = String(inp.value || '').trim().toLowerCase();
  const all = (typeof getAllCustomers === 'function') ? getAllCustomers() : [];
  // بدون كتابة → لا تعرض شي
  if(!q){
    hidePayCustSuggestions();
    return;
  }

  const data = all.filter(n => n.toLowerCase().includes(q));

  host.innerHTML = '';
  __payCustIdx = -1;

  data.forEach(name=>{
    const li = document.createElement('li');
    li.className = 'sugg-item';
    li.textContent = name;
    li.onclick = ()=>{
      inp.value = name;
      hidePayCustSuggestions();
      // بعد الاختيار: ننقلك على نوع الحركة
      const target = document.getElementById('payType');
      if (target){
        target.focus();
        if (typeof target.showPicker === 'function') target.showPicker();
      }
    };
    host.appendChild(li);
  });

  host.style.display = data.length ? 'block' : 'none';
}

// إظهار/تحديث اللستة أثناء الكتابة
inpCustomer.addEventListener('input', ()=>{
  renderPayCustSuggestions();
});

// تنقّل بالأسهم + Enter/Esc
inpCustomer.addEventListener('keydown', (e)=>{
  const hasQuery = String(inpCustomer.value||'').trim().length > 0;

  // إذا اللستة مخفية ونضغط أسهم/إنتر مع نص → افتح/حدّث
  const host = document.getElementById('payCustSuggestions');
  const isHidden = !host || host.style.display === 'none';

  if(isHidden){
    if((e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') && hasQuery){
      e.preventDefault();
      renderPayCustSuggestions();
    }
    return;
  }

  // اللستة ظاهرة: تنقّل واختيار
  const items = getPayCustLis();
  if(!items.length) return;

  if(e.key === 'ArrowDown'){
    e.preventDefault();
    __payCustIdx = (__payCustIdx < 0) ? 0 : Math.min(items.length - 1, __payCustIdx + 1);
    highlightPayCustItem();
  }else if(e.key === 'ArrowUp'){
    e.preventDefault();
    __payCustIdx = (__payCustIdx < 0) ? items.length - 1 : Math.max(0, __payCustIdx - 1);
    highlightPayCustItem();
  }else if(e.key === 'Enter'){
    e.preventDefault();
    if(__payCustIdx >= 0) items[__payCustIdx].click();
  }else if(e.key === 'Escape'){
    e.preventDefault();
    hidePayCustSuggestions();
  }
});

// إغلاق اللستة إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const host = document.getElementById('payCustSuggestions');
  if(!host) return;
  const inside = host.contains(ev.target) || inpCustomer.contains(ev.target);
  if(!inside) hidePayCustSuggestions();
});


  // ========== فتح / غلق ==========
 
function openPayments(){
  paymentsBackdrop.classList.add('active');
  paymentsModal.classList.add('active');
  body.classList.add('modal-open');

  // ✨ تأكد الشريط مخفي ومصفّر عند الفتح
  if (searchWrap) searchWrap.style.display = 'none';
  if (searchBtn) {
    searchBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i><span>بحث</span>';
    searchBtn.setAttribute('aria-expanded','false');
  }
  if (typeof paymentsSearchQuery !== 'undefined') paymentsSearchQuery = '';
  if (searchInput) searchInput.value = '';

  const todayISO = new Date().toISOString().slice(0,10);
  if (inpDate && !inpDate.value) {
    inpDate.value = todayISO;
  }

  inpCustomer.focus();
}


 
function closePayments(){
  paymentsBackdrop.classList.remove('active');
  paymentsModal.classList.remove('active');
  body.classList.remove('modal-open');

  // ✨ رجّع شريط البحث للوضع الافتراضي
  if (searchWrap) {
    searchWrap.style.display = 'none';
  }
  if (searchBtn) {
    searchBtn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i><span>بحث</span>';
    searchBtn.setAttribute('aria-expanded','false');
  }
  if (typeof paymentsSearchQuery !== 'undefined') paymentsSearchQuery = '';
  if (searchInput) searchInput.value = '';

  // إن تحب ترجّع الجدول بدون فلترة فورًا (اختياري):
  if (typeof renderPaymentsRows === 'function') renderPaymentsRows();
}


  openBtn.addEventListener('click', openPayments);
  closeBtn.addEventListener('click', closePayments);
  paymentsBackdrop.addEventListener('click', closePayments);

  // ========== تنسيق المبلغ (فوارز د.ع) ==========
 function formatIQD(v){
  const n = Number(String(v||'').replace(/[^\d.]/g,''));
  if(!isFinite(n)) return '';
  return n.toLocaleString('en-US'); // يطلع "12,500"
}

// ربطها بحقل المبلغ
inpAmount.addEventListener('input', ()=>{
  const caretPos = inpAmount.selectionStart;
  const oldLen   = inpAmount.value.length;
  inpAmount.value = formatIQD(inpAmount.value);
  const newLen   = inpAmount.value.length;
  inpAmount.selectionStart = inpAmount.selectionEnd = caretPos + (newLen-oldLen);
});

  inpAmount.addEventListener('input', ()=>{
    const caretPos = inpAmount.selectionStart;
    const oldLen   = inpAmount.value.length;
    inpAmount.value = formatIQD(inpAmount.value);
    // رجع الكارِت تقريبياً حتى ما يقفز المؤشر لنهاية بعنف
    const newLen   = inpAmount.value.length;
    inpAmount.selectionStart = inpAmount.selectionEnd = caretPos + (newLen-oldLen);
  });

  // ========== اقتراحات الاسم ==========
function showCustSuggestions(prefix){
  const q = prefix.trim();
  if(!q){
    suggBox.style.display='none';
    return;
  }

  const allNames = getAllCustomers();
  const list = allNames.filter(n => n.includes(q)); // بدون slice

  let html = '';
  if(list.length){
    list.forEach(n=>{
      html += `<div class="sugg-item" data-name="${n}">${n}</div>`;
    });
  }

  suggBox.innerHTML = html;
  suggBox.style.display = list.length ? 'block' : 'none';
}



  inpCustomer.addEventListener('input', e=>{
    showCustSuggestions(e.target.value);
  });

  // اختيار من الاقتراح
  suggBox.addEventListener('click', e=>{
    const item = e.target.closest('.sugg-item');
    if(!item) return;
    const name = item.getAttribute('data-name') || '';
    inpCustomer.value = name;
    suggBox.style.display='none';
    inpType.focus();
  });

  // لو يطلع برّه، نخفيها شوي
  document.addEventListener('click', e=>{
    if(!paymentsModal.contains(e.target)){ return; }
    if(e.target===inpCustomer || e.target.closest('.pf-cust')) return;
    suggBox.style.display='none';
  });

  // ========== إضافة دفعة ==========
function addPayment(){
  const cust   = inpCustomer.value.trim();
  const kind   = inpType.value;
  const amtStr = inpAmount.value.replace(/[^\d.]/g,'');
  const notes  = inpNotes.value.trim();
  const day    = inpDate.value || new Date().toISOString().slice(0,10);
  const time12 = new Date().toLocaleTimeString('ar-IQ', { hour:'numeric', minute:'2-digit' });

  if(!cust || !amtStr){ return; }

  const amountNum = Number(amtStr) || 0;
  const now  = new Date();
  const time = now.toLocaleTimeString('ar-IQ', { hour:'2-digit', minute:'2-digit' });

  const id = 'pay_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);

  paymentsData.push({
    id,
    cust, kind, amount: amountNum, notes,
    date: day,                        // عندك أصلاً تضيف التاريخ
   time: time12      // فقط هذا، ما نضيف time24
  });

  savePayments(day, paymentsData);    // [جديد]: خزّن يوم الإدخال
  renderPaymentsRows();

  // تفريغ بسيط كما بكودك
  inpCustomer.value=''; inpAmount.value=''; inpNotes.value='';
  // نخلي التاريخ ثابت لليوم الحالي حتى تواصل إدخال نفس اليوم
  // inpDate.value = day;
  suggBox.style.display='none';
  inpCustomer.focus();
}


// [E] تشغيل الإضافة من زر الفورم
form?.addEventListener('submit', (e)=>{
  e.preventDefault();       // يمنع إعادة تحميل الصفحة
  addPayment();             // ينفّذ الإضافة
});



// ==== حذف حركة تسديد/سحب مع تأكيد ====
async function deletePayment(idx){
  const row = paymentsData[idx];
  if (!row) return;

  const isWithdraw = (row?.kind === 'سحب');
  const title   = isWithdraw ? 'تأكيد حذف عملية سحب' : 'تأكيد حذف عملية تسديد';
  const amount  = Number(String(row?.amount ?? 0).replace(/[^\d.]/g,''));
  const amtTxt  = (isFinite(amount) ? amount : 0).toLocaleString('ar-IQ');
  const whenTxt = [row?.date, row?.time].filter(Boolean).join(' — ');

  const ok = await showConfirm({
    title,
    message: `
      هل تريد حذف ${isWithdraw ? 'السحب' : 'التسديد'}
      للزبون "<strong>${row?.cust || ''}</strong>"
      بمبلغ <strong>${amtTxt}</strong> د.ع
      ${whenTxt ? `(<em>${whenTxt}</em>)` : ''} ؟
    `,
    okText: 'حذف',
    cancelText: 'رجوع',
    danger: true
  });
  if (!ok) return;

  // تنفيذ الحذف بعد التأكيد (تومبستون بدل الإزالة الفعلية)
  // paymentsData.splice(idx, 1);
  const nowIso = new Date().toISOString();
  row.id = row.id || row._id || __paymentKey__(row); // تثبيت هوية السطر
  row.deletedAt = nowIso;  // علامة حذف للمزامنة
  row.updatedAt = nowIso;  // آخر تعديل

  savePayments(currentDay, paymentsData);   // تبقى مثل ما هي
  renderPaymentsRows();

  // نفس أسلوب التوستات عندك
  (typeof showToast === 'function') && showToast('error', 'تم حذف الحركة من الحسابات');
}


function renderPaymentsRows(){
  // حوّل أرقام ٠١٢٣… إلى 0123 حتى نكدر نحلّلها
  function toLatinDigits(s){
    if (!s) return '';
    return s.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, ch => String('٠١٢٣٤٥٦٧٨٩'.indexOf(ch)));
  }

  // حوّل "HH:MM ص/م" إلى دقائق من بداية اليوم
  function minutesFrom12h(timeStr){
    const raw = toLatinDigits(String(timeStr||'')).trim();
    const m = raw.match(/(\d{1,2}):(\d{1,2})/);   // يشتغل حتى لو دقيقة/ساعة خانة وحدة
    if(!m) return -1;                             // لو ماكو وقت، نزّله لآخر القائمة
    let h = Number(m[1]), mi = Number(m[2]);

    const isPM = /م/.test(raw) || /PM/i.test(raw);
    const isAM = /ص/.test(raw) || /AM/i.test(raw);

    // تحويل 12h إلى 0..23
    if (isPM && h < 12) h += 12;   // 1م..11م => 13..23
    if (isAM && h === 12) h = 0;   // 12ص => 00
    return h*60 + mi;
  }

  // حوّل التاريخ إلى قيمة رقمية آمنة للمقارنة (يدعم "YYYY-MM-DD" و "DD/MM/YYYY")
  function dateValue(d){
    const s = toLatinDigits(String(d || '')).trim();
    if (!s) return 0;
    // إذا الصيغة DD/MM/YYYY
    if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)){
      const [dd, mm, yy] = s.split('/');
      const yyyy = yy.length === 2 ? ('20' + yy) : yy;
      const iso = `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
      const t = new Date(iso).getTime();
      return isNaN(t) ? 0 : t;
    }
    const t = new Date(s).getTime();
    return isNaN(t) ? 0 : t;
  }

  // ❶ جهّز المصدر:
  // - إذا ماكو بحث: اعرض اليوم الحالي فقط (نفس سلوكك القديم).
  // - إذا اكو بحث: اجمع كل الأيام من paymentsStore وخلّ الفلترة تمشي عليها.
  let view;
  if (!paymentsSearchQuery){
    view = Array.isArray(paymentsData) ? [...paymentsData] : [];
  } else {
    const all = [];
    if (paymentsStore && typeof paymentsStore === 'object'){
      Object.keys(paymentsStore).forEach(dayKey=>{
        const arr = paymentsStore[dayKey];
        if (Array.isArray(arr)) all.push(...arr);
      });
    } else {
      // احتياط: لو ماكو paymentsStore نرجع لبيانات اليوم الحالي
      if (Array.isArray(paymentsData)) all.push(...paymentsData);
    }
    view = all;
  }

  // ✅ تعديل مضاف: اخفِ السطور المعلّمة كمحذوفة (deletedAt)
  view = (view || []).filter(r => !r?.deletedAt);

  // ❷ ترتيب مبدئي (رح نعيد الترتيب بعد الفلترة همين)
  view.sort((a,b)=> minutesFrom12h(b?.time) - minutesFrom12h(a?.time));

  // ❸ إذا اكو نص بحث: يشمل تسديد وسحب + مطابقة الاسم/الملاحظة/المبلغ
  if (paymentsSearchQuery){
    const q = toLatinDigits(paymentsSearchQuery).toLowerCase();
    view = view.filter(r=>{
      const cust  = String(r?.cust  || '').toLowerCase();
      const notes = String(r?.notes || '').toLowerCase();

      const amtNum = Number(
        toLatinDigits(String(r?.amount ?? '')).replace(/[^\d.]/g,'')
      );
      const amtStr = isFinite(amtNum) ? String(amtNum) : '';

      return (
        cust.includes(q) ||
        notes.includes(q) ||
        amtStr.includes(q)
      );
    });
  }

  // ❹ ترتيب نهائي: التاريخ نزولاً ثم الوقت نزولاً
  view.sort((a,b)=>{
    const byDate = dateValue(b?.date) - dateValue(a?.date);
    if (byDate !== 0) return byDate;
    return minutesFrom12h(b?.time) - minutesFrom12h(a?.time);
  });

  // ❺ بناء الصفوف (نفس تنسيقك القديم)
  rowsWrap.innerHTML = view.map((row,idx)=>{
    // تنسيق المبلغ بأمان (لو كان نص/فارغ/أرقام عربية)
    const amtNum = Number(
      toLatinDigits(String(row?.amount ?? '0')).replace(/[^\d.]/g,'')
    );
    const formattedAmt = (isFinite(amtNum) ? amtNum : 0).toLocaleString('ar-IQ');

    const isIn  = row?.kind === 'تسديد';
    const isOut = row?.kind === 'سحب';

    const rowPayload = encodeURIComponent(JSON.stringify({
      cust: row?.cust ?? '',
      kind: row?.kind ?? '',
      amount: row?.amount ?? '',
      notes: row?.notes ?? '',
      date: row?.date ?? '',
      time: row?.time ?? ''
    }));

    return `
      <div class="payment-row ${isOut ? 'withdraw' : ''}">
        <div>${idx+1}</div>
        <div>${row?.cust ?? ''}</div>
        <div>
          <div class="pay-type ${isIn ? 'pay-in':'pay-out'}">${row?.kind ?? ''}</div>
        </div>
        <div class="pay-amt">${formattedAmt}</div>
        <div>${row?.notes || ''}</div>
        <div>${row?.date || ''}</div>
        <div>${row?.time || ''}</div>
        <div>
          <button class="payment-del-btn" data-idx="${paymentsData.indexOf(row)}">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </div>
        <div>
          <button class="payment-print-btn" data-row="${rowPayload}" title="طباعة وصل">
            <i class="fa-solid fa-print"></i>
          </button>
        </div>
      </div>
    `;
  }).join('');
}








  rowsWrap.addEventListener('click', e=>{
    // حذف
    const delBtn = e.target.closest('.payment-del-btn');
    if(delBtn){
      const idx = Number(delBtn.getAttribute('data-idx'));
      deletePayment(idx);
      return;
    }

    // طباعة وصل
    const printBtn = e.target.closest('.payment-print-btn');
    if(!printBtn) return;

    try{
      const payload = printBtn.getAttribute('data-row') || '';
      const row = JSON.parse(decodeURIComponent(payload));

      // إذا تحب: فقط للتسديد
      // if(row?.kind !== 'تسديد'){ (typeof showToast==='function') && showToast('warn','الطباعة متاحة للتسديد فقط'); return; }

      printPaymentReceipt(row);
    }catch(err){
      console.error('printPaymentReceipt parse error:', err);
      (typeof showToast==='function') && showToast('error','فشل تحضير بيانات الطباعة');
    }
  });


  // ========== طباعة وصل تسديد (فاتورة صغيرة) ==========
function printPaymentReceipt(row){
  try{
    const esc = (s)=> String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');

    const kind  = row?.kind || 'تسديد';
    const title = (kind === 'سحب') ? 'وصل سحب' : 'وصل تسديد';
    const badge = (kind === 'سحب') ? 'قيد السحب' : 'قيد التسديد';

    const amtNum = Number(String(row?.amount ?? '').replace(/[^\d.]/g,'')) || 0;
    const amtStr = amtNum.toLocaleString('ar-IQ') + ' د.ع';

    const cust  = esc(row?.cust  || '');
    const notes = esc(row?.notes || '');
    const date  = esc(row?.date  || '');
    const time  = esc(row?.time  || '');

    // رقم سند أنيق (إذا عندك row.ref/row.id يستعمله، غيره يولّد رقم)
    const now = new Date();
    const pad2 = (n)=> String(n).padStart(2,'0');
    const stamp = `${now.getFullYear()}${pad2(now.getMonth()+1)}${pad2(now.getDate())}-${pad2(now.getHours())}${pad2(now.getMinutes())}`;
    const ref = esc(row?.ref || row?.id || row?.no || row?.receiptNo || '');
    const receiptNo = ref || `RCPT-${stamp}`;

    const issuedAt = esc(now.toLocaleString('ar-IQ'));

    const w = window.open('', '_blank', 'width=520,height=720');
    if(!w){ (typeof showToast==='function') && showToast('warn','افتح السماح بالنوافذ المنبثقة'); return; }

    w.document.open();
    w.document.write(`<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${esc(title)}</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
<style>
  :root{
    --ink:#0b0f19;
    --muted:#6b7280;
    --stroke:#e5e7eb;
    --soft:#f3f4f6;
    --gold:#b08a2a;
  }
  *{ box-sizing:border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  html,body{ margin:0; padding:0; font-family:"Cairo",system-ui; color:var(--ink); background:#fff; }

  .wrap{ padding:14px; }
  .card{
    position:relative;
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:12px 12px 10px;
    overflow:hidden;
    background:
      linear-gradient(180deg, #fff, #fff),
      radial-gradient(circle at 20% 0%, rgba(176,138,42,.08), transparent 55%),
      radial-gradient(circle at 90% 35%, rgba(11,15,25,.05), transparent 60%);
  }
  .card::before{
    content:"";
    position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, var(--ink), var(--gold), var(--ink));
    opacity:.95;
  }
  .card::after{
    content:"ASSAL";
    position:absolute;
    left:12px; top:44px;
    font-weight:900;
    font-size:42px;
    letter-spacing:6px;
    opacity:.04;
    transform:rotate(-10deg);
    pointer-events:none;
    user-select:none;
  }

  .hdr{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
  .brandRow{ display:flex; gap:10px; align-items:flex-start; }
  .mark{
    width:38px; height:38px;
    border:1px solid var(--ink);
    border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    font-weight:900; letter-spacing:.3px;
    background:linear-gradient(180deg,#fff,#fafafa);
    position:relative;
  }
  .mark::after{
    content:"";
    position:absolute; inset:5px;
    border-radius:10px;
    border:1px solid rgba(176,138,42,.55);
  }
  .brand .name{ font-weight:900; letter-spacing:.3px; font-size:14px; line-height:1.1; }
  .brand .sub{ color:var(--muted); font-weight:800; font-size:11.5px; margin-top:2px; }
  .brand .line{ color:var(--muted); font-weight:700; font-size:11.5px; margin-top:2px; }

  .title{ font-weight:900; font-size:16px; margin:0; letter-spacing:.2px; }
  .badge{
    display:inline-block;
    border:1px solid rgba(176,138,42,.55);
    border-radius:999px;
    padding:3px 10px;
    font-weight:900;
    font-size:11.5px;
    background:linear-gradient(180deg, #fff, rgba(176,138,42,.10));
    white-space:nowrap;
  }

  .metaTop{
    margin-top:8px;
    display:flex; justify-content:space-between; gap:10px;
    font-size:11.5px; color:var(--muted); font-weight:800;
    border-top:1px solid var(--stroke);
    padding-top:8px;
  }
  .metaTop b{ color:var(--ink); }

  .amount{
    margin-top:10px;
    border:1px solid var(--ink);
    border-radius:14px;
    padding:10px 12px;
    background:linear-gradient(135deg, rgba(176,138,42,.10), transparent 55%), #fff;
  }
  .amount .label{ color:var(--muted); font-size:11.5px; font-weight:900; }
  .amount .val{ font-weight:900; font-size:22px; margin-top:2px; font-variant-numeric: tabular-nums; letter-spacing:.2px; }

  .tableWrap{
    margin-top:10px;
    border:1px solid var(--stroke);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:12.5px;
  }
  td{
    padding:8px 10px;
    border-bottom:1px solid var(--stroke);
  }
  tr:last-child td{ border-bottom:none; }
  td.k{
    width:38%;
    color:var(--muted);
    font-weight:900;
    background:#fafafa;
  }
  td.v{
    font-weight:900;
    text-align:left;
    font-variant-numeric: tabular-nums;
  }

  .notes{
    margin-top:10px;
    border:1px solid var(--stroke);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
  }
  .notes .head{
    padding:8px 10px;
    font-size:12px;
    font-weight:900;
    color:var(--ink);
    border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg,#fff,#fafafa);
  }
  .notes .body{
    padding:10px;
    font-size:13px;
    font-weight:700;
    white-space:pre-wrap;
    line-height:1.65;
    min-height:28px;
  }

  .sig{
    margin-top:10px;
    display:flex; justify-content:space-between; gap:10px;
    font-size:11.5px;
  }
  .sig .slot{ flex:1; }
  .sig .lbl{ color:var(--muted); font-weight:900; }
  .sig .line{ border-bottom:1px solid #111; height:16px; margin-top:8px; opacity:.9; }

  .foot{
    margin-top:10px;
    padding-top:8px;
    border-top:1px solid var(--stroke);
    display:flex; justify-content:space-between; gap:10px;
    font-size:11.5px; color:var(--muted); font-weight:800;
  }
  .foot b{ color:var(--ink); }

  /* ====== التوسيط: كل جسم الفاتورة توسيط عدا الهيدر والفوتر ====== */
  .card.center-body{ text-align:center; }
  .card.center-body .hdr,
  .card.center-body .foot{ text-align:initial; }
  .card.center-body td.v{ text-align:center !important; }

  @media print{
    @page{ size:auto; margin:10mm; }
    .wrap{ padding:0; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card center-body">
      <div class="hdr">
        <div>
          <div class="brandRow">
            <div class="mark">AS</div>
            <div class="brand">
              <div class="name">ASSAL</div>
              <div class="sub">Financial System • Official Receipt</div>
              <div class="line">بعقوبة - شارع الأوقاف | 07728640560</div>
            </div>
          </div>
          <div style="margin-top:6px;">
            <h1 class="title">${esc(title)}</h1>
          </div>
        </div>
        <div class="badge">${esc(badge)}</div>
      </div>

      <div class="metaTop">
        <div><b>رقم السند:</b> ${esc(receiptNo)}</div>
        <div><b>التاريخ:</b> ${date || '-'} ${time ? '• ' + time : ''}</div>
      </div>

      <div class="amount">
        <div class="label">إجمالي المبلغ (IQD)</div>
        <div class="val">${esc(amtStr)}</div>
      </div>

      <div class="tableWrap">
        <table>
          <tr><td class="k">اسم الزبون</td><td class="v">${cust || '-'}</td></tr>
          <tr><td class="k">النوع</td><td class="v">${esc(kind)}</td></tr>
          <tr><td class="k">مرجع الإصدار</td><td class="v">${esc(issuedAt)}</td></tr>
          <tr><td class="k">ملاحظة النظام</td><td class="v">ASSAL FINANCE</td></tr>
        </table>
      </div>

      <div class="notes">
        <div class="head">ملاحظات</div>
        <div class="body">${notes ? notes : '—'}</div>
      </div>

      <div class="sig">
        <div class="slot"><div class="lbl">توقيع المستلم</div><div class="line"></div></div>
        <div class="slot"><div class="lbl">الختم</div><div class="line"></div></div>
      </div>

      <div class="foot">
        <div>تم إنشاء السند إلكترونياً • <b>Secure Print</b></div>
        <div>© ASSAL</div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', function(){ window.print(); });
  <\/script>
</body>
</html>`);
    w.document.close();
    w.focus();
  }catch(err){
    console.error('printPaymentReceipt error:', err);
    (typeof showToast==='function') && showToast('error','فشل إنشاء صفحة الطباعة');
  }
}






  // ========== Enter flow ==========
  // ترتيب الإدخال: اسم -> نوع -> مبلغ -> ملاحظات -> إضافة
  function focusNext(current){
    if(current===inpCustomer){ inpType.focus(); return; }
    if(current===inpType){ inpAmount.focus(); return; }
    if(current===inpAmount){ inpNotes.focus(); return; }
    if(current===inpNotes){ addPayment(); return; }
  }

  [inpCustomer, inpType, inpAmount, inpNotes].forEach(el=>{
    el.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        focusNext(el);
      }
    });
  });

  // الفورم نفسه (اضافة)
  form.addEventListener('submit', e=>{
    e.preventDefault();
    addPayment();
  });

  addBtn.addEventListener('click', e=>{
    e.preventDefault();
    addPayment();
  });

 // ========== تصدير ==========
exportBtn.addEventListener('click', ()=>{
  // 🔥 نفلتر أي سجل بيه deletedAt حتى لا يظهر بالتصدير
  const printable = (Array.isArray(paymentsData) ? paymentsData : [])
    .filter(r => !r?.deletedAt);

  if (!printable.length){
    (typeof showToast === 'function') && showToast('warn','ماكو بيانات للطباعة');
    return;
  }

  exportPayments_Print(printable); // نرسل البيانات المفلترة فقط
});


// === طباعة جدول الحسابات (نفس أسلوب طباعة البطاقة: نافذة نظيفة + print) ===
function exportPayments_Print(list){
  try{
    // نضمن أن البيانات مفلترة من المحذوفين (في حال أحد نادانا بدون فلترة)
    const data = (Array.isArray(list) ? list : []).filter(r => !r?.deletedAt);

    // تاريخ للطباعة (من نافذة الحسابات إذا موجود)
    const dateStr =
      document.getElementById('payDate')?.value ||
      document.getElementById('dateBadge')?.textContent || '';

    // نبني صفوف الجدول من القائمة المفلترة فقط
    const rows = data.map((r, i)=> {
      const kind = (r?.kind ?? '').trim();
      const isWithdraw = (kind === 'سحب');
      const amt = String(r.amount ?? '')
        .replace(/[^\d.]/g,'')
        .replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return `
      <tr class="payment-row${isWithdraw ? ' withdraw' : ''}">
        <td>${i+1}</td>
        <td>${r.cust ?? ''}</td>
        <td>${kind}</td>
        <td class="num">${amt}</td>
        <td style="text-align:start">${r.notes ?? ''}</td>
        <td>${r.date ?? ''}</td>
        <td>${r.time ?? ''}</td>
      </tr>
      `;
    }).join('');

    const title = 'حركة الحسابات — مكتب عسل';
    const w = window.open('', '_blank');
    if(!w){
      (typeof showToast==='function') && showToast('error','المتصفح منع فتح نافذة الطباعة');
      return;
    }

    w.document.write(`<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${title}</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
<style>
  :root{ --ink:#111827; --muted:#6b7280; --stroke:#e5e7eb; }
  html,body{ margin:0; padding:0; font-family:"Cairo",system-ui; color:var(--ink); background:#fff; }
  .wrap{ padding:18px; }
  .head{
    display:flex; align-items:center; justify-content:space-between;
    border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; margin-bottom:14px; background:#fafafa;
  }
  .title{ font-weight:900; }
  .date{ font-size:12px; color:var(--muted); }

  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid var(--stroke); padding:6px 8px; font-size:12px; }
  th{ background:#f3f4f6; font-weight:900; text-align:center; }
  td{ text-align:center; }
  .num{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1; font-weight:900; }
  tbody tr:nth-child(even){ background:#fafafa; }

  /* ===== تظليل صف "سحب" للطباعة ===== */
  .payment-row.withdraw{
    background:#2a0c12 !important;
    color:#fca5a5;
  }
  .payment-row.withdraw td{
    border-color: rgba(127,29,29,0.45) !important;
  }
  .payment-row.withdraw td:nth-child(4){
    background:#200a0f;
    border:1px solid #7f1d1d !important;
    color:#fecaca;
    font-weight:800;
  }

  *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  @media print{ @page{ size:auto; margin:10mm; } }
</style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">${title}</div>
      <div class="date">${dateStr || ''}</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>الاسم</th>
          <th>النوع</th>
          <th>المبلغ (د.ع)</th>
          <th>ملاحظات</th>
          <th>تاريخ</th>
          <th>وقت</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  </div>
  <script>
    window.addEventListener('load', ()=>{ window.print(); });
  <\/script>
</body>
</html>`);

    w.document.close();
    w.focus();
  }catch(err){
    console.error('exportPayments_Print error:', err);
    (typeof showToast==='function') && showToast('error','فشل إنشاء صفحة الطباعة');
  }
}


})();



</script>


<script>
// ==== مزامنة آمنة تعتمد على selectedDay فقط (ما نلمس TODAY حتى لو const) ====
// ضع هذه الكتلة في نهاية ملفك بعد كل شيء.

// اسماء فريدة حتى ما نصطدم بتعاريف ثانية
(function __railDayAutoSync__(){
  // إرجاع تاريخ اليوم بصيغة YYYY-MM-DD
  function __getTodayYMD__(){
    const pad2 = n => String(n).padStart(2,'0');
    const now = new Date();
    return `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
  }

  // نحتفظ بآخر يوم شفناه (من selectedDay أو TODAY إذا selectedDay مو معرف)
  var __lastSeenDay__ = (typeof selectedDay === 'string' && selectedDay) 
                          ? selectedDay 
                          : (typeof TODAY === 'string' ? TODAY : __getTodayYMD__());

  function __tickSync__(){
    try{
      const today = __getTodayYMD__();

      // إذا اختلف تاريخ اليوم عن آخر يوم شغال عندنا → نحدّث selectedDay فقط
      if (today !== __lastSeenDay__) {
        __lastSeenDay__ = today;
        // لا نقترب من TODAY حتى لو كانت const
        if (typeof selectedDay === 'undefined') { window.selectedDay = today; }
        else { selectedDay = today; }

        // نعيد الرسم إذا الدوال موجودة
        if (typeof renderBoard === 'function') renderBoard();
        if (typeof renderRail  === 'function') renderRail();
        if (typeof refreshStats=== 'function') refreshStats();
      }
    } catch(e){
      // ما نسوي شي، نخليها صامتة حتى لا تكسر الصفحة لو صار استثناء
      // console.error('[rail sync]', e);
    }
  }

  // تشغيل أولي + مؤقت كل 60 ثانية
  __tickSync__();
  if (!window.__railDayAutoSyncInterval__) {
    window.__railDayAutoSyncInterval__ = setInterval(__tickSync__, 60 * 1000);
  }
})();
</script>





  
</body>
</html>

