<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ASSAL • فواتير ديون يومية مكتب عسل</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  

  <style>
  
  /* فكّ حماية أيقونات Font Awesome من Cairo وتحديد الوزن الصحيح */
.fa-solid, .fas{
  font-family: "Font Awesome 6 Free" !important;
  font-weight: 900 !important;   /* مهم للـ solid */
}
.fa-regular, .far{
  font-family: "Font Awesome 6 Free" !important;
  font-weight: 400 !important;
}
.fa-brands, .fab{
  font-family: "Font Awesome 6 Brands" !important;
  font-weight: 400 !important;
}

  
  
  /* 1) خط Cairo على كل الواجهة (يشمل الأزرار والنوافذ والمدخلات) */
:root{ --ui-font: "Cairo", system-ui; }

/* غطّي كل العناصر المرئية في الصفحة */
:where(html, body, button, input, select, textarea, .btn, .field,
       .ribbon, .ribbon *, .layout, .rail, .rail *,
       .board, .board *, .masonry, .card, .card *,
       .insights, .insights *, .dock, .dock *,
       .footer, .footer *, .modal, .modal *){
  font-family: var(--ui-font) !important;
}

/* 2) حماية أيقونات Font Awesome حتى لا يتغيّر خطّها */
i.fa, i.fa-solid, i.fa-regular, i.fa-brands,
.fa, .fa-solid, .fa-regular, .fa-brands{
  font-family: var(--fa-style-family, "Font Awesome 6 Free") !important;
  font-weight: inherit;
}

  
  
  
  
    /* =================== لوحة ألوان عصرية =================== */
    :root{
      /* أساسيات */
      --bg:#0b1220;                /* خلفية داكنة أنيقة */
      --bg-2:#121a2b;              /* أغمق قليلاً لمناطق ثانوية */
      --paper:#0f172a;             /* لوحات وبطاقات داكنة ناعمة */
      --rail:#0f172a;              /* سايدبار */
      --ink:#e5e7eb;               /* نص رئيسي فاتح */
      --muted:#9aa4b2;             /* نص ثانوي */
      --stroke:#1f2a44;            /* حدود رفيعة */

      /* ألوان العلامة (تدرّج عصري) */
      --brand:#12d1b4;             /* فيروزي */
      --brand-2:#7c3aed;           /* بنفسجي */
      --brand-3:#0ea5e9;           /* أزرق سماوي للتفاصيل */

      /* دلالية */
      --good:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      /* مؤثرات */
      --radius:16px;
      --shadow:0 18px 50px rgba(0,0,0,.35);

      /* قياسات */
      --footer-h:44px;
      --dock-gap:68px;
      --hdr-h:54px;

      /* أسطح فاتحة داخل الداكن */
      --surface:#111a2f;
      --surface-2:#0e1630;
      --chip:#0f1a33;
    }

    /* خلفية بنمط شعاعي لطيف */
    body{
      margin:0;
      height:100%;
      color:var(--ink);
      font-family:"Cairo",system-ui;
      background:
        radial-gradient(1000px 600px at 80% -10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 500px at -10% 10%, rgba(18,209,180,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      overflow-x:hidden;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }

    /* =================== Header (عنوان بالمنتصف + زجاجي) =================== */
    .ribbon{
      position:sticky; top:0; z-index:70;
      background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(17,24,39,.5));
      border-bottom:1px solid rgba(124,58,237,.25);
      backdrop-filter:blur(10px);
    }
    .ribbon-wrap{
      height:var(--hdr-h);
      max-width:1480px;
      margin:auto;
      padding:0 14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* يسار | مركز | يمين */
      align-items:center;
      gap:10px;
    }
    .r-left{display:flex;align-items:center;gap:8px}
    .r-center{justify-self:center}
    .r-right{justify-self:end;display:flex;gap:6px}

    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand .dot{
      width:26px;height:26px;border-radius:8px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;font-size:13px;font-weight:800;
      box-shadow:0 8px 22px rgba(124,58,237,.35);
    }
    .brand .name{
      font-size:15px;letter-spacing:.1px;color:#fff;
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    .pill{
      border:1px solid rgba(124,58,237,.25);
      border-radius:999px;
      padding:4px 10px;
      color:#cbd5e1;
      background:linear-gradient(180deg, #0b1220, #0d1527);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
      font-size:12px;
    }
    .icon{
      width:34px;height:34px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0c1426,#0e1830);
      border-radius:10px;display:grid;place-items:center;cursor:pointer;
      color:#e2e8f0;
    }
    .icon:hover{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 8px 24px rgba(124,58,237,.25);
      transform:translateY(-1px);
      transition:.18s ease;
    }

    /* =================== Layout =================== */
    .layout{
      max-width:1480px;margin:14px auto;padding:0 14px;
      display:grid;grid-template-columns: 280px 1fr 320px;gap:14px
    }
    @media (max-width:1280px){ .layout{grid-template-columns: 240px 1fr 280px} }
    @media (max-width:980px){ .layout{grid-template-columns: 1fr; grid-auto-rows:min-content} }

    /* =================== Rail =================== */
    .rail{
      background:var(--surface);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
      position:sticky;
      top:calc(var(--hdr-h) + 8px);
      height:calc(100vh - var(--hdr-h) - 24px);
      display:flex;flex-direction:column
    }
    .rail h3{margin:0 0 6px 0;font-size:14px;font-weight:900;color:#e2e8f0}
    .rail .search{margin:6px 0}
    .input{
      width:100%;height:34px;padding:8px 10px;
      border:1px solid var(--stroke);border-radius:10px;background:#0c1325;color:#e5e7eb;
      font-family:"Cairo",system-ui;
      outline:none;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .input:focus{
      border-color:rgba(18,209,180,.6);
      box-shadow:0 0 0 3px rgba(18,209,180,.14);
    }

    /* شهور + أيام */
    .month{
      margin:10px 0 8px 0;
      padding:8px;
      border:1px dashed rgba(124,58,237,.35);
      border-radius:12px;
      background:linear-gradient(180deg, #0e1730, #0c1427);
    }
    .month-title{
      font-weight:900;color:#e5e7eb;margin-bottom:6px;
      display:flex;align-items:center;gap:8px;
    }
    .month-title .mchip{
      font-size:11px;border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;
      background:#0a1020;color:#a0aec0
    }

    .day{
      position:relative;margin:8px 0;padding:8px 10px;border:1px solid var(--stroke);
      border-radius:10px;cursor:pointer;background:#0b1327;
      display:flex;align-items:center;justify-content:space-between
    }
    .day .title{font-weight:800;font-size:13px;color:#e2e8f0}
    .day .meta{font-size:11px;color:#9aa4b2}
    .day:hover{border-color:rgba(124,58,237,.45)}
    .day.active{outline:2px solid rgba(124,58,237,.35)}
    
    
   .day{ position: relative; border-radius: 12px; }
.day.active{
  outline: none;
  background: rgba(18,209,180,.08);   /* تظليل خفيف كلش */
  border: 1px solid rgba(18,209,180,.20);
}



    /* =================== Board =================== */
    .board{min-height:60vh;padding-bottom:calc(var(--dock-gap) + var(--footer-h) + 18px)}
 
 
   /* استبدل تعريف .board-head الحالي بهذا */
.board-head{
  position: sticky;
  top: calc(var(--hdr-h) + 10px);  /* تحت الشريط العلوي */
  z-index: 60;

  display: grid;
  grid-template-columns: auto 1fr auto; /* يسار | وسط (بحث) | يمين */
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;

  padding: 10px;
  background: linear-gradient(135deg, rgba(20,30,55,.85), rgba(17,25,45,.85));
  backdrop-filter: blur(10px);
  border: 1px solid rgba(124,58,237,.28);
  border-radius: 14px;
  box-shadow: 0 12px 28px rgba(0,0,0,.35);
}

/* تأكد حقل البحث ياخذ العرض كامل في الوسط */
.board-search .input{ width:100%; height:34px; }





.board-head .chip input[type="checkbox"]{
  transform: translateY(1px);
}


 
 
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;
      background:#0b1327;color:#cbd5e1;font-size:12px
    }

    .masonry{
  display: grid;
  grid-template-columns: 1fr; /* كولمن واحد */
  gap: 12px;                  /* المسافة بين الكروت */
}


    .card{
      background:linear-gradient(180deg, #0f1a33, #0d172d);
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:10px;display:flex;flex-direction:column;gap:10px
    }
    .card-head{display:flex;align-items:center;justify-content:space-between}
    .cust{font-weight:900;display:flex;align-items:center;gap:8px;color:#e7eef9}
    .bill-badge{
      font-size:11px;padding:2px 8px;border-radius:999px;
      background:linear-gradient(180deg,#0f5132,#0b3d25);
      color:#b7f7d6;border:1px solid rgba(34,197,94,.35)
    }
    .tag{
      font-size:11px;border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;
      color:#c6d0e1;background:#0a1020
    }


    /* =================== Rows =================== */
    .items{display:flex;flex-direction:column;gap:6px}
    .item{
       display:grid;
  grid-template-columns: auto auto 1fr 1fr 1fr 1fr auto auto; 
     gap:8px;align-items:center;border:1px solid var(--stroke);
  border-radius:12px;padding:10px;background:#0c1529;transition:background .2s ease, opacity .2s ease
    }
    .btn-mini{
      width:28px;height:28px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0d172d,#0b1426);
      border-radius:8px;display:grid;place-items:center;cursor:pointer;color:#e5e7eb
    }
    .btn-mini:hover{border-color:rgba(18,209,180,.5)}
    .btn-return:hover{box-shadow:0 0 0 3px rgba(245,158,11,.18)}
    .btn-pay:hover{box-shadow:0 0 0 3px rgba(18,209,180,.18)}
    .btn-del:hover{box-shadow:0 0 0 3px rgba(239,68,68,.18)}

    .iname{font-weight:800;font-size:13px;color:#e8eef8}
    .icat{font-size:11px;color:#9aa4b2}
    .iqty{font-weight:800;color:#e8eef8}

    
    
    .ichip{
  font-size:12px;color:#c7d2e1;
  padding:4px 10px;border-radius:999px;background:#0a1122;border:1px solid var(--stroke);
  max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  text-align:center;
}
.inote{
  font-size:12px;color:#c7d2e1;
  padding:2px 8px;  /* تقلل العرض بصريًا */
  border-radius:999px;background:#0a1122;border:1px solid var(--stroke);
  max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.iqty {font-weight:800;color:#e8eef8;text-align:center}

    
    
    .itime{font-size:11px;color:#97a3b8}
    .badge{
      font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--stroke);
      background:#0a1020;color:#a5b0c2;margin-inline-start:6px
    }
    .item.returned .iname,.item.returned .icat{ text-decoration: line-through; color:#e3b860 }
    .item.paid .iname,.item.paid .icat{ text-decoration: line-through; color:#4ade80 }
    .item.returned{background:#261a06}
    .item.paid{background:#0b2617}

    /* =================== Foot actions =================== */
    .card-foot{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .foot-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .i-btn{
      height:32px;min-width:32px;padding:0 10px;border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0c1426,#0e1830);
      border-radius:10px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#e2e8f0
    }
    .i-btn .fa-solid,.i-btn .fa-regular{font-size:13px}
    .i-btn.primary{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;border-color:transparent;box-shadow:0 10px 28px rgba(124,58,237,.35)
    }
    .i-btn.ghost{background:#0b1327;border:1px solid var(--stroke);color:#cbd5e1}
    .i-btn:hover{transform:translateY(-1px);transition:.18s ease}

    /* =================== Insights =================== */
    .insights{
      background:linear-gradient(180deg,#0f1a33,#0d172d);
      border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow);padding:12px;
      position:sticky;top:calc(var(--hdr-h) + 8px);height:calc(100vh - var(--hdr-h) - 24px);
      display:flex;flex-direction:column;gap:10px
    }
    .stat{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--stroke);border-radius:12px;padding:8px;background:#0c1529;color:#e5e7eb
    }

    /* =================== Dock =================== */
    .dock{
  position:fixed;
  inset-inline:50%;
  transform:translateX(50%); /* خليه مثل ما هو حتى يبقى بمحاذاة RTL */
  bottom:var(--dock-gap);
    bottom: calc(var(--footer-h) + 5px); /* 10px فوق الفوتر */
  z-index:80;

  /* كبّر العرض */
  max-width: 1380px;            /* كان 1020px */
  width: calc(100vw - 96px);    /* كان calc(100vw - 260px) */
}
@media (max-width:980px){
  .dock{ width: calc(100vw - 24px); } /* كانت -36px */
}

.dock-inner{
  display:grid;
  /*       cust   type   cat    item         price  qty   note              */
  grid-template-columns: 160px 120px 150px 3.4fr   110px 80px minmax(260px, 1fr);
  gap:8px;
  background:linear-gradient(135deg, rgba(20,30,55,.85), rgba(17,25,45,.85));
  backdrop-filter:blur(12px);
  border:1px solid rgba(124,58,237,.35);
  border-radius:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
  padding:8px;
  z-index:0; 
  position:relative;
}


/* 3) (اختياري بس مفيد) امنع أي عنصر يدفش الشبكة خارج الحاوية */
.dock-inner > *{
  min-width: 0;
}



/* تغليف الملاحظات مع زر الإضافة داخلها */
/* 1) صغّر الملاحظات وكبّر زر الإضافة داخل .note-wrap */
.note-wrap{
  display: grid;
  grid-template-columns: minmax(120px, .7fr) 130px; /* كان 160px */
  gap: 8px;
  min-width: 0;
}


.note-field{
  height: 36px;        /* نفس الارتفاع */
  min-width: 0;        /* يمنع التمدد الزايد */
}

.note-add{
  height: 36px;
  padding: 0 10px;   /* كان 16px */
  font-weight: 800;
  justify-content: center;
  white-space: nowrap;
  gap: 6px;          /* يقلّل المسافة بين الأيقونة والنص */
}




    
    .dock-inner::before{
  content:"";
  position:absolute;

  /* يمين في RTL + يغطي ارتفاع الدوك */
  inset-inline-start: 8px;
  inset-block: 8px;            /* أعلى وأسفل */

  width:5px;
  border-radius:999px;
  background:linear-gradient(180deg,var(--brand),var(--brand-2));
  box-shadow:0 0 18px rgba(124,58,237,.45);

  z-index:3;                   /* أهم سطر: فوق عناصر الـgrid */
  pointer-events:none;         /* لا يعطّل النقر على الحقول */
}
    
    
    .field, .btn{ font-family:"Cairo",system-ui }

.field{
  height:36px;
  padding:8px 10px;
  border:1px solid var(--stroke);
  border-radius:10px;
  background:#0b1327;
  color:#e8eef8;
  outline:none;
  width:100%;              /* <-- جديد: يخلي كل input/select يملأ العمود */
}




    .field:focus{
      border-color:rgba(14,165,233,.6);
      box-shadow:0 0 0 3px rgba(14,165,233,.16);
    }
  
  
  .btn{height:36px;padding:0 12px;border:none;border-radius:10px;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:8px}

  
  
    .primary{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;box-shadow:0 12px 28px rgba(124,58,237,.35)
    }
    .primary:hover{transform:translateY(-1px)}
    .ghost{background:#0b1327;border:1px solid var(--stroke);color:#e2e8f0}

    /* =================== Footer =================== */
    .footer{
      position:fixed;bottom:0;inset-inline:0;height:var(--footer-h);z-index:75;
      background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(17,24,39,.55));
      border-top:1px solid rgba(124,58,237,.25);
      display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:16px;
      backdrop-filter:blur(8px);
    }

    /* =================== Modal =================== */
    .modal-backdrop{
      position:fixed;inset:0;z-index:1000;
      background:rgba(2,6,23,.6);
      display:none;
      backdrop-filter:blur(2px);
    }
    .modal-backdrop.active{ display:block }
    .modal{
      position:fixed;inset:0;z-index:1001;
      display:none;align-items:center;justify-content:center;
    }
    .modal.active{ display:flex }
    
    
    .modal-card{
  width:min(480px, calc(100vw - 48px));
  background:linear-gradient(180deg,#0f1a33,#0d172d);
  border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);
  padding:16px;display:flex;flex-direction:column;gap:12px;color:#e7eef9;
  align-items:center;   /* توسيط أفقي */
  text-align:center;    /* توسيط النص */
}
.modal-actions{
  display:flex;
  gap:8px;
  justify-content:center;  /* توسيط الأزرار */
  width:100%;
}

    
    
    
    .modal-head{font-weight:900;font-size:16px}
    .modal-body{color:#cbd5e1;font-size:14px}
   
  
   
   
    .modal-btn{
      height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--stroke);
      background:#0b1327;cursor:pointer;color:#e5e7eb
    }
    .modal-btn.danger{
      background:linear-gradient(135deg,#ef4444,#f97316);
      color:#fff;border-color:transparent;box-shadow:0 10px 26px rgba(249,115,22,.3)
    }
    .modal-btn.ghost{background:#0b1327}
    
    
    
    /* بادج نوع الفاتورة جنب اسم الزبون */
.badge-type{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:#0a1020;
  margin-inline-start:6px;
}
.badge-type.sell{
  color:#a7f3d0;                 /* أخضر فاتح */
  background:linear-gradient(180deg,#064e3b,#052e2a);
  border-color:rgba(16,185,129,.35);
}
.badge-type.return{
  color:#fecaca;                 /* أحمر فاتح */
  background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
  border-color:rgba(239,68,68,.35);
}

/* خلي المواد الراجعة أوضح بالأحمر */
.item.returned{
  background:#2a0c12;            /* خلفية أحمر داكن */
  border-color:#7f1d1d;
}
.item.returned .iname,
.item.returned .icat{
  color:#fca5a5;                  /* نص أحمر وردي */
  text-decoration:line-through;   /* تبقيها مشطوب */
}

    
 
 
 /* بادج "جديد" لاسم غير موجود بالمصفوفة */
.badge-new{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(127,29,29,.55);
  background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
  color:#fecaca; /* وردي فاتح للنص */
  margin-inline-start:8px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}

 
 
    
    
    
   /* نفس الإلغاء للسعر والعدد سوا */
#qty, #price{
  -moz-appearance: textfield;   /* Firefox */
}
#qty::-webkit-outer-spin-button,
#qty::-webkit-inner-spin-button,
#price::-webkit-outer-spin-button,
#price::-webkit-inner-spin-button{
  -webkit-appearance: none;     /* Chrome/Edge/Safari */
  margin: 0;
}




/* ===== Toasts (أعلى الصفحة + توسيط الرسالة) ===== */


.toasts{
  position:fixed;
  inset-inline:50%;
  transform:translateX(50%);
  top:18px;
  z-index:30000;                /* أعلى من الـ splash/الطبقات */
  display:flex;flex-direction:column;gap:12px;
  pointer-events:none;
}

/* خط فاصل أنيق بين كل توست والتالي */
.toasts .toast + .toast{
  position: relative;
}
.toasts .toast + .toast::before{
  content:"";
  position:absolute;
  inset-inline: 12px;
  top:-6px;
  height:1px;
  background: linear-gradient(90deg,
    rgba(255,255,255,.08),
    rgba(124,58,237,.35),
    rgba(255,255,255,.08)
  );
  pointer-events:none;
}



.toast{
  min-width:280px;max-width:520px;padding:10px 12px;border-radius:12px;
  border:1px solid var(--stroke);
  background:linear-gradient(135deg, rgba(20,30,55,.95), rgba(17,25,45,.95));
  box-shadow:0 10px 28px rgba(0,0,0,.45);color:#e7eef9;
  display:flex;align-items:center;gap:10px;pointer-events:auto;
  animation:toast-in-top .25s ease-out both;

  /* المفتاح: خلّي توزيع العناصر يسمح بتوسيط النص */
  justify-content:space-between;
}
.toast__icon{
  width:28px;height:28px;border-radius:8px;
  display:grid;place-items:center;background:#0b1327;border:1px solid var(--stroke);
  flex:0 0 auto;                  /* حجم ثابت */
}

.toast__msg{
  font-size:14px;
  font-weight:800;
  letter-spacing:.2px;
  flex:1 1 auto;
  text-align:center;
  white-space: nowrap;          /* سطر واحد */
  overflow: hidden;             /* قصّ الزائد */
  text-overflow: ellipsis;      /* … */
}



.toast__close{
  margin-inline-start:8px;cursor:pointer;opacity:.9;
  display:grid;place-items:center;width:28px;height:28px;border-radius:8px;
  border:1px solid var(--stroke);background:#0b1327;
  flex:0 0 auto;                  /* حجم ثابت */
}

.toast.success .toast__icon{background:linear-gradient(180deg,#064e3b,#052e2a);border-color:rgba(16,185,129,.35)}
.toast.warn    .toast__icon{background:linear-gradient(180deg,#5b3b06,#3a2704);border-color:rgba(245,158,11,.4)}
.toast.error   .toast__icon{background:linear-gradient(180deg,#7f1d1d,#4c0b0b);border-color:rgba(239,68,68,.45)}
.toast.info    .toast__icon{background:linear-gradient(180deg,#0b3b5b,#07293f);border-color:rgba(14,165,233,.45)}

@keyframes toast-in-top{from{transform:translateX(50%) translateY(-10px);opacity:0}to{transform:translateX(50%) translateY(0);opacity:1}}
@keyframes toast-out-top{from{transform:translateX(50%) translateY(0);opacity:1}to{transform:translateX(50%) translateY(-8px);opacity:0}}

/* أخفِ زر الإغلاق نهائياً */
.toast__close{ display:none !important; }


/* ===== تعديلات أسطر البطاقة (داخل الكارت) =====
   [راجع] [تسديد] | اسم المادة | الصنف | العدد | الملاحظات | الوقت | حذف
   ملاحظة: استعملنا !important حتى نضمن التطبيق فوق القواعد القديمة
*/
.card .item{
  /* [راجع] [تسديد] | الاسم | الصنف | السعر | العدد | الملاحظات | الوقت | حذف */
  grid-template-columns: auto auto .9fr 2.2fr .8fr .6fr 1fr auto auto !important;
  column-gap: 6px !important;
}

/* مظهر أنيق للسعر */
.iprice{
  font-weight:900;
  text-align:center;
  padding:2px 8px;
  border-radius:999px;
  background:#0a1020;
  border:1px solid var(--stroke);
  font-size:12px;
  color:#c7d2e1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


/* وسّط ووسّع اسم المادة */
.card .item .iname{
  text-align: center !important;
  min-width: 0 !important;     /* يمنع التمدد */
}

/* صغّر الصنف والملاحظات بصرياً وامنعها تقصّر الصف */
.card .item .ichip,
.card .item .inote{
  padding-inline: 8px !important;
  min-width: 0 !important;
  max-width: 100% !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* العدد بمساحة أضيق ومحاذاة وسط */
.card .item .iqty{
  text-align: center !important;
}

/* (اختياري) صغّر خط الوقت شوي */
.card .item .itime{
  font-size: 10.5px !important;
}



/* لمعة مؤقتة للبطاقة الجديدة */
/* لمعة مؤقتة للبطاقة الجديدة */
.flash-card{
  outline: 2px solid rgba(124,58,237,.55);
  box-shadow: 0 0 0 3px rgba(124,58,237,.22), var(--shadow);
  transition: outline .2s ease, box-shadow .2s ease;
}

/* خلّي المتصفّح يحسب مسافة فوق الكارت مساوية لارتفاع الهيدر */
.card{
  scroll-margin-top: calc(var(--hdr-h) + 10px);
  
}



/* ===== Zebra قوية وواضحة بين البطاقات ===== */

/* ضمّن إن البطاقة نسبية للزخرفة */
.masonry > .card{ position:relative; }

/* الزوجية: أفتح شوي */
.masonry > .card:nth-child(even){
  background: linear-gradient(180deg, #122243, #0e1b36) !important;
  border-color: #2c3f66 !important;
}

/* الفردية: أغمق شوي */
.masonry > .card:nth-child(odd){
  background: linear-gradient(180deg, #0b162e, #091126) !important;
  border-color: #223556 !important;
}


.masonry > .card:nth-child(even)::before{
  background: linear-gradient(180deg, var(--brand-3), var(--brand-2));
  opacity:.85;
}

/* لمسة ظل مختلفة خفيفة */
.masonry > .card:nth-child(even){
  box-shadow: 0 16px 36px rgba(0,0,0,.42);
}
.masonry > .card:nth-child(odd){
  box-shadow: 0 14px 32px rgba(0,0,0,.38);
}



/* ========= إبراز اسم الزبون داخل البطاقة ========= */

/* أيقونة صغيرة قبل الاسم (من Font Awesome) */
.card .card-head .cust{
  position: relative;
  gap: 10px;
}
.card .card-head .cust::before{
  content: "\f007"; /* user icon */
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  display: grid; place-items: center;
  width: 26px; height: 26px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: #fff;
  box-shadow: 0 6px 16px rgba(124,58,237,.28);
  margin-inline-start: 0;
  margin-inline-end: 6px;
}

/* اسم الزبون نفسه (أول span داخل .cust) بتدرّج أنيق */
.card .card-head .cust > span:first-child{
  position: relative;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: .2px;
  line-height: 1.1;
  background: linear-gradient(90deg, #eef2ff, #cbd5ff);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;               /* يُظهر التدرّج كنص */
  text-shadow: 0 1px 0 rgba(255,255,255,.04);
}



/* مسافات أنظف بين الاسم والبادجات اللاحقة */
.card .card-head .cust .badge-type,
.card .card-head .cust .bill-badge{
  margin-inline-start: 8px;
}

/* تباين بسيط لبادج النوع قرب الاسم */
.card .card-head .cust .badge-type{
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}




/* خلي حاوية البحث صف واحد */
.board-search{
  display:flex;
  align-items:center;
  gap:8px;
}

/* الحقل يتمدّد، بدون ما يطيح للتالي */
.board-search .input{
  flex:1 1 auto;
  min-width:160px;
  height:34px;
}

/* (اختياري) استجابة للشاشات الصغيرة: خليه يلفّ بنعومة */
@media (max-width:700px){
  .board-search{
    flex-wrap:wrap;
  }
  .board-search .input{
    flex:1 1 100%;
  }
}




/* === توحيد المسافات داخل رأس البطاقة (الاسم + البادجات) === */
:root{ --cust-inline-gap: 6px; }  /* غيّرها لـ 4px أو 8px إذا تريد تضبط أكثر */

.card .card-head .cust{
  gap: var(--cust-inline-gap) !important;               /* مسافة موحّدة بين العناصر */
}

/* شيل أي هوامش إضافية قديمة حتى ما تتضاعف المسافات */
.card .card-head .cust .badge-new,
.card .card-head .cust .badge-type,
.card .card-head .cust .bill-badge{
  margin-inline-start: 0 !important;
}

/* خلي أيقونة المستخدم بنفس المسافة */
.card .card-head .cust::before{
  margin-inline-end: var(--cust-inline-gap) !important;
}


/* ====== قائمة الأصناف المخصّصة ====== */
.cat-list{ list-style:none; margin:0; padding:0; }
.cat-item{
  height:36px; display:flex; align-items:center; gap:10px;
  padding:0 12px; cursor:pointer; color:#e7eef9;
  border-bottom:1px dashed rgba(255,255,255,.06);
}
.cat-item i{ width:18px; text-align:center; opacity:.95; }
.cat-item:hover, .cat-item.active{ background:#0e1b36; }






/* ===== Page breaks (html2pdf) ===== */
@media print{
  .card{ break-inside: avoid; page-break-inside: avoid; }
}
.html2pdf__page-break{ height: 0; break-after: page; page-break-after: always; }

/* ===== Loading Overlay (للـ reloader فقط) ===== */
.loading{
  position: fixed;
  inset: 0;
  z-index: 20000;
  background: rgba(2,6,23,.72);
  backdrop-filter: blur(2px);
  display: none;
  align-items: center;
  justify-content: center;
}
.loading.active{ display:flex; }

.loading-box{
  min-width: 220px;
  padding: 16px 18px;
  border-radius: 14px;
  border: 1px solid var(--stroke);
  background: linear-gradient(135deg, rgba(20,30,55,.95), rgba(17,25,45,.95));
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
  color: #e7eef9;
  display:flex; align-items:center; gap:10px;
  font-weight: 800;
}


.pct{
  margin-inline-start:8px;
  padding:2px 8px;
  border:1px solid var(--stroke);
  border-radius:999px;
  background:#0b1327;
  font-size:12px;
  font-weight:900;
  letter-spacing:.2px;
  min-width:48px;
  text-align:center;
}




.spinner{
  width: 22px; height: 22px; border-radius: 50%;
  border: 3px solid rgba(255,255,255,.18);
  border-top-color: #7c3aed;
  animation: spin 0.8s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }


/* سهم منسدل لحقل الأصناف */
.cat-wrap{
  position:relative;
}
.cat-wrap::after{
  content:"";
  position:absolute;
  inset-inline-end: 12px;
  top:50%;
  width: 8px; height: 8px;
  border-inline-start: 2px solid #9aa4b2;
  border-bottom:       2px solid #9aa4b2;
  transform: translateY(-50%) rotate(-45deg);
  pointer-events:none;
  opacity:.9;
  transition: transform .18s ease, opacity .18s ease;
}
/* لما القائمة تنفتح يدور السهم */
.cat-wrap.open::after{
  transform: translateY(-50%) rotate(135deg);
  opacity:1;
}


/* حاويات نطبّق عليها سكرول أنيق */
.nice-scroll{
  scrollbar-gutter: stable;
  overscroll-behavior: contain;
}

/* افتراضي: إخفاء في فايرفوكس */
.nice-scroll{
  scrollbar-width: none;          /* Firefox */
}
.nice-scroll:hover{
  scrollbar-width: thin;          /* يظهر عند التحويم */
}

/* WebKit (كروم/إيدج/سفاري) */
.nice-scroll::-webkit-scrollbar{
  width: 0; height: 0;            /* مخفي */
}
.nice-scroll:hover::-webkit-scrollbar{
  width: 10px; height:10px;       /* يظهر عند التحويم */
}
.nice-scroll::-webkit-scrollbar-track{
  background: linear-gradient(180deg, #0a1020, #0b1327);
  border-radius: 999px;
  border: 1px solid var(--stroke);
}
.nice-scroll::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, var(--brand-3), var(--brand-2));
  border-radius: 999px;
  border: 2px solid transparent;
  background-clip: padding-box;
}
.nice-scroll::-webkit-scrollbar-thumb:hover{
  filter: brightness(1.1);
}

/* توسيط اسم المادة والملاحظات داخل الكارد */
.card .item .iname{ text-align:center !important; }
.card .item .inote{ text-align:center !important; }



/* ===== لوحة الملاحظات (بدون سكرول أفقي + أناقة أعلى) ===== */
.notes-compact{
  position: relative;
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0b1327;
  padding:10px 10px 8px;
  margin-top:8px;
  overflow: hidden; /* يضمن ما يطلع شي برّه */
  display: grid;
  /* نستخدم صف واحد قابل للطي/الفتح (يفيدنا بالتوسيع لاحقًا) */
  grid-template-rows: 1fr auto;           /* القائمة ثم شريط الإدخال */
  align-content: center;                   /* يوسّط المحتوى عموديًا داخل الحاوية */
  padding-block: 12px 10px;   
}




/* خط زينة رأسي خفيف (Timeline) داخل الصندوق */
.notes-compact::before{
  content:"";
  position:absolute;
  inset-inline-start: 6px;    /* RTL */
  top:8px; bottom:8px;
  width:3px;
  border-radius:999px;
  background:linear-gradient(180deg,var(--brand-3),var(--brand-2));
  opacity:.65;
  pointer-events:none;
}

/* إلغاء الرأس/العدّاد */
.notes-compact__head,
.notes-compact__title,
.notes-compact__count{ display:none !important; }

/* قائمة الملاحظات — عمودي فقط، لا أفقي */
.notes-compact__list{
  display:flex; flex-direction:column; gap:8px;
  max-height:168px;
  overflow-y:auto;        /* عمودي فقط */
  overflow-x:hidden;      /* لا أفقي نهائيًا */
  padding-inline-start: 8px; /* يبتعد عن خط الزينة */
  padding-inline-end: 2px;   /* حتى ما يغطي سكرول عمودي على المحتوى*/
  
}
.notes-compact__empty{ display:none !important; }

/* صف الملاحظة: يضمن ما يصير تمدد بعرض زايد */
.note-row{
  position:relative;
  padding-inline-end: 38px;     /* مساحة لزر الحذف الخارجي */
  min-width: 0;                 /* مهم لمنع تمدد grid */
}

/* شكل الحبة — أنعم */
.note-pill{
  display:grid;
  grid-template-columns: auto 1fr auto; /* # | النص | الوقت */
  align-items:center;
  height:34px;
  padding:0 12px;
  background:linear-gradient(180deg,#0a1327,#0b1327);
  border:1px solid var(--stroke);
  border-radius:10px;
  gap:10px;
  min-width:0;                  /* يمنع الهروب عرضيًا */
  box-shadow: 0 6px 14px rgba(0,0,0,.18);
}
.note-pill:hover{
  border-color: rgba(124,58,237,.45);
  box-shadow: 0 8px 18px rgba(124,58,237,.18);
  transform: translateY(-1px);
  transition: .18s ease;
}

/* زيبرا خفيفة */
.notes-compact__list .note-row:nth-child(odd) .note-pill{
  background:linear-gradient(180deg,#0b1428,#0a1326);
  border-color:#223556;
}

/* رقم التسلسل — تدرّج ناعم */
.note-pill__idx{
  font-weight:900; font-size:12px; letter-spacing:.2px;
  color:#eef2ff;
  min-width:34px; height:22px;
  display:grid; place-items:center;
  border-radius:999px;
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  box-shadow:0 4px 12px rgba(124,58,237,.25);
}

/* نص الملاحظة — سطر واحد بدون أي سكرول أفقي */
.note-pill__text{
  font-size:13px; color:#e7eef9; min-width:0;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* الوقت + أيقونة صغيرة */
.note-pill__time{
  display:inline-flex; align-items:center; gap:6px;
  font-size:11px; color:#9aa4b2;
  padding:2px 8px; border-radius:999px;
  background:#0b1327; border:1px solid var(--stroke);
}
.note-pill__time i{ font-size:10px; opacity:.95; }

/* زر حذف خارج الحبة على الحافة */
.note-del-out{
  position:absolute;
  inset-inline-end: -2px; top:50%;
  transform: translateY(-50%);
  width:28px; height:28px;
  border-radius:8px;
  border:1px solid rgba(239,68,68,.45);
  background:linear-gradient(135deg,#7f1d1d,#4c0b0b);
  color:#fecaca; display:grid; place-items:center; cursor:pointer;
}
.note-del-out:hover{ filter:brightness(1.06); transform: translateY(-50%) scale(1.04); }

/* شريط الإدخال */
.notes-compact__bar{
  display:grid; grid-template-columns: 1fr auto; gap:6px; margin-top:8px;
}
.note-input-sm{
  height:34px; padding:6px 10px; font-size:13px;
  background:#0a1327; border:1px solid var(--stroke); border-radius:10px; color:#e7eef9;
}
.note-add-mini{
  height:34px; min-width:40px; padding:0 12px; font-weight:900;
  border-radius:10px; border:1px solid transparent;
  background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff;
  display:inline-flex; align-items:center; gap:6px;
}
.note-add-mini i{ font-size:12px; }



/* ===== Notes block (للطباعة) ===== */
.notes{ margin-top:8px; border:1px solid var(--stroke); border-radius:10px; }
.notes__head{
  display:flex; align-items:center; justify-content:space-between;
  background:#f5f5f5; padding:6px 10px; border-bottom:1px solid var(--stroke);
  font-weight:900;
}
.notes__list{ padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
.note{
  display:flex; align-items:center; gap:8px;
  border:1px solid var(--stroke); border-radius:10px; padding:6px 10px;
}
.note__idx{
  font-weight:900; font-size:12px; min-width:28px; text-align:center;
  border:1px solid var(--stroke); border-radius:999px; padding:2px 6px; background:#fff;
}
.note__text{ flex:1; }
.note__time{ font-size:11px; color:#6b7280; white-space:nowrap; }



/* قائمة اقتراحات الزبائن */
#custSuggestions{ padding:6px 0; }

/* العنصر */
#custSuggestions .sugg-item{
  position: relative;
  padding: 12px 12px;          /* مساحة علوية تكفي فوق الخط */
  line-height: 1.5;            /* ارتفاع سطر مريح */
  white-space: normal;          /* يسمح باللف */
  word-break: break-word;       /* يكسر الكلمات الطويلة */
  display: block;               /* يضمن امتداد العرض بالكامل */
  cursor: pointer;
}

/* الفاصل بين العناصر — صار pseudo-element حتى ما يلمس النص */
#custSuggestions .sugg-item + .sugg-item::before{
  content: "";
  position: absolute;
  inset-inline: 12px;           /* يبعد عن الحواف */
  top: 0;                       /* أعلى العنصر */
  height: 1px;
  background: linear-gradient(90deg,
    rgba(255,255,255,.06),
    rgba(255,255,255,.12),
    rgba(255,255,255,.06)
  );
  pointer-events: none;
}

/* لون التحويم */
#custSuggestions .sugg-item:hover{
  background:#0e1b36;
}



/* ===== توسيع لوحة الكروت بتصغير الأعمدة الجانبية (العرضين متطابقين – أَعْرَض) ===== */
.layout{
  /* كان: 280px 1fr 320px */
  grid-template-columns: 260px 1fr 260px !important; /* يسار = يمين (أعرض) */
}

/* على الشاشات المتوسطة */
@media (max-width:1280px){
  .layout{
    /* كان: 240px 1fr 280px */
    grid-template-columns: 240px 1fr 240px !important; /* يسار = يمين (أعرض) */
  }
}

/* توازن الحشوات */
.rail, .insights{
  padding: 12px !important;
}
.rail .search{ margin: 6px 0 !important; }
.stat{ padding: 8px !important; }

/* عناصر الأيام – رجّعناها شوي أوسع */
.day{ padding: 8px 12px !important; }
.day .title{ font-size: 13px !important; }
.day .meta{ font-size: 11.5px !important; }

/* الدوك: بقاء مع توسيع بسيط إذا تحتاج عرض إضافي */
.dock{
  max-width: 1480px !important;
  width: calc(100vw - 80px) !important;
}

.loading-box{
  min-width: 220px;
  padding: 16px 18px;
  border-radius: 14px;
  border: 1px solid var(--stroke);
  background: linear-gradient(135deg, rgba(20,30,55,.95), rgba(17,25,45,.95));
  box-shadow: 0 18px 40px rgba(0,0,0,.45);
  color: #e7eef9;
  display:flex; align-items:center; gap:10px;
  font-weight: 800;
}



/* ===== Login Gate (animated) ===== */
.gate{
  position:fixed; inset:0; z-index:99999; display:grid; place-items:center;
  background:
    radial-gradient(1000px 600px at 80% -10%, rgba(124,58,237,.16), transparent 60%),
    radial-gradient(900px 500px at -10% 10%, rgba(18,209,180,.12), transparent 60%),
    linear-gradient(180deg, #0b1220, #0f172a);
  animation: gate-bg 12s ease-in-out infinite alternate;
}
@keyframes gate-bg{
  0%{ background-position: 0 0, 0 0, 0 0; }
  100%{ background-position: -40px -20px, 30px 10px, 0 0; }
}

.gate-card{
  width:min(420px, 92vw);
  border:1px solid var(--stroke);
  border-radius:16px;
  background:linear-gradient(180deg,#0f1a33,#0d172d);
  box-shadow:0 22px 56px rgba(0,0,0,.45);
  padding:16px;
  display:flex; flex-direction:column; gap:14px;
  transform: translateY(6px);
  animation: gate-float 3s ease-in-out infinite;
}
@keyframes gate-float{
  0%,100%{ transform: translateY(6px); }
  50%    { transform: translateY(0); }
}

.gate-head{ display:flex; flex-direction:column; gap:6px; text-align:center; }
.gate-logo{ display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900; }
.g-dot{
  width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
  background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff;
  box-shadow:0 8px 24px rgba(124,58,237,.35); font-size:13px;
}
.g-name{ color:#fff; letter-spacing:.2px }
.g-sub{ color:#9aa4b2; font-size:12.5px }

.gate-body{ display:flex; flex-direction:column; gap:10px }
.gate-input{
  height:40px;
  background:#0b1327;
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#e7eef9;
  outline:none;
  transition:border-color .18s ease, box-shadow .18s ease, transform .12s ease;
}
.gate-input:focus{
  border-color:rgba(124,58,237,.55);
  box-shadow:0 0 0 4px rgba(124,58,237,.16);
  transform: translateY(-1px);
}

.gate-btn{
  height:40px;
  font-weight:900;
  position:relative;
  overflow:hidden;
}
.gate-btn .btn-spin{
  width:18px; height:18px; border-radius:50%;
  border:3px solid rgba(255,255,255,.25);
  border-top-color:#fff; display:none; margin-inline-start:8px;
  animation: spin 0.85s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.gate-btn.loading .btn-txt{ opacity:.0 }
.gate-btn.loading .btn-spin{ display:inline-block }

.gate-msg{
  min-height:18px;
  color:#fca5a5;
  font-size:12px;
  text-align:center;
}

/* دخول/خروج أنيميشين */
.gate.fade-in{ animation: gate-in .25s ease-out both; }
.gate.fade-out{ animation: gate-out .22s ease-in both; }
@keyframes gate-in{ from{ opacity:0 } to{ opacity:1 } }
@keyframes gate-out{ from{ opacity:1 } to{ opacity:0 } }




/* توسيع حاوية التوست حتى لا يختفي النص الطويل */
.toasts .toast{
  max-width: 840px !important;   /* كان 520px */
  min-width: 320px;              /* كان 280px */
}

/* لو احتجنا أعرض لرسائل معيّنة */
.toasts .toast.wide{
  max-width: 1080px !important;  /* توست عريض جدًا */
}

/* على الشاشات الصغيرة خلّيه ياخذ تقريبًا كل العرض */
@media (max-width: 980px){
  .toasts .toast{
    max-width: calc(100vw - 32px) !important;
  }
}


/* ابعاد زر الدخول قليلاً عن حقل كلمة السر */
#lgBtn{
  margin-top: 6px !important;   /* جرّب 6–10px حسب ذوقك */
}

/* على الشاشات الصغيرة نزّل الزر أكثر شوية */
@media (max-width: 480px){
  #lgBtn{
    margin-top: 10px !important;
  }
}




/* ===== Reload Overlay (Pro) ===== */
.reloader{
  position:fixed; inset:0; z-index:40000;
  display:none; place-items:center;
  background: radial-gradient(1200px 700px at 100% -10%, rgba(124,58,237,.16), transparent 55%),
              radial-gradient(1000px 600px at -10% 10%, rgba(18,209,180,.12), transparent 55%),
              rgba(2,6,23,.68);
  backdrop-filter: blur(6px);
}
.reloader.active{ display:grid; animation:reloader-in .22s ease-out both; }
@keyframes reloader-in{ from{ opacity:0; transform:scale(.98) } to{ opacity:1; transform:scale(1) } }

/* زخارف خفيفة */
.reloader-bg{ position:absolute; inset:0; overflow:hidden; pointer-events:none; }
.orb{
  position:absolute; filter: blur(24px); opacity:.22; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, var(--brand, #12d1b4), transparent 60%);
  width:280px; height:280px; animation: orb-float 9s ease-in-out infinite;
}
.orb-a{ top:8%;  right:8%;  background: radial-gradient(circle, #7c3aed, transparent 60%); }
.orb-b{ bottom:10%; left:6%; background: radial-gradient(circle, #0ea5e9, transparent 60%); animation-delay: -2s;}
.orb-c{ top:40%; left:50%; transform:translateX(-50%); width:220px; height:220px; animation-delay:-4s;}
@keyframes orb-float{ 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(-14px)} }

/* بطاقة */
.reload-card{
  position:relative;
  width:min(520px, 92vw);
  padding:18px 18px 16px;
  border:1px solid rgba(124,58,237,.35);
  border-radius:16px;
  background:linear-gradient(135deg, rgba(20,30,55,.92), rgba(17,25,45,.92));
  box-shadow:0 24px 70px rgba(0,0,0,.55);
  display:flex; flex-direction:column; gap:14px; color:#e7eef9;
}

/* رأس */
.reload-head{ display:flex; align-items:center; gap:10px; }
.brand-dot{
  flex: 0 0 auto;
  width:30px; height:30px; border-radius:9px; display:grid; place-items:center;
  background:linear-gradient(135deg, var(--brand,#12d1b4), var(--brand-2,#7c3aed));
  color:#fff; font-weight:900; box-shadow:0 10px 26px rgba(124,58,237,.35);
}
.reload-title{ font-weight:900; font-size:16px; letter-spacing:.2px; }
.reload-sub{ color:#bfc7d6; font-size:12.5px; margin-inline-start:auto; }

/* حلقة */
.ring-wrap{
  position:relative; height:92px;
  display:grid; place-items:center; margin-top:4px;
}
.ring{
  position:absolute; width:88px; height:88px; border-radius:50%;
  border:3px solid rgba(255,255,255,.10);
  border-top-color:#7c3aed;
  animation: spin 1s linear infinite;
}
.ring-2{
  width:72px; height:72px; border-color:rgba(255,255,255,.08);
  border-top-color:#12d1b4; animation-duration: 1.4s; animation-direction: reverse;
}
.ring-pct{ position:relative; font-weight:900; letter-spacing:.3px; }

/* شريط التقدّم */
.progress{
  height:10px; border-radius:999px; overflow:hidden;
  background: linear-gradient(180deg,#0b1327,#0e1830);
  border:1px solid rgba(255,255,255,.08);
}
.progress .bar{
  height:100%; width:0%;
  background:linear-gradient(90deg, #12d1b4, #7c3aed, #0ea5e9);
  background-size:200% 100%;
  animation: slide 2.4s linear infinite;
  border-right:1px solid rgba(255,255,255,.25);
}
@keyframes slide{ 0%{background-position:0 0} 100%{background-position:200% 0} }
@keyframes spin{ to{ transform: rotate(360deg); } }

/* أسفل */
.reload-foot{ display:flex; gap:6px; justify-content:flex-end; }
.reload-foot .chip{
  font-size:11px; padding:2px 8px; border-radius:999px;
  border:1px solid rgba(255,255,255,.08);
  background:#0b1327; color:#cbd5e1;
}

/* تباين نص النسبة داخل الحلقة */
.ring-pct{ font-size:14px; text-shadow:0 1px 0 rgba(0,0,0,.35) }




/* ===== Auth Splash (Highly Polished) ===== */
.auth-splash{
  position: fixed; inset: 0; z-index: 30000;
  display: none; place-items: center;
  backdrop-filter: blur(6px);
  background:
    radial-gradient(1000px 600px at 80% -10%, rgba(124,58,237,.12), transparent 60%),
    radial-gradient(900px 500px at -10% 10%, rgba(18,209,180,.10), transparent 60%),
    linear-gradient(180deg, rgba(11,18,32,.92), rgba(15,23,42,.92));
}

.auth-shell{
  width: min(520px, 92vw);
  border-radius: 16px;
  padding: 18px 18px 16px;
  border: 1px solid rgba(124,58,237,.25);
  background:
    linear-gradient(180deg, rgba(17,24,39,.75), rgba(15,23,42,.85));
  box-shadow: 0 24px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.03);
  display:flex; flex-direction:column; gap:14px;
  animation: auth-pop .22s ease-out both;
}

@keyframes auth-pop{ from{ transform: translateY(8px); opacity:0 } to{ transform: translateY(0); opacity:1 } }

.auth-brand{ display:flex; align-items:center; gap:12px }
.auth-mark{
  width:36px; height:36px; border-radius:10px;
  display:grid; place-items:center; font-weight:900;
  color:#fff;
  background:linear-gradient(135deg,var(--brand,#12d1b4),var(--brand-2,#7c3aed));
  box-shadow:0 10px 26px rgba(124,58,237,.35);
}
.auth-texts .auth-title{
  font-weight:900; letter-spacing:.5px; color:#fff; line-height:1;
}
.auth-texts .auth-sub{
  font-size:12px; color:#cbd5e1; opacity:.9; margin-top:2px;
}

.auth-status{ display:flex; flex-direction:column; gap:10px }
.auth-tip{
  font-weight:800; letter-spacing:.2px; color:#e7eef9;
  text-align:center;
}
.auth-progress{
  height:12px; border-radius:999px; overflow:hidden;
  border:1px solid var(--stroke,#1f2a44);
  background:linear-gradient(180deg,#0b1327,#0d172d);
  position:relative;
}
.auth-bar{
  height:100%; width:0%;
  background:linear-gradient(90deg, var(--brand-3,#0ea5e9), var(--brand-2,#7c3aed));
  border-right:1px solid rgba(255,255,255,.28);
  box-shadow: inset 0 0 10px rgba(255,255,255,.14);
  position:relative;
}
.auth-bar::after{
  content:"";
  position:absolute; inset:0;
  background-size: 32px 12px;
  background-image: linear-gradient( -45deg, rgba(255,255,255,.14) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.14) 50%, rgba(255,255,255,.14) 75%, transparent 75%, transparent);
  animation: auth-stripes 1s linear infinite;
  mix-blend-mode: screen;
  opacity:.55;
}
@keyframes auth-stripes{ to{ background-position: 32px 0 } }

.auth-meta{
  display:flex; align-items:center; justify-content:center; gap:8px;
  font-size:12.5px; color:#9aa4b2;
}
.auth-pct{ font-weight:900; color:#e7eef9 }
.auth-sep{ opacity:.6 }
.auth-subtle{ color:#b5bfd0 }

.auth-bg{
  position:absolute; filter: blur(24px); opacity:.22; pointer-events:none;
  border-radius: 50%;
}
.auth-bg--1{ width:340px; height:340px; right:8%; top:8%; background: radial-gradient(circle at 30% 30%, #7c3aed, transparent 70%); }
.auth-bg--2{ width:420px; height:420px; left:6%; bottom:6%; background: radial-gradient(circle at 70% 70%, #0ea5e9, transparent 70%); }
.auth-bg--3{ width:260px; height:260px; left:40%; top:12%; background: radial-gradient(circle at 50% 50%, #12d1b4, transparent 70%); }

@media (prefers-reduced-motion: reduce){
  .auth-shell{ animation:none }
  .auth-bar::after{ animation: none }
}



/* صندوق المال المضغوط */
.money--compact{
  border:1px solid var(--stroke);
  border-radius:12px;
  background:#0c1529;
  padding:8px;                 /* صغير */
  display:flex;
  flex-direction:column;
  gap:6px;                     /* مسافة صغيرة بين السطور */
}

/* كل سطر عبارة عن شريحتين يمين/يسار */
.money--compact .mrow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:6px 8px;             /* خفيف */
  border:1px solid var(--stroke);
  border-radius:10px;
  background:#0b1327;
}

.money--compact .mlabel{
  font-size:12.5px;
  color:#cbd5e1;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.money--compact .mlabel i{ font-size:12px; opacity:.95; }

.money--compact .mval{
  font-weight:900;
  font-size:13px;
  letter-spacing:.2px;
  color:#e7eef9;
}

/* دلالات ألوان خفيفة ومقروءة */
.money--compact .mval--paid   { color:#86efac; }   /* أخضر فاتح */
.money--compact .mval--unpaid { color:#fbbf24; }   /* أصفر */
.money--compact .mval--ret    { color:#fca5a5; }   /* أحمر وردي */


/* مسافة أنيقة بين صندوقي الإحصائيات داخل العمود الأيمن (.insights) */
#insightsBody{
  display: flex;
  flex-direction: column;
  gap: 8px;        /* غيّرها 8–16px حسب ذوقك */
}

/* (اختياري) شدّ حواف الصناديق شوي حتى يبين الفراغ أحلى */
#quickStats, #moneyStats{
  border-radius: 12px;
}


/* باجات sums داخل ذيل البطاقة — أنيق ومو بارز */
.card-foot .sum-badge{
  font-size: 12.5px;
  padding: 4px 10px;
  border-radius: 10px;
  background: #0b1327;
  border: 1px solid var(--stroke);
  color: #dbe2ea;
  letter-spacing: .1px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
}

/* لمسات ألوان خفيفة لكل نوع */
.card-foot .sum--items{
  border-color: rgba(14,165,233,.28);
  background: linear-gradient(180deg,#0b1426,#0b1327);
}
.card-foot .sum--total{
  border-color: rgba(148,163,184,.22);
  background: linear-gradient(180deg,#0b1424,#0b1327);
}
.card-foot .sum--unpaid{
  border-color: rgba(245,158,11,.28);
  background: linear-gradient(180deg,#0b151f,#0b1327);
}

/* اخفاء كل شي يخص الملاحظات داخل البطاقة فقط */
.card .notes-compact,
.card .notes-compact__list,
.card .notes-compact__bar,
.card .note-add-mini {
  display: none !important;
}

/* ضمان المودال يبقى ظاهر (لا يتأثر) */
#notesModal .notes-compact__list { display: block !important; }
#notesModal .notes-compact__bar { display: grid !important; } /* إذا تستخدم Grid بالمودال */



/* إلغاء أي تأثير hover على كبسولة الملاحظة */
.note-pill{
  transition: none !important;
}
.note-pill:hover{
  border-color: var(--stroke) !important;
  box-shadow: 0 6px 14px rgba(0,0,0,.18) !important; /* نفس الأساس */
  transform: none !important;
}


/* عند فتح أي مودال نمنع تمرير الصفحة */
body.modal-open{
  overflow: hidden !important;
  overscroll-behavior: none !important;
  touch-action: none !important; /* مفيد للموبايل */
}


/* ===== أزرار أسفل بطاقة الزبون (PDF / تسديد / ملاحظات / حذف) — ألوان مطفّية أنيقة ===== */
.card-foot .foot-actions .i-btn{
  border: 1px solid var(--stroke);
  transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
  border-radius: 12px;
  box-shadow: 0 6px 14px rgba(0,0,0,.08);
}

/* (1) PDF — تِيل مطفّي */
.card-foot .foot-actions .i-btn:nth-child(1){
  background: linear-gradient(135deg, #3a8d8e, #2e6e6f);
  color: #f3fbfb;
  border-color: rgba(58,141,142,.45);
}
.card-foot .foot-actions .i-btn:nth-child(1):hover{
  transform: translateY(-1px);
  filter: brightness(1.04);
}

/* (2) تسديد الكل — بدون تغيير */

/* (3) الملاحظات — بنفسجي مُعتّق (mauve) */
.card-foot .foot-actions .i-btn:nth-child(3){
  background: linear-gradient(135deg, #7a6aa6, #66558c);
  color: #f7f5ff;
  border-color: rgba(122,106,166,.45);
}
.card-foot .foot-actions .i-btn:nth-child(3):hover{
  transform: translateY(-1px);
  filter: brightness(1.04);
}

/* (4) حذف البطاقة — طوبي/آجري مطفّي */
.card-foot .foot-actions .i-btn:nth-child(4){
  background: linear-gradient(135deg, #b64a3b, #8c372d);
  color: #fff4f3;
  border-color: rgba(182,74,59,.50);
}
.card-foot .foot-actions .i-btn:nth-child(4):hover{
  transform: translateY(-1px);
  filter: brightness(1.05);
}

/* فوكس هادئ موحّد */
.card-foot .foot-actions .i-btn:focus-visible{
  outline: 0;
  box-shadow:
    0 0 0 3px rgba(255,255,255,.08),
    0 0 0 6px rgba(99,102,241,.22);
}

/* أيقونات */
.card-foot .foot-actions .i-btn i{
  opacity:.95; margin-inline-end:.35rem;
}



/* ===== تثبيت الهيدر بدون لمس بقية التنسيقات ===== */
:root{ --hdr-h: 54px; } /* نفس اللي عندك، نثبّته للاحتياط */

.ribbon{
  position: fixed;     /* كان sticky */
  top: 0;
  inset-inline: 0;     /* يمين/يسار = 0 (يدعم RTL) */
  z-index: 1000;       /* فوق كلشي */
}

/* فراغ بسيط تحت الهيدر حتى ما يغطي أول المحتوى */
body{ padding-top: var(--hdr-h); }


/* حتى لا يُقصّ البادج لو يطلع خارج حدود الزر */
.card-foot .foot-actions { overflow: visible; }

/* زر الملاحظات يحتاج مرجع تموضع */
.card-foot .foot-actions .i-btn{ position: relative; }

/* بادج عدّاد الملاحظات — أحمر غامق */
.i-btn .notes-count{
  position: absolute;
  top: -6px;
  inset-inline-end: -6px;          /* يدعم RTL */
  min-width: 18px;
  height: 18px;
  padding: 0 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  line-height: 18px;
  text-align: center;
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b); /* أحمر غامق */
  color: #fecaca;
  border: 1px solid rgba(239,68,68,.45);
  box-shadow: 0 2px 10px rgba(239,68,68,.25);
  pointer-events: none; /* ما يمنع النقر على الزر */
}

/* إخفاء تام عندما العدد = 0 */
.i-btn .notes-count[hidden]{ display: none; }



/* ===== زر حذف سطر المادة داخل البطاقة ===== */
/* نغطي الاحتمالات الشائعة: زر صغير داخل العناصر، وأي زر يحمل كلاس/داتا حذف */
.item .btn-del,
.btn-mini.btn-del,
.item [data-action="del-item"],
.item .btn[data-action="del-item"]{
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b); /* أحمر غامق */
  color: #fecaca;
  border: 1px solid rgba(239,68,68,.45);
  box-shadow: 0 8px 18px rgba(239,68,68,.24);
  transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
}

/* Hover/Focus */
.item .btn-del:hover,
.btn-mini.btn-del:hover,
.item [data-action="del-item"]:hover,
.item .btn[data-action="del-item"]:hover{
  transform: translateY(-1px);
  filter: brightness(1.06);
  box-shadow: 0 12px 24px rgba(239,68,68,.30);
}

.item .btn-del:focus-visible,
.btn-mini.btn-del:focus-visible,
.item [data-action="del-item"]:focus-visible,
.item .btn[data-action="del-item"]:focus-visible{
  outline: 0;
  box-shadow:
    0 0 0 2px rgba(255,255,255,.10),
    0 0 0 5px rgba(239,68,68,.35);
}

/* لو عندك ستايل يفرض "شفاف/ghost" يتغلب على الخلفية، نعالجه هنا */
.item .btn-del.ghost,
.btn-mini.btn-del.ghost,
.item [data-action="del-item"].ghost{
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b);
  color: #fecaca;
  border-color: rgba(239,68,68,.45);
}

/* لو الحاوية تقصّ البادج/الظل بسبب overflow */
.item .actions, .item .controls { overflow: visible; }

/* (اختياري كحل أخير فقط) لو بعده أكو قاعدة تغلب – فعّل !important للخلفية واللون فقط */
/*
.item .btn-del,
.btn-mini.btn-del{
  background: linear-gradient(135deg, #7f1d1d, #4c0b0b) !important;
  color: #fecaca !important;
}
*/




  </style>
</head>

<body>
  <!-- Header -->
  <div class="ribbon">
    <div class="ribbon-wrap">
      <div class="r-left">
        <span id="dateBadge" class="pill">—</span>
      </div>

      <div class="r-center">
        <div class="brand">
          <div class="dot">A</div>
          <div class="name">فواتير ديون يومية مكتب عسل</div>
        </div>
      </div>

      
      <div class="r-right">
  <button class="icon" id="btnRefresh" title="تحديث الصفحة" aria-label="تحديث الصفحة">
    <i class="fa-solid fa-rotate-right"></i>
  </button>

  <!-- تصدير محلي بدل زر البحث -->
  <button class="icon" id="btnExportLocal" title="تصدير محلي (JSON)" aria-label="تصدير محلي (JSON)">
    <i class="fa-solid fa-download"></i>
  </button>

  <!-- تصدير للسيرفر (رفع) -->
  <button class="icon" id="btnExportAll" title="رفع النسخة للسيرفر" aria-label="رفع النسخة للسيرفر">
    <i class="fa-solid fa-cloud-arrow-up"></i>
  </button>

  <!-- استيراد من السيرفر (سحب) -->
  <button class="icon" id="btnImportAll" title="سحب النسخة من السيرفر" aria-label="سحب النسخة من السيرفر">
    <i class="fa-solid fa-cloud-arrow-down"></i>
  </button>

  <button class="icon" id="btnNextDay" title="فتح فاتورة اليوم التالي" aria-label="فتح فاتورة اليوم التالي">
    <i class="fa-solid fa-calendar-plus"></i>
  </button>

  <button class="icon" id="btnLogout" title="تسجيل خروج" style="display:none" aria-label="تسجيل خروج">
    <i class="fa-solid fa-right-from-bracket"></i>
  </button>
</div>

      
      
      
    </div>
  </div>

  <!-- Layout -->
  <main class="layout">
    <!-- Rail -->
    <aside class="rail">
      <h3><i class="fa-regular fa-calendar-days"></i> الفواتير السابقة</h3>
      <div class="search">

<input id="dayFilter" class="input" type="text" placeholder="فلترة (مثال: 02-10-2025 )"/>


      </div>
      <div id="rail" class="timeline"></div>
    </aside>

    <!-- Board -->
    <section class="board">
      
      
     <div class="board-head">
  <div class="chips">
    <span class="chip"><i class="fa-solid fa-layer-group"></i> بطاقات اليوم</span>
    <span id="cardsCount" class="chip">0 بطاقة</span>
  </div>

  <div class="board-search">
    <input id="cardSearch" class="input" type="text" placeholder="بحث بالاسم (مثال: حسين)"/>
    <label class="chip" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;flex:0 0 auto">
      <input id="globalSearch" type="checkbox" style="accent-color:#7c3aed;width:16px;height:16px;cursor:pointer">
      بحث كل الأيام
    </label>
  </div>

  <div class="chips">
    <button id="btnExportDay" class="btn ghost"><i class="fa-regular fa-file-pdf"></i> PDF اليوم</button>
    <button id="btnClearDay" class="btn ghost"><i class="fa-regular fa-trash-can"></i> تفريغ اليوم</button>
  </div>
</div>




      
      
      <div id="masonry" class="masonry"></div>
    </section>

    <!-- Insights -->
    <aside class="insights">
      <h3><i class="fa-solid fa-chart-simple"></i> ملخص اليوم</h3>
     
    </aside>
  </main>

  <!-- Dock -->
  
  
  <!-- ===== Dock (كامل بعد التعديل) ===== -->
<div class="dock">
  <div class="dock-inner">
    <!-- 1) اسم الزبون (اقتراحات فوق + 8 مرئية) -->
    <div class="cust-wrap" style="position:relative; min-width:0;">
      <input id="cust" class="field" type="text" placeholder="اسم الزبون"/>
      <ul id="custSuggestions" class="nice-scroll" style="
  display:none; position:absolute; inset-inline:0; bottom:calc(100% + 6px);
  z-index:1100; background:#0b1327; border:1px solid var(--stroke);
  border-radius:10px; max-height:288px; overflow:auto; margin:0; padding:6px 0; list-style:none;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
"></ul>
    </div>

    <!-- 2) نوع الفاتورة -->
    <select id="type" class="field">
      <option value="بيع" selected>بيع</option>
      <option value="راجع">راجع</option>
    </select>

    <!-- 3) الصنف (قائمة مخصّصة تطلع فوق + Scroll) -->
    <div class="cat-wrap" style="position:relative; min-width:0;">
      <input id="cat" class="field" type="text" placeholder="الصنف" readonly />
      <div id="catPanel" class="cat-panel nice-scroll" style="
  display:none; position:absolute; inset-inline:0; bottom:calc(100% + 6px);
  z-index:1100; background:#0b1327; border:1px solid var(--stroke);
  border-radius:10px; max-height:288px; overflow:auto; padding:6px 0;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
">
        <div class="cat-list" id="catList">
          <div class="cat-item" data-val="LCD"><i class="fa-solid fa-tv"></i> شاشات</div>
          <div class="cat-item" data-val="BATTERY"><i class="fa-solid fa-bolt"></i> بطاريات</div>
          <div class="cat-item" data-val="CAMERA"><i class="fa-solid fa-camera"></i> كاميرات</div>
          <div class="cat-item" data-val="CHARGING"><i class="fa-solid fa-plug"></i> شحن</div>
          <div class="cat-item" data-val="SPEAKER"><i class="fa-solid fa-headphones"></i> سماعة</div>
          <div class="cat-item" data-val="HOUSING"><i class="fa-solid fa-border-none"></i> شواصي</div>
          <div class="cat-item" data-val="BACK"><i class="fa-solid fa-mobile-screen"></i> أظهر</div>
          <div class="cat-item" data-val="BUZZER"><i class="fa-solid fa-bell"></i> جرس</div>
          <div class="cat-item" data-val="FINGER"><i class="fa-solid fa-fingerprint"></i> بصمة</div>
          <div class="cat-item" data-val="FLAT LCD"><i class="fa-solid fa-film"></i> فلات شاشة</div>
          <div class="cat-item" data-val="POWER"><i class="fa-solid fa-charging-station"></i> فلات بور</div>
          <div class="cat-item" data-val="VOLUME"><i class="fa-solid fa-sliders"></i> فلات صوت</div>
          <div class="cat-item" data-val="LENS"><i class="fa-solid fa-bullseye"></i> عدسة كاميرا</div>
          <div class="cat-item" data-val="NO-CATEGORY"><i class="fa-regular fa-square"></i> بدون صنف</div>
        </div>
      </div>
    </div>

    <!-- 4) اسم المادة (اقتراحات فوق + 8 مرئية) -->
    <div style="position:relative; min-width:0;">
      <input id="item" class="field" type="text" placeholder="اسم القطعة"/>
     <ul id="itemSuggestions" class="nice-scroll" style="
  display:none; position:absolute; inset-inline:0; bottom:calc(100% + 6px);
  z-index:1000; background:#0b1327; border:1px solid var(--stroke);
  border-radius:10px; max-height:288px; /* 8 عناصر × ~36px */
  overflow:auto; margin:0; padding:6px 0; list-style:none;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
"></ul>
    </div>

    <!-- 5) السعر -->
   <input id="price" class="field" type="text" inputmode="numeric" placeholder="السعر (دينار)"/>


    <!-- 6) العدد -->
    <input id="qty" class="field" type="number" min="1" step="1" placeholder="العدد"/>

    <!-- 7) الملاحظات + زر الإضافة -->
    <div class="note-wrap">
      <input id="note" class="field note-field" type="text" placeholder="ملاحظات (اختياري)"/>
      <button id="btnAdd" class="btn primary note-add">
        <i class="fa-solid fa-plus"></i> إضافة
      </button>
    </div>
  </div>
</div>





<!-- Auth Splash: نافذة احترافية للتحقق من الجلسة -->
<div id="authSplash" class="auth-splash" aria-live="polite" aria-atomic="true" style="display:none">
  <div class="auth-shell" role="dialog" aria-label="جاري التحقق من الجلسة">
    <div class="auth-brand">
      <div class="auth-mark">A</div>
      <div class="auth-texts">
        <div class="auth-title">ASSAL</div>
        <div class="auth-sub">مكتب عسل</div>
      </div>
    </div>

    <div class="auth-status">
      <div id="authTip" class="auth-tip">نحضّر كلشي…</div>

      <div class="auth-progress" aria-label="شريط التقدم">
        <div id="authBar" class="auth-bar"></div>
      </div>

      <div class="auth-meta">
        <span id="authPct" class="auth-pct">0%</span>
        <span class="auth-sep">•</span>
        <span id="authSub" class="auth-subtle">التحقق من الجلسة</span>
      </div>
    </div>
  </div>
  <!-- خلفية زخرفية -->
  <div class="auth-bg auth-bg--1"></div>
  <div class="auth-bg auth-bg--2"></div>
  <div class="auth-bg auth-bg--3"></div>
</div>


  

  <!-- Footer -->
 <div class="footer">© 2025 مكتب عسل — جميع الحقوق محفوظة</div>

  <!-- ===== Modal ===== -->
  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-card" role="document">
      <div class="modal-head" id="modal-title">تأكيد</div>
      <div class="modal-body" id="modal-body">هل أنت متأكد؟</div>
      <div class="modal-actions">
        <button id="modal-cancel" class="modal-btn ghost">إلغاء</button>
        <button id="modal-confirm" class="modal-btn danger">تأكيد</button>
      </div>
    </div>
  </div>
  
  
  <!-- Toasts -->
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>


<!-- Page Reload Overlay (احترافي) -->
<div id="reloader" class="reloader" aria-live="polite" aria-atomic="true" role="dialog" aria-modal="true">
  <!-- خلفية زخرفية خفيفة -->
  <div class="reloader-bg">
    <span class="orb orb-a"></span>
    <span class="orb orb-b"></span>
    <span class="orb orb-c"></span>
  </div>

  <!-- بطاقة اللودينگ -->
  <div class="reload-card">
    <div class="reload-head">
      <div class="brand-dot">A</div>
      <div class="reload-title">جاري تحديث الصفحة…</div>
      <div id="reloadTip" class="reload-sub">نحفظ شغلك أولاً ثم نحدّث</div>
    </div>

    <!-- حلقة متحركة + نسبة -->
    <div class="ring-wrap" aria-hidden="true">
      <div class="ring"></div>
      <div class="ring ring-2"></div>
      <div id="splashPct" class="ring-pct">0%</div>
    </div>

    <!-- شريط تقدّم -->
    <div class="progress">
      <div id="reloadBar" class="bar"></div>
    </div>

    <div class="reload-foot">
      <span class="chip">لا تغلق النافذة</span>
      <span class="chip">ثواني ونرجع لك</span>
    </div>
  </div>
</div>


<input type="file" id="importFile" accept="application/json" style="display:none">


<!-- Gate: شاشة تسجيل الدخول (جديدة بحركة ناعمة) -->
<div id="loginGate" class="gate" style="display:none">
  <div class="gate-card">
    <div class="gate-head">
      <div class="gate-logo">
        <span class="g-dot">A</span>
        <span class="g-name">ASSAL • دخول</span>
      </div>
      <div class="g-sub">سجّل دخولك للمتابعة</div>
    </div>

    <div class="gate-body">
      <input id="lgEmail" type="email" class="field gate-input" placeholder="الإيميل">
      <input id="lgPass"  type="password" class="field gate-input" placeholder="كلمة السر">
      <button id="lgBtn"  class="btn primary gate-btn">
        <span class="btn-txt">دخول</span>
        <span class="btn-spin" aria-hidden="true"></span>
      </button>
      <div id="lgMsg" class="gate-msg" role="status" aria-live="polite"></div>
    </div>
  </div>
</div>




<!-- مـودال الملاحظات -->
<div id="notesModalBackdrop" class="modal-backdrop"></div>
<div id="notesModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="notesModalTitle">
    <div class="modal-head" id="notesModalTitle">ملاحظات البطاقة</div>
    <div class="modal-body" style="width:100%;">
      <!-- قائمة ملاحظات داخل المودال -->
      <div id="notesModalList" class="notes-compact__list nice-scroll" style="max-height:200px;"></div>

      <!-- شريط إدخال داخل المودال -->
      <div class="notes-compact__bar" style="display:grid; grid-template-columns:1fr auto; gap:6px; margin-top:10px;">
        <input id="notesModalInput" class="field note-input-sm" placeholder="اكتب الملاحظة…"/>
        <button id="notesModalAdd" class="btn primary">
          <i class="fa-solid fa-plus"></i><span>إضافة</span>
        </button>
      </div>
    </div>

    <div class="modal-actions">
      <button id="notesModalClose" class="modal-btn ghost">إغلاق</button>
    </div>
  </div>
</div>








  <script>
    
    
    
    
  if(typeof window.IS_SIGNED_IN === 'undefined'){ window.IS_SIGNED_IN = false; }
  
  
  
  
  
  
    
    
    
    // ===== Excel DB (تحميل جوجل شيت) =====
let database = {};   // نخزّن بيه جداول الأصناف

// نفس رابطك (استخدم Google Sheets published XLSX)
const dropboxMainFile =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZww_ZDcqXnX6pUjlKccZdFUkRR9Z_JmfmdvNsnGVYT_rq_RTsSB1ydTy6QVrrS_o4s_ml1DNBTnaQ/pub?output=xlsx"
  + "&t=" + new Date().getTime();

async function loadExcelFiles(){
  try{
    const resp   = await fetch(dropboxMainFile, { cache: 'no-store' });
    const buffer = await resp.arrayBuffer();
    const wb     = XLSX.read(buffer, { type:"array" });

    database = {
      LCD       : XLSX.utils.sheet_to_json(wb.Sheets["LCD"]       || {}, {defval:null}),
      BATTERY   : XLSX.utils.sheet_to_json(wb.Sheets["BATTERY"]   || {}, {defval:null}),
      HOUSING   : XLSX.utils.sheet_to_json(wb.Sheets["HOUSING"]   || {}, {defval:null}),
      BACK      : XLSX.utils.sheet_to_json(wb.Sheets["BACK"]      || {}, {defval:null}),
      CAMERA    : XLSX.utils.sheet_to_json(wb.Sheets["CAMERA"]    || {}, {defval:null}),
      CHARGING  : XLSX.utils.sheet_to_json(wb.Sheets["CHARGING"]  || {}, {defval:null}),
      BUZZER    : XLSX.utils.sheet_to_json(wb.Sheets["BUZZER"]    || {}, {defval:null}),
      SPEAKER   : XLSX.utils.sheet_to_json(wb.Sheets["SPEAKER"]   || {}, {defval:null}),
      FINGER    : XLSX.utils.sheet_to_json(wb.Sheets["FINGER"]    || {}, {defval:null}),
      "FLAT LCD": XLSX.utils.sheet_to_json(wb.Sheets["FLAT LCD"]  || {}, {defval:null}),
      POWER     : XLSX.utils.sheet_to_json(wb.Sheets["POWER"]     || {}, {defval:null}),
      VOLUME    : XLSX.utils.sheet_to_json(wb.Sheets["VOLUME"]    || {}, {defval:null}),
      LENS      : XLSX.utils.sheet_to_json(wb.Sheets["LENS"]      || {}, {defval:null})
    };

    // للتأكيد
    // console.log("DB loaded:", Object.keys(database));
  }catch(err){
    console.error("❌ خطأ تحميل:", err);
    showToast?.('error','تعذر تحميل بيانات الأصناف');
  }
}

/* ===== Auto Sync (every 15 min, no toast on load) ===== */

// مدة التزامن الدوري
const AUTO_SYNC_MS = 15 * 60 * 1000;

// أول مزامنة *بعد* تشغيل الصفحة (عدّلها مؤقتًا لـ 30s للفحص إذا تحب)
let firstAutoSyncAt = Date.now() + AUTO_SYNC_MS;

// ثروتل أمان حتى لو صار تعدد استدعاءات
const AUTO_SYNC_THROTTLE_MS = 60 * 1000;

// تتبع آخر مزامنة فعلية
let __lastAutoSyncAt = 0;
let __autoSyncTimer   = null;

// شروط جاهزية المزامنة التلقائية
function canAutoSyncNow(){
  const now = Date.now();

  // لحد يشتغل قبل أول موعد محدد
  if (now < firstAutoSyncAt) return false;

  // ما يصير أقل من الثروتل
  if (now - __lastAutoSyncAt < AUTO_SYNC_THROTTLE_MS) return false;

  // لازم داخل السيشن ومسجّل دخول
  if (!window.IS_SIGNED_IN) return false;

  // لازم اونلاين وبالواجهة مرئية
  if (!navigator.onLine) return false;
  if (document.visibilityState !== 'visible') return false;

  return true;
}

// شغّل المزامنة، واظهر توست فقط لو كانت "تلقائية" ونجحت
// شغّل المزامنة، واظهر توست واحد فقط بعد النجاح
async function runAutoSync(){
  // نحفظ الدالة الأصلية ونكمّمها مؤقتًا
  const prevShowToast = window.showToast;
  try{
    window.showToast = function(){ /* mute toasts during auto-sync */ };

    await smartExportToServer();   // رفع/دمج بصمت

    __lastAutoSyncAt = Date.now();
  }catch(e){
    console.error('AutoSync failed:', e);
    // (اختياري) إذا تريد تظهر فشل واحد فقط، فكّ التعليق التالي:
    // prevShowToast && prevShowToast('warn','تعذّرت المزامنة التلقائية');
  }finally{
    // نرجّع دالة التوست الأصلية
    window.showToast = prevShowToast;
  }

  // نطلع توست واحد فقط بعد انتهاء المزامنة التلقائية
  prevShowToast && prevShowToast('info','تمت المزامنة التلقائية');
}


// حلقة تفقد خفيفة (كل 5 ثواني) لنشوف إذا حان وقت المزامنة
function startAutoSyncLoop(){
  if (__autoSyncTimer) clearInterval(__autoSyncTimer);
  __autoSyncTimer = setInterval(()=>{
    if (canAutoSyncNow()){
      runAutoSync();
    }
  }, 5000);
}

// حسّن السلوك عند العودة للتبويب
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible' && canAutoSyncNow()){
    runAutoSync();
  }
});

// ابدأ الحلقة بعد جاهزية الصفحة/تسجيل الدخول
startAutoSyncLoop();



/* ===== Dropdown الأصناف المخصّصة (8 مرئية + Scroll للأعلى) ===== */
let __catIdx = -1;



function showCatPanel(){
  const panel = document.getElementById('catPanel');
  if(!panel) return;
  panel.style.display = 'block';
  // دوران السهم
  document.querySelector('.cat-wrap')?.classList.add('open');
  __catIdx = -1;
  highlightCatItem();
}
function hideCatPanel(){
  const panel = document.getElementById('catPanel');
  if(panel) panel.style.display = 'none';
  // رجّع السهم لوضعه الطبيعي
  document.querySelector('.cat-wrap')?.classList.remove('open');
  __catIdx = -1;
  highlightCatItem();
}



function getCatItems(){ return Array.from(document.querySelectorAll('#catList .cat-item')); }
function highlightCatItem(){
  const items = getCatItems();
  items.forEach((li,i)=> li.classList.toggle('active', i===__catIdx));
  if(__catIdx >= 0 && items[__catIdx]){
    items[__catIdx].scrollIntoView({ block:'nearest' });
  }
}
function selectCatByIndex(i){
  const items = getCatItems();
  if(i < 0 || i >= items.length) return;
  const li = items[i];
  const val = li.getAttribute('data-val') || '';
  const input = document.getElementById('cat');
  if(input){
    input.value = val;                 // نخزن القيمة الإنجليزية
    hideCatPanel();
    // أشعل أحداثك الحالية المرتبطة بـ #cat (تعبئة اقتراحات/سعر...)
    input.dispatchEvent(new Event('change', { bubbles:true }));
    document.getElementById('item')?.focus();
  }
}

// فتح/إغلاق بالنقر على الحقل
document.getElementById('cat')?.addEventListener('click', (e)=>{
  e.stopPropagation();
  const panel = document.getElementById('catPanel');
  const visible = panel && panel.style.display === 'block';
  if(visible) hideCatPanel(); else showCatPanel();
});

// اختيار بالماوس
document.getElementById('catList')?.addEventListener('click', (e)=>{
  const li = e.target.closest('.cat-item');
  if(!li) return;
  const items = getCatItems();
  __catIdx = items.indexOf(li);
  selectCatByIndex(__catIdx);
});

// هايلايت مع حركة الماوس (اختياري)
document.getElementById('catList')?.addEventListener('mousemove', (e)=>{
  const li = e.target.closest('.cat-item');
  if(!li) return;
  const items = getCatItems();
  const idx = items.indexOf(li);
  if(idx !== -1 && idx !== __catIdx){
    __catIdx = idx;
    highlightCatItem();
  }
});

// تنقّل الكيبورد داخل قائمة الأصناف
// 2) تنقّل الكيبورد داخل قائمة الأصناف (ArrowUp/ArrowDown فقط)
// 2) تنقّل الكيبورد: ضفنا دعم ArrowLeft/ArrowRight كمكافئ لفوق/تحت
document.getElementById('cat')?.addEventListener('keydown', (e)=>{
  const panel = document.getElementById('catPanel');
  const visible = panel && panel.style.display === 'block';

  if(!visible){
    if(e.key === 'Enter' || e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'ArrowLeft' || e.key === 'ArrowRight'){
      e.preventDefault();
      showCatPanel();

      // عند الفتح من هنا، خليه يبدأ على LCD أيضًا
      const items = getCatItems();
      const lcdIndex = items.findIndex(li => (li.getAttribute('data-val')||'') === 'LCD');
      __catIdx = lcdIndex >= 0 ? lcdIndex : 0;
      highlightCatItem();
    }
    return;
  }

  const items = getCatItems();
  if(!items.length) return;

  // اعتبر Left مثل Up و Right مثل Down (مفيد مع RTL)
  const isDown = (e.key === 'ArrowDown' || e.key === 'ArrowRight');
  const isUp   = (e.key === 'ArrowUp'   || e.key === 'ArrowLeft');

  if(isDown){
    e.preventDefault();
    __catIdx = (__catIdx < 0) ? 0 : Math.min(items.length - 1, __catIdx + 1);
    highlightCatItem();
  }else if(isUp){
    e.preventDefault();
    __catIdx = (__catIdx < 0) ? items.length - 1 : Math.max(0, __catIdx - 1);
    highlightCatItem();
  }else if(e.key === 'Enter'){
    e.preventDefault();
    if(__catIdx >= 0) selectCatByIndex(__catIdx);
  }else if(e.key === 'Escape'){
    e.preventDefault();
    hideCatPanel();
  }
});

// إغلاق إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const panel = document.getElementById('catPanel');
  const field = document.getElementById('cat');
  if(!panel || !field) return;
  const inside = panel.contains(ev.target) || field.contains(ev.target);
  if(!inside) hideCatPanel();
});






// ===== أوتوكومبليت لاسم القطعة معتمد على الصنف المختار =====
let __autoIdx = -1;

function norm(s){ return String(s||'').replace(/\s+/g,'').toLowerCase(); }

function getSelectedCat(){
  const c = document.getElementById('cat')?.value || '';
  return c.trim();
}




function parseIQD(v){
  const s = String(v||'').replace(/[^\d.]/g,'');
  if(!s) return '';
  const n = Math.round(parseFloat(s));
  return isFinite(n) ? n : '';
}

function findPrice(cat, itemName){
  if(!cat || cat === 'NO-CATEGORY' || !itemName) return '';
  const list = database[cat] || [];
  const qn = norm(itemName);
  const row = list.find(r => norm(r["Item Name"] || r["Item"] || '') === qn);
  return row ? parseIQD(row["Price"]) : '';
}

function tryFillPrice(){
  const cat  = getSelectedCat();
  const name = (document.getElementById('item')?.value || '').trim();
  const priceEl = document.getElementById('price');
  if(!priceEl) return;
  const p = findPrice(cat, name);
  if(p !== '') priceEl.value = formatIQD(p);  // 12,500
}






/* تحت دوال parseIQD / findPrice أضف: */
function formatIQD(v){
  const n = Number(String(v||'').replace(/[^\d.]/g,''));
  if(!isFinite(n)) return '';
  // نستخدم en-US حتى يطلع 12,500 (فوارز)
  return n.toLocaleString('en-US');
}


// ===== Price field one-time listeners =====
(function bindPriceField(){
  const priceInput = document.getElementById('price');
  if(!priceInput) return;
  priceInput.addEventListener('focus', ()=> priceInput.select?.());
  priceInput.addEventListener('input', ()=>{
    priceInput.value = priceInput.value.replace(/[^\d]/g,'');
  });
  priceInput.addEventListener('blur', ()=>{
    if(priceInput.value) priceInput.value = formatIQD(priceInput.value);
  });
})();



function activeCardsOfDay(dayKey){
  return (days[dayKey]||[]).filter(c=>{
    if (c?.deletedAt) return false;
    return (c.lines||[]).some(l=> !l.deletedAt);
  });
}
function activeLinesCountOfDay(dayKey){
  return (days[dayKey]||[]).reduce((sum,c)=>{
    if (c?.deletedAt) return sum;
    return sum + (c.lines||[]).filter(l=> !l.deletedAt).length;
  }, 0);
}




/* ===== IDs & Time helpers (أضِف) ===== */
function nowISO(){ return new Date().toISOString(); }
function genId(){ return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

/* اختصار مقارنة وقت: يرجّع true إذا tsB أحدث من tsA */
function isNewer(tsA, tsB){
  const a = tsA ? new Date(tsA).getTime() : 0;
  const b = tsB ? new Date(tsB).getTime() : 0;
  return b > a;
}






function renderItemSuggestions(){
  const host = document.getElementById('itemSuggestions');
  const qEl  = document.getElementById('item');
  if(!host || !qEl) return;

  const cat = getSelectedCat();
  const q   = norm(qEl.value.trim());

  host.innerHTML = '';
  host.style.display = 'none';
  __autoIdx = -1;

  // إذا ما مختار صنف أو NO-CATEGORY، لا نعرض اقتراحات
  if(!cat || cat === 'NO-CATEGORY') return;
  // إذا قاعدة البيانات بعد ما انملت، انتظر (ما نعرض شي)
  const list = database[cat] || [];
  if(!q) return;

  // نجرّب حقول اسم شائعة
  const filtered = list.filter(row=>{
    const name = norm(row["Item Name"] || row["Item"] || '');
    return name.includes(q);
  });

  if(!filtered.length) return;

  filtered.forEach(row=>{
    const name = row["Item Name"] || row["Item"];
    const li = document.createElement('li');
    li.textContent = name || '';
    li.style.cssText = `
      padding:8px 12px; height:36px; display:flex; align-items:center;
      cursor:pointer; border-bottom:1px dashed rgba(255,255,255,.06);
    `;
    li.onmouseenter = ()=> li.style.background = '#0e1b36';
    li.onmouseleave = ()=> li.style.background = 'transparent';
   
   
   li.onclick = ()=>{
  qEl.value = name || '';
  host.style.display = 'none';

  // تعبئة السعر تلقائياً
  const priceEl = document.getElementById('price');
  if(priceEl){
   const p = findPrice(cat, name || '');
if(p !== '') priceEl.value = formatIQD(p);

  }

  document.getElementById('qty')?.focus();
  document.getElementById('qty')?.select?.();
};

   
   
    host.appendChild(li);
  });

  host.style.display = 'block';
}

function hideItemSuggestions(){
  const host = document.getElementById('itemSuggestions');
  if(host){ host.style.display = 'none'; __autoIdx = -1; }
}

// تريّغر العرض عند الكتابة وتغيير الصنف
document.getElementById('item')?.addEventListener('input', renderItemSuggestions);


document.getElementById('cat')?.addEventListener('change', ()=>{
  hideItemSuggestions();
  if((document.getElementById('item')?.value||'').trim()) renderItemSuggestions();
  // محاولة تعبية السعر حسب الاسم الحالي
  tryFillPrice();
});

// إذا المستخدم كتب/غيّر اسم المادة يدويًا ثم خرج من الحقل
document.getElementById('item')?.addEventListener('change', tryFillPrice);



// تنقّل الكيبورد داخل قائمة الاقتراحات
document.getElementById('item')?.addEventListener('keydown', (e)=>{
  const host = document.getElementById('itemSuggestions');
  const visible = host && host.style.display === 'block';
  if(!visible){
    // إنتر من item بدون اقتراحات → نزّل للـ qty
    if(e.key === 'Enter'){
      e.preventDefault();
      document.getElementById('qty')?.focus();
      document.getElementById('qty')?.select?.();
    }
    return;
  }

  const items = Array.from(host.querySelectorAll('li'));
  if(!items.length) return;

  if(e.key === 'ArrowDown' || e.key === 'ArrowUp'){
    e.preventDefault();
    const step = (e.key === 'ArrowDown') ? 1 : -1;
    if(__autoIdx < 0){
      __autoIdx = (e.key === 'ArrowDown') ? 0 : items.length - 1;
    }else{
      __autoIdx = Math.max(0, Math.min(items.length - 1, __autoIdx + step));
    }
    items.forEach((li, i)=> li.style.background = (i===__autoIdx) ? '#0e1b36' : 'transparent');
    items[__autoIdx].scrollIntoView({ block:'nearest' });
  }

  if(e.key === 'Enter' && __autoIdx >= 0){
    e.preventDefault();
    const li = items[__autoIdx];
    document.getElementById('item').value = li.textContent;
    hideItemSuggestions();
    document.getElementById('qty')?.focus();
    document.getElementById('qty')?.select?.();
  }

  if(e.key === 'Escape'){
    hideItemSuggestions();
  }
});

// إغلاق الاقتراحات إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const host = document.getElementById('itemSuggestions');
  const field= document.getElementById('item');
  if(!host || !field) return;
  const inside = host.contains(ev.target) || field.contains(ev.target);
  if(!inside) hideItemSuggestions();
});

    
    
    
    
    
    
    
    
    /* ============ بيانات محلية ============ */
    const STORAGE = 'assal:board:v3';
    const NAMES   = 'assal:names:v3';
    let globalLimit = 20;
    
    
    
    
    
    /* ====== SYNC CONFIG ====== */
const SYNC = {
  // بدّل <your-subdomain> إذا طالع لك دومين مخصص؛
  // إذا ما عندك دومين مخصص استعمل workers.dev مالك مثل الظاهر أدناه:
  BASE_URL: "https://assal-proxy.ahmed-al-bayatii-90.workers.dev/",
  TOKEN   : "test1234"
};
    
    /* ====== قائمة أسماء الزبائن اليدوية (عدّلها على راحتك) ====== */
const CUSTOMERS = [
  "ابو همام - الكهربائي",
  "ابو يونس",
  "احمد الدليمي",
  "احمد الغزالي",
  "احمد تكسي - ابو مينا",
  "احمد سمير",
   "مصطفى - نانا",
  "احمد عباس - تحرير",
  "احمد عسل - بلدروز",
  "احمد علي - كنعان",
  "احمد محسن - مندلي",
  "احمد محمد داودي",
  "ادم شروين",
  "ادم صيانة - 2",
  "انور دبي",
  "ايسر - سومر",
  "حارث - خان بني سعد",
  "حازم الغوالبة",
  "حسين ابل",
  "حسين بيروت - الكاطون",
  "حسين حنو",
  "حسين سعيد",
  "حسين علي - خان بني سعد",
  "حسين قزانية - ايسر بيروت",
  "حمزة كرايب ادم",
  "حيدر اركان",
  "حيدر متعب - العظيم",
  "رسول كنعان",
  "رسول وي سامر",
  "رشيد مرسى سابقا",
  "زياد CBU - الاسود",
  "سامر العنبكي - صيانة",
  "سامر عبداللطيف",
  "ستار - المرسى 2",
  "سجاد - ماستر",
  "سعد غيلان",
  "سلوان - عمار جيزاني",
  "سمعو عسل",
  "ايوب - حديد",
  "مهند - خرنابات",
  "سيف سنتر - 2",
  "شاكر هبهب",
  "شعبان هبهب - حسين نانة",
  "صلاح المبرمج",
  "طالب جيزاني",
  "طيف المعموري - خان بني سعد",
  "عادل مندلي",
  "عباس حديد",
  "عبدالرحمن هبهب",
  "عبدالله سعد - خان",
  "عدنان هزاع - ابو مينا",
  "عزام ابراهيم - دورة",
  "عصام روتانا",
  "علي الحاتمية - وي نشوان",
  "علي الساحل - 2",
  "علي السادة",
  "علي هباوي - جامعة",
  "عماد هاتف خان - حبوب",
  "عمار سوفت",
  "عمر الباوي",
  "عمر سلفة - عسل",
  "غالب اكرم",
  "غسان هويدر",
  "فاضل - مكتب الساعة",
  "فراس - سايق اربيل",
  "كريم حديد",
  "كوري",
  "م. محمد - ابو مينا",
  "ماجد زيونة",
  "مازن العالمية",
  "محمد - مكتب بابل",
  "محمد ابو السلفة",
  "محمد الباقر - ايسر بيروت",
  "محمد خرنابات",
  "محمد سحاب",
  "محمد سمعو",
  "محمد صخرة",
  "محمد قحطان - ابو القسط",
  "محمد م. الموج",
  "محمد مجول",
  "محمد مؤيد دورة",
  "محمد هاشم السادة",
  "محمد هبهب",
  "محي - قرة تبة",
  "مرتضى سراجق",
  "مركز التطور",
  "مصطفى - خان بني سعد",
  "مصطفى - وية همام",
  "مصطفى السادة",
  "مصطفى برج دبي",
  "مصطفى ثامر - الوثبة",
  "مصطفى طارق - كوكل",
  "مصطفى عسل",
  "مكتب القمة - راس الشارع",
  "مكتب الماسة",
  "مكتب الهرم - 2",
  "مهند سراجق",
  "نشوان - الحاتمية",
  "نظير مرهج - العظيم",
  "نور - مركز بيروت",
  "همام - اخو ادم",
  "همام ظاهر",
  "هيثم - فروسية",
  "وسام جمعة - اخو حيدر جمعة",
  "ياسر بهرز",
  "ياسر شفتة",
  "ياسر غالبية",
  "ياسر فون - مجاور عزت عشتار",
  "سيف سنتر - 1",
  "ياسين البدراني"
];



// مساعد: يرجّع ارتفاع شريط البورد اللاصق
    const boardHeadH = ()=> (document.querySelector('.board-head')?.offsetHeight || 0);

    const $  = (s)=> document.querySelector(s);
    const CE = (t, c)=>{ const e = document.createElement(t); if(c) e.className=c; return e; };

    const todayISO      = ()=> new Date().toISOString().slice(0,10);
    const TODAY         = todayISO();              // ← ثابت لليوم الحالي

    const arDateWithDay = (d)=> new Date(d).toLocaleDateString('ar-EG',{weekday:'long',year:'numeric',month:'2-digit',day:'2-digit'});
    const arMonthName   = (d)=> new Date(d).toLocaleDateString('ar-EG',{year:'numeric',month:'long'});
    const arTime        = (d)=> new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});

    let days        = load(STORAGE, {});
    let names       = load(NAMES, []);
    let selectedDay = todayISO();
    
    
    Object.defineProperty(window, 'days', { get(){ return days; } });
Object.defineProperty(window, 'selectedDay', { get(){ return selectedDay; } });
    
    

    function load(k, d){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); }catch{ return d; } }
    
  function save(){
  localStorage.setItem(STORAGE, JSON.stringify(days));
  LAST_EDIT_TS = Date.now(); // ← حتى نمنع المزامنة مباشرة بعد أي تعديل
}
    
    
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  /* ====== Enter Navigation (جديد) ====== */
/* التسلسل المطلوب: cust -> type -> cat -> item -> qty -> note */
const order = ['cust','type','cat','item','price','qty','note'];


function openSelect(el){
  try{
    el.focus();
    if(typeof el.showPicker === 'function'){ el.showPicker(); }
    else{
      // fallback: ركّز وخلّي المستخدم ينزل بالسهم (ماكو API موحّد لكل المتصفحات)
      // نرسل ArrowDown كإشارة خفيفة (قد لا تعمل بكل المتصفحات)
      const ev = new KeyboardEvent('keydown', { key:'ArrowDown', bubbles:true });
      el.dispatchEvent(ev);
    }
  }catch(_){}
}

order.forEach((id, idx)=>{
  const el = document.getElementById(id);
  el.addEventListener('keydown', (e)=>{
    if(e.key !== 'Enter') return;
    e.preventDefault();

   if(id === 'cust'){
  // إذا قائمة الاقتراحات مفتوحة، خلّي مستمع الكيبورد أعلاه يتكفّل
  const vis = document.getElementById('custSuggestions')?.style.display === 'block';
  if(vis) return;

  // ماكو قائمة → تاليها نوع الفاتورة كالعادة
  const target = document.getElementById('type');
  openSelect(target);
  return;
}


  // 1) Enter على نوع الفاتورة: افتح القائمة وحدّد LCD مباشرة
if(id === 'type'){
  const catField = document.getElementById('cat');
  catField?.focus();

  // افتح القائمة
  showCatPanel();

  // ابحث عن فهرس "شاشات" (data-val="LCD") وخلّه محدّد
  const items = getCatItems();
  const lcdIndex = items.findIndex(li => (li.getAttribute('data-val')||'') === 'LCD');
  __catIdx = lcdIndex >= 0 ? lcdIndex : 0;   // إذا ما لقاها، خليه على أول عنصر
  highlightCatItem();

  // الآن إذا ضغطت Enter مرة ثانية فورًا يختارها
  return;
}


   if (id === 'note') {
  // أضف السطر
  document.getElementById('btnAdd').click();

  // رجّع الفوكس إلى "اسم الزبون"
  setTimeout(()=>{
    const target = document.getElementById('cust');
    target.focus();
    target.select?.();
  }, 0);

  return;
}

    // باقي الحقول تتنقل للتالي بشكل طبيعي
    const next = document.getElementById(order[idx+1]);
    if(next){
      next.focus();
      next.select?.();
      if(next.tagName === 'SELECT') openSelect(next);
    }
  });
});




/* ===== Toasts: صف واحد دائمًا + تباعد أنيق ===== */
const __toastQueue = [];
let __toastBusy = false;

function showToast(type='info', message='تم التنفيذ', timeout=2200){
  // ندفع دائمًا للصف — ما نعتمد على حالة السلاش
  __toastQueue.push({ type:type.toLowerCase(), message, timeout });
  if(!__toastBusy) processToastQueueUnified();
}

async function processToastQueueUnified(){
  __toastBusy = true;
  const host = document.getElementById('toasts');
  if(!host){ __toastBusy=false; return; }

  while(__toastQueue.length){
    const {type, message, timeout} = __toastQueue.shift();
    const t = document.createElement('div');
    t.className = `toast ${['success','warn','error','info'].includes(type)?type:'info'}`;
    t.setAttribute('role','status');

    const icon = document.createElement('div');
    icon.className='toast__icon';
    icon.innerHTML = ({
      success:'<i class="fa-solid fa-check"></i>',
      warn   :'<i class="fa-solid fa-triangle-exclamation"></i>',
      error  :'<i class="fa-solid fa-xmark"></i>',
      info   :'<i class="fa-solid fa-circle-info"></i>'
    })[type] || '<i class="fa-solid fa-circle-info"></i>';

    const msg = document.createElement('div');
    msg.className='toast__msg';
    msg.textContent = message || 'تم التنفيذ';

    // زر الإغلاق مخفي عندك أصلًا
    const btn = document.createElement('button');
    btn.className='toast__close';
    btn.title='إغلاق';
    btn.innerHTML='<i class="fa-solid fa-xmark"></i>';

    let closed = false;
    function dismiss(){
      if(closed) return;
      closed = true;
      t.style.animation='toast-out-top .22s ease-in both';
      setTimeout(()=> t.remove(), 180);
    }
    btn.onclick = dismiss;

    t.append(icon, msg, btn);
    // سقف 3 مرئيات (الطابور يضمن واحد بواحد، بس نخلي تنظيف احتياطي)
    while(host.children.length >= 3){ host.removeChild(host.firstElementChild); }
    host.appendChild(t);

    await new Promise(res=>{
      const timer = setTimeout(()=>{ dismiss(); res(); }, timeout);
    });

    // تباعد لطيف بين الرسالة واللي بعدها
    await new Promise(res=> setTimeout(res, 220));
  }
  __toastBusy = false;
}






    /* ====== Modal API ====== */
    const $modal  = $('#modal');
    const $back   = $('#modal-backdrop');
    const $mtitle = $('#modal-title');
    const $mbody  = $('#modal-body');
    const $mok    = $('#modal-confirm');
    const $mcancel= $('#modal-cancel');

    function showConfirm({title='تأكيد', message='هل أنت متأكد؟', okText='تأكيد', cancelText='إلغاء', danger=true}={}){
      return new Promise((resolve)=>{
        $mtitle.textContent = title;
        $mbody.textContent  = message;
        $mok.textContent    = okText;
        $mcancel.textContent= cancelText;
        $mok.classList.toggle('danger', !!danger);

        $back.classList.add('active');
        $modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        const done = (val)=>{
          $back.classList.remove('active');
          $modal.classList.remove('active');
          document.body.style.overflow = '';
          $mok.onclick = null;
          $mcancel.onclick = null;
          resolve(val);
        };

        $mok.onclick     = ()=> done(true);
        $mcancel.onclick = ()=> done(false);
        document.onkeydown = (e)=>{ if(e.key === 'Escape'){ /* مقفلة */ } };
      });
    }

    /* ====== إضافة سطر (نظيف) ====== */
/* ====== إضافة سطر (نظيف) ====== */
document.getElementById('btnAdd').onclick = () => {
  const customer = (document.getElementById('cust').value || '').trim();
  const item     = (document.getElementById('item').value || '').trim();
 
 const priceVal = Number(parseIQD(document.getElementById('price').value) || 0);


 
 
  let   qty      = String(document.getElementById('qty').value || '1').trim();
  const cat      = (document.getElementById('cat').value || '').trim();
  const type     = (document.getElementById('type').value || 'بيع').trim(); // بيع / راجع
  const note     = (document.getElementById('note').value || '').trim();

  if (!customer || !item) return;
  if (!/^\d+$/.test(qty)) qty = '1';

  if (!days[selectedDay]) days[selectedDay] = [];

  let createdNewCard = false;


// ابحث عن البطاقة وموقعها (استبعد المحذوفة)
let cardIndex = days[selectedDay].findIndex(c => c.customer === customer && !c.deletedAt);
let card = days[selectedDay][cardIndex];

if (!card) {
  // إنشاء بطاقة جديدة + updatedAt
  card = {
    id: Date.now(),
    customer,
    lines: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    paidAll: false,
    billType: type
  };
  days[selectedDay].unshift(card);
  createdNewCard = true;
} else {
  // ✅ إنعاش البطاقة إذا كانت محذوفة منطقيًا (حالة نادرة لو لقّطتها من مصدر قديم)
  if (card.deletedAt) {
    delete card.deletedAt;
  }

  // لو نوع مختلف يصير مختلط
  if (card.billType && card.billType !== type) card.billType = 'مختلط';
  if (!card.billType) card.billType = type;

  // حدّث آخر نشاط وارفع البطاقة للأعلى
  card.updatedAt = new Date().toISOString();
  days[selectedDay].splice(cardIndex, 1);
  days[selectedDay].unshift(card);
}


  const isReturn = (type === 'راجع');
  
const now = nowISO();

if (card && (!Array.isArray(card.lines) || !card.lines.some(l => !l.deletedAt))) {
  card.createdAt = now;
}

card.lines.push({
  lineId   : genId(),
  item, cat, price: priceVal, qty, note, type,
  paid:false, returned:isReturn,
  createdAt: now,
  updatedAt: now,
  at: now,                 // <— إضافة لضمان التوافق القديم
  deletedAt: null
});

card.updatedAt = now;


  save();


  document.getElementById('item').value = '';
  document.getElementById('price').value = '';   // <-- نظّف السعر
  document.getElementById('qty').value  = '';
  document.getElementById('note').value = '';
  document.getElementById('item').focus();

  renderBoard();
  renderRail();
  refreshStats();

  // اسحب الكارت أسفل شريط البحث بمسافة أنيقة دائمًا
  focusNewCard(card);

  showToast('success', createdNewCard ? 'تم إنشاء بطاقة وإضافة مادة' : 'تم إضافة مادة وتحريك البطاقة للأعلى');
};










// استبدال كامل للدالة القديمة
function rebuildNames(){
  // لم نعد نستخدم <datalist> لاقتراحات الزبائن.
  // خَلّيناه no-op حتى ما ينهار الكود لو بقت مناداته بمكان.
}





// احسب عدد الملاحظات (يتجاهل المحذوفة)
function getNotesCount(card){
  const arr = (card && Array.isArray(card.notes)) ? card.notes : [];
  return arr.filter(n => !n.deletedAt).length;
}

// ضمن الزر: يظهر/يخفي البادج حسب العدد
function updateNotesBadge(btnNotes, card){
  if(!btnNotes) return;
  const badge = btnNotes.querySelector('.notes-count');
  if(!badge) return;
  const n = getNotesCount(card);
  if(n > 0){
    badge.textContent = n;
    badge.hidden = false;
  }else{
    badge.hidden = true;
  }
}



    /* ====== رسم اللوح ====== */
    
function renderBoard(){
  const host = document.getElementById('masonry'); 
  host.innerHTML = '';

  const q = (document.getElementById('cardSearch')?.value || '').trim().toLowerCase();
  const global = document.getElementById('globalSearch')?.checked;


  
// جهّز مصدر البطاقات
const collect = (d)=> (days[d]||[]).map(c => ({...c, __day: d}));
let pool = [];

if(global){
  const allDaysKeys = Object.keys(days).sort().reverse();
  allDaysKeys.forEach(d => { pool.push(...collect(d)); });
}else{
  pool = collect(selectedDay);
}

// بس الفعّال: بطاقة غير محذوفة وبها سطر فعّال
const isActiveCard = (c)=> !c.deletedAt && (c.lines||[]).some(l=> !l.deletedAt);
pool = pool.filter(isActiveCard);

// فلترة بالاسم
let arr = q ? pool.filter(c => (c.customer||'').toLowerCase().includes(q)) : pool;

// فرز بالبحث الشامل
if(global){
  arr.sort((a,b)=> new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
}

// العدادات الصحيحة
const totalCount = arr.length;
if(global){
  const sliced = arr.slice(0, globalLimit);
  document.getElementById('cardsCount').textContent = `${sliced.length} / ${totalCount} بطاقة`;
  arr = sliced;
}else{
  document.getElementById('cardsCount').textContent = `${arr.length} بطاقة`;
}


  // لا توجد نتائج
  if(!arr.length){
    host.innerHTML = `<div style="border:1px dashed var(--stroke);background:#0b1327;border-radius:14px;padding:16px;text-align:center;color:#9aa4b2">
      لا توجد بطاقات${global ? ' مطابقة في كل الأيام' : ' اليوم'}
    </div>`;
    return;
  }

  // اطبع البطاقات
  arr.forEach((card, ci)=>{
    if(card.deletedAt){ return; }
    
     dedupeCardLines(card);
    const box = CE('div','card');
    box.id = 'card-' + card.id;

    /* Head */
    const head = CE('div','card-head');
    const custWrap = CE('div','cust');
    const custName = CE('span'); 
    custName.textContent = card.customer;
    custWrap.appendChild(custName);
    
    
    // لو الاسم مو ضمن المصفوفة اليدوية نضيف "جديد"
const isKnownCustomer = CUSTOMERS.includes(card.customer);
if (!isKnownCustomer) {
  const newBadge = CE('span','badge-new');
 newBadge.textContent = 'زبون جديد';
  custWrap.appendChild(newBadge);
}

    
    

    // نوع الفاتورة (بيع/راجع/مختلط)
    let billType = card.billType;
    if(!billType){
      const types = Array.from(new Set((card.lines||[]).map(l=>l.type)));
      billType = (types.length === 1) ? types[0] : 'مختلط';
      card.billType = billType;
    }
   
   const typeBadge = CE('span','badge-type ' + (billType==='راجع' ? 'return' : billType==='بيع' ? 'sell' : ''));
const typeLabel = (billType === 'راجع')
  ? 'فاتورة راجع'
  : (billType === 'بيع')
    ? 'فاتورة بيع'
    : 'فاتورة مختلطة';
typeBadge.textContent = typeLabel;
custWrap.appendChild(typeBadge);

   
   
    // بادج “تم التسديد” إن كل الفعال مدفوع
    if(card.paidAll || (card.lines.length && card.lines.every(l=>l.paid))){
      card.paidAll = true;
      const paidBadge = CE('span','bill-badge'); 
      paidBadge.textContent='تم تسديد مواد اليوم';
      custWrap.appendChild(paidBadge);
    }

    // يمين الهيدر: التاريخ (من يوم البطاقة) + الوقت (من createdAt)
    const rightWrap = CE('div'); 
    rightWrap.style.display = 'flex';
    rightWrap.style.gap = '6px';

    const dateTag = CE('span','tag'); 
    dateTag.textContent = fmtDMY(card.__day || selectedDay);  // DD-MM-YYYY

    const timeTag = CE('span','tag'); 
    timeTag.textContent = arTime(card.createdAt);

    rightWrap.append(dateTag, timeTag);
    head.append(custWrap, rightWrap);
    box.appendChild(head);

    /* Items */
    const itemsWrap = CE('div','items');
   card.lines
  .filter(ln => !ln.deletedAt)        // تجاهل المحذوف
  .forEach((ln, li)=>{
    const it = CE('div','item');
      if(ln.returned) it.classList.add('returned');
      if(ln.paid)     it.classList.add('paid');

      const btnReturn = CE('button','btn-mini btn-return'); 
      btnReturn.innerHTML='<i class="fa-solid fa-rotate-left"></i>'; 
      btnReturn.title='راجع';

      const btnPay    = CE('button','btn-mini btn-pay');    
      btnPay.innerHTML   ='<i class="fa-solid fa-check"></i>';      
      btnPay.title='تسديد';

     
     
     const name  = CE('div','iname');  name.textContent = ln.item;
const cat   = CE('div','ichip');  cat.textContent  = ln.cat || '—';
const price = CE('div','iprice'); price.textContent = ln.price ? formatIQD(ln.price) : '—';
const qty   = CE('div','iqty');   qty.textContent  = `× ${ln.qty}`;
const note  = CE('div','inote');  note.textContent = (ln.note && ln.note.trim()) ? ln.note : '—';

const time  = CE('div','itime');
const ts = ln.at || ln.createdAt || ln.updatedAt;
time.textContent = arTime(ts);





     
     
      const del   = CE('button','btn-mini btn-del'); 
      del.innerHTML='<i class="fa-regular fa-trash-can"></i>'; 
      del.title='حذف';

      const badge = CE('span','badge'); 
      setBadge(badge, ln);
      if (badge.textContent) name.appendChild(badge);

    it.append(btnReturn, btnPay, cat, name, price, qty, note, time, del);

btnReturn.onclick = ()=>{
  ln.returned = !ln.returned;
  if(ln.returned) ln.paid = false;
  ln.updatedAt = nowISO();
  card.updatedAt = ln.updatedAt;

  save(); renderBoard(); renderRail(); refreshStats();
  showToast(ln.returned ? 'warn' : 'info', ln.returned ? 'تم تعليمها راجع' : 'تم إلغاء الراجع');
};



 btnPay.onclick = ()=>{
  ln.paid = !ln.paid;
  if(ln.paid) ln.returned = false;
  ln.updatedAt = nowISO();
  card.updatedAt = ln.updatedAt;

  save(); /* لاحقًا سنضيف scheduleExportDebounced() */ 
  renderBoard(); renderRail(); refreshStats();
  showToast(ln.paid ? 'success' : 'info', ln.paid ? 'تم تسديد المادة' : 'تم إلغاء التسديد');
};



      del.onclick = async ()=>{
        const ok = await showConfirm({
          title:'تأكيد حذف السطر',
          message:`هل تريد حذف "${ln.item}"؟`,
          okText:'حذف',
          cancelText:'إلغاء',
          danger:true
        });
        if(!ok) return;
        
        ln.deletedAt = nowISO();
ln.updatedAt = ln.deletedAt;
card.updatedAt = ln.deletedAt;
save(); renderBoard(); renderRail(); refreshStats();
showToast('error','تم تعليم السطر كمحذوف');

        
        
      };

      itemsWrap.appendChild(it);
    });
    
    
    
    box.appendChild(itemsWrap);



/* ===== ملاحظات البطاقة (Timeline أنيق + بدون سكرول أفقي) ===== */
if(!Array.isArray(card.notes)) card.notes = [];

const notesBox  = CE('div','notes-compact');
const notesList = CE('div','notes-compact__list');

const notesBar   = CE('div','notes-compact__bar');
const noteInput  = CE('input','field note-input-sm');
noteInput.placeholder = 'اكتب الملاحظة…';
const noteAddBtn = CE('button','btn primary note-add-mini');
noteAddBtn.title = 'إضافة ملاحظة';
noteAddBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';

notesBar.append(noteInput, noteAddBtn);
notesBox.append(notesList, notesBar);
box.appendChild(notesBox);

// وقت عربي قصير
const tinyTime = (d)=> new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});

// رسم أنيق: (#) متدرّج + وقت مع أيقونة + زر حذف خارجي
function renderNotes(){
  // نظّف القائمة
  notesList.innerHTML = '';

  // اعرض فقط الملاحظات غير المحذوفة، والأحدث أولاً
  const arr = (card.notes || [])
    .filter(n => !n.deletedAt)
    .sort((a, b) => new Date(b.at) - new Date(a.at));

  // لو تحب، ممكن تعرض حالة فارغة (حالياً مهملة حسب تصميمك)
  // if (!arr.length) {
  //   const empty = CE('div', 'notes-compact__empty');
  //   empty.textContent = 'لا توجد ملاحظات';
  //   notesList.appendChild(empty);
  //   return;
  // }

  arr.forEach((n, i) => {
    const row  = CE('div','note-row');        // يحتوي الحبة + زر الحذف
    row.style.minWidth = '0';

    const pill = CE('div','note-pill');       // الحبة نفسها
    pill.style.minWidth = '0';

    // # التسلسل (الأحدث = #1)
    const idx = CE('div','note-pill__idx');
    idx.textContent = `#${i+1}`;

    // النص — سطر واحد + tooltip بالنص الكامل
    const txt = CE('div','note-pill__text');
    txt.textContent = n.text || '';
    txt.title = n.text || '';

    // الوقت + أيقونة
    const when = CE('div','note-pill__time');
    when.innerHTML = '<i class="fa-regular fa-clock"></i>' + tinyTime(n.at || Date.now());

    // زر حذف خارج الحبة على الحافة
    const del = CE('button','note-del-out');
    del.innerHTML = '<i class="fa-solid fa-xmark"></i>';
    del.title = 'حذف الملاحظة';

    del.onclick = async ()=>{
      const ok = await showConfirm({
        title:'حذف ملاحظة',
        message:'تحب تحذف هذه الملاحظة؟',
        okText:'حذف',
        cancelText:'إلغاء',
        danger:true
      });
      if(!ok) return;

      if(deleteCardNote(card, n.id)){
        renderNotes();                 // إعادة الرسم بعد الحذف
        showToast('error','تم حذف الملاحظة');
      }else{
        showToast('warn','تعذر حذف الملاحظة');
      }
    };

    pill.append(idx, txt, when);
    row.append(pill, del);
    notesList.appendChild(row);
  });
}


function doAddNote(){
  const val = (noteInput.value||'').trim();
  if(!val) return;
  if(addCardNote(card, val)){
    noteInput.value = '';
    renderNotes();
    showToast('success','تمت إضافة الملاحظة');
    setTimeout(()=> noteInput.focus(), 0);
  }
}

noteAddBtn.onclick = doAddNote;
noteInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); doAddNote(); }
});

// أول رسم
renderNotes();


    
    
    
    function sumCardAmounts(card){
  let total = 0, paid = 0, unpaid = 0, returned = 0;
  for(const l of (card.lines || [])){
    if(l.deletedAt) continue;
    const price = Number(l.price || 0);
    const qty   = parseInt(String(l.qty || '1'), 10) || 1;
    const sub   = price * qty;

    if(l.returned){
      returned += sub;
      continue;
    }
    total += sub;
    if(l.paid) paid += sub; else unpaid += sub;
  }
  return { total, paid, unpaid, returned };
}

    
    
    
    

    /* Foot */
    const foot = CE('div','card-foot');
  const left = CE('div');
const sums = sumCardAmounts(card);

left.innerHTML = `
  <span class="sum-badge sum--items">مواد: ${(card.lines||[]).filter(l=>!l.deletedAt).length}</span>
  <span class="sum-badge sum--total">المجموع: ${formatIQD(sums.total)}</span>
  <span class="sum-badge sum--unpaid">غير مدفوع: ${formatIQD(sums.unpaid)}</span>
`;


    const right = CE('div','foot-actions');

   const btnPdf = CE('button','i-btn');
btnPdf.innerHTML = '<i class="fa-regular fa-file-pdf"></i><span>PDF</span>';
btnPdf.title = 'طباعة هاي البطاقة فقط';
btnPdf.onclick = ()=>{
  // نمرّر يوم البطاقة (يدعم وضع البحث الشامل)
  exportCardPDF_Vector(card, card.__day || selectedDay);
};


    const btnPayAll = CE('button','i-btn');
    card.paidAll = allActivePaid(card);
    stylePayAll(btnPayAll, card);

   btnPayAll.onclick = ()=>{
  if (!card.lines.length) return;
  const active = activeLines(card);
  if (active.length === 0) return;

  const allPaidBefore = active.every(l => l.paid);
  const makePaid = !allPaidBefore;

  active.forEach(l => { l.paid = makePaid; });
  card.paidAll = allActivePaid(card);

  card.updatedAt = new Date().toISOString();   // <-- جديد

  save(); renderBoard(); renderRail(); refreshStats();
  showToast(makePaid ? 'success' : 'info', makePaid ? 'تم تسديد كل المواد' : 'تم إلغاء تسديد الكل');
};


    const btnDel = CE('button','i-btn'); 
    btnDel.innerHTML  = '<i class="fa-regular fa-trash-can"></i><span>حذف البطاقة</span>'; 
    btnDel.title='حذف البطاقة';
    btnDel.onclick = async ()=>{
      const ok = await showConfirm({
        title:'تأكيد حذف البطاقة',
        message:`سيتم حذف بطاقة "${card.customer}" بكافة موادها.`,
        okText:'حذف البطاقة',
        cancelText:'إلغاء',
        danger:true
      });
      if(!ok) return;

      // عند البحث الشامل: احذف من يوم البطاقة الحقيقي
      const dayKey = card.__day || selectedDay;
const arrRef = (days[dayKey]||[]);
const real = arrRef.find(c => c.id === card.id);
if(real){
  real.deletedAt = nowISO();
  real.updatedAt = real.deletedAt;
  save();
}


      renderBoard(); renderRail(); refreshStats();
      showToast('error', 'تم حذف البطاقة');
    };
    
    
    // === زر ملاحظات (جديد) ===
const btnNotes = CE('button','i-btn');
btnNotes.innerHTML = `
  <i class="fa-regular fa-note-sticky"></i>
  <span>ملاحظات</span>
  <b class="badge notes-count" hidden>0</b>
`;
btnNotes.title = 'إضافة/استعراض ملاحظات البطاقة';
btnNotes.onclick = () => openNotesModal(card);

// تحديث العدّاد أول ما ينتهي بناء الزر
updateNotesBadge(btnNotes, card);



   right.append(btnPdf, btnPayAll, btnNotes, btnDel);
    foot.append(left,right);
    box.appendChild(foot);

    host.appendChild(box);
  });

  // زر عرض المزيد للبحث الشامل
  if(global && totalCount > arr.length){
    const more = CE('button','i-btn');
    more.style.margin = '8px auto 0';
    more.innerHTML = '<i class="fa-solid fa-angles-down"></i><span>عرض المزيد</span>';
    more.onclick = ()=>{ globalLimit += 20; renderBoard(); };
    host.appendChild(more);
  }
}



// حالة المودال الحالية
let __activeNotesCard = null;

// تنسيقات عنصر واحد (نفس ستايل الكبسولة داخل البطاقة)
function makeNoteRow(n, idx){
  const row  = CE('div','note-row');
  const pill = CE('div','note-pill');

  const idxEl = CE('div','note-pill__idx');  idxEl.textContent = idx;
  const txtEl = CE('div','note-pill__text'); txtEl.textContent = n.text || '';
  const tmEl  = CE('div','note-pill__time');
  tmEl.innerHTML = '<i class="fa-regular fa-clock"></i>' + tinyTime(n.at || n.createdAt || new Date());

  pill.append(idxEl, txtEl, tmEl);

  // زر حذف بسيط ضمن المودال
  const del = CE('button','note-del-out');
  del.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
  del.title = 'حذف الملاحظة';
  del.onclick = () => {
    n.deletedAt = nowISO();
    save();
    renderNotesModalList();
    renderBoard();   // حتى تنعكس داخل البطاقة أيضاً
    showToast('error','تم حذف الملاحظة');
  };

  row.append(pill, del);
  return row;
}

// وقت عربي قصير (موجود شبيه داخل ملفك)
function tinyTime(d){
  return new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
}

// افتح المودال على بطاقة معيّنة
function openNotesModal(card){
  // اربط على الأصل المخزّن داخل days (حتى لو اللي ظاهر نسخة بحث)
  const real = (typeof getMutableCard === 'function' ? getMutableCard(card) : null) || card;

  __activeNotesCard = real;
  if (!Array.isArray(__activeNotesCard.notes)) __activeNotesCard.notes = [];

  renderNotesModalList();

  document.getElementById('notesModalBackdrop').classList.add('active');
  document.getElementById('notesModal').classList.add('active');

  // فوكس مؤكد بعد عرض المودال
  requestAnimationFrame(() => {
    const inp = document.getElementById('notesModalInput');
    if (inp) { inp.focus(); inp.select(); }
  });

  // قفل تمرير الخلفية
  document.body.classList.add('modal-open');
}


// ارسم القائمة داخل المودال (أحدث وقت أولاً)
function renderNotesModalList(){
  const list = document.getElementById('notesModalList');
  const arr = (__activeNotesCard.notes || [])
    .filter(n => !n.deletedAt)
    .sort((a,b)=> new Date(b.at || b.createdAt) - new Date(a.at || a.createdAt)); // تأكيد الترتيب
  list.innerHTML = '';
  arr.forEach((n, i)=> list.appendChild(makeNoteRow(n, arr.length - i)));
}

// إغلاق المودال
function closeNotesModal(){
  document.getElementById('notesModalBackdrop').classList.remove('active');
  document.getElementById('notesModal').classList.remove('active');
  __activeNotesCard = null;

  // رجّع تمرير الخلفية طبيعي
  document.body.classList.remove('modal-open');
}

// إضافة من داخل المودال
function addNoteFromModal(){
  const inp  = document.getElementById('notesModalInput');
  const text = (inp && inp.value ? inp.value : '').trim();
  if (!text || !__activeNotesCard) return;

  // اشتغل على الأصل داخل days حتى تبقى الملاحظة بعد الإغلاق
  const real = (typeof getMutableCard === 'function' ? getMutableCard(__activeNotesCard) : null) || __activeNotesCard;
  if (!Array.isArray(real.notes)) real.notes = [];

  real.notes.push({
    id: (typeof crypto !== 'undefined' && crypto.randomUUID)
          ? crypto.randomUUID()
          : (Date.now() + '-' + Math.random().toString(16).slice(2)),
    text,
    at: (typeof nowISO === 'function') ? nowISO() : new Date().toISOString()
  });

  real.updatedAt = (typeof nowISO === 'function') ? nowISO() : new Date().toISOString();

  // خزّن وأعد الرسم حتى يبان كلشي مباشرة
  try { if (typeof save === 'function') save(); } catch(_){}
  try { if (typeof renderNotesModalList === 'function') renderNotesModalList(); } catch(_){}
  try { if (typeof renderBoard === 'function') renderBoard(); } catch(_){}

  if (inp) inp.value = '';
  try { if (typeof showToast === 'function') showToast('success','انضافت الملاحظة'); } catch(_){}
}



// ربط أزرار المودال
document.getElementById('notesModalClose').onclick = closeNotesModal;
document.getElementById('notesModalBackdrop').onclick = closeNotesModal; // اغلاق عند الضغط خارج
document.getElementById('notesModalAdd').onclick = addNoteFromModal;

// عناصر المودال
const _mi = document.getElementById('notesModalInput');
const _ma = document.getElementById('notesModalAdd');
const _mc = document.getElementById('notesModalClose');

// Enter بالحقل → يروح على زر الإضافة
_mi?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  _ma?.focus();
});

// Enter على زر الإضافة → يضيف + يحوّل الفوكس لزر الإغلاق
_ma?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  addNoteFromModal();
  setTimeout(()=> _mc?.focus(), 0);
});

// Enter على زر الإغلاق → يغلق
_mc?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  closeNotesModal();
});
    
  
  function activeLines(card){ return (card.lines||[]).filter(l => !l.deletedAt && !l.returned); }

  
  
function allActivePaid(card){
  const a = activeLines(card);
  return a.length>0 && a.every(l => l.paid);
}



/* سكرول مضمونة للكارت الجديد بعد الريندر */
/* سكرول مضمونة للكارت الجديد بعد الريندر */


/* سكرول مضمونة للكارت الجديد بعد الريندر (أسفل شريط البحث بمسافة صغيرة) */
function focusNewCard(card){
  const el = document.getElementById('card-' + card.id);
  if(!el) return;

  requestAnimationFrame(()=>{
    const header  = document.querySelector('.ribbon');
    const headerH = header ? header.offsetHeight : 0;
    const bh      = boardHeadH();   // ارتفاع .board-head اللاصق
    const gap     = 16;             // المسافة الأنيقة المطلوبة أسفل الشريط

    // خَلّي أعلى البطاقة يبتعد بمقدار gap تحت أسفل الشريط
    const absTop = el.getBoundingClientRect().top + window.pageYOffset;
    const y = Math.max(0, absTop - (headerH + bh + gap));

    window.scrollTo({ top: y, behavior: 'smooth' });

    el.classList.add('flash-card');
    setTimeout(()=> el.classList.remove('flash-card'), 1600);
  });
}



    
    
  
    
    
    

    /* ===== Helpers ===== */
    
  
    
    
   // (جديد) رجّع الكارت الأصلي المخزَّن داخل days اعتمادًا على __day + id
function getMutableCard(viewCard){
  if(!viewCard) return null;
  const dayKey = viewCard.__day || selectedDay;
  const arr = days[dayKey] || [];
  const idx = arr.findIndex(c => c.id === viewCard.id);
  return idx >= 0 ? arr[idx] : null;
}

function addCardNote(viewCard, text){
  if(!viewCard || !text) return false;

  // اشتغل على الأصل داخل days (حتى ينحفظ فعليًا)
  const real = getMutableCard(viewCard);
  if(!real) return false;

  real.notes ||= [];
  // وحّد المرجع مع الكارت المعروض حتى تتحدّث الواجهة فورًا
  viewCard.notes = real.notes;

 const t = nowISO();
real.notes.push({
  id: genId(),
  text,
  at: t,
  updatedAt: t,
  deletedAt: null
});
real.updatedAt = t;


  // حدّث آخر نشاط (يفيد بالفرز حسب updatedAt إن موجود)
  real.updatedAt = new Date().toISOString();

  save();
  return true;
}

function deleteCardNote(viewCard, noteId){
  if(!viewCard) return false;

  const real = getMutableCard(viewCard);
  if(!real || !Array.isArray(real.notes)) return false;

  const i = real.notes.findIndex(n => n.id === noteId);
  if(i === -1) return false;

 const n = real.notes[i];
if(n){
  n.deletedAt = nowISO();
  n.updatedAt = n.deletedAt;
}
real.updatedAt = nowISO();


  // وحّد المرجع مع الكارت المعروض
  viewCard.notes = real.notes;
  save();
  return true;
}


 
 
 
 function stylePayAll(btn, cardRef){
  const allPaidNow = allActivePaid(cardRef);
  if(allPaidNow || cardRef.paidAll){
    btn.classList.remove('primary'); btn.classList.add('ghost');
    btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i><span>إلغاء التسديد</span>';
    btn.title = 'إلغاء تسديد المواد غير الراجعة';
  }else{
    btn.classList.remove('ghost'); btn.classList.add('primary');
    btn.innerHTML = '<i class="fa-solid fa-check-double"></i><span>تسديد الكل</span>';
    btn.title = 'تسديد كل المواد غير الراجعة';
  }
}

 
 
 
    function wrapName(name, cat, badge){
      const box = CE('div');
      box.style.display='flex'; box.style.alignItems='center'; box.style.gap='6px';
      box.append(name, cat); if(badge.textContent) box.appendChild(badge);
      return box;
    }
    function setBadge(el, ln){
      el.textContent = ln.returned ? 'راجع' : (ln.paid ? 'تم التسديد' : '');
      el.style.display = el.textContent ? 'inline-flex' : 'none';
    }
    
    
    
    
    
    /* ===== تنسيقات مساعدة للفلترة ===== */
function pad2(n){ n = String(n); return n.length===1 ? '0'+n : n; }
function fmtDMY(iso){ // 'YYYY-MM-DD' -> 'DD-MM-YYYY'
  if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const [y,m,d] = iso.split('-'); return `${d}-${m}-${y}`;
}
function fmtMY(iso){ // 'YYYY-MM-DD' -> 'MM-YYYY'
  if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const [y,m] = iso.split('-'); return `${m}-${y}`;
}
function getYear(iso){ return /^\d{4}-\d{2}-\d{2}$/.test(iso) ? iso.slice(0,4) : iso; }

/* تحضير مُرشِّح حسب إدخال المستخدم */
function makeFilterPredicate(fraw){
  const f = (fraw||'').trim();
  if(!f) return ()=>true;

  // أنماط مدعومة:
  // 1) DD-MM-YYYY  2) MM-YYYY  3) YYYY
  const dmy = /^(\d{2})-(\d{2})-(\d{4})$/;
  const my  = /^(\d{2})-(\d{4})$/;
  const y   = /^(\d{4})$/;

  if(dmy.test(f)){
    const [_, dd, mm, yyyy] = f.match(dmy);
    const want = `${dd}-${mm}-${yyyy}`;
    return (iso)=> fmtDMY(iso) === want;
  }
  if(my.test(f)){
    const [_, mm, yyyy] = f.match(my);
    const want = `${mm}-${yyyy}`;
    return (iso)=> fmtMY(iso) === want;
  }
  if(y.test(f)){
    const [_, yyyy] = f.match(y);
    return (iso)=> getYear(iso) === yyyy;
  }

  // لو نص حر، نجرّب contains على صيغتنا
  const s = f.toLowerCase();
  return (iso)=> (fmtDMY(iso).toLowerCase().includes(s) ||
                  fmtMY(iso).toLowerCase().includes(s)  ||
                  getYear(iso).toLowerCase().includes(s));
}

    
    
    
    

    /* ===== Rail (تجميع شهري) ===== */


function renderRail(){
  const host = document.getElementById('rail'); host.innerHTML='';

  const allDays = Object.keys(days).sort().reverse();

  // ثبّت TODAY أعلى السكة دائماً حتى لو المستخدم واقف على يوم سابق
  if (!allDays.includes(TODAY)) {
    allDays.unshift(TODAY);
  }

  const fraw = (document.getElementById('dayFilter').value||'').trim();
  const match = makeFilterPredicate(fraw);
  const isFiltering = !!fraw;

  // لو فلترة: نختار الأيام المطابقة فقط
  // لو لا: نطبق سياسة "آخر يومين لكل شهر" و"آخر شهرين لكل سنة"
  let daysToShow = [];

  if(isFiltering){
    daysToShow = allDays.filter(k => match(k));
  }else{
    // نبني شجرة: year -> month -> [days...]
    const tree = {};
    allDays.forEach(k=>{
      const [y,m] = [k.slice(0,4), k.slice(5,7)];
      (tree[y] ||= {});
      (tree[y][m] ||= []);
      tree[y][m].push(k);
    });

    // لكل سنة: أخذ آخر شهرين فقط
    const years = Object.keys(tree).sort().reverse();
    years.forEach(y=>{
      const months = Object.keys(tree[y]).sort().reverse(); // '12','11',...
      const lastTwoMonths = months.slice(0,2);
      lastTwoMonths.forEach(m=>{
        const daysList = tree[y][m].sort().reverse();       // 'YYYY-MM-DD' نزولياً
        const lastTwoDays = daysList.slice(0,2);
        daysToShow.push(...lastTwoDays);
      });
    });

    // تأكد نظل محافظين على الترتيب العام نزولياً
    daysToShow.sort().reverse();
  }

  if(!daysToShow.length){
    host.innerHTML = '<div style="color:#9aa4b2">لا يوجد أيام لعرضها</div>';
    return;
  }

  // نجمع بالشهور (YYYY-MM)
  const groups = {};
  daysToShow.forEach(d=>{
    const key = d.slice(0,7); // YYYY-MM
    (groups[key] ||= []).push(d);
  });

  // نحتاج أيضاً تجميع بالسنة لفرز الأشهر صح
  const monthKeys = Object.keys(groups).sort().reverse(); // '2025-10', '2025-09', ...
  const yearsSet = new Set(monthKeys.map(mk=> mk.slice(0,4)));
  const yearsOrdered = Array.from(yearsSet).sort().reverse();

  yearsOrdered.forEach(yyyy=>{
    // الأشهر التابعة لهذه السنة، بالأحدث أولاً
    const monthsOfYear = monthKeys.filter(mk => mk.startsWith(yyyy+'-')).sort().reverse();

    monthsOfYear.forEach(monthKey=>{
      const monthBox = CE('div','month');

      const mTitle = CE('div','month-title');
      const niceMonth = arMonthName(monthKey+'-01');
     
     const mCount = groups[monthKey].reduce((n,k)=> n + activeCardsOfDay(k).length, 0);

     
      mTitle.innerHTML = `<span>${niceMonth}</span><span class="mchip">${mCount} بطاقة</span>`;
      monthBox.appendChild(mTitle);

      // الأيام داخل هذا الشهر
      const daysInMonth = groups[monthKey].sort().reverse();
      daysInMonth.forEach(k=>{
        const row = CE('div','day'+(k===selectedDay?' active':'')); 
       row.innerHTML = `
  <div class="title">${arDateWithDay(k)}</div>
  <div class="meta">${activeCardsOfDay(k).length} بطاقة</div>
`;

       
      row.onclick = ()=>{
  selectedDay = k;
  renderBoard();
  renderRail();      // <-- أضفها حتى يتأشر اليوم المختار
  refreshStats();
  // لا تحدّث الهيدر هنا حتى يبقى ثابت على TODAY
  // document.getElementById('dateBadge').textContent = arDateWithDay(selectedDay);
};
       
       
        monthBox.appendChild(row);
      });

      host.appendChild(monthBox);
    });
  });
}



    document.getElementById('dayFilter').addEventListener('input', renderRail);
    document.getElementById('cardSearch').addEventListener('input', renderBoard);
    document.getElementById('btnExportLocal')?.addEventListener('click', exportInvoices);

  
  
   document.getElementById('globalSearch')?.addEventListener('change', ()=>{
  globalLimit = 20;     // رجّع الحد للبداية كل ما تبدّل وضع البحث الشامل
  renderBoard();
});



    /* ===== Stats ===== */
function refreshStats(){
  // بطاقات اليوم الفعّالة
  const cardsArr = activeCardsOfDay(selectedDay);

  // عدد المواد الفعّالة
  const itemsCount = cardsArr.reduce((n, c) =>
    n + (c.lines || []).filter(l => !l.deletedAt).length, 0
  );

  // مجاميع مالية
  const totals = cardsArr.reduce((acc, c) => {
    const s = sumCardAmounts(c); // { total, unpaid, paid, returned }
    acc.total    += s.total;
    acc.unpaid   += s.unpaid;
    acc.paid     += s.paid;
    acc.returned += s.returned;
    return acc;
  }, { total:0, unpaid:0, paid:0, returned:0 });

  // تحديث العدادين الأساسيين
  const setTxt = (id, v)=>{ const el = document.getElementById(id); if(el) el.textContent = v; };
  setTxt('statCards', String(cardsArr.length));
  setTxt('statItems', String(itemsCount));
  setTxt('statTime',  new Date().toLocaleTimeString('ar-EG'));

  // الحاوية الرئيسية
  const insights = document.querySelector('.insights');
  if(!insights) return;

  // --- نحدد العنوان كنقطة ارتكاز ثم ننشئ جسمًا بعده ---
  const titleEl = insights.querySelector('.insights__title, .section-title, h3, h2, h1');
  let body = document.getElementById('insightsBody');
  if(!body){
    body = document.createElement('div');
    body.id = 'insightsBody';
    if(titleEl && titleEl.after) titleEl.after(body);
    else insights.prepend(body); // احتياط
  }

  // ===== صندوق الإحصائيات السريعة (عدد البطاقات/المواد/آخر تحديث) =====
  let quick = document.getElementById('quickStats');
  if(!quick){
    quick = document.createElement('div');
    quick.id = 'quickStats';
    quick.className = 'money--compact';
    body.appendChild(quick);
  }
  quick.innerHTML = `
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-layer-group"></i> عدد البطاقات</span>
      <span class="mval">${cardsArr.length}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-boxes-stacked"></i> عدد المواد</span>
      <span class="mval">${itemsCount}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-regular fa-clock"></i> آخر تحديث</span>
      <span class="mval">${new Date().toLocaleTimeString('ar-EG')}</span>
    </div>
  `;

  // ===== صندوق المال المضغوط =====
  let box = document.getElementById('moneyStats');
  if(!box){
    box = document.createElement('div');
    box.id = 'moneyStats';
    box.className = 'money--compact';
    body.appendChild(box);
    
    
    
    // ===== صندوق ملخّصات إضافية (تحت إجمالي اليوم) =====
let extra = document.getElementById('extraStats');
if (!extra) {
  extra = document.createElement('div');
  extra.id = 'extraStats';
  extra.className = 'money--compact';
  body.appendChild(extra); // body هو insightsBody نفسه (موجود فوق)
}

// مساعدات آمنة
const F = (v)=> (typeof formatIQD === 'function' ? formatIQD(v || 0) : (v||0).toLocaleString('ar-IQ'));
const N = (v)=> (v||0).toLocaleString('ar-EG');

// حسابات سريعة (موجودة عندك أصلاً فوق)
const cardsCount  = Array.isArray(cardsArr) ? cardsArr.length : 0;
const avgPerCard  = cardsCount ? (totals.total / cardsCount) : 0;
const avgPerItem  = (itemsCount ? (totals.total / itemsCount) : 0);

// بطاقات فيها دين (غير مدفوعة كليًا)
const withUnpaidCount = (Array.isArray(cardsArr) ? cardsArr.filter(c => {
  const s = typeof sumCardAmounts==='function' ? sumCardAmounts(c) : {unpaid:0};
  return (s.unpaid||0) > 0;
}).length : 0);

// أول/آخر وقت عملية (تقريبي من خطوط الكروت)
function getFirstLastTime(arr){
  try{
    const all = arr.flatMap(c => (c.lines||[]))
                   .filter(l => !l.deletedAt && l.at)
                   .map(l => new Date(l.at).getTime())
                   .sort((a,b)=>a-b);
    if(!all.length) return {first:'—', last:'—'};
    const fmt = (ts)=> new Date(ts).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
    return { first: fmt(all[0]), last: fmt(all[all.length-1]) };
  }catch{ return {first:'—', last:'—'} }
}
const span = getFirstLastTime(Array.isArray(cardsArr)?cardsArr:[]);

extra.innerHTML = `
  <div class="mrow">
    <span class="mlabel"><i class="fa-solid fa-receipt"></i> متوسّط الفاتورة</span>
    <span class="mval">${F(avgPerCard)}</span>
  </div>
  
  <div class="mrow">
    <span class="mlabel"><i class="fa-regular fa-rectangle-list"></i> فواتير فيها دين</span>
    <span class="mval mval--unpaid">${N(withUnpaidCount)}</span>
  </div>
  
`;

    
    
    
  }

  const F = (v)=> formatIQD(v || 0);

  box.innerHTML = `
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-sack-dollar"></i> إجمالي اليوم</span>
      <span class="mval">${F(totals.total)}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-regular fa-circle-check"></i> مدفوع</span>
      <span class="mval mval--paid">${F(totals.paid)}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-regular fa-clock"></i> غير مدفوع</span>
      <span class="mval mval--unpaid">${F(totals.unpaid)}</span>
    </div>
    <div class="mrow">
      <span class="mlabel"><i class="fa-solid fa-rotate-left"></i> راجع</span>
      <span class="mval mval--ret">${F(totals.returned)}</span>
    </div>
  `;
  
}







    /* ===== Actions ===== */
   
  document.getElementById('btnClearDay').onclick  = async ()=>{
  const ok = await showConfirm({
    title:'تفريغ اليوم',
    message:`سيتم حذف جميع بطاقات يوم ${arDateWithDay(selectedDay)}.`,
    okText:'تفريغ اليوم',
    cancelText:'إلغاء',
    danger:true
  });
  if(!ok) return;

  const now = nowISO();
  const arr = days[selectedDay] || [];

  arr.forEach(card=>{
    if(card){
      card.deletedAt = now;
      card.updatedAt = now;

      (card.lines || []).forEach(l=>{
        l.deletedAt = now;
        l.updatedAt = now;
      });
      (card.notes || []).forEach(n=>{
        n.deletedAt = now;
        n.updatedAt = now;
      });
    }
  });

  // لا تصفّر المصفوفة — خلّ التومبستونات تنسجّم مع الدمج
  save(); renderBoard(); renderRail(); refreshStats();
  showToast('error', 'تم تعليم كل بطاقات اليوم كمحذوفة');
};


   
   
   
// كسر الكاش + عرض شاشة التحديث قبل الرِيلود
function hardReload(){
  const url = new URL(location.href);
  url.searchParams.set('_ts', Date.now());
  location.replace(url.toString());
}

// نصائح بسيطة تتبدّل أثناء التحديث
const RELOAD_TIPS = [
  'نرتّب لك البيانات…',
  'نحفظ آخر التغييرات…',
  'نحدّث الواجهة…',
  'ثواني ونرجع لك…'
];

// فتح نافذة التحديث وبدء الأنيميشن
function showReloadOverlay(){
  const el = document.getElementById('reloader');
  if(!el) return;
  el.classList.add('active');

  // صفر الشريط والنسبة
  const bar = document.getElementById('reloadBar');
  const pct = document.getElementById('splashPct');
  const tip = document.getElementById('reloadTip');
  if(bar) bar.style.width = '0%';
  if(pct) pct.textContent = '0%';
  if(tip) tip.textContent = RELOAD_TIPS[0] || 'جارٍ التحديث…';
}

// إخفاء النافذة (في حال احتجت)
function hideReloadOverlay(){
  const el = document.getElementById('reloader');
  if(!el) return;
  el.classList.remove('active');
}

// أنيميشن نسبة + شريط، بعدها نعمل Reload
function animateReloadAndGo(totalMs = 1400){
  const bar = document.getElementById('reloadBar');
  const pct = document.getElementById('splashPct');
  const tip = document.getElementById('reloadTip');

  const start = performance.now();
  let tipIdx = 0;

  function step(now){
    const t = Math.min(1, (now - start) / totalMs);
    const eased = 1 - Math.pow(1 - t, 2); // ease-out
    const val = Math.floor(eased * 100);

    if(bar) bar.style.width = val + '%';
    if(pct) pct.textContent = val + '%';

    // بدّل النص كل ~450ms
    const newTipIdx = Math.min(RELOAD_TIPS.length - 1, Math.floor((now - start) / 450));
    if(tip && newTipIdx !== tipIdx){
      tipIdx = newTipIdx;
      tip.textContent = RELOAD_TIPS[tipIdx];
    }

    if(t < 1){
      requestAnimationFrame(step);
    }else{
      // بعد الاكتمال: ريفرش قاسي مع كسر كاش
      hardReload();
    }
  }
  requestAnimationFrame(step);
}



// استدعاء من زر التحديث
function refreshWithOverlay(){
  showReloadOverlay();
  animateReloadAndGo(1600, 300); // تقدر تغيّر المدة (ms)
}

// ربط الزر
document.getElementById('btnRefresh')?.addEventListener('click', refreshWithOverlay);







/* ===== اقتراحات اسم الزبون (تطلع فوق + 8 مرئية + Scroll) ===== */
let __custIdx = -1;

function getAllCustomers(){
  return Array.isArray(CUSTOMERS) ? [...CUSTOMERS] : [];
}


function renderCustSuggestions(){
  const host = document.getElementById('custSuggestions');
  const inp  = document.getElementById('cust');
  if(!host || !inp) return;

  const q = String(inp.value||'').trim().toLowerCase();
  const all = getAllCustomers();

  // ماكو كتابة → لا تعرض شي
  if(!q){
    host.innerHTML = '';
    host.style.display = 'none';
    __custIdx = -1;
    return;
  }

  // فلترة بسيطة
  const data = all.filter(n => n.toLowerCase().includes(q));

  host.innerHTML = '';
  __custIdx = -1;

  data.forEach(name=>{
    const li = document.createElement('li');
    li.className = 'sugg-item';
    li.textContent = name;
    li.onclick = ()=>{
      inp.value = name;
      hideCustSuggestions();
      // بعد الاختيار: روّح على نوع الفاتورة
      const target = document.getElementById('type');
      target && (target.focus(), typeof target.showPicker==='function' && target.showPicker());
    };
    host.appendChild(li);
  });

  host.style.display = data.length ? 'block' : 'none';
}


function hideCustSuggestions(){
  const host = document.getElementById('custSuggestions');
  if(host){ host.style.display = 'none'; __custIdx = -1; }
}

function getCustLis(){
  const host = document.getElementById('custSuggestions');
  return host ? Array.from(host.querySelectorAll('li')) : [];
}

function highlightCustItem(){
  const items = getCustLis();
  items.forEach((li,i)=> li.style.background = (i===__custIdx) ? '#0e1b36' : 'transparent');
  if(__custIdx >= 0 && items[__custIdx]){
    items[__custIdx].scrollIntoView({ block:'nearest' });
  }
}

// فتح أثناء الكتابة/الفوكس/الضغط
document.getElementById('cust')?.addEventListener('input',  renderCustSuggestions);
document.getElementById('btnExportDay').onclick = exportDayPDF_Vector;



// تنقّل الكيبورد داخل قائمة الزبائن
document.getElementById('cust')?.addEventListener('keydown', (e)=>{
  const host = document.getElementById('custSuggestions');
  const inp  = document.getElementById('cust');
  const visible = host && host.style.display === 'block';
  const hasQuery = !!String(inp.value||'').trim();

  // إذا الاقتراحات مو ظاهرة:
  if(!visible){
    // إذا ضغط Enter بدون كتابة → امشِ على "نوع الفاتورة" مباشرة
    if(e.key === 'Enter' && !hasQuery){
      e.preventDefault();
      const target = document.getElementById('type');
      if(target){
        target.focus();
        if(typeof target.showPicker==='function') target.showPicker();
      }
      return;
    }

    // إذا Down/Up/Enter ومعك كتابة → افتح الاقتراحات
    if((e.key==='ArrowDown' || e.key==='ArrowUp' || e.key==='Enter') && hasQuery){
      e.preventDefault();
      renderCustSuggestions();
    }
    return;
  }

  // الاقتراحات ظاهرة: تنقل واختيار
  const items = getCustLis();
  if(!items.length) return;

  if(e.key === 'ArrowDown'){
    e.preventDefault();
    __custIdx = (__custIdx < 0) ? 0 : Math.min(items.length - 1, __custIdx + 1);
    highlightCustItem();
  }else if(e.key === 'ArrowUp'){
    e.preventDefault();
    __custIdx = (__custIdx < 0) ? items.length - 1 : Math.max(0, __custIdx - 1);
    highlightCustItem();
  }else if(e.key === 'Enter'){
    e.preventDefault();
    if(__custIdx >= 0) items[__custIdx].click();
  }else if(e.key === 'Escape'){
    e.preventDefault();
    hideCustSuggestions();
  }
});


// إغلاق إذا نقرّت برّه
document.addEventListener('click', (ev)=>{
  const host = document.getElementById('custSuggestions');
  const field= document.getElementById('cust');
  if(!host || !field) return;
  const inside = host.contains(ev.target) || field.contains(ev.target);
  if(!inside) hideCustSuggestions();
});



/* ==== Helper: HTML Escaper (للاحتياط لو احتجت نص داخل template) ==== */
function escHtml(s){
  return String(s||'')
   .replace(/&/g,'&amp;').replace(/</g,'&lt;')
   .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ===== تصدير كل بطاقات اليوم إلى PDF (محدّثة) =====
function exportDayPDF_Vector(){
  // نضمن آخر رسم
  renderBoard();

  // ✅ استبعاد البطاقات المحذوفة فقط (تغيير وحيد)
  const source = (days[selectedDay] || []);
  const cards  = source.filter(c => !c?.deletedAt);

  if(!cards.length){ showToast('warn','ماكو بطاقات اليوم للتصدير'); return; }

  const dateStr = document.getElementById('dateBadge')?.textContent || '';

  // نحضر بايلود + نمرر قائمة الزبائن المعروفة
  const payload = { dateStr, cards, known: CUSTOMERS || [] };

  const w = window.open('', '_blank');
  if(!w){ showToast('error','المتصفح منع فتح نافذة الطباعة'); return; }

  const title = 'فواتير ديون — مكتب عسل';
  const payloadJSON = JSON.stringify(payload).replace(/</g,'\\u003C'); // أمان بسيط

  w.document.write(`
    <!DOCTYPE html><html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title>${title}</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
      <style>
        :root{ --ink:#111827; --muted:#6b7280; --stroke:#e5e7eb; }
        html,body{ margin:0; padding:0; font-family:"Cairo",system-ui; color:var(--ink); }
        .wrap{ padding:18px; }
        .head{
          display:flex; align-items:center; justify-content:space-between;
          border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; margin-bottom:14px;
          background:#fafafa;
        }
        .title{ font-weight:900; }
        .date{ font-size:12px; color:var(--muted); }
        .card{
          border:1px solid var(--stroke); border-radius:12px; padding:10px; margin-bottom:10px;
          page-break-inside: avoid;
        }
        .card-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .cust{ font-weight:900; font-size:16px; display:flex; align-items:center; gap:8px; }
        .tag{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--stroke); color:#374151; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border:1px solid var(--stroke); padding:6px 8px; font-size:12.5px; }
        th{ background:#f5f5f5; text-align:center; }
        td{ vertical-align:top; }
        .center{ text-align:center; }
        .right{ text-align:right; }

        /* ===== خط على اسم المادة حسب الحالة ===== */
        .nm.return{ text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color:#b91c1c; }
        .nm.paid  { text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color:#065f46; }

        /* ===== بادج زبون جديد ===== */
        .badge-new{
          font-size:11px;
          padding:2px 8px;
          border-radius:999px;
          border:1px solid rgba(127,29,29,.55);
          background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
          color:#fecaca;
          box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
        }

        /* ===== Notes block (للطباعة) ===== */
        .notes{ margin-top:8px; border:1px solid var(--stroke); border-radius:10px; }
        .notes__head{
          display:flex; align-items:center; justify-content:space-between;
          background:#f5f5f5; padding:6px 10px; border-bottom:1px solid var(--stroke);
          font-weight:900;
        }
        .notes__list{ padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
        .note{
          display:flex; align-items:center; gap:8px;
          border:1px solid var(--stroke); border-radius:10px; padding:6px 10px;
        }
        .note__idx{
          font-weight:900; font-size:12px; min-width:28px; text-align:center;
          border:1px solid var(--stroke); border-radius:999px; padding:2px 6px; background:#fff;
        }
        .note__text{ flex:1; }
        .note__time{ font-size:11px; color:#6b7280; white-space:nowrap; }

        @media print{ .card{ break-inside: avoid; } }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="head">
          <div class="title">${title}</div>
          <div id="dateHolder" class="date"></div>
        </div>
        <div id="printCards"></div>
      </div>
      <script>
        // نفس مُنسّق السعر المُستخدم بالكروت
        function formatIQD(v){
          const n = Number(String(v||'').replace(/[^\\d.]/g,''));
          if(!Number.isFinite(n)) return '';
          return n.toLocaleString('en-US');
        }

        // البيانات المحقونة
        const PAYLOAD = ${payloadJSON};

        (function(){
          const host = document.getElementById('printCards');
          document.getElementById('dateHolder').textContent = PAYLOAD.dateStr || '';
          const KNOWN = Array.isArray(PAYLOAD.known) ? PAYLOAD.known : [];

          const cards = PAYLOAD.cards || [];
          if(!cards.length){ host.innerHTML = '<div>لا توجد بطاقات اليوم</div>'; return; }

          function arTime(d){ return new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}); }

          cards.forEach(card=>{
            const box = document.createElement('div');
            box.className = 'card';

            const head = document.createElement('div');
            head.className = 'card-head';

            const left = document.createElement('div');
            left.className = 'cust';

            // اسم الزبون
            const nm = document.createElement('span');
            nm.textContent = card.customer || '';
            left.appendChild(nm);

            // بادج زبون جديد إذا مو موجود بالمصفوفة
            if(card.customer && !KNOWN.includes(card.customer)){
              const nb = document.createElement('span');
              nb.className = 'badge-new';
              nb.textContent = 'زبون جديد';
              left.appendChild(nb);
            }

            const right = document.createElement('div');
            const type = card.billType || (()=>{
              const ts = Array.from(new Set((card.lines||[]).map(l=>l.type)));
              return (ts.length===1) ? ts[0] : 'مختلط';
            })();
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = (type==='راجع') ? 'فاتورة راجع' : (type==='بيع') ? 'فاتورة بيع' : 'فاتورة مختلطة';
            right.appendChild(tag);

            head.append(left,right);
            box.appendChild(head);

            const tbl = document.createElement('table');
            tbl.innerHTML = \`
              <thead>
                <tr>
                  <th>الصنف</th>
                  <th>اسم المادة</th>
                  <th>السعر</th>
                  <th>العدد</th>
                  <th>ملاحظات</th>
                  <th>الوقت</th>
                  <th>الحالة</th>
                </tr>
              </thead>
              <tbody></tbody>\`;
            const tbody = tbl.querySelector('tbody');

            (card.lines||[]).filter(ln=>!ln.deletedAt).forEach(ln=>{
              const tr = document.createElement('tr');
              const isReturned = !!ln.returned;
              const isPaid     = !!ln.paid;
              const state = isReturned ? 'راجع' : (isPaid ? 'مدفوع' : '');
              const price = (ln.price === 0 || ln.price) ? (formatIQD(ln.price) || '—') : '—';

              const nmClass = isReturned ? 'return' : (isPaid ? 'paid' : '');
              const nameHTML = \`<span class="nm \${nmClass}">\${ln.item || ''}</span>\`;

              tr.innerHTML = \`
                <td class="center">\${ln.cat || '—'}</td>
                <td class="center">\${nameHTML}</td>
                <td class="center">\${price}</td>
                <td class="center">× \${ln.qty || '1'}</td>
                <td class="center">\${(ln.note && ln.note.trim()) ? ln.note : '—'}</td>
                <td class="center">\${arTime(ln.at || ln.createdAt || ln.updatedAt)}</td>
                <td class="center">\${state}</td>\`;
              tbody.appendChild(tr);
            });

            box.appendChild(tbl);

            // ===== Notes (إن وُجدت) =====
            (function(){
              const arr = Array.isArray(card.notes)
                ? card.notes
                    .filter(n => !n.deletedAt)
                    .slice()
                    .sort((a,b)=> new Date(b.at || b.updatedAt || 0) - new Date(a.at || a.updatedAt || 0))
                : [];
              if(!arr.length) return;

              const notes = document.createElement('div');
              notes.className = 'notes';

              const head = document.createElement('div');
              head.className = 'notes__head';
              head.innerHTML = \`<span>الملاحظات</span><span>\${arr.length}</span>\`;

              const list = document.createElement('div');
              list.className = 'notes__list';

              const tinyTime = (d)=> new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});

              arr.forEach((n, i)=>{
                const row = document.createElement('div');
                row.className = 'note';

                const idx = document.createElement('div');
                idx.className = 'note__idx';
                idx.textContent = \`#\${i+1}\`;

                const text = document.createElement('div');
                text.className = 'note__text';
                text.textContent = n.text || '';

                const when = document.createElement('div');
                when.className = 'note__time';
                when.textContent = tinyTime(n.at || Date.now());

                row.append(idx, text, when);
                list.appendChild(row);
              });

              notes.append(head, list);
              box.appendChild(notes);
            })();

            host.appendChild(box);
          });

          setTimeout(function(){ window.focus(); window.print(); }, 200);
        })();
      <\/script>
    </body></html>
  `);

  w.document.close();
  showToast('success','جاهز للطباعة — اختر "حفظ كـ PDF"');
}




// ===== تصدير بطاقة واحدة إلى PDF (محدّثة) =====
function exportCardPDF_Vector(card, dayKey){
  if(!card || !card.lines || !card.lines.length){
    showToast('warn','هاي البطاقة فارغة');
    return;
  }

  const theDayISO = dayKey || card.__day || selectedDay;
  const dateStr = (function(iso){
    try{
      return new Date(iso).toLocaleDateString('ar-EG',{weekday:'long',year:'numeric',month:'2-digit',day:'2-digit'});
    }catch{ return document.getElementById('dateBadge')?.textContent || ''; }
  })(theDayISO);

  // نمرر كذلك known: CUSTOMERS
  const payload = { dateStr, card, known: CUSTOMERS || [] };

  const w = window.open('', '_blank');
  if(!w){ showToast('error','المتصفح منع فتح نافذة الطباعة'); return; }

  const title = 'فاتورة ديون — مكتب عسل';
  const payloadJSON = JSON.stringify(payload).replace(/</g,'\\u003C');

  w.document.write(`
    <!DOCTYPE html><html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title>${title}</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
      <style>
        :root{ --ink:#111827; --muted:#6b7280; --stroke:#e5e7eb; }
        html,body{ margin:0; padding:0; font-family:"Cairo",system-ui; color:var(--ink); }
        .wrap{ padding:18px; }
        .head{
          display:flex; align-items:center; justify-content:space-between;
          border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; margin-bottom:14px;
          background:#fafafa;
        }
        .title{ font-weight:900; }
        .date{ font-size:12px; color:var(--muted); }
        .card{
          border:1px solid var(--stroke); border-radius:12px; padding:10px; margin-bottom:10px;
          page-break-inside: avoid;
        }
        .card-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .cust{ font-weight:900; font-size:16px; display:flex; align-items:center; gap:8px; }
        .tag{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--stroke); color:#374151; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border:1px solid var(--stroke); padding:6px 8px; font-size:12.5px; }
        th{ background:#f5f5f5; text-align:center; }
        td{ vertical-align:top; }
        .center{ text-align:center; }
        .right{ text-align:right; }

        /* ===== خط على اسم المادة حسب الحالة ===== */
        .nm.return{ text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color:#b91c1c; }
        .nm.paid  { text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color:#065f46; }

        /* ===== بادج زبون جديد ===== */
        .badge-new{
          font-size:11px;
          padding:2px 8px;
          border-radius:999px;
          border:1px solid rgba(127,29,29,.55);
          background:linear-gradient(180deg,#7f1d1d,#4c0b0b);
          color:#fecaca;
          box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
        }

        /* ===== Notes block (للطباعة) ===== */
        .notes{ margin-top:8px; border:1px solid var(--stroke); border-radius:10px; }
        .notes__head{
          display:flex; align-items:center; justify-content:space-between;
          background:#f5f5f5; padding:6px 10px; border-bottom:1px solid var(--stroke);
          font-weight:900;
        }
        .notes__list{ padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
        .note{
          display:flex; align-items:center; gap:8px;
          border:1px solid var(--stroke); border-radius:10px; padding:6px 10px;
        }
        .note__idx{
          font-weight:900; font-size:12px; min-width:28px; text-align:center;
          border:1px solid var(--stroke); border-radius:999px; padding:2px 6px; background:#fff;
        }
        .note__text{ flex:1; }
        .note__time{ font-size:11px; color:#6b7280; white-space:nowrap; }

        @media print{ .card{ break-inside: avoid; } }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="head">
          <div class="title">${title}</div>
          <div id="dateHolder" class="date"></div>
        </div>
        <div id="printCard"></div>
      </div>
      <script>
        // نفس مُنسّق السعر المُستخدم بالكروت
        function formatIQD(v){
          const n = Number(String(v||'').replace(/[^\\d.]/g,''));
          if(!Number.isFinite(n)) return '';
          return n.toLocaleString('en-US');
        }

        const PAYLOAD = ${payloadJSON};

        (function(){
          document.getElementById('dateHolder').textContent = PAYLOAD.dateStr || '';
          const KNOWN = Array.isArray(PAYLOAD.known) ? PAYLOAD.known : [];

          const host = document.getElementById('printCard');
          const card = PAYLOAD.card;

          const box = document.createElement('div');
          box.className = 'card';

          const head = document.createElement('div');
          head.className = 'card-head';

          const left = document.createElement('div');
          left.className = 'cust';

          // اسم الزبون
          const nm = document.createElement('span');
          nm.textContent = card.customer || '';
          left.appendChild(nm);

          // بادج زبون جديد إذا مو معروف
          if(card.customer && !KNOWN.includes(card.customer)){
            const nb = document.createElement('span');
            nb.className = 'badge-new';
            nb.textContent = 'زبون جديد';
            left.appendChild(nb);
          }

          const right = document.createElement('div');
          const type = card.billType || (()=>{
            const ts = Array.from(new Set((card.lines||[]).map(l=>l.type)));
            return (ts.length===1) ? ts[0] : 'مختلط';
          })();
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = (type==='راجع') ? 'فاتورة راجع' : (type==='بيع') ? 'فاتورة بيع' : 'فاتورة مختلطة';
          right.appendChild(tag);

          head.append(left,right);
          box.appendChild(head);

          const tbl = document.createElement('table');
          tbl.innerHTML = \`
            <thead>
              <tr>
                <th>الصنف</th>
                <th>اسم المادة</th>
                <th>السعر</th>
                <th>العدد</th>
                <th>ملاحظات</th>
                <th>الوقت</th>
                <th>الحالة</th>
              </tr>
            </thead>
            <tbody></tbody>\`;
          const tbody = tbl.querySelector('tbody');

          function arTime(d){ return new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}); }

         (card.lines||[]).filter(ln=>!ln.deletedAt).forEach(ln=>{
            const tr = document.createElement('tr');
            const isReturned = !!ln.returned;
            const isPaid     = !!ln.paid;
            const state = isReturned ? 'راجع' : (isPaid ? 'مدفوع' : '');
            const price = (ln.price === 0 || ln.price) ? (formatIQD(ln.price) || '—') : '—';

            const nmClass = isReturned ? 'return' : (isPaid ? 'paid' : '');
            const nameHTML = \`<span class="nm \${nmClass}">\${ln.item || ''}</span>\`;

            tr.innerHTML = \`
              <td class="center">\${ln.cat || '—'}</td>
              <td class="center">\${nameHTML}</td>
              <td class="center">\${price}</td>
              <td class="center">× \${ln.qty || '1'}</td>
              <td class="center">\${(ln.note && ln.note.trim()) ? ln.note : '—'}</td>
              <td class="center">\${arTime(ln.at || ln.createdAt || ln.updatedAt)}</td>
              <td class="center">\${state}</td>\`;
            tbody.appendChild(tr);
          });

          box.appendChild(tbl);

          // ===== Notes (إن وُجدت) =====
          (function(){
           const arr = Array.isArray(card.notes)
  ? card.notes
      .filter(n => !n.deletedAt)
      .slice()
      .sort((a,b)=> new Date(b.at || b.updatedAt || 0) - new Date(a.at || a.updatedAt || 0))
  : [];
if(!arr.length) return;


            const notes = document.createElement('div');
            notes.className = 'notes';

            const head = document.createElement('div');
            head.className = 'notes__head';
            head.innerHTML = \`<span>الملاحظات</span><span>\${arr.length}</span>\`;

            const list = document.createElement('div');
            list.className = 'notes__list';

            const tinyTime = (d)=> new Date(d).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});

            arr.forEach((n, i)=>{
              const row = document.createElement('div');
              row.className = 'note';

              const idx = document.createElement('div');
              idx.className = 'note__idx';
              idx.textContent = \`#\${i+1}\`;

              const text = document.createElement('div');
              text.className = 'note__text';
              text.textContent = n.text || '';

              const when = document.createElement('div');
              when.className = 'note__time';
              when.textContent = tinyTime(n.at || Date.now());

              row.append(idx, text, when);
              list.appendChild(row);
            });

            notes.append(head, list);
            box.appendChild(notes);
          })();

          host.appendChild(box);

          setTimeout(function(){ window.focus(); window.print(); }, 200);
        })();
      <\/script>
    </body></html>
  `);

  w.document.close();
  showToast('success','جاهز لطباعة البطاقة — اختر "حفظ كـ PDF"');
}










// ربط الأزرار والملف
const btnExportAll = document.getElementById('btnExportAll');
const btnImportAll = document.getElementById('btnImportAll');
const importInput  = document.getElementById('importFile');

document.getElementById('btnNextDay')?.addEventListener('click', openNextDayFromToday);

// التصدير الآن يرفع إلى السيرفر (ويب آب)
btnExportAll && (btnExportAll.onclick = smartExportToServer);

// الاستيراد يجي من السيرفر مباشرة
btnImportAll && (btnImportAll.onclick = smartImportFromServer);

// إذا بعدها تريد تحتفظ بخيار الاستيراد من ملف يدوي (زر مخفي أو منيو)
// خلِّه مثل ما هو: importInput.onclick… و importInvoicesFromFile(file)


importInput && (importInput.onchange = (e) => {
  const file = e.target.files?.[0];
  if(file) importInvoicesFromFile(file);
  e.target.value = ''; // حتى تقدر تختار نفس الملف مرة ثانية
});





// --- ضعها قبل exportInvoices() ---
function prepareCleanPayload(daysObj, namesArr){
  const cleanDays = {};
  for (const [dayKey, cards] of Object.entries(daysObj || {})) {
    const activeCards = (cards || [])
      .filter(c => !c?.deletedAt)
      .map(c => ({
        ...c,
        lines: (c.lines || []).filter(l => !l?.deletedAt),
        notes: (c.notes || []).filter(n => !n?.deletedAt)
      }))
      .sort((a,b)=> new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0));
    if (activeCards.length) cleanDays[dayKey] = activeCards;
  }

  // الأسماء الفعّالة فقط (الموجودة فعلاً ببطاقات فعّالة)
  const allowedNames = new Set();
  for (const cards of Object.values(cleanDays)) {
    for (const c of cards) if (c.customer) allowedNames.add(String(c.customer).trim());
  }
  const cleanNames = (namesArr || []).filter(n => allowedNames.has(String(n).trim()));

  return {
    version: 3,
    exportedAt: new Date().toISOString(),
    days: cleanDays,
    names: cleanNames
  };
}









function isActiveCard(card){
  if (!card || card.deletedAt) return false;
  const lines = Array.isArray(card.lines) ? card.lines.filter(l => !l.deletedAt) : [];
  return lines.length > 0; // لازم بيه مواد فعلية
}


// ===== تصدير/استيراد كل الفواتير (JSON) =====

// يبقي بس البيانات الفعّالة (غير محذوفة)
// يبقي بس البطاقات التي تحتوي أسطر فعّالة (الملاحظات لا تكفي لوحدها)
function compactDaysForExport(srcDays){
  const out = {};
  for (const [day, cards] of Object.entries(srcDays || {})) {
    const kept = [];
    for (const c of (cards || [])) {
      if (c?.deletedAt) continue;

      const lines = (c.lines || []).filter(l => !l?.deletedAt);
      if (lines.length === 0) continue; // <-- هنا التغيير: تجاهل أي بطاقة بلا أسطر

      // الملاحظات نضمّنها فقط كمعلومات إضافية، لكنها ما تأثر على قرار الإبقاء
      const notes = (c.notes || []).filter(n => !n?.deletedAt);

      const copy = {
        id       : c.id,
        customer : c.customer,
        createdAt: c.createdAt,
        updatedAt: c.updatedAt,
        paidAll  : !!c.paidAll,
        billType : c.billType,
        lines,
        notes
      };
      delete copy.deletedAt;
      kept.push(copy);
    }
    if (kept.length) out[day] = kept;
  }
  return out;
}






// ===== (اختياري) تنظيف محلي مرّة واحدة =====
// يشيل أي بطاقة ما بيها ولا سطر فعّال، حتى لو عدها ملاحظات
function cleanupLocalOnce(){
  if (!days || typeof days !== 'object') return 0;

  let changes = 0;
  const hasActiveLine = (card)=> (card.lines||[]).some(l => !l.deletedAt);

  Object.keys(days).forEach(dayKey=>{
    const arr = Array.isArray(days[dayKey]) ? days[dayKey] : [];
    const kept = arr.filter(hasActiveLine);
    changes += (arr.length - kept.length);
    if (kept.length) days[dayKey] = kept;
    else { delete days[dayKey]; changes++; }
  });

  save?.(); renderBoard?.(); renderRail?.(); refreshStats?.();
  showToast?.('success', changes ? `تم تنظيف ${changes} عنصر قديم` : 'لا يوجد شيء للتنظيف');
  return changes;
}






function cleanupEmptyCardsOnce(){
  let changed = 0;
  for(const [day, cards] of Object.entries(days || {})){
    const before = (cards || []).length;
    const afterArr = (cards || []).filter(isActiveCard);
    if (afterArr.length !== before){
      days[day] = afterArr;
      changed++;
    }
  }
  if (changed){
    save();
    renderBoard(); renderRail(); refreshStats();
    showToast('success', `تنظيف تم: ${changed} يوم تغيّر`);
  }else{
    showToast('info','ماكو شي يحتاج تنظيف');
  }
}
// نادِها يدويًا من الكونسول إذا تريد: cleanupEmptyCardsOnce()




// تصدير محلي نظيف: بدون تومبستونات + أسماء من CUSTOMERS فقط
function exportInvoices(){
  try{
    const payload = {
      version   : 3,
      mode      : "clean", // علم يفيد بالاستيراد
      exportedAt: new Date().toISOString(),
      days      : compactDaysForExport(days || {}),
      names     : Array.from(CUSTOMERS) // أو [] إذا ما تريدها
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const d = new Date().toISOString().slice(0,10);
    a.download = `assal-bills-backup-${d}.json`;
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
    showToast?.('success','تم تصدير الفواتير كـ JSON (نظيف)');
  }catch(err){
    console.error(err);
    showToast?.('error','تعذّر التصدير');
  }
}







async function importInvoicesFromFile(file){
  if(!file) return;
  try{
    const text = await file.text();
    let data = JSON.parse(text);

    // هيّئ بيانات الملف بنمط موحّد
    let fileDays  = {};
    let fileNames = [];
    if(data && typeof data === 'object'){
      if(data.days){            // فورمات جديد {version, days, names, ...}
        fileDays  = data.days || {};
        fileNames = data.names || [];
      }else{                    // فورمات قديم: كائن أيام مباشرة
        fileDays  = data;
      }
    }else{
      showToast?.('error','ملف غير صالح');
      return;
    }

    // دمج قوي: المحلي × الملف
    const localDays = days || {};
    const { days: mergedDays, report } = mergeAllDays(localDays, fileDays);


    // خزّن النتيجة المدموجة
    localStorage.setItem(STORAGE, JSON.stringify(mergedDays));

    // الأسماء: دمج بسيط (مجموعة)
    const curNames = Array.isArray(names) ? names : [];
    const newNames = Array.isArray(fileNames) ? fileNames : [];
    const namesSet = new Set([ ...curNames, ...newNames ]);
    const mergedNames = Array.from(namesSet);
    localStorage.setItem(NAMES, JSON.stringify(mergedNames));

    // حدّث الذاكرة والواجهة
    days  = load(STORAGE, {});
    names = load(NAMES,   []);
    renderBoard(); renderRail(); refreshStats();

    const changes = report.length;
    showToast?.('success', changes ? `تم الدمج من الملف (${changes} تغيير)` : 'لا تغييرات من الملف');

    // (اختياري) تقرير للكونسول
    console.groupCollapsed('ASSAL MERGE REPORT (FILE)');
    report.forEach(r=> console.log(r));
    console.groupEnd();

  }catch(err){
    console.error(err);
    showToast?.('error','تعذّر قراءة/دمج الملف');
  }
}




// يرجّع 'YYYY-MM-DD' بعد n أيام من ISO معيّن
function addDaysISO(iso, n=1){
  try{
    const d = new Date(iso);
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0,10);
  }catch{ 
    const t = new Date(); t.setDate(t.getDate()+n);
    return t.toISOString().slice(0,10);
  }
}

// افتح يوم "باجر" بالنسبة لتاريخ اليوم الحقيقي (TODAY)
function openNextDayFromToday(){
  const nextISO = addDaysISO(TODAY, 1);      // باجر
  selectedDay = nextISO;

  // إذا اليوم ما موجود بالقائمة، سوّي مصفوفة فارغة
  if(!days[selectedDay]) days[selectedDay] = [];

  // خزّن التغيير (حتى إذا أضفت مواد فورًا تبقى على نفس المفتاح)
  save();

  // حدّث شارة التاريخ بالهيدر حتى توضح إنّه على اليوم التالي
  const badge = document.getElementById('dateBadge');
  if(badge){
    badge.textContent = arDateWithDay(selectedDay) + ' — (اليوم التالي)';
  }

  renderBoard();
  renderRail();
  refreshStats();

  showToast('info','تم فتح فاتورة اليوم التالي');
}




/* ====== Sync Helpers (Server <-> Local) ====== */

// احسب أحدث وقت تعديل داخل كل البيانات (بطاقات/سطور/ملاحظات)
function getUpdatedAtMax(daysObj){
  let maxTs = 0;
  const asTs = (d)=> (d ? new Date(d).getTime() : 0);

  Object.values(daysObj||{}).forEach(cards=>{
    (cards||[]).forEach(card=>{
      maxTs = Math.max(maxTs, asTs(card.updatedAt), asTs(card.createdAt));
      
      
      (card.lines||[]).forEach(l=>{
  maxTs = Math.max(maxTs, asTs(l.updatedAt), asTs(l.createdAt), asTs(l.at));
});
(card.notes||[]).forEach(n=>{
  maxTs = Math.max(maxTs, asTs(n.updatedAt), asTs(n.at));
});

      
      
    });
  });
  return maxTs || 0;
}

// حضّر بايلود النسخة الاحتياطية (نفس فورماتك + updatedAtMax)
function buildBackupPayload(){
  const payload = {
    version: 3,
    exportedAt: new Date().toISOString(),
    updatedAtMax: getUpdatedAtMax(days || {}),
    days : days || {},
    names: names || []
  };
  return payload;
}


async function serverGetBackup(){
  const resp = await fetch(SYNC.BASE_URL, {
    method: 'GET',
    cache : 'no-store',
    headers: { 'Authorization': `Bearer ${SYNC.TOKEN}` }
  });
  if(!resp.ok) throw new Error('GET failed');
  return await resp.json();
}

async function serverPostBackup(payload){
  const resp = await fetch(SYNC.BASE_URL, {
    method : 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${SYNC.TOKEN}`
    },
    body: JSON.stringify(payload)
  });
  if(!resp.ok) throw new Error('POST failed');
  return await resp.json();
}



function safeStr(s){ return String(s||'').trim().replace(/\s+/g,' '); }

// --- جديد: تجميع الطابع الزمني على مستوى الدقيقة فقط ---
function minuteBucket(ts){
  try{
    const d = new Date(ts);
    if(!Number.isFinite(d.getTime())) return '';
    d.setSeconds(0, 0);          // نلغي الثواني والميلي ثانية
    return d.toISOString();
  }catch{ return ''; }
}

// --- تعريف lineKey الوحيد المعتمد في النظام (لا تنسخه مرتين) ---
function lineKey(l){
  if(l?.lineId) return l.lineId;
  const item = safeStr(l?.item);
  const cat  = safeStr(l?.cat);
  const price= String(l?.price ?? '');
  const qty  = String(l?.qty   ?? '');
  const note = safeStr(l?.note);
  const t    = minuteBucket(l?.createdAt || l?.at || l?.updatedAt || '');
  return `SYN::${item}|${cat}|${price}|${qty}|${note}|${t}`;
}






// نفس الفكرة للملاحظة
function noteKey(n){
  if(n?.id) return n.id;
  const text = safeStr(n?.text);
  const t    = minuteBucket(n?.at || n?.updatedAt || '');
  return `SYNNOTE::${text}|${t}`;
}






// اجمع مبالغ البطاقة (يرجع كائن)
function sumCardAmounts(card){
  const out = { total:0, unpaid:0, paid:0, returned:0 };
  (card.lines||[]).forEach(l=>{
    if(l?.deletedAt) return;
    const price = Number(String(l.price??'').replace(/[^\d.]/g,'')) || 0;
    const qty   = Number(l.qty||1);
    const amt   = price * qty;
    out.total   += amt;
    if(l.returned) out.returned += amt;
    else if(l.paid) out.paid += amt;
    else out.unpaid += amt;
  });
  return out;
}






/* ====== Smart Export / Import ====== */


// ===== تصدير/رفع ذكي لكل الفواتير إلى السيرفر (نهائي بعد الدمج) =====
let __EXPORTING__ = false;

async function smartExportToServer(){
  // حماية: لا تسمح باستدعاء متزامن
  if(__EXPORTING__){
    showToast?.('info','جاري الرفع بالفعل… انتظر انتهاء العملية الحالية');
    return;
  }

  if(!window.IS_SIGNED_IN){
    showToast?.('warn','سجّل دخول أولاً');
    return;
  }
  
  __EXPORTING__ = true;
  try{
    showToast('info','جاري تحضير النسخة للرفع (دمج+تسوية)…', 2000);

    // لقطة سلامة: أعلى توقيت تحديث محلي قبل أي عملية
    const preTs = getUpdatedAtMax(days || {});

    // 1) حاول تجيب نسخة السيرفر (قد لا تكون موجودة أول مرة)
    let server = null;
    try{
      server = await serverGetBackup();
    }catch(_){
      server = null; // ماكو نسخة على السيرفر — نعدّها فارغة
    }

    // 2) دمج قبل الرفع لتقليل التعارض (محلي × سيرفر)
    const localDays  = days || {};
    const remoteDays = server?.days || {};
    const { days: mergedDays, report } = mergeAllDays(localDays, remoteDays);

    // 3) تثبيت المعرّفات + إزالة التكرارات
    normalizeIdsInAllDays(mergedDays);
    dedupeAllDays(mergedDays);

    // 4) وحّد أسماء الزبائن (إن وجِدت على السيرفر)
    const curNames = Array.isArray(names) ? names : [];
    const srvNames = Array.isArray(server?.names) ? server.names : [];
    const mergedNames = Array.from(new Set([...curNames, ...srvNames]));

    // 5) خزّن نتيجة الدمج محليًا حتى تظل الواجهة متوافقة مع اللي راح ينرفع
    localStorage.setItem(STORAGE, JSON.stringify(mergedDays));
    localStorage.setItem(NAMES,   JSON.stringify(mergedNames));
    // حدّث الحالة بالذاكرة
    days  = load(STORAGE, {});
    names = load(NAMES,   []);

    // 6) حضّر الحمولة للرفع
    const now = (typeof nowISO === 'function') ? nowISO() : new Date().toISOString();
    const payload = {
      version     : 3,
      exportedAt  : now,
      updatedAtMax: getUpdatedAtMax(mergedDays),
      days        : mergedDays,
      names       : mergedNames
    };

    // 7) تحاشي الرفع إذا لا تغييرات فعلية مقارنةً بالسيرفر
    const sameDays  = JSON.stringify(remoteDays)  === JSON.stringify(mergedDays);
    const sameNames = JSON.stringify(srvNames)    === JSON.stringify(mergedNames);
    if (sameDays && sameNames){
      showToast('info','لا توجد تغييرات تُرفع — البيانات متطابقة مع السيرفر');
      return;
    }

    // 8) فحص سباق التعديل: إذا تغيّرت البيانات محليًا أثناء التحضير — ألغِ العملية
    const postTs = getUpdatedAtMax(days || {});
    if(postTs !== preTs){
      showToast('warn','تغيّرت البيانات أثناء التحضير — أعد المحاولة بعد اكتمال التعديلات');
      return;
    }

    // 9) الرفع
    const r = await serverPostBackup(payload);

    if(r?.status === 'ok' || r?.status === undefined){
      const ch = report?.length || 0;
      showToast('success', ch ? `انرفع النسخة بعد دمج (${ch} تغيير)` : 'انرفع النسخة — لا تغييرات كبيرة');
      // (اختياري) اطبع تقرير الدمج
      console.groupCollapsed?.('ASSAL MERGE REPORT (EXPORT)');
      (report || []).forEach(row => console.log(row));
      console.groupEnd?.();
    }else{
      showToast('error','فشل التصدير للسيرفر');
    }
  }catch(err){
    console.error(err);
    showToast('error','تعذّر الدمج/الرفع إلى السيرفر');
  }finally{
    __EXPORTING__ = false;
  }
}





function normalizeIdsInAllDays(daysObj){
  Object.values(daysObj||{}).forEach(cards=>{
    (cards||[]).forEach(card=>{
      (card.lines||[]).forEach(l => { if(!l.lineId) l.lineId = lineKey(l); });
      (card.notes||[]).forEach(n => { if(!n.id)     n.id     = noteKey(n); });
    });
  });
}






/* =========================================================
   STRONG MERGE: يوم-بيوم، بطاقة-ببطاقة، سطر-بسطر، ملاحظة-بملاحظة
   ========================================================= */

/* اجلب حقل بالأحدث (حسب updatedAt خاصّ بالحقل إن وُجد، وإلا السطر/الملاحظة) */
function pickNewerField(aVal, aTs, bVal, bTs){
  return isNewer(aTs, bTs) ? {val:bVal, ts:bTs} : {val:aVal, ts:aTs};
}

/* دمج سطرين بنفس lineId */
function mergeLine(a, b, report, path){
  // a, b قد يكون أحدهما undefined
  const x = a || {};
  const y = b || {};

  // إذا أحدهما غير موجود → رجّع الموجود (لكن سجّل)
  if(!a && b){
    report.push({ path, type:'line-add', before:null, after:y });
    return {...y};
  }
  if(a && !b){
    report.push({ path, type:'line-keep', before:null, after:x });
    return {...x};
  }

  // كلاهما موجود: قارن deletedAt vs updatedAt (حذف مقابل تعديل)
  const delA = x.deletedAt || null;
  const delB = y.deletedAt || null;

  // إذا أحدهما محذوف والآخر عدّل بعد الحذف → الإلغاء/الإبقاء حسب الأحدث
  const base = {...x};

  // الحقول التي ندمجها حقل-بحقل
  const fields = ['item','cat','price','qty','note','paid','returned'];
  const merged = {...base};

  // timestamps لكل حقل (إذا ما عندك لكل حقل، نستعمل line.updatedAt كله)
  fields.forEach(f=>{
    const aVal = x[f];
    const bVal = y[f];
    const aTs  = x.updatedAt || x.at || null;
    const bTs  = y.updatedAt || y.at || null;
    const {val} = pickNewerField(aVal, aTs, bVal, bTs);
    merged[f] = val;
  });

  // قرارات الحذف:
  // إن كان delA أو delB موجودين، نحسم بحسب من الأحدث مقارنةً مع آخر updatedAt
  const lineUpdatedA = x.updatedAt || x.at || null;
  const lineUpdatedB = y.updatedAt || y.at || null;
  const newestEditTs = isNewer(lineUpdatedA, lineUpdatedB) ? lineUpdatedB : lineUpdatedA;
  const newestDelTs  = isNewer(delA, delB) ? delB : delA;

  if(newestDelTs && !isNewer(newestEditTs, newestDelTs)){
    // الحذف أحدث أو مساوي → إبقاء التومبستون
    merged.deletedAt = newestDelTs;
  }else{
    // التعديل أحدث → إلغاء الحذف
    merged.deletedAt = null;
  }

  // updatedAt = أحدث من الاثنين
  merged.updatedAt = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  merged.createdAt = x.createdAt || y.createdAt || merged.updatedAt || nowISO();
  merged.lineId    = x.lineId || y.lineId || genId();

  // سجّل before/after إذا تغيّر شيء مهم
  const before = JSON.stringify(x);
  const after  = JSON.stringify(merged);
  if(before !== after){
    report.push({ path, type:'line-merge', before:x, after:merged });
  }
  return merged;
}

/* دمج ملاحظة noteId */
function mergeNote(a, b, report, path){
  const x = a || {};
  const y = b || {};
  if(!a && b){ report.push({ path, type:'note-add', before:null, after:y }); return {...y}; }
  if(a && !b){ report.push({ path, type:'note-keep', before:null, after:x }); return {...x}; }

  const merged = {...x};
  const aTs = x.updatedAt || x.at || null;
  const bTs = y.updatedAt || y.at || null;

  // text
  merged.text = pickNewerField(x.text, aTs, y.text, bTs).val;

  // حذف مقابل تعديل
  const delA = x.deletedAt || null, delB = y.deletedAt || null;
  const newestEditTs = isNewer(aTs, bTs) ? bTs : aTs;
  const newestDelTs  = isNewer(delA, delB) ? delB : delA;
  merged.deletedAt = (newestDelTs && !isNewer(newestEditTs, newestDelTs)) ? newestDelTs : null;

  merged.updatedAt = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  merged.at        = x.at || y.at || merged.updatedAt || nowISO();
  merged.id        = x.id || y.id || genId();

  const before = JSON.stringify(x);
  const after  = JSON.stringify(merged);
  if(before !== after){
    report.push({ path, type:'note-merge', before:x, after:merged });
  }
  return merged;
}

/* دمج بطاقة cardId */
function mergeCard(a, b, report, path){
  const x = a || {};
  const y = b || {};

  if(!a && b){ report.push({ path, type:'card-add', before:null, after:y }); return {...y}; }
  if(a && !b){ report.push({ path, type:'card-keep', before:null, after:x }); return {...x}; }

  const merged = {...x};

  // اسم الزبون بالأحدث (نادرًا يتغيّر)
  const custPick = pickNewerField(x.customer, x.updatedAt, y.customer, y.updatedAt);
  merged.customer = custPick.val;

  // حذف مقابل تعديل
  const delA = x.deletedAt || null, delB = y.deletedAt || null;
  const newestEditTs = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  const newestDelTs  = isNewer(delA, delB) ? delB : delA;
  merged.deletedAt = (newestDelTs && !isNewer(newestEditTs, newestDelTs)) ? newestDelTs : null;

  // الدمج سطر-بسطر بالـ lineId
 // مطابقة بمفتاح ثابت
const linesByKey = {};
(a.lines||[]).forEach(l => { linesByKey[lineKey(l)] = l; });
(b.lines||[]).forEach(l => {
  const k = lineKey(l);
  linesByKey[k] = mergeLine(linesByKey[k], l, report, path+'.line:'+k);
});
merged.lines = Object.values(linesByKey).map(l => {
  // ضمن وجود lineId بعد الدمج
  if(!l.lineId) l.lineId = lineKey(l);
  return l;
});


  // دمج الملاحظات noteId
  const notesByKey = {};
(a.notes||[]).forEach(n => { notesByKey[noteKey(n)] = n; });
(b.notes||[]).forEach(n => {
  const k = noteKey(n);
  notesByKey[k] = mergeNote(notesByKey[k], n, report, path+'.note:'+k);
});
merged.notes = Object.values(notesByKey).map(n => {
  if(!n.id) n.id = noteKey(n);
  return n;
});


  // updatedAt الأحدث
  merged.updatedAt = isNewer(x.updatedAt, y.updatedAt) ? y.updatedAt : x.updatedAt;
  merged.createdAt = x.createdAt || y.createdAt || merged.updatedAt || nowISO();

  // billType يعاد احتسابه من السطور
  const types = Array.from(new Set((merged.lines||[]).filter(l=>!l.deletedAt).map(l=> l.returned ? 'راجع' : 'بيع')));
  merged.billType = (types.length===1) ? types[0] : (types.length===0 ? (x.billType||y.billType||'بيع') : 'مختلط');

  // paidAll يُعاد احتسابه
  merged.paidAll = (function(){
    const active = (merged.lines||[]).filter(l=> !l.deletedAt && !l.returned);
    return active.length>0 && active.every(l=> !!l.paid);
  })();

  const before = JSON.stringify(x);
  const after  = JSON.stringify(merged);
  if(before !== after){
    report.push({ path, type:'card-merge', before:x, after:merged });
  }
  return merged;
}

/* دمج أيام: local مقابل remote (سيرفر) — يرجّع {days: merged, report:[] } */
function mergeAllDays(localDays, remoteDays){
  const out = {};
  const report = [];

  const allKeys = new Set([...Object.keys(localDays||{}), ...Object.keys(remoteDays||{})]);
  const keysSorted = Array.from(allKeys).sort(); // ترتيب ثابت

  keysSorted.forEach(dayKey=>{
    const a = localDays?.[dayKey] || [];
    const b = remoteDays?.[dayKey] || [];

    // بطاقات حسب card.id (هو موجود عندك)
    const byId = {};
    a.forEach(c => { byId[c.id] = c; });
    b.forEach(c => {
      byId[c.id] = mergeCard(byId[c.id], c, report, `day:${dayKey}.card:${c.id}`);
    });

    // لو بطاقات في A فقط
    a.forEach(c=>{
      if(!(b.find(x=>x.id===c.id))){
        byId[c.id] = mergeCard(c, null, report, `day:${dayKey}.card:${c.id}`);
      }
    });

    
    const mergedCards = Object.values(byId)
  .map(c => {
    // لا نحذف المحذوف—نخليه لأجل سجلات/تومبستون
    return c;
  })
  .sort((x,y)=> new Date(y.updatedAt||y.createdAt||0) - new Date(x.updatedAt||x.createdAt||0));
out[dayKey] = mergedCards;

    
  });

  return { days: out, report };
}






// استيراد ذكي: يسحب من السيرفر إذا هو أحدث (أو إذا المحلي فارغ)

async function smartImportFromServer(){
  if(!window.IS_SIGNED_IN){
    showToast('warn','سجّل دخول أولاً');
    return;
  }

  try{
    showToast('info','جاري جلب آخر نسخة من السيرفر…', 1800);

    const server = await serverGetBackup();
    if(!server || !server.days){
      showToast('warn','ماكو نسخة على السيرفر بعد');
      return;
    }

    const localDays  = days || {};
    const remoteDays = server.days || {};

    const { days: mergedDays, report } = mergeAllDays(localDays, remoteDays);
    normalizeIdsInAllDays(mergedDays);
    dedupeAllDays(mergedDays);

    // خزن محلي
    localStorage.setItem(STORAGE, JSON.stringify(mergedDays));
    const curNames = Array.isArray(names) ? names : [];
    const srvNames = Array.isArray(server.names) ? server.names : [];
    const mergedNames = Array.from(new Set([...curNames, ...srvNames]));
    localStorage.setItem(NAMES, JSON.stringify(mergedNames));

    // حدّث الذاكرة والواجهة
    days  = load(STORAGE, {});
    names = load(NAMES,   {});
    renderBoard(); renderRail(); refreshStats();

    const changes = report.length;
    showToast('success', changes ? `تم الدمج الآمن (${changes} تغيير)` : 'لا تغييرات — البيانات متطابقة');
    console.groupCollapsed?.('ASSAL MERGE REPORT (IMPORT)');
    (report||[]).forEach(r => console.log(r));
    console.groupEnd?.();
  }catch(err){
    console.error(err);
    showToast('error','تعذّر جلب/دمج النسخة من السيرفر');
  }
}






/* ===== Dedupe Helpers (Lines/Notes) ===== */
function dedupeCardLines(card){
  if(!card || !Array.isArray(card.lines)) return;

  // احتفظ بالأحدث لكل lineKey
  const byKey = new Map();
  for(const ln of card.lines){
    const k = lineKey(ln);
    const cur = byKey.get(k);
    if(!cur){
      byKey.set(k, ln);
    }else{
      const curTs = new Date(cur.updatedAt || cur.at || 0).getTime();
      const newTs = new Date(ln.updatedAt || ln.at || 0).getTime();
      // خذ الأحدث
      if(newTs > curTs) byKey.set(k, ln);
    }
  }
  card.lines = Array.from(byKey.values());

  // رتب نزولياً بالأحدث
  card.lines.sort((a,b)=> new Date(b.updatedAt||b.createdAt||0) - new Date(a.updatedAt||a.createdAt||0));
}

function dedupeCardNotes(card){
  if(!card || !Array.isArray(card.notes)) return;
  const byKey = new Map();
  for(const n of card.notes){
    const k = noteKey(n);
    const cur = byKey.get(k);
    if(!cur){
      byKey.set(k, n);
    }else{
      const curTs = new Date(cur.updatedAt || cur.at || 0).getTime();
      const newTs = new Date(n.updatedAt || n.at || 0).getTime();
      if(newTs > curTs) byKey.set(k, n);
    }
  }
  card.notes = Array.from(byKey.values());
  card.notes.sort((a,b)=> new Date(b.at||b.updatedAt||0) - new Date(a.at||a.updatedAt||0));
}

/* طبّق الديدوب على كل الأيام/البطاقات */
function dedupeAllDays(daysObj){
  Object.values(daysObj||{}).forEach(cards=>{
    (cards||[]).forEach(c=>{
      // ثبّت lineId / id لو ناقصة
      (c.lines||[]).forEach(l => { if(!l.lineId) l.lineId = lineKey(l); });
      (c.notes||[]).forEach(n => { if(!n.id)     n.id     = noteKey(n); });
      dedupeCardLines(c);
      dedupeCardNotes(c);
    });
  });
}




    /* ===== Init ===== */


(function init(){
  document.getElementById('dateBadge').textContent = arDateWithDay(TODAY);
  // --- سطر جديد: حمّل قاعدة الأصناف من الشيت ---
  loadExcelFiles();
  // ----------------------------------------------
  rebuildNames(); renderBoard(); renderRail(); refreshStats();
})();







(function(){
  // شيل أي وسوم قديمة من العنوان وخلي أساس ثابت
  const clean = s => String(s||"").replace(/\s*\[(cust|item|note|filter|c-note)\]\s*/gi, "").trim();
  const baseTitle = clean(document.title);

  function markTag(tag){
    document.title = `${baseTitle} ${tag}`;
  }
  function clearTag(){
    document.title = baseTitle;
  }

  // ===== حقول الـ Dock (ثابتة) =====
  const cust = document.getElementById('cust');   // اسم الزبون → عربي
  const item = document.getElementById('item');   // اسم المادة → إنكليزي
  const note = document.getElementById('note');   // الملاحظات (Dock) → عربي
  const cardSearch = document.getElementById('cardSearch'); // فلترة الكروت → عربي

  cust && cust.addEventListener('focus', ()=> markTag('[cust]'));
  cust && cust.addEventListener('blur',  ()=> clearTag());

  item && item.addEventListener('focus', ()=> markTag('[item]'));
  item && item.addEventListener('blur',  ()=> clearTag());

  note && note.addEventListener('focus', ()=> markTag('[note]'));
  note && note.addEventListener('blur',  ()=> clearTag());

  cardSearch && cardSearch.addEventListener('focus', ()=> markTag('[filter]'));
  cardSearch && cardSearch.addEventListener('blur',  ()=> clearTag());

  // ===== ملاحظات داخل الكروت (تنشأ ديناميكياً) =====
  // عنصر الإدخال داخل البطاقة: input.note-input-sm
  document.addEventListener('focusin', (e)=>{
    if(e.target?.classList?.contains('note-input-sm')){
      markTag('[c-note]');
    }
  });
  document.addEventListener('focusout', (e)=>{
    if(e.target?.classList?.contains('note-input-sm')){
      clearTag();
    }
  });

  // حماية: لو تغيّر العنوان لسبب آخر، نظّفه كل 3 ثواني
  setInterval(()=>{
    const t = document.title;
    const cleaned = clean(t);
    if (t !== cleaned && !/\[(cust|item|note|filter|c-note)\]/i.test(t)) {
      document.title = cleaned;
    }
  }, 3000);
})();



  </script>
  
  
  
<script type="module">
  // ===== Firebase (ES Modules) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc }
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // كونفِغ مشروعك (نفس اللي أعطيتني)
  const firebaseConfig = {
    apiKey: "AIzaSyACIkf1KHXOiM_hAoNHT1CnxFAr-joo7oM",
    authDomain: "assal-debts.firebaseapp.com",
    projectId: "assal-debts",
    storageBucket: "assal-debts.firebasestorage.app",
    messagingSenderId: "329153281725",
    appId: "1:329153281725:web:1b69678fde727f3efa01d4"
  };

  // Init
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ===== حالة الجلسة كمتغيّر عالمي =====
window.IS_SIGNED_IN = false;     // خليها عالمية لأن كود خارج المودول يستعملها

// عناصر البوابة (تعريف مرّة وحدة فقط)
const gate     = document.getElementById('loginGate');
const emailEl  = document.getElementById('lgEmail');
const passEl   = document.getElementById('lgPass');
const btnEl    = document.getElementById('lgBtn');
const msgEl    = document.getElementById('lgMsg');
const btnLogout= document.getElementById('btnLogout');

// أزرار لازم تتعطّل لحد الدخول
const ctrlButtons = [
  document.getElementById('btnExportAll'),
  document.getElementById('btnImportAll'),
  document.getElementById('btnExportDay'),
  document.getElementById('btnClearDay'),
  document.getElementById('btnNextDay')
];
function toggleControls(disabled){
  ctrlButtons.forEach(b=> b && (b.disabled = !!disabled));
}
// ✅ فعّل القفل من البداية (تنفيذ ملاحظتك السابقة)
toggleControls(true);

  
  
  
  
  
  // عناصر السلاش

// ===== Auth Splash (منطق التقدّم الاحترافي) =====
const authSplash = document.getElementById('authSplash');
const authBar    = document.getElementById('authBar');
const authTip    = document.getElementById('authTip');
const authPct    = document.getElementById('authPct');
const authSubEl  = document.getElementById('authSub');

let authRAF = null, authStart = 0, authHold = false;

const AUTH_TIPS = [
  'نحضّر كلشي…',
  'نحدّث حالة الجلسة…',
  'نتأكد من صلاحيات الدخول…',
  'نربط بياناتك بأمان…'
];

// easeOutQuad
function easeOut(t){ return 1 - (1 - t) * (1 - t); }

// شغّل التقدم إلى 95% (الباقي عند الإخفاء)
function startAuthProgress(totalMs = 2200){
  cancelAnimationFrame(authRAF);
  authStart = performance.now();
  authHold  = false;

  function step(now){
    const t = Math.min(1, (now - authStart) / totalMs);
    const eased = easeOut(t);
    const val = Math.min(95, Math.floor(eased * 100)); // نمسك عند 95%

    if(authBar) authBar.style.width = val + '%';
    if(authPct) authPct.textContent = val + '%';

    // بدّل التلميح كل 500ms تقريبًا
    const tipIdx = Math.min(AUTH_TIPS.length - 1, Math.floor((now - authStart) / 500));
    if(authTip) authTip.textContent = AUTH_TIPS[tipIdx];

    if(t < 1 && !authHold){
      authRAF = requestAnimationFrame(step);
    }
  }
  authRAF = requestAnimationFrame(step);
}

// نكمل لـ 100% بسرعة لطيفة ثم نخفي
function completeAuthProgress(holdAfterMs = 120){
  authHold = true;
  cancelAnimationFrame(authRAF);

  const start = performance.now();
  const from  = parseInt((authPct?.textContent || '0').replace(/\D/g,''), 10) || 0;

  function step(now){
    const t = Math.min(1, (now - start) / 260); // اندفاع قصير
    const val = Math.floor(from + (100 - from) * easeOut(t));

    if(authBar) authBar.style.width = val + '%';
    if(authPct) authPct.textContent = val + '%';

    if(t < 1){
      requestAnimationFrame(step);
    }else{
      setTimeout(hideSplash, holdAfterMs);
    }
  }
  requestAnimationFrame(step);
}

// واجهات العرض/الإخفاء (استبدل الموجودة بكودك القديم)
function showSplash(subtitle = 'التحقق من الجلسة'){
  if(authSubEl) authSubEl.textContent = subtitle;
  if(authTip)   authTip.textContent   = AUTH_TIPS[0];
  if(authBar)   authBar.style.width   = '0%';
  if(authPct)   authPct.textContent   = '0%';

  authSplash.style.display = 'grid';
  startAuthProgress();
}
function hideSplash(){
  // أنيميشن خروج خفيف
  authSplash.style.animation = 'auth-pop .22s reverse ease-in both';
  setTimeout(()=>{
    authSplash.style.display   = 'none';
    authSplash.style.animation = '';
  }, 180);
}




function setBtnLoading(btn, on){
  if(!btn) return;
  btn.disabled = !!on;
  btn.classList.toggle('loading', !!on);
}




function showGate(message=''){
  gate.classList.remove('fade-out');
  gate.classList.add('fade-in');
  gate.style.display = 'grid';
  if(msgEl) msgEl.textContent = message || '';
  if(btnLogout) btnLogout.style.display = 'none';
}
function hideGate(){
  gate.classList.remove('fade-in');
  gate.classList.add('fade-out');
  // اخفِ بعد الأنيميشن
  setTimeout(()=>{ gate.style.display = 'none'; }, 200);
  if(msgEl) msgEl.textContent = '';
  if(btnLogout) btnLogout.style.display = '';
}

// UI عند الدخول/الخروج
function setSignedInUI(user){
  IS_SIGNED_IN = true;
  const badge = document.getElementById('userBadge');
  if(badge){ badge.textContent = user?.email || ''; badge.style.display = ''; }
  if(btnLogout){ btnLogout.style.display = ''; btnLogout.title = `تسجيل خروج (${user?.email||''})`; }
  toggleControls(false);   // فعّل الأزرار
  showToast?.('success','تم تسجيل الدخول بنجاح');
}


function setSignedOutUI(){
  IS_SIGNED_IN = false;
  const badge = document.getElementById('userBadge');
  if(badge){ badge.textContent = ''; badge.style.display = 'none'; }
  if(btnLogout){ btnLogout.style.display = 'none'; btnLogout.title = 'تسجيل خروج'; }
  toggleControls(true);    // عطّل الأزرار
  showToast?.('info','تم تسجيل الخروج');
}

// allowlist من Firestore
async function isAllowed(email){
  try{
    const snap = await getDoc(doc(db, "allowlist", "assal"));
    const emails = (snap.exists() && Array.isArray(snap.data().emails)) ? snap.data().emails : [];
    return emails.includes(email);
  }catch{ return false; }
}

// ابدأ والسلاش ظاهر والبوابة مخفية
showSplash();
gate.style.display = 'none';

// دخول يدوي
// تنقّل بالـ Enter داخل بوابة الدخول
emailEl?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); passEl?.focus(); }
});
passEl?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); btnEl?.focus(); }
});
btnEl?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); btnEl.click(); }
});

// دخول يدوي
btnEl?.addEventListener('click', async ()=>{
  msgEl.textContent = '';
  const email = (emailEl.value||'').trim();
  const pass  = passEl.value;
  if(!email || !pass){ msgEl.textContent = 'أدخل الإيميل وكلمة السر'; return; }

  // حركة زر + انتقال لطيف: gate يخفّ، بعدها يظهر Splash
  setBtnLoading(btnEl, true);
  try{
    hideGate();                 // أنيميشين خفيف
    setTimeout(()=> showSplash(), 180);  // بعد خفوت البوابة

    const { user } = await signInWithEmailAndPassword(auth, email, pass);
    if(!(await isAllowed(user.email))){
      await signOut(auth);
      hideSplash();
      showGate('هذا الإيميل غير مخوّل بالدخول');
      return;
    }

    setSignedInUI(user);
    // هنا لا نعرض توستين مع بعض؛ نظام الطابور يضمن واحد ورا الثاني تلقائيًا
  }catch(e){
    hideSplash();
    showGate('فشل تسجيل الدخول');
  }finally{
    setBtnLoading(btnEl, false);
  }
});




// خروج
btnLogout?.addEventListener('click', async ()=>{
  showSplash();
  try{
    await signOut(auth);
    setSignedOutUI();
    showGate('');
  }finally{
    hideSplash();
  }
});

// مراقبة حالة المصادقة (واحد فقط)
onAuthStateChanged(auth, async (user)=>{
  showSplash();
  try{
    if(!user){
      setSignedOutUI();
      showGate('');
      return;
    }
    const ok = await isAllowed(user.email);
    if(ok){
      hideGate();
      setSignedInUI(user);

      // ← هنا فقط: أول استيراد ذكي بعد تسجيل الدخول
      await smartImportFromServer();
    }else{
      await signOut(auth);
      setSignedOutUI();
      showGate('الإيميل غير مخوّل');
    }
  }finally{
    hideSplash();
  }
});







</script>
  
</body>
</html>



